# DNS 迭代查询和递归查询详解

DNS（域名系统）是互联网的基础服务之一，负责将人类可读的域名（如`www.example.com`）转换为机器可读的 IP 地址（如`93.184.216.34`）。在 DNS 解析过程中，有两种主要的查询方式：**迭代查询**和**递归查询**。

## DNS 查询基础

在讨论这两种查询方式前，我们需要了解 DNS 系统的层次结构：

1. **根域名服务器**：互联网 DNS 层次结构的顶层
2. **顶级域名服务器**：管理.com、.org、.net 等顶级域名
3. **权威域名服务器**：负责特定域名的最终解析
4. **本地 DNS 服务器**：通常由 ISP 提供，为用户提供 DNS 查询服务

## 递归查询（Recursive Query）

### 定义

递归查询是指客户端（通常是本地 DNS 服务器）向 DNS 服务器发出请求后，由 DNS 服务器完成域名解析的整个过程，并将最终结果返回给客户端。客户端只需要发送一次请求，等待最终答案。

### 工作流程

1. 客户端向本地 DNS 服务器发送查询请求
2. 如果本地 DNS 服务器有缓存结果，直接返回
3. 如果没有缓存，本地 DNS 服务器代表客户端：
   - 向根域名服务器查询
   - 根据返回信息向顶级域名服务器查询
   - 继续向权威域名服务器查询
   - 获取最终 IP 地址
4. 本地 DNS 服务器将结果返回给客户端

### 递归查询示例

假设用户想访问`www.example.com`：

```
客户端 → 本地DNS服务器："请告诉我www.example.com的IP地址"
本地DNS服务器 → 根域名服务器："请告诉我www.example.com的IP地址"
根域名服务器 → 本地DNS服务器："我不知道确切地址，但你可以问.com域名服务器"
本地DNS服务器 → .com域名服务器："请告诉我www.example.com的IP地址"
.com域名服务器 → 本地DNS服务器："我不知道确切地址，但你可以问example.com的域名服务器"
本地DNS服务器 → example.com域名服务器："请告诉我www.example.com的IP地址"
example.com域名服务器 → 本地DNS服务器："www.example.com的IP地址是93.184.216.34"
本地DNS服务器 → 客户端："www.example.com的IP地址是93.184.216.34"
```

在这个过程中，客户端只需要等待最终结果，所有中间查询都由本地 DNS 服务器完成。

## 迭代查询（Iterative Query）

### 定义

迭代查询是指 DNS 服务器收到客户端请求后，如果没有所查询的信息，会返回其他可能知道这个信息的 DNS 服务器地址，由客户端自己进行后续查询，直到获得最终结果。

### 工作流程

1. 客户端向 DNS 服务器发送查询请求
2. 如果该服务器不知道答案，它会返回一个可能知道答案的其他服务器地址
3. 客户端继续向这个新的服务器发送查询
4. 这个过程持续进行，直到客户端获得最终答案或确定无法解析

### 迭代查询示例

```
客户端 → 根域名服务器："请告诉我www.example.com的IP地址"
根域名服务器 → 客户端："我不知道，但你可以问.com域名服务器（并提供地址）"
客户端 → .com域名服务器："请告诉我www.example.com的IP地址"
.com域名服务器 → 客户端："我不知道，但你可以问example.com的域名服务器（并提供地址）"
客户端 → example.com域名服务器："请告诉我www.example.com的IP地址"
example.com域名服务器 → 客户端："www.example.com的IP地址是93.184.216.34"
```

在迭代查询中，客户端需要自己完成多次查询过程，直到获得最终结果。

## 两种查询方式的对比

### 递归查询的特点

1. **客户端负担小**：只需发送一次请求，等待最终结果
2. **服务器负担大**：本地 DNS 服务器需要完成整个查询过程
3. **查询效率**：对客户端来说更快，因为只有一次往返通信
4. **适用场景**：普通客户端（如个人电脑、手机等）访问互联网

### 迭代查询的特点

1. **客户端负担大**：需要进行多次查询
2. **服务器负担小**：每个 DNS 服务器只需提供自己知道的信息
3. **查询效率**：总体通信次数增多，但减轻了单个 DNS 服务器的负担
4. **适用场景**：DNS 服务器之间的通信

## 实际应用中的混合使用

在现实网络中，递归查询和迭代查询通常是混合使用的：

1. **用户设备 → 本地 DNS 服务器**：使用递归查询
2. **本地 DNS 服务器 → 其他 DNS 服务器**：使用迭代查询

这种方式既减轻了用户设备的负担，又分散了 DNS 服务器的压力。

## DNS 查询使用的传输协议：UDP 与 TCP

DNS 查询通常会使用 UDP 或 TCP 协议进行传输，但在不同场景下有不同的选择。

### 主要使用 UDP 的原因

1. **效率考虑**：大多数 DNS 查询使用 UDP（用户数据报协议），端口号为 53。UDP 是无连接协议，不需要建立连接和断开连接的过程，因此更快速。

2. **数据包大小**：典型的 DNS 查询和响应很小（通常小于 512 字节），能够很好地适应 UDP 的特性。

3. **容错机制**：虽然 UDP 不保证可靠传输，但 DNS 客户端内置了超时重传机制，如果没有收到响应，会自动重新发送查询。

### 何时使用 TCP

DNS 在以下情况下会改用 TCP 协议（同样使用 53 端口）：

1. **响应大小超过 512 字节**：根据 DNS 协议规范（RFC 1035），当 DNS 响应超过 512 字节时，会截断信息，并在响应中设置 TC（截断）标志位。客户端看到这个标志后，会通过 TCP 重新查询以获取完整响应。

2. **区域传输（Zone Transfer）**：当 DNS 服务器之间需要同步区域信息时，由于数据量较大且需要可靠传输，总是使用 TCP。

3. **DNSSEC 签名数据**：带有 DNSSEC（DNS 安全扩展）签名的响应通常较大，可能需要 TCP 传输。

4. **DNS over TCP (DoT)**：为加强隐私保护而设计的 DNS over TLS 协议使用 TCP 853 端口，提供加密的 DNS 服务。

### EDNS0（扩展 DNS）的影响

为了克服 UDP 的 512 字节限制，现代 DNS 实现了 EDNS0（扩展 DNS 机制），它允许：

1. 客户端指定其能够接收的 UDP 数据包大小（通常为 4096 字节）
2. 使更多的 DNS 查询能够继续使用 UDP，减少对 TCP 的依赖
3. 改善 DNS 查询的效率，尤其是对于包含多项记录的响应

### UDP 与 TCP 在 DNS 中的性能对比

| 特性     | UDP                 | TCP                    |
| -------- | ------------------- | ---------------------- |
| 连接开销 | 无连接，开销小      | 需要三次握手，开销大   |
| 可靠性   | 不保证可靠传输      | 保证可靠传输           |
| 传输速度 | 对于小数据包更快    | 建立连接后传输速度稳定 |
| 数据大小 | 原生限制为 512 字节 | 无实际大小限制         |
| 资源消耗 | 服务器资源消耗小    | 服务器需维护连接状态   |
| 使用场景 | 标准 DNS 查询       | 区域传输、大型响应     |

### 实际网络中的应用

在实际网络中：

- 约 **95%** 的标准 DNS 查询使用 UDP 协议
- 当遇到大型响应或特殊需求时自动切换到 TCP
- 许多 DNS 服务器同时监听 UDP 和 TCP 的 53 端口，以应对不同类型的查询需求

## 小结

- **递归查询**：客户端发一次请求，DNS 服务器帮你问到底，然后返回最终结果。就像你请朋友帮你查一个地址，朋友负责打所有电话，最后告诉你结果。
- **迭代查询**：客户端发出请求后，DNS 服务器返回"下一个应该问谁"，客户端自己继续查询。就像你找地址时，每个人只告诉你"去问下一个人"，你需要自己一个个询问。
- **传输协议选择**：DNS 优先使用 UDP 以提高效率，必要时（大型响应、区域传输等）切换到 TCP 以确保数据完整性。

这两种查询方式和传输协议的选择相辅相成，共同保障了 DNS 系统的高效运行和稳定性，使互联网的域名解析服务既快速又可靠。
