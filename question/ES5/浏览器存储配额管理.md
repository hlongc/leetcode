# æµè§ˆå™¨å­˜å‚¨é…é¢ç®¡ç†è¯¦è§£

## ğŸš¨ Service Worker ç¼“å­˜ 30GB çš„é—®é¢˜

### â“ ç”¨æˆ·ç¡¬ç›˜ç©ºé—´ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ

**å¥½æ¶ˆæ¯**ï¼šæµè§ˆå™¨æœ‰å®Œå–„çš„é…é¢ç®¡ç†æœºåˆ¶ï¼Œä¸ä¼šè®©å•ä¸ªç½‘ç«™å ç”¨å¤ªå¤šç©ºé—´ï¼

---

## ğŸ“Š æµè§ˆå™¨å­˜å‚¨é…é¢æœºåˆ¶

### é…é¢é™åˆ¶ï¼ˆä¸åŒæµè§ˆå™¨ï¼‰

| æµè§ˆå™¨ | é…é¢è®¡ç®—æ–¹å¼ | å…¸å‹é™åˆ¶ |
|--------|-------------|---------|
| **Chrome** | å¯ç”¨ç£ç›˜ç©ºé—´çš„ 60% | æœ€å¤§çº¦å‡ å GB |
| **Firefox** | å¯ç”¨ç£ç›˜ç©ºé—´çš„ 50% | æœ€å¤§ 2GBï¼ˆå¯ç”³è¯·æ›´å¤šï¼‰ |
| **Safari** | å›ºå®šé™åˆ¶ | çº¦ 1GB |
| **Edge** | ä¸ Chrome ç›¸åŒ | å¯ç”¨ç©ºé—´çš„ 60% |

**é‡è¦**ï¼šé…é¢æ˜¯**æ‰€æœ‰ç½‘ç«™å…±äº«**çš„ï¼Œä¸æ˜¯å•ä¸ªç½‘ç«™ï¼

```javascript
/**
 * Chrome é…é¢è®¡ç®—ç¤ºä¾‹
 * 
 * å‡è®¾ç”¨æˆ·ç¡¬ç›˜ï¼š
 * - æ€»å®¹é‡ï¼š500GB
 * - å·²ä½¿ç”¨ï¼š300GB
 * - å‰©ä½™ç©ºé—´ï¼š200GB
 * 
 * æµè§ˆå™¨æ€»é…é¢ = 200GB Ã— 60% = 120GB
 * 
 * å•ä¸ªç½‘ç«™é™åˆ¶ï¼š
 * - ä¸´æ—¶å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰ï¼šæ€»é…é¢çš„ 10-20%ï¼ˆçº¦ 12-24GBï¼‰
 * - æŒä¹…åŒ–å­˜å‚¨ï¼šéœ€è¦ç”¨æˆ·æˆæƒï¼Œå¯ä»¥æ›´å¤š
 */
```

---

## ğŸ” æŸ¥è¯¢å½“å‰é…é¢å’Œä½¿ç”¨æƒ…å†µ

### æ–¹æ³•1ï¼šStorage APIï¼ˆæ ‡å‡†ï¼‰

```javascript
/**
 * æŸ¥è¯¢å­˜å‚¨é…é¢å’Œä½¿ç”¨æƒ…å†µ
 */
async function checkStorageQuota() {
  if ('storage' in navigator && 'estimate' in navigator.storage) {
    const estimate = await navigator.storage.estimate();
    
    const usage = estimate.usage;        // å·²ä½¿ç”¨ï¼ˆå­—èŠ‚ï¼‰
    const quota = estimate.quota;        // æ€»é…é¢ï¼ˆå­—èŠ‚ï¼‰
    const percent = (usage / quota * 100).toFixed(2);
    
    console.log('å­˜å‚¨é…é¢ä¿¡æ¯:');
    console.log('å·²ä½¿ç”¨:', (usage / 1024 / 1024).toFixed(2), 'MB');
    console.log('æ€»é…é¢:', (quota / 1024 / 1024).toFixed(2), 'MB');
    console.log('ä½¿ç”¨ç‡:', percent, '%');
    console.log('å‰©ä½™ç©ºé—´:', ((quota - usage) / 1024 / 1024).toFixed(2), 'MB');
    
    // è¯¦ç»†ä¿¡æ¯
    if (estimate.usageDetails) {
      console.log('\nè¯¦ç»†ä½¿ç”¨æƒ…å†µ:');
      for (const [type, size] of Object.entries(estimate.usageDetails)) {
        console.log(`${type}:`, (size / 1024 / 1024).toFixed(2), 'MB');
      }
    }
    
    return estimate;
  } else {
    console.warn('æµè§ˆå™¨ä¸æ”¯æŒ Storage API');
    return null;
  }
}

// ä½¿ç”¨
checkStorageQuota();

/**
 * å…¸å‹è¾“å‡ºï¼š
 * 
 * å­˜å‚¨é…é¢ä¿¡æ¯:
 * å·²ä½¿ç”¨: 45.23 MB
 * æ€»é…é¢: 12288.00 MB  (çº¦ 12GB)
 * ä½¿ç”¨ç‡: 0.37 %
 * å‰©ä½™ç©ºé—´: 12242.77 MB
 * 
 * è¯¦ç»†ä½¿ç”¨æƒ…å†µ:
 * caches: 30.50 MB       (Service Worker ç¼“å­˜)
 * indexedDB: 14.73 MB    (IndexedDB)
 */
```

### æ–¹æ³•2ï¼šå®æ—¶ç›‘æ§

```javascript
/**
 * å®æ—¶ç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µ
 */
class StorageMonitor {
  constructor() {
    this.warningThreshold = 0.8;  // 80% å‘Šè­¦
    this.criticalThreshold = 0.95; // 95% ä¸¥é‡å‘Šè­¦
  }
  
  async check() {
    const estimate = await navigator.storage.estimate();
    const percent = estimate.usage / estimate.quota;
    
    if (percent > this.criticalThreshold) {
      console.error('ğŸ”´ å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³!', (percent * 100).toFixed(2) + '%');
      this.handleCritical();
    } else if (percent > this.warningThreshold) {
      console.warn('ğŸŸ¡ å­˜å‚¨ç©ºé—´ä¸è¶³!', (percent * 100).toFixed(2) + '%');
      this.handleWarning();
    } else {
      console.log('ğŸŸ¢ å­˜å‚¨ç©ºé—´å……è¶³', (percent * 100).toFixed(2) + '%');
    }
    
    return estimate;
  }
  
  handleWarning() {
    // æ¸…ç†è¿‡æœŸç¼“å­˜
    this.cleanExpiredCache();
    
    // æç¤ºç”¨æˆ·
    this.notifyUser('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²è‡ªåŠ¨æ¸…ç†éƒ¨åˆ†ç¼“å­˜');
  }
  
  handleCritical() {
    // æ¿€è¿›æ¸…ç†
    this.aggressiveCleanup();
    
    // å¼ºçƒˆæç¤ºç”¨æˆ·
    this.notifyUser('å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼è¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜', 'error');
  }
  
  async cleanExpiredCache() {
    const cacheNames = await caches.keys();
    
    for (const name of cacheNames) {
      // åˆ é™¤æ—§ç‰ˆæœ¬ç¼“å­˜
      if (name.includes('-old-') || name.includes('-v1-')) {
        await caches.delete(name);
        console.log('åˆ é™¤æ—§ç¼“å­˜:', name);
      }
    }
  }
  
  async aggressiveCleanup() {
    // åªä¿ç•™æœ€æ–°çš„ç¼“å­˜
    const cacheNames = await caches.keys();
    const latestCache = cacheNames[cacheNames.length - 1];
    
    for (const name of cacheNames) {
      if (name !== latestCache) {
        await caches.delete(name);
        console.log('åˆ é™¤ç¼“å­˜:', name);
      }
    }
  }
  
  notifyUser(message, type = 'warning') {
    // æ˜¾ç¤ºé€šçŸ¥æˆ–æç¤º
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('å­˜å‚¨ç©ºé—´æé†’', { body: message });
    } else {
      alert(message);
    }
  }
}

// ä½¿ç”¨
const monitor = new StorageMonitor();

// å®šæœŸæ£€æŸ¥ï¼ˆæ¯10åˆ†é’Ÿï¼‰
setInterval(() => {
  monitor.check();
}, 10 * 60 * 1000);

// ç«‹å³æ£€æŸ¥ä¸€æ¬¡
monitor.check();
```

---

## ğŸ’¡ ç©ºé—´ä¸è¶³æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

### æµè§ˆå™¨çš„è‡ªåŠ¨å¤„ç†

```javascript
/**
 * å½“å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶ï¼Œæµè§ˆå™¨ä¼šï¼š
 */

const browserBehavior = {
  // 1. å†™å…¥å¤±è´¥
  writeFailure: {
    action: 'cache.put() æˆ– indexedDB.add() ä¼šæŠ›å‡º QuotaExceededError',
    example: `
      try {
        await cache.put(request, response);
      } catch (error) {
        if (error.name === 'QuotaExceededError') {
          console.error('å­˜å‚¨é…é¢å·²æ»¡ï¼');
        }
      }
    `
  },
  
  // 2. è‡ªåŠ¨æ¸…ç†ï¼ˆæŸäº›æµè§ˆå™¨ï¼‰
  autoCleanup: {
    chrome: 'ä¼šæç¤ºç”¨æˆ·ï¼Œæˆ–åœ¨åå°è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®',
    firefox: 'å¯èƒ½è‡ªåŠ¨æ¸…ç† LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰çš„æ•°æ®',
    safari: 'æ›´æ¿€è¿›çš„æ¸…ç†ç­–ç•¥'
  },
  
  // 3. æ•°æ®ä¸¢å¤±é£é™©
  dataLoss: {
    warning: 'ä¸´æ—¶å­˜å‚¨ï¼ˆéæŒä¹…åŒ–ï¼‰çš„æ•°æ®å¯èƒ½è¢«æµè§ˆå™¨è‡ªåŠ¨æ¸…é™¤',
    solution: 'ç”³è¯·æŒä¹…åŒ–å­˜å‚¨'
  }
};
```

### é”™è¯¯å¤„ç†ç¤ºä¾‹

```javascript
/**
 * å¤„ç†é…é¢è¶…é™é”™è¯¯
 */
async function safeCachePut(cache, request, response) {
  try {
    await cache.put(request, response);
    return true;
  } catch (error) {
    if (error.name === 'QuotaExceededError') {
      console.error('âŒ å­˜å‚¨é…é¢å·²æ»¡');
      
      // ç­–ç•¥1ï¼šæ¸…ç†æ—§ç¼“å­˜
      await cleanOldCache();
      
      // ç­–ç•¥2ï¼šé‡è¯•
      try {
        await cache.put(request, response);
        console.log('âœ… æ¸…ç†åé‡è¯•æˆåŠŸ');
        return true;
      } catch (retryError) {
        console.error('âŒ é‡è¯•ä»å¤±è´¥');
        
        // ç­–ç•¥3ï¼šé™çº§ï¼ˆä¸ç¼“å­˜ï¼‰
        console.warn('âš ï¸ é™çº§ä¸ºä¸ç¼“å­˜æ¨¡å¼');
        return false;
      }
    } else {
      console.error('å…¶ä»–é”™è¯¯:', error);
      return false;
    }
  }
}

// æ¸…ç†æ—§ç¼“å­˜
async function cleanOldCache() {
  const cacheNames = await caches.keys();
  
  // åˆ é™¤é™¤æœ€æ–°ç‰ˆæœ¬å¤–çš„æ‰€æœ‰ç¼“å­˜
  const latestCache = 'app-cache-v' + getCurrentVersion();
  
  for (const name of cacheNames) {
    if (name !== latestCache) {
      await caches.delete(name);
      console.log('ğŸ—‘ï¸ åˆ é™¤æ—§ç¼“å­˜:', name);
    }
  }
}
```

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè¯·æ±‚æŒä¹…åŒ–å­˜å‚¨ï¼ˆPersistent Storageï¼‰

```javascript
/**
 * ç”³è¯·æŒä¹…åŒ–å­˜å‚¨
 * 
 * ä¼˜ç‚¹ï¼šæ•°æ®ä¸ä¼šè¢«æµè§ˆå™¨è‡ªåŠ¨æ¸…ç†
 * ç¼ºç‚¹ï¼šéœ€è¦ç”¨æˆ·æˆæƒ
 */
async function requestPersistentStorage() {
  if ('storage' in navigator && 'persist' in navigator.storage) {
    // æ£€æŸ¥å½“å‰æ˜¯å¦å·²æŒä¹…åŒ–
    const isPersisted = await navigator.storage.persisted();
    
    if (isPersisted) {
      console.log('âœ… å·²ç»æ˜¯æŒä¹…åŒ–å­˜å‚¨');
      return true;
    }
    
    // è¯·æ±‚æŒä¹…åŒ–
    const granted = await navigator.storage.persist();
    
    if (granted) {
      console.log('âœ… æŒä¹…åŒ–å­˜å‚¨å·²æˆæƒ');
      return true;
    } else {
      console.log('âŒ æŒä¹…åŒ–å­˜å‚¨è¢«æ‹’ç»');
      return false;
    }
  } else {
    console.warn('æµè§ˆå™¨ä¸æ”¯æŒæŒä¹…åŒ–å­˜å‚¨');
    return false;
  }
}

// ä½¿ç”¨
await requestPersistentStorage();
```

### æ–¹æ¡ˆ2ï¼šæ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼ˆæ¨èï¼‰

```javascript
/**
 * æ™ºèƒ½ç¼“å­˜ç®¡ç†å™¨
 * 
 * æ ¸å¿ƒæ€æƒ³ï¼š
 * 1. è®¾ç½®ç¼“å­˜ä¼˜å…ˆçº§
 * 2. æ ¹æ®ç©ºé—´åŠ¨æ€è°ƒæ•´
 * 3. è‡ªåŠ¨æ¸…ç†ä½ä¼˜å…ˆçº§ç¼“å­˜
 */
class SmartCacheManager {
  constructor() {
    this.maxUsagePercent = 0.7; // æœ€å¤šä½¿ç”¨ 70% é…é¢
    
    // ç¼“å­˜ä¼˜å…ˆçº§é…ç½®
    this.priorities = {
      critical: ['/', '/index.html', '/app.js', '/styles.css'], // æ ¸å¿ƒèµ„æº
      high: ['/api/user', '/api/config'],                        // é‡è¦ API
      medium: ['/images/logo.png', '/fonts/'],                   // ä¸€èˆ¬èµ„æº
      low: ['/images/', '/videos/']                              // å¤§æ–‡ä»¶
    };
  }
  
  /**
   * æ£€æŸ¥å¹¶æ¸…ç†ç©ºé—´
   */
  async ensureSpace(requiredBytes = 0) {
    const estimate = await navigator.storage.estimate();
    const currentUsage = estimate.usage;
    const quota = estimate.quota;
    const maxAllowed = quota * this.maxUsagePercent;
    
    console.log('é…é¢æ£€æŸ¥:');
    console.log('å½“å‰ä½¿ç”¨:', (currentUsage / 1024 / 1024).toFixed(2), 'MB');
    console.log('æœ€å¤§å…è®¸:', (maxAllowed / 1024 / 1024).toFixed(2), 'MB');
    console.log('éœ€è¦ç©ºé—´:', (requiredBytes / 1024 / 1024).toFixed(2), 'MB');
    
    // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œå¼€å§‹æ¸…ç†
    if (currentUsage + requiredBytes > maxAllowed) {
      console.warn('âš ï¸ ç©ºé—´ä¸è¶³ï¼Œå¼€å§‹æ¸…ç†...');
      await this.cleanup();
      
      // å†æ¬¡æ£€æŸ¥
      const newEstimate = await navigator.storage.estimate();
      if (newEstimate.usage + requiredBytes > maxAllowed) {
        throw new Error('æ¸…ç†åç©ºé—´ä»ä¸è¶³');
      }
    }
    
    return true;
  }
  
  /**
   * æ¸…ç†ç¼“å­˜ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
   */
  async cleanup() {
    const cacheNames = await caches.keys();
    let freedSpace = 0;
    
    // ä»ä½ä¼˜å…ˆçº§å¼€å§‹æ¸…ç†
    for (const priority of ['low', 'medium']) {
      for (const cacheName of cacheNames) {
        const cache = await caches.open(cacheName);
        const requests = await cache.keys();
        
        for (const request of requests) {
          const url = request.url;
          
          // æ£€æŸ¥æ˜¯å¦å±äºå½“å‰ä¼˜å…ˆçº§
          if (this.matchesPriority(url, priority)) {
            await cache.delete(request);
            freedSpace++;
            console.log(`ğŸ—‘ï¸ åˆ é™¤ ${priority} ä¼˜å…ˆçº§ç¼“å­˜:`, url);
          }
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦é‡Šæ”¾äº†è¶³å¤Ÿç©ºé—´
      const estimate = await navigator.storage.estimate();
      if (estimate.usage < estimate.quota * this.maxUsagePercent) {
        console.log(`âœ… æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾äº† ${freedSpace} ä¸ªç¼“å­˜é¡¹`);
        return;
      }
    }
  }
  
  matchesPriority(url, priority) {
    const patterns = this.priorities[priority] || [];
    return patterns.some(pattern => url.includes(pattern));
  }
  
  /**
   * æ·»åŠ ç¼“å­˜å‰æ£€æŸ¥ç©ºé—´
   */
  async smartCachePut(cacheName, request, response) {
    try {
      // ä¼°ç®—å“åº”å¤§å°
      const blob = await response.clone().blob();
      const estimatedSize = blob.size;
      
      // ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
      await this.ensureSpace(estimatedSize);
      
      // ç¼“å­˜
      const cache = await caches.open(cacheName);
      await cache.put(request, response);
      
      console.log('âœ… ç¼“å­˜æˆåŠŸ:', request.url);
      return true;
    } catch (error) {
      if (error.name === 'QuotaExceededError') {
        console.error('âŒ é…é¢è¶…é™ï¼Œç¼“å­˜å¤±è´¥');
        
        // å°è¯•æ¸…ç†åé‡è¯•
        await this.cleanup();
        
        try {
          const cache = await caches.open(cacheName);
          await cache.put(request, response);
          console.log('âœ… æ¸…ç†åç¼“å­˜æˆåŠŸ');
          return true;
        } catch (retryError) {
          console.error('âŒ æ¸…ç†åä»å¤±è´¥ï¼Œæ”¾å¼ƒç¼“å­˜');
          return false;
        }
      }
      
      console.error('âŒ ç¼“å­˜å¤±è´¥:', error);
      return false;
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const cacheManager = new SmartCacheManager();

// åœ¨ Service Worker ä¸­ä½¿ç”¨
self.addEventListener('fetch', (event) => {
  event.respondWith(
    (async () => {
      const response = await fetch(event.request);
      
      // ä½¿ç”¨æ™ºèƒ½ç¼“å­˜
      await cacheManager.smartCachePut('app-cache', event.request, response.clone());
      
      return response;
    })()
  );
});
```

---

## ğŸ¯ ç¼“å­˜å¤§å°æ§åˆ¶ç­–ç•¥

### ç­–ç•¥1ï¼šé™åˆ¶ç¼“å­˜é¡¹æ•°é‡

```javascript
/**
 * LRU (Least Recently Used) ç¼“å­˜
 * 
 * é™åˆ¶æœ€å¤šç¼“å­˜ 100 ä¸ªé¡¹ç›®
 */
class LRUCache {
  constructor(maxItems = 100) {
    this.maxItems = maxItems;
    this.cacheName = 'lru-cache';
  }
  
  async put(request, response) {
    const cache = await caches.open(this.cacheName);
    
    // è·å–å½“å‰ç¼“å­˜é¡¹
    const keys = await cache.keys();
    
    // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œåˆ é™¤æœ€æ—§çš„
    if (keys.length >= this.maxItems) {
      const oldestKey = keys[0]; // å‡è®¾ç¬¬ä¸€ä¸ªæ˜¯æœ€æ—§çš„
      await cache.delete(oldestKey);
      console.log('ğŸ—‘ï¸ LRU æ¸…ç†:', oldestKey.url);
    }
    
    // æ·»åŠ æ–°ç¼“å­˜
    await cache.put(request, response);
  }
}

// åœ¨ Service Worker ä¸­ä½¿ç”¨
const lruCache = new LRUCache(100);

self.addEventListener('fetch', (event) => {
  event.respondWith(
    (async () => {
      const response = await fetch(event.request);
      await lruCache.put(event.request, response.clone());
      return response;
    })()
  );
});
```

### ç­–ç•¥2ï¼šè®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´

```javascript
/**
 * å¸¦è¿‡æœŸæ—¶é—´çš„ç¼“å­˜
 */
class CacheWithExpiry {
  constructor(cacheName, defaultTTL = 3600000) { // é»˜è®¤1å°æ—¶
    this.cacheName = cacheName;
    this.defaultTTL = defaultTTL;
  }
  
  async put(request, response, ttl = this.defaultTTL) {
    const cache = await caches.open(this.cacheName);
    
    // æ·»åŠ è¿‡æœŸæ—¶é—´åˆ°å“åº”å¤´
    const headers = new Headers(response.headers);
    headers.set('X-Cache-Expiry', Date.now() + ttl);
    
    const newResponse = new Response(response.body, {
      status: response.status,
      statusText: response.statusText,
      headers: headers
    });
    
    await cache.put(request, newResponse);
  }
  
  async match(request) {
    const cache = await caches.open(this.cacheName);
    const response = await cache.match(request);
    
    if (!response) return null;
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    const expiry = response.headers.get('X-Cache-Expiry');
    if (expiry && Date.now() > parseInt(expiry)) {
      console.log('â° ç¼“å­˜å·²è¿‡æœŸï¼Œåˆ é™¤:', request.url);
      await cache.delete(request);
      return null;
    }
    
    return response;
  }
  
  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   */
  async cleanExpired() {
    const cache = await caches.open(this.cacheName);
    const requests = await cache.keys();
    
    let cleaned = 0;
    
    for (const request of requests) {
      const response = await cache.match(request);
      if (!response) continue;
      
      const expiry = response.headers.get('X-Cache-Expiry');
      if (expiry && Date.now() > parseInt(expiry)) {
        await cache.delete(request);
        cleaned++;
      }
    }
    
    console.log(`ğŸ§¹ æ¸…ç†äº† ${cleaned} ä¸ªè¿‡æœŸç¼“å­˜`);
    return cleaned;
  }
}

// å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
setInterval(() => {
  const cache = new CacheWithExpiry('app-cache');
  cache.cleanExpired();
}, 3600000); // æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡
```

### ç­–ç•¥3ï¼šæŒ‰èµ„æºç±»å‹åˆ†çº§ç¼“å­˜

```javascript
/**
 * åˆ†çº§ç¼“å­˜ç­–ç•¥
 * 
 * - HTML/CSS/JS: é•¿æœŸç¼“å­˜
 * - API: çŸ­æœŸç¼“å­˜
 * - å›¾ç‰‡: æŒ‰éœ€ç¼“å­˜
 * - è§†é¢‘: ä¸ç¼“å­˜
 */
self.addEventListener('fetch', (event) => {
  const url = new URL(event.request.url);
  const pathname = url.pathname;
  
  event.respondWith(
    (async () => {
      // 1. HTML/CSS/JS - æ°¸ä¹…ç¼“å­˜
      if (/\.(html|css|js)$/.test(pathname)) {
        return await cacheFirst(event.request, 'static-cache');
      }
      
      // 2. API - çŸ­æœŸç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
      if (pathname.startsWith('/api/')) {
        return await networkFirst(event.request, 'api-cache', 5 * 60 * 1000);
      }
      
      // 3. å°å›¾ç‰‡ - ç¼“å­˜
      if (/\.(png|jpg|gif)$/.test(pathname)) {
        const size = parseInt(event.request.headers.get('Content-Length') || 0);
        if (size < 500 * 1024) { // å°äº 500KB
          return await cacheFirst(event.request, 'image-cache');
        }
      }
      
      // 4. å¤§æ–‡ä»¶/è§†é¢‘ - ä¸ç¼“å­˜
      if (/\.(mp4|webm|zip)$/.test(pathname)) {
        return await fetch(event.request);
      }
      
      // é»˜è®¤ï¼šç½‘ç»œä¼˜å…ˆ
      return await networkFirst(event.request, 'default-cache');
    })()
  );
});
```

---

## ğŸ“ è®¾ç½®åˆç†çš„ç¼“å­˜å¤§å°

### æ¨èç¼“å­˜å¤§å°

```javascript
/**
 * ä¸åŒç±»å‹åº”ç”¨çš„æ¨èç¼“å­˜å¤§å°
 */
const recommendedCacheSizes = {
  // ç®€å•åšå®¢/æ–‡æ¡£ç«™
  simpleSite: {
    total: '10-50 MB',
    breakdown: {
      html: '5 MB',
      css: '2 MB',
      js: '5 MB',
      images: '10-30 MB'
    }
  },
  
  // å•é¡µåº”ç”¨ï¼ˆSPAï¼‰
  spa: {
    total: '50-200 MB',
    breakdown: {
      html: '1 MB',
      js: '20-50 MB',
      css: '5 MB',
      api: '20-100 MB',
      images: '10-50 MB'
    }
  },
  
  // å¤æ‚åº”ç”¨ï¼ˆå¦‚åœ¨çº¿ç¼–è¾‘å™¨ï¼‰
  complexApp: {
    total: '200-500 MB',
    breakdown: {
      core: '100 MB',
      userFiles: '100-300 MB',
      assets: '50-100 MB'
    }
  },
  
  // âš ï¸ ä¸æ¨èè¶…è¿‡ 1GB
  maxRecommended: '500 MB - 1 GB'
};

console.log('æ¨èç¼“å­˜å¤§å°:', recommendedCacheSizes.spa.total);
```

### åŠ¨æ€è°ƒæ•´ç­–ç•¥

```javascript
/**
 * æ ¹æ®å¯ç”¨é…é¢åŠ¨æ€è°ƒæ•´ç¼“å­˜ç­–ç•¥
 */
async function getAdaptiveCacheStrategy() {
  const estimate = await navigator.storage.estimate();
  const quotaGB = estimate.quota / 1024 / 1024 / 1024;
  
  if (quotaGB < 5) {
    // ä½é…é¢è®¾å¤‡ï¼ˆ< 5GBï¼‰
    return {
      maxCacheSize: 50 * 1024 * 1024,     // 50MB
      imageQuality: 'low',
      cacheImages: false,
      cacheVideos: false
    };
  } else if (quotaGB < 20) {
    // ä¸­ç­‰é…é¢ï¼ˆ5-20GBï¼‰
    return {
      maxCacheSize: 200 * 1024 * 1024,    // 200MB
      imageQuality: 'medium',
      cacheImages: true,
      cacheVideos: false
    };
  } else {
    // é«˜é…é¢ï¼ˆ> 20GBï¼‰
    return {
      maxCacheSize: 500 * 1024 * 1024,    // 500MB
      imageQuality: 'high',
      cacheImages: true,
      cacheVideos: true
    };
  }
}

// ä½¿ç”¨
const strategy = await getAdaptiveCacheStrategy();
console.log('å½“å‰ç¼“å­˜ç­–ç•¥:', strategy);
```

---

## ğŸ”” ç”¨æˆ·æç¤ºå’Œäº¤äº’

### æç¤ºç”¨æˆ·æ¸…ç†ç©ºé—´

```javascript
/**
 * å‹å¥½çš„ç”¨æˆ·æç¤º
 */
class StorageNotification {
  static async checkAndNotify() {
    const estimate = await navigator.storage.estimate();
    const usagePercent = estimate.usage / estimate.quota;
    
    if (usagePercent > 0.9) {
      // 90% ä»¥ä¸Šï¼Œä¸¥é‡è­¦å‘Š
      this.showCriticalWarning();
    } else if (usagePercent > 0.7) {
      // 70% ä»¥ä¸Šï¼Œæé†’
      this.showWarning();
    }
  }
  
  static showWarning() {
    const message = `
      æ‚¨çš„æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡è¾ƒé«˜ã€‚
      
      å»ºè®®æ“ä½œï¼š
      1. æ¸…ç†æµè§ˆå™¨ç¼“å­˜
      2. åˆ é™¤ä¸éœ€è¦çš„ç¦»çº¿æ•°æ®
      
      æ˜¯å¦ç°åœ¨æ¸…ç†ï¼Ÿ
    `;
    
    if (confirm(message)) {
      this.clearCache();
    }
  }
  
  static showCriticalWarning() {
    const message = `
      âš ï¸ å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼
      
      åº”ç”¨å¯èƒ½æ— æ³•æ­£å¸¸ç¦»çº¿ä½¿ç”¨ã€‚
      å»ºè®®ç«‹å³æ¸…ç†æµè§ˆå™¨ç¼“å­˜ã€‚
    `;
    
    alert(message);
    
    // è‡ªåŠ¨æ¸…ç†
    this.clearCache();
  }
  
  static async clearCache() {
    // åªä¿ç•™æ ¸å¿ƒç¼“å­˜
    const cacheNames = await caches.keys();
    const keepCache = 'app-cache-v-latest';
    
    let deleted = 0;
    
    for (const name of cacheNames) {
      if (name !== keepCache) {
        await caches.delete(name);
        deleted++;
      }
    }
    
    alert(`å·²æ¸…ç† ${deleted} ä¸ªç¼“å­˜ï¼Œé‡Šæ”¾ç©ºé—´`);
    
    // åˆ·æ–°é¡µé¢
    location.reload();
  }
}

// å®šæœŸæ£€æŸ¥
setInterval(() => {
  StorageNotification.checkAndNotify();
}, 30 * 60 * 1000); // æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
window.addEventListener('load', () => {
  StorageNotification.checkAndNotify();
});
```

---

## ğŸ’¾ IndexedDB é…é¢ç®¡ç†

IndexedDB å’Œ Cache Storage å…±äº«é…é¢ï¼š

```javascript
/**
 * IndexedDB ç©ºé—´ç®¡ç†
 */
async function manageIndexedDBQuota() {
  // æŸ¥è¯¢ä½¿ç”¨æƒ…å†µ
  const estimate = await navigator.storage.estimate();
  
  if (estimate.usageDetails) {
    console.log('IndexedDB ä½¿ç”¨:', 
      (estimate.usageDetails.indexedDB / 1024 / 1024).toFixed(2), 'MB'
    );
  }
  
  // æ¸…ç†æ—§æ•°æ®
  const db = await openDB('myDatabase');
  const tx = db.transaction('messages', 'readwrite');
  const store = tx.objectStore('messages');
  
  // åˆ é™¤ 30 å¤©å‰çš„æ•°æ®
  const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
  const index = store.index('timestamp');
  const range = IDBKeyRange.upperBound(thirtyDaysAgo);
  
  let cursor = await index.openCursor(range);
  let deleted = 0;
  
  while (cursor) {
    await cursor.delete();
    deleted++;
    cursor = await cursor.continue();
  }
  
  console.log(`ğŸ—‘ï¸ åˆ é™¤äº† ${deleted} æ¡æ—§æ•°æ®`);
}
```

---

## ğŸ¨ å®æˆ˜ï¼šæ¸è¿›å¼ç¼“å­˜ç­–ç•¥

### å®Œæ•´çš„ Service Worker ç¤ºä¾‹

```javascript
/**
 * ç”Ÿäº§çº§ Service Worker
 * åŒ…å«å®Œå–„çš„é…é¢ç®¡ç†
 */

const CACHE_NAME = 'app-v1';
const MAX_CACHE_SIZE = 100 * 1024 * 1024; // 100MB
const MAX_CACHE_ITEMS = 500;

// ç¼“å­˜ä¼˜å…ˆçº§
const CACHE_PRIORITY = {
  critical: [/\/(index\.html|app\.js|styles\.css)$/],
  high: [/\/api\/(user|config)/],
  medium: [/\.(png|jpg|svg)$/],
  low: [/\/images\//]
};

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      // åªé¢„ç¼“å­˜æ ¸å¿ƒèµ„æºï¼ˆå‡å°‘åˆå§‹ç¼“å­˜å¤§å°ï¼‰
      return cache.addAll([
        '/',
        '/index.html',
        '/app.js',
        '/styles.css'
      ]);
    })
  );
});

self.addEventListener('fetch', (event) => {
  event.respondWith(
    (async () => {
      try {
        // 1. æ£€æŸ¥é…é¢
        const estimate = await navigator.storage.estimate();
        const usagePercent = estimate.usage / estimate.quota;
        
        // 2. å¦‚æœç©ºé—´ä¸è¶³ï¼Œæ¸…ç†
        if (usagePercent > 0.9) {
          await cleanupCache();
        }
        
        // 3. å°è¯•ä»ç¼“å­˜è·å–
        const cachedResponse = await caches.match(event.request);
        if (cachedResponse) {
          return cachedResponse;
        }
        
        // 4. ä»ç½‘ç»œè·å–
        const response = await fetch(event.request);
        
        // 5. å†³å®šæ˜¯å¦ç¼“å­˜
        if (shouldCache(event.request, response)) {
          const cache = await caches.open(CACHE_NAME);
          
          try {
            await cache.put(event.request, response.clone());
          } catch (error) {
            if (error.name === 'QuotaExceededError') {
              // é…é¢è¶…é™ï¼Œæ¸…ç†åé‡è¯•
              await cleanupCache();
              try {
                await cache.put(event.request, response.clone());
              } catch {
                console.warn('æ¸…ç†åä»æ— æ³•ç¼“å­˜ï¼Œæ”¾å¼ƒ');
              }
            }
          }
        }
        
        return response;
      } catch (error) {
        console.error('Fetch å¤±è´¥:', error);
        return new Response('Network error', { status: 503 });
      }
    })()
  );
});

// åˆ¤æ–­æ˜¯å¦åº”è¯¥ç¼“å­˜
function shouldCache(request, response) {
  // åªç¼“å­˜æˆåŠŸçš„å“åº”
  if (response.status !== 200) return false;
  
  // æ£€æŸ¥èµ„æºå¤§å°
  const contentLength = response.headers.get('Content-Length');
  if (contentLength && parseInt(contentLength) > 5 * 1024 * 1024) {
    // å¤§äº 5MB çš„èµ„æºä¸ç¼“å­˜
    return false;
  }
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯é™æ€èµ„æº
  const url = request.url;
  return /\.(html|css|js|png|jpg|svg|woff2)$/.test(url);
}

// æ¸…ç†ç¼“å­˜
async function cleanupCache() {
  const cache = await caches.open(CACHE_NAME);
  const requests = await cache.keys();
  
  // ä¿ç•™æ ¸å¿ƒèµ„æº
  const criticalUrls = ['/', '/index.html', '/app.js', '/styles.css'];
  
  for (const request of requests) {
    const url = request.url;
    
    // ä¸åˆ é™¤æ ¸å¿ƒèµ„æº
    if (criticalUrls.some(core => url.endsWith(core))) {
      continue;
    }
    
    // åˆ é™¤å…¶ä»–èµ„æº
    await cache.delete(request);
  }
  
  console.log('ğŸ§¹ ç¼“å­˜æ¸…ç†å®Œæˆ');
}
```

---

## ğŸ“Š æ€»ç»“

### å…³é”®è¦ç‚¹

1. **æµè§ˆå™¨æœ‰é…é¢é™åˆ¶**
   - ä¸æ˜¯æƒ³å­˜å¤šå°‘å°±å­˜å¤šå°‘
   - é€šå¸¸æ˜¯å¯ç”¨ç£ç›˜ç©ºé—´çš„ 50-60%
   - æ‰€æœ‰ç½‘ç«™å…±äº«è¿™ä¸ªé…é¢

2. **å•ä¸ªç½‘ç«™é™åˆ¶**
   - ä¸´æ—¶å­˜å‚¨ï¼šæ€»é…é¢çš„ 10-20%
   - æŒä¹…åŒ–å­˜å‚¨ï¼šéœ€è¦ç”¨æˆ·æˆæƒ

3. **ç©ºé—´ä¸è¶³æ—¶**
   - å†™å…¥æ“ä½œä¼šæŠ›å‡º `QuotaExceededError`
   - æµè§ˆå™¨å¯èƒ½è‡ªåŠ¨æ¸…ç†æ•°æ®
   - éœ€è¦åšå¥½é”™è¯¯å¤„ç†

4. **æœ€ä½³å®è·µ**
   - âœ… è®¾ç½®åˆç†çš„ç¼“å­˜å¤§å°ï¼ˆ< 500MBï¼‰
   - âœ… å®ç° LRU æˆ–è¿‡æœŸæ¸…ç†
   - âœ… ç›‘æ§é…é¢ä½¿ç”¨æƒ…å†µ
   - âœ… æ•è· QuotaExceededError
   - âœ… æä¾›é™çº§æ–¹æ¡ˆ

### æ¨èé…ç½®

```javascript
const bestPractice = {
  maxCacheSize: '100-500 MB',        // åˆç†çš„ç¼“å­˜å¤§å°
  maxItems: 500,                      // é™åˆ¶ç¼“å­˜é¡¹æ•°é‡
  ttl: '1-24 å°æ—¶',                   // è®¾ç½®è¿‡æœŸæ—¶é—´
  monitoring: 'å®šæœŸæ£€æŸ¥é…é¢',         // ç›‘æ§
  cleanup: 'è‡ªåŠ¨æ¸…ç†è¿‡æœŸ/ä½ä¼˜å…ˆçº§',   // æ¸…ç†ç­–ç•¥
  fallback: 'ç©ºé—´ä¸è¶³æ—¶é™çº§'          // é™çº§æ–¹æ¡ˆ
};
```

**ç»“è®º**ï¼šä¸ç”¨æ‹…å¿ƒ Service Worker å ç”¨å¤ªå¤šç©ºé—´ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç®¡ç†ã€‚ä½†ä½œä¸ºå¼€å‘è€…ï¼Œåº”è¯¥å®ç°åˆç†çš„ç¼“å­˜ç­–ç•¥ï¼ğŸ¯

