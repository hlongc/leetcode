<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Worker ç‰ˆæœ¬ç®¡ç†æ¼”ç¤º</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .header p {
        color: #666;
        line-height: 1.6;
      }

      .version-info {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .version-info h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .info-item label {
        display: block;
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-item .value {
        color: #333;
        font-size: 16px;
        font-weight: 600;
      }

      .info-item.mismatch {
        border-left-color: #ff9800;
        background: #fff3e0;
      }

      .info-item.mismatch .value {
        color: #ff9800;
      }

      .controls {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .controls h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 20px;
      }

      .button-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      button:active {
        transform: translateY(0);
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-success {
        background: #4caf50;
        color: white;
      }

      .btn-warning {
        background: #ff9800;
        color: white;
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-info {
        background: #2196f3;
        color: white;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .logs {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .logs h2 {
        color: #333;
        margin-bottom: 15px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .log-container {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", Courier, monospace;
        font-size: 13px;
        line-height: 1.6;
      }

      .log-entry {
        margin-bottom: 8px;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .log-entry.info {
        color: #2196f3;
      }
      .log-entry.success {
        color: #4caf50;
      }
      .log-entry.warning {
        color: #ff9800;
      }
      .log-entry.error {
        color: #f44336;
      }

      .timestamp {
        color: #888;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-badge.active {
        background: #4caf50;
        color: white;
      }

      .status-badge.inactive {
        background: #f44336;
        color: white;
      }

      .status-badge.waiting {
        background: #ff9800;
        color: white;
      }

      .cache-stats {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
        color: #333;
      }

      .cache-stats pre {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- å¤´éƒ¨ -->
      <div class="header">
        <h1>ğŸš€ Service Worker ç‰ˆæœ¬ç®¡ç†æ¼”ç¤º</h1>
        <p>
          è¿™ä¸ªæ¼”ç¤ºå±•ç¤ºäº†å¦‚ä½•ç®¡ç† Service Worker
          çš„ç‰ˆæœ¬æ›´æ–°ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ£€æµ‹ã€è‡ªåŠ¨æ›´æ–°ã€ç”¨æˆ·æç¤ºç­‰åŠŸèƒ½ã€‚
        </p>
      </div>

      <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
      <div class="version-info">
        <h2>ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯</h2>
        <div class="info-grid">
          <div class="info-item">
            <label>æœŸæœ›ç‰ˆæœ¬</label>
            <div class="value" id="expected-version">-</div>
          </div>
          <div class="info-item" id="actual-version-item">
            <label>å®é™…ç‰ˆæœ¬</label>
            <div class="value" id="actual-version">-</div>
          </div>
          <div class="info-item">
            <label>æ„å»ºæ—¶é—´</label>
            <div class="value" id="build-time">-</div>
          </div>
          <div class="info-item">
            <label>Service Worker çŠ¶æ€</label>
            <div class="value" id="sw-status">
              <span class="status-badge inactive">æœªæ¿€æ´»</span>
            </div>
          </div>
          <div class="info-item">
            <label>ç¼“å­˜åç§°</label>
            <div class="value" id="cache-name">-</div>
          </div>
          <div class="info-item">
            <label>é¡µé¢åŠ è½½æ—¶é—´</label>
            <div class="value" id="page-load-time">-</div>
          </div>
        </div>
      </div>

      <!-- æ§åˆ¶æŒ‰é’® -->
      <div class="controls">
        <h2>ğŸ® æ“ä½œæ§åˆ¶</h2>
        <div class="button-grid">
          <button class="btn-primary" onclick="checkForUpdate()">
            ğŸ”„ æ£€æŸ¥æ›´æ–°
          </button>
          <button class="btn-success" onclick="forceUpdate()">
            âš¡ å¼ºåˆ¶æ›´æ–°
          </button>
          <button class="btn-info" onclick="getVersionInfo()">
            ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
          </button>
          <button class="btn-warning" onclick="getCacheStats()">
            ğŸ“Š ç¼“å­˜ç»Ÿè®¡
          </button>
          <button class="btn-danger" onclick="clearCache()">ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜</button>
          <button class="btn-danger" onclick="unregisterSW()">
            âŒ æ³¨é”€ SW
          </button>
        </div>
        <div id="cache-stats-container"></div>
      </div>

      <!-- æ—¥å¿— -->
      <div class="logs">
        <h2>
          ğŸ“ æ“ä½œæ—¥å¿—
          <button
            class="btn-warning"
            onclick="clearLogs()"
            style="padding: 6px 12px; font-size: 12px"
          >
            æ¸…ç©ºæ—¥å¿—
          </button>
        </h2>
        <div class="log-container" id="log-container"></div>
      </div>
    </div>

    <script>
      // ==================== é…ç½® ====================
      const EXPECTED_VERSION = "1.0.0"; // ğŸš¨ ä¸ Service Worker ç‰ˆæœ¬ä¿æŒä¸€è‡´
      const CHECK_UPDATE_INTERVAL = 5 * 60 * 1000; // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ›´æ–°
      const SW_PATH = "/sw-version-demo.js";

      // ==================== å…¨å±€å˜é‡ ====================
      let registration = null;
      let updateCheckTimer = null;

      // ==================== åˆå§‹åŒ– ====================
      window.addEventListener("load", () => {
        log("info", "é¡µé¢åŠ è½½å®Œæˆ");
        document.getElementById("expected-version").textContent =
          EXPECTED_VERSION;
        document.getElementById("page-load-time").textContent =
          new Date().toLocaleString("zh-CN");

        if ("serviceWorker" in navigator) {
          initServiceWorker();
        } else {
          log("error", "âŒ æµè§ˆå™¨ä¸æ”¯æŒ Service Worker");
          document.getElementById("sw-status").innerHTML =
            '<span class="status-badge inactive">ä¸æ”¯æŒ</span>';
        }
      });

      // ==================== Service Worker åˆå§‹åŒ– ====================
      async function initServiceWorker() {
        log("info", "æ­£åœ¨æ³¨å†Œ Service Worker...");

        try {
          registration = await navigator.serviceWorker.register(SW_PATH);
          log("success", `âœ… Service Worker æ³¨å†ŒæˆåŠŸ: ${registration.scope}`);

          // æ›´æ–°çŠ¶æ€
          updateSWStatus();

          // ç›‘å¬æ›´æ–°
          registration.addEventListener("updatefound", () => {
            log("warning", "ğŸ”„ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ Service Worker");
            const newWorker = registration.installing;

            newWorker.addEventListener("statechange", () => {
              log("info", `çŠ¶æ€å˜åŒ–: ${newWorker.state}`);

              if (
                newWorker.state === "installed" &&
                navigator.serviceWorker.controller
              ) {
                // æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œä½†æ—§ç‰ˆæœ¬ä»åœ¨è¿è¡Œ
                log("warning", "âš ï¸ æ–°ç‰ˆæœ¬å·²å°±ç»ªï¼Œç­‰å¾…æ¿€æ´»");
                showUpdateNotification(newWorker);
              }

              updateSWStatus();
            });
          });

          // ç›‘å¬æ§åˆ¶æƒå˜åŒ–
          navigator.serviceWorker.addEventListener("controllerchange", () => {
            log("success", "ğŸ”„ Service Worker æ§åˆ¶æƒå·²å˜åŒ–");
            log("info", "å‡†å¤‡åˆ·æ–°é¡µé¢...");

            // æ˜¾ç¤ºåˆ·æ–°æç¤º
            setTimeout(() => {
              if (
                confirm("Service Worker å·²æ›´æ–°ï¼Œæ˜¯å¦åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ–°ç‰ˆæœ¬ï¼Ÿ")
              ) {
                window.location.reload();
              }
            }, 500);
          });

          // ç›‘å¬æ¥è‡ª Service Worker çš„æ¶ˆæ¯
          navigator.serviceWorker.addEventListener("message", (event) => {
            handleSWMessage(event.data);
          });

          // è·å–ç‰ˆæœ¬ä¿¡æ¯
          setTimeout(() => getVersionInfo(), 500);

          // å®šæœŸæ£€æŸ¥æ›´æ–°
          updateCheckTimer = setInterval(() => {
            log("info", "â° å®šæœŸæ£€æŸ¥æ›´æ–°...");
            checkForUpdate();
          }, CHECK_UPDATE_INTERVAL);

          // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æŸ¥æ›´æ–°
          document.addEventListener("visibilitychange", () => {
            if (!document.hidden && registration) {
              log("info", "ğŸ‘€ é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥æ›´æ–°...");
              checkForUpdate();
            }
          });
        } catch (error) {
          log("error", `âŒ Service Worker æ³¨å†Œå¤±è´¥: ${error.message}`);
        }
      }

      // ==================== æ›´æ–° SW çŠ¶æ€æ˜¾ç¤º ====================
      function updateSWStatus() {
        const statusEl = document.getElementById("sw-status");

        if (!registration) {
          statusEl.innerHTML =
            '<span class="status-badge inactive">æœªæ³¨å†Œ</span>';
          return;
        }

        let status = "æœªçŸ¥";
        let badge = "inactive";

        if (registration.active) {
          status = "å·²æ¿€æ´»";
          badge = "active";
        } else if (registration.waiting) {
          status = "ç­‰å¾…ä¸­";
          badge = "waiting";
        } else if (registration.installing) {
          status = "å®‰è£…ä¸­";
          badge = "waiting";
        }

        statusEl.innerHTML = `<span class="status-badge ${badge}">${status}</span>`;
      }

      // ==================== å¤„ç† SW æ¶ˆæ¯ ====================
      function handleSWMessage(data) {
        log("info", "ğŸ“¨ æ”¶åˆ° Service Worker æ¶ˆæ¯:");
        console.log(data);

        switch (data.type) {
          case "SW_ACTIVATED":
            log("success", `âœ… Service Worker ${data.version} å·²æ¿€æ´»`);
            document.getElementById("actual-version").textContent =
              data.version || "-";
            document.getElementById("build-time").textContent = data.buildTime
              ? new Date(data.buildTime).toLocaleString("zh-CN")
              : "-";
            checkVersionMatch();
            break;

          case "VERSION_INFO":
            log("info", `ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: ${data.version}`);
            document.getElementById("actual-version").textContent =
              data.version || "-";
            document.getElementById("build-time").textContent = data.buildTime
              ? new Date(data.buildTime).toLocaleString("zh-CN")
              : "-";
            document.getElementById("cache-name").textContent =
              data.cacheName || "-";
            checkVersionMatch();
            break;

          case "CACHE_CLEARED":
            log("success", "âœ… ç¼“å­˜å·²æ¸…ç†");
            break;

          case "CACHE_STATS":
            displayCacheStats(data.stats);
            break;

          default:
            log("info", `æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${data.type}`);
        }
      }

      // ==================== æ£€æŸ¥ç‰ˆæœ¬åŒ¹é… ====================
      function checkVersionMatch() {
        const actualVersion =
          document.getElementById("actual-version").textContent;
        const actualVersionItem = document.getElementById(
          "actual-version-item"
        );

        if (actualVersion === EXPECTED_VERSION) {
          actualVersionItem.classList.remove("mismatch");
          log("success", "âœ… ç‰ˆæœ¬åŒ¹é…");
        } else if (actualVersion !== "-") {
          actualVersionItem.classList.add("mismatch");
          log(
            "warning",
            `âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…ï¼æœŸæœ›: ${EXPECTED_VERSION}, å®é™…: ${actualVersion}`
          );
        }
      }

      // ==================== è·å–ç‰ˆæœ¬ä¿¡æ¯ ====================
      async function getVersionInfo() {
        if (!navigator.serviceWorker.controller) {
          log("warning", "âš ï¸ Service Worker å°šæœªæ§åˆ¶é¡µé¢");
          return;
        }

        log("info", "æ­£åœ¨è·å–ç‰ˆæœ¬ä¿¡æ¯...");

        const messageChannel = new MessageChannel();
        navigator.serviceWorker.controller.postMessage("GET_VERSION", [
          messageChannel.port2,
        ]);

        messageChannel.port1.onmessage = (event) => {
          handleSWMessage(event.data);
        };
      }

      // ==================== æ£€æŸ¥æ›´æ–° ====================
      async function checkForUpdate() {
        if (!registration) {
          log("error", "âŒ Service Worker æœªæ³¨å†Œ");
          return;
        }

        log("info", "ğŸ” æ£€æŸ¥æ›´æ–°ä¸­...");

        try {
          await registration.update();
          log("success", "âœ… æ›´æ–°æ£€æŸ¥å®Œæˆ");

          // æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…ä¸­çš„ worker
          if (registration.waiting) {
            log("warning", "âš ï¸ å‘ç°æ–°ç‰ˆæœ¬æ­£åœ¨ç­‰å¾…");
            showUpdateNotification(registration.waiting);
          } else if (registration.installing) {
            log("info", "ğŸ“¦ æ–°ç‰ˆæœ¬æ­£åœ¨å®‰è£…ä¸­...");
          } else {
            log("info", "âœ¨ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬");
          }
        } catch (error) {
          log("error", `âŒ æ£€æŸ¥æ›´æ–°å¤±è´¥: ${error.message}`);
        }
      }

      // ==================== å¼ºåˆ¶æ›´æ–° ====================
      async function forceUpdate() {
        if (!registration) {
          log("error", "âŒ Service Worker æœªæ³¨å†Œ");
          return;
        }

        const newWorker = registration.waiting || registration.installing;

        if (!newWorker) {
          log("warning", "âš ï¸ æ²¡æœ‰ç­‰å¾…æ¿€æ´»çš„æ–°ç‰ˆæœ¬");
          log("info", "å°è¯•æ£€æŸ¥æ›´æ–°...");
          await checkForUpdate();
          return;
        }

        if (
          confirm("ç¡®å®šè¦ç«‹å³æ›´æ–°å—ï¼Ÿé¡µé¢å°†ä¼šåˆ·æ–°ï¼Œæœªä¿å­˜çš„æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ã€‚")
        ) {
          log("info", "âš¡ å¼ºåˆ¶æ›´æ–°...");
          newWorker.postMessage({ type: "SKIP_WAITING" });
        }
      }

      // ==================== æ˜¾ç¤ºæ›´æ–°é€šçŸ¥ ====================
      function showUpdateNotification(newWorker) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºé€šçŸ¥
        if (document.getElementById("update-notification")) {
          return;
        }

        const notification = document.createElement("div");
        notification.id = "update-notification";
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: white;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
          z-index: 10000;
          max-width: 350px;
          animation: slideIn 0.3s ease-out;
        `;

        notification.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong style="color: #333; font-size: 18px;">ğŸ‰ æ–°ç‰ˆæœ¬å¯ç”¨ï¼</strong>
          </div>
          <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
            æˆ‘ä»¬å·²ç»æ”¹è¿›äº†åº”ç”¨çš„æ€§èƒ½å’ŒåŠŸèƒ½ã€‚æ›´æ–°åªéœ€å‡ ç§’é’Ÿã€‚
          </p>
          <div style="display: flex; gap: 10px;">
            <button id="update-now-btn" style="
              flex: 1;
              background: #667eea;
              color: white;
              border: none;
              padding: 10px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
            ">
              ç«‹å³æ›´æ–°
            </button>
            <button id="update-later-btn" style="
              flex: 1;
              background: #f5f5f5;
              color: #333;
              border: none;
              padding: 10px;
              border-radius: 6px;
              cursor: pointer;
            ">
              ç¨å
            </button>
          </div>
        `;

        document.body.appendChild(notification);

        // æ·»åŠ åŠ¨ç”»
        const style = document.createElement("style");
        style.textContent = `
          @keyframes slideIn {
            from {
              transform: translateX(400px);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);

        // ç«‹å³æ›´æ–°
        document.getElementById("update-now-btn").onclick = () => {
          log("info", "ğŸš€ ç”¨æˆ·ç¡®è®¤æ›´æ–°");
          newWorker.postMessage({ type: "SKIP_WAITING" });
          notification.remove();
        };

        // ç¨åæ›´æ–°
        document.getElementById("update-later-btn").onclick = () => {
          log("info", "â° ç”¨æˆ·é€‰æ‹©ç¨åæ›´æ–°");
          notification.remove();

          // 30åˆ†é’Ÿåå†æé†’
          setTimeout(() => {
            if (
              registration &&
              (registration.waiting || registration.installing)
            ) {
              showUpdateNotification(newWorker);
            }
          }, 30 * 60 * 1000);
        };
      }

      // ==================== è·å–ç¼“å­˜ç»Ÿè®¡ ====================
      async function getCacheStats() {
        if (!navigator.serviceWorker.controller) {
          log("warning", "âš ï¸ Service Worker å°šæœªæ§åˆ¶é¡µé¢");
          return;
        }

        log("info", "æ­£åœ¨è·å–ç¼“å­˜ç»Ÿè®¡...");

        navigator.serviceWorker.controller.postMessage({
          type: "GET_CACHE_STATS",
        });
      }

      // ==================== æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡ ====================
      function displayCacheStats(stats) {
        log("success", "âœ… ç¼“å­˜ç»Ÿè®¡å·²è·å–");

        let container = document.getElementById("cache-stats-container");
        if (!container) {
          container = document.createElement("div");
          container.id = "cache-stats-container";
          document.querySelector(".controls").appendChild(container);
        }

        container.className = "cache-stats";
        container.innerHTML = `
          <strong>ç¼“å­˜ç»Ÿè®¡ï¼š</strong>
          <br>
          æ€»ç¼“å­˜æ•°: ${stats.cacheCount}
          <pre>${JSON.stringify(stats.caches, null, 2)}</pre>
        `;
      }

      // ==================== æ¸…ç†ç¼“å­˜ ====================
      async function clearCache() {
        if (!navigator.serviceWorker.controller) {
          log("warning", "âš ï¸ Service Worker å°šæœªæ§åˆ¶é¡µé¢");
          return;
        }

        if (!confirm("ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ")) {
          return;
        }

        log("info", "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç†ç¼“å­˜...");
        navigator.serviceWorker.controller.postMessage({ type: "CLEAR_CACHE" });
      }

      // ==================== æ³¨é”€ Service Worker ====================
      async function unregisterSW() {
        if (!registration) {
          log("error", "âŒ Service Worker æœªæ³¨å†Œ");
          return;
        }

        if (
          !confirm("ç¡®å®šè¦æ³¨é”€ Service Worker å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ç¼“å­˜å’Œç¦»çº¿åŠŸèƒ½ã€‚")
        ) {
          return;
        }

        log("info", "âŒ æ­£åœ¨æ³¨é”€ Service Worker...");

        try {
          const success = await registration.unregister();
          if (success) {
            log("success", "âœ… Service Worker å·²æ³¨é”€");
            updateSWStatus();

            if (confirm("Service Worker å·²æ³¨é”€ï¼Œæ˜¯å¦åˆ·æ–°é¡µé¢ï¼Ÿ")) {
              window.location.reload();
            }
          } else {
            log("error", "âŒ æ³¨é”€å¤±è´¥");
          }
        } catch (error) {
          log("error", `âŒ æ³¨é”€å¤±è´¥: ${error.message}`);
        }
      }

      // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
      function log(level, message) {
        const container = document.getElementById("log-container");
        const entry = document.createElement("div");
        entry.className = `log-entry ${level}`;

        const time = new Date().toLocaleTimeString("zh-CN");
        entry.innerHTML = `<span class="timestamp">[${time}]</span> ${message}`;

        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;

        // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
        console.log(`[${level}] ${message}`);
      }

      function clearLogs() {
        document.getElementById("log-container").innerHTML = "";
        log("info", "æ—¥å¿—å·²æ¸…ç©º");
      }

      // ==================== æ¸…ç†å®šæ—¶å™¨ ====================
      window.addEventListener("beforeunload", () => {
        if (updateCheckTimer) {
          clearInterval(updateCheckTimer);
        }
      });
    </script>
  </body>
</html>
