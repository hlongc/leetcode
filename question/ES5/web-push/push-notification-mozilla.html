<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¨é€é€šçŸ¥æµ‹è¯• - Mozillaç‰ˆæœ¬</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .section {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      button {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 8px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .status {
        margin: 10px 0;
        padding: 12px;
        border-radius: 8px;
        font-weight: 500;
      }
      .success {
        background: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border: 1px solid rgba(46, 204, 113, 0.3);
      }
      .error {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
      }
      .warning {
        background: rgba(241, 196, 15, 0.2);
        color: #f1c40f;
        border: 1px solid rgba(241, 196, 15, 0.3);
      }
      .info {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }
      h1,
      h2 {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .mozilla-badge {
        display: inline-block;
        background: linear-gradient(45deg, #ff9500, #ff6b35);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”” æ¨é€é€šçŸ¥æµ‹è¯• <span class="mozilla-badge">Mozillaç‰ˆæœ¬</span></h1>
      <p>ä½¿ç”¨Mozillaæ¨é€æœåŠ¡ï¼Œè§£å†³Google FCMè¿æ¥é—®é¢˜</p>
    </div>

    <div class="section">
      <h2>ğŸ“‹ ç³»ç»Ÿä¿¡æ¯</h2>
      <div id="systemInfo">æ£€æµ‹ä¸­...</div>
    </div>

    <div class="section">
      <h2>ğŸ”” æ¨é€é€šçŸ¥</h2>
      <button id="requestPermission">è¯·æ±‚é€šçŸ¥æƒé™</button>
      <button id="subscribe">è®¢é˜…æ¨é€</button>
      <button id="unsubscribe">å–æ¶ˆè®¢é˜…</button>
      <button id="sendTestPush">å‘é€æµ‹è¯•æ¨é€</button>
      <button id="sendCustomPush">å‘é€è‡ªå®šä¹‰æ¨é€</button>
    </div>

    <div class="section">
      <h2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
      <button id="getStats">è·å–è®¢é˜…ç»Ÿè®¡</button>
      <button id="cleanupSubscriptions">æ¸…ç†æ— æ•ˆè®¢é˜…</button>
    </div>

    <div class="section">
      <h2>ğŸŒ ç½‘ç»œçŠ¶æ€</h2>
      <button id="checkNetwork">æ£€æŸ¥ç½‘ç»œçŠ¶æ€</button>
    </div>

    <div class="section">
      <h2>ğŸ“ çŠ¶æ€æ—¥å¿—</h2>
      <div id="status"></div>
    </div>

    <script>
      // Mozillaæ¨é€æœåŠ¡ç‰ˆæœ¬
      // ä½¿ç”¨Mozillaæ¨é€æœåŠ¡æ›¿ä»£Google FCM

      let currentSubscription = null;
      const SERVER_URL = "http://localhost:3000";

      // æ£€æŸ¥é€šçŸ¥æ”¯æŒ
      function checkNotificationSupport() {
        const systemInfo = document.getElementById("systemInfo");

        if (!("Notification" in window)) {
          systemInfo.innerHTML = "âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥";
          return false;
        }

        if (!("serviceWorker" in navigator)) {
          systemInfo.innerHTML = "âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒService Worker";
          return false;
        }

        if (!("PushManager" in window)) {
          systemInfo.innerHTML = "âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒæ¨é€";
          return false;
        }

        systemInfo.innerHTML = `
          <p>âœ… æµè§ˆå™¨æ”¯æŒé€šçŸ¥</p>
          <p>âœ… æµè§ˆå™¨æ”¯æŒService Worker</p>
          <p>âœ… æµè§ˆå™¨æ”¯æŒæ¨é€</p>
          <p><strong>é€šçŸ¥æƒé™:</strong> ${Notification.permission}</p>
          <p><strong>æ¨é€æœåŠ¡:</strong> Mozilla (updates.push.services.mozilla.com)</p>
          <p><strong>ç”¨æˆ·ä»£ç†:</strong> ${navigator.userAgent}</p>
        `;
        return true;
      }

      // æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
      function checkSystemInfo() {
        const systemInfo = document.getElementById("systemInfo");
        systemInfo.innerHTML += `
          <p><strong>åœ¨çº¿çŠ¶æ€:</strong> ${
            navigator.onLine ? "åœ¨çº¿" : "ç¦»çº¿"
          }</p>
          <p><strong>è¯­è¨€:</strong> ${navigator.language}</p>
          <p><strong>å¹³å°:</strong> ${navigator.platform}</p>
          <p><strong>Cookieå¯ç”¨:</strong> ${
            navigator.cookieEnabled ? "æ˜¯" : "å¦"
          }</p>
        `;
      }

      // è¯·æ±‚é€šçŸ¥æƒé™
      async function requestNotificationPermission() {
        try {
          const permission = await Notification.requestPermission();
          updateStatus(
            `é€šçŸ¥æƒé™: ${permission}`,
            permission === "granted" ? "success" : "warning"
          );
          return permission === "granted";
        } catch (error) {
          updateStatus("è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥: " + error.message, "error");
          console.error("Request permission failed:", error);
          return false;
        }
      }

      // æ³¨å†ŒService Worker
      async function registerServiceWorker() {
        try {
          const registration = await navigator.serviceWorker.register(
            "/sw-fixed.js"
          );
          updateStatus("Service Workeræ³¨å†ŒæˆåŠŸ", "success");
          console.log("Service Worker registered:", registration);
          return registration;
        } catch (error) {
          updateStatus("Service Workeræ³¨å†Œå¤±è´¥: " + error.message, "error");
          console.error("Service Worker registration failed:", error);
          return null;
        }
      }

      // è®¢é˜…æ¨é€
      async function subscribeToPush() {
        try {
          const registration = await registerServiceWorker();
          if (!registration) {
            return;
          }

          const response = await fetch(`${SERVER_URL}/api/vapid-public-key`);
          const data = await response.json();
          const publicKey = data.publicKey;

          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          });

          currentSubscription = subscription;
          updateStatus("æ¨é€è®¢é˜…æˆåŠŸ (MozillaæœåŠ¡)", "success");

          // å‘é€è®¢é˜…åˆ°æœåŠ¡å™¨
          await fetch(`${SERVER_URL}/api/push-subscription`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(subscription),
          });

          updateStatus("è®¢é˜…å·²ä¿å­˜åˆ°æœåŠ¡å™¨", "success");
        } catch (error) {
          updateStatus("è®¢é˜…æ¨é€å¤±è´¥: " + error.message, "error");
          console.error("Subscribe failed:", error);
        }
      }

      // å–æ¶ˆè®¢é˜…
      async function unsubscribeFromPush() {
        try {
          if (currentSubscription) {
            await currentSubscription.unsubscribe();
            currentSubscription = null;
            updateStatus("æ¨é€è®¢é˜…å·²å–æ¶ˆ", "success");
          } else {
            updateStatus("æ²¡æœ‰æ´»è·ƒçš„è®¢é˜…", "warning");
          }
        } catch (error) {
          updateStatus("å–æ¶ˆè®¢é˜…å¤±è´¥: " + error.message, "error");
          console.error("Unsubscribe failed:", error);
        }
      }

      // å‘é€æµ‹è¯•æ¨é€
      async function sendTestPush() {
        if (!currentSubscription) {
          updateStatus("è¯·å…ˆè®¢é˜…æ¨é€", "warning");
          return;
        }

        try {
          const response = await fetch(`${SERVER_URL}/api/send-push`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              subscription: currentSubscription,
              payload: {
                title: "Mozillaæ¨é€æµ‹è¯•",
                body: "è¿™æ˜¯é€šè¿‡Mozillaæ¨é€æœåŠ¡å‘é€çš„æµ‹è¯•é€šçŸ¥",
                icon: "/icon.png",
              },
            }),
          });

          const result = await response.json();
          if (result.success) {
            updateStatus("æµ‹è¯•æ¨é€å‘é€æˆåŠŸ (MozillaæœåŠ¡)", "success");
          } else {
            updateStatus("æµ‹è¯•æ¨é€å‘é€å¤±è´¥: " + result.error, "error");
            if (result.suggestion) {
              updateStatus("å»ºè®®: " + result.suggestion, "info");
            }
          }
        } catch (error) {
          updateStatus("å‘é€æµ‹è¯•æ¨é€å¤±è´¥: " + error.message, "error");
          console.error("Send test push failed:", error);
        }
      }

      // å‘é€è‡ªå®šä¹‰æ¨é€
      async function sendCustomPush() {
        if (!currentSubscription) {
          updateStatus("è¯·å…ˆè®¢é˜…æ¨é€", "warning");
          return;
        }

        const title = prompt("è¯·è¾“å…¥æ¨é€æ ‡é¢˜:", "Mozillaè‡ªå®šä¹‰æ¨é€");
        const body = prompt(
          "è¯·è¾“å…¥æ¨é€å†…å®¹:",
          "è¿™æ˜¯é€šè¿‡Mozillaæ¨é€æœåŠ¡å‘é€çš„è‡ªå®šä¹‰é€šçŸ¥"
        );

        if (!title || !body) {
          updateStatus("æ¨é€æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º", "warning");
          return;
        }

        try {
          const response = await fetch(`${SERVER_URL}/api/send-push`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              subscription: currentSubscription,
              payload: {
                title: title,
                body: body,
                icon: "/icon.png",
              },
            }),
          });

          const result = await response.json();
          if (result.success) {
            updateStatus("è‡ªå®šä¹‰æ¨é€å‘é€æˆåŠŸ (MozillaæœåŠ¡)", "success");
          } else {
            updateStatus("è‡ªå®šä¹‰æ¨é€å‘é€å¤±è´¥: " + result.error, "error");
            if (result.suggestion) {
              updateStatus("å»ºè®®: " + result.suggestion, "info");
            }
          }
        } catch (error) {
          updateStatus("å‘é€è‡ªå®šä¹‰æ¨é€å¤±è´¥: " + error.message, "error");
          console.error("Send custom push failed:", error);
        }
      }

      // è·å–è®¢é˜…ç»Ÿè®¡
      async function getSubscriptionStats() {
        try {
          const response = await fetch(`${SERVER_URL}/api/subscription-stats`, {
            method: "GET",
          });

          if (response.ok) {
            const result = await response.json();
            updateStatus(
              `è®¢é˜…ç»Ÿè®¡: å…± ${result.totalSubscriptions} ä¸ªè®¢é˜…`,
              "success"
            );
            console.log("è®¢é˜…ç»Ÿè®¡:", result);

            // æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
            const status = document.getElementById("status");
            status.innerHTML += `
              <div class="info">
                <h4>ğŸ“Š è®¢é˜…ç»Ÿè®¡è¯¦æƒ…</h4>
                <p><strong>æ€»è®¢é˜…æ•°:</strong> ${result.totalSubscriptions}</p>
                <p><strong>æ¨é€æœåŠ¡:</strong> Mozilla</p>
                <p><strong>è®¢é˜…åˆ—è¡¨:</strong></p>
                <ul>
                  ${result.subscriptions
                    .map(
                      (sub) => `<li>${sub.endpoint.substring(0, 50)}...</li>`
                    )
                    .join("")}
                </ul>
              </div>
            `;
          } else {
            const errorText = await response.text();
            updateStatus(
              `è·å–ç»Ÿè®¡å¤±è´¥: ${response.status} - ${errorText}`,
              "error"
            );
            console.error("è·å–ç»Ÿè®¡é”™è¯¯:", response.status, errorText);
          }
        } catch (error) {
          updateStatus("è·å–è®¢é˜…ç»Ÿè®¡å¤±è´¥: " + error.message, "error");
          console.error("Get subscription stats failed:", error);
        }
      }

      // æ¸…ç†æ— æ•ˆè®¢é˜…
      async function cleanupSubscriptions() {
        try {
          const response = await fetch(
            `${SERVER_URL}/api/cleanup-subscriptions`,
            {
              method: "POST",
            }
          );

          const result = await response.json();
          if (result.success) {
            updateStatus(result.message, "success");
          } else {
            updateStatus("æ¸…ç†è®¢é˜…å¤±è´¥: " + result.error, "error");
          }
        } catch (error) {
          updateStatus("æ¸…ç†è®¢é˜…å¤±è´¥: " + error.message, "error");
          console.error("Cleanup subscriptions failed:", error);
        }
      }

      // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
      async function checkNetworkStatus() {
        try {
          const response = await fetch(`${SERVER_URL}/api/network-status`);
          const result = await response.json();
          updateStatus(`ç½‘ç»œçŠ¶æ€: ${result.message}`, "info");
          updateStatus(`æ¨é€æœåŠ¡: ${result.service}`, "info");
          console.log("ç½‘ç»œçŠ¶æ€:", result);
        } catch (error) {
          updateStatus("æ£€æŸ¥ç½‘ç»œçŠ¶æ€å¤±è´¥: " + error.message, "error");
          console.error("Check network status failed:", error);
        }
      }

      // å·¥å…·å‡½æ•°ï¼šURL Base64 è½¬ Uint8Array
      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      // æ›´æ–°çŠ¶æ€
      function updateStatus(message, type = "info") {
        const status = document.getElementById("status");
        const timestamp = new Date().toLocaleTimeString();
        status.innerHTML += `<div class="status ${type}">[${timestamp}] ${message}</div>`;
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        status.scrollTop = status.scrollHeight;
      }

      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners() {
        // ä½¿ç”¨PromiseåŒ…è£…æ‰€æœ‰å¼‚æ­¥æ“ä½œï¼Œç¡®ä¿é”™è¯¯è¢«æ­£ç¡®æ•è·
        document
          .getElementById("requestPermission")
          .addEventListener("click", async () => {
            try {
              await requestNotificationPermission();
            } catch (error) {
              updateStatus("è¯·æ±‚æƒé™æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Request permission error:", error);
            }
          });

        document
          .getElementById("subscribe")
          .addEventListener("click", async () => {
            try {
              await subscribeToPush();
            } catch (error) {
              updateStatus("è®¢é˜…æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Subscribe error:", error);
            }
          });

        document
          .getElementById("unsubscribe")
          .addEventListener("click", async () => {
            try {
              await unsubscribeFromPush();
            } catch (error) {
              updateStatus("å–æ¶ˆè®¢é˜…æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Unsubscribe error:", error);
            }
          });

        document
          .getElementById("sendTestPush")
          .addEventListener("click", async () => {
            try {
              await sendTestPush();
            } catch (error) {
              updateStatus("å‘é€æµ‹è¯•æ¨é€æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Send test push error:", error);
            }
          });

        document
          .getElementById("sendCustomPush")
          .addEventListener("click", async () => {
            try {
              await sendCustomPush();
            } catch (error) {
              updateStatus(
                "å‘é€è‡ªå®šä¹‰æ¨é€æ—¶å‘ç”Ÿé”™è¯¯: " + error.message,
                "error"
              );
              console.error("Send custom push error:", error);
            }
          });

        document
          .getElementById("getStats")
          .addEventListener("click", async () => {
            try {
              await getSubscriptionStats();
            } catch (error) {
              updateStatus("è·å–ç»Ÿè®¡æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Get stats error:", error);
            }
          });

        document
          .getElementById("cleanupSubscriptions")
          .addEventListener("click", async () => {
            try {
              await cleanupSubscriptions();
            } catch (error) {
              updateStatus("æ¸…ç†è®¢é˜…æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Cleanup subscriptions error:", error);
            }
          });

        document
          .getElementById("checkNetwork")
          .addEventListener("click", async () => {
            try {
              await checkNetworkStatus();
            } catch (error) {
              updateStatus("æ£€æŸ¥ç½‘ç»œçŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯: " + error.message, "error");
              console.error("Check network status error:", error);
            }
          });
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
      window.onload = function () {
        checkNotificationSupport();
        checkSystemInfo();
        setupEventListeners();
        updateStatus("Mozillaæ¨é€æœåŠ¡ç‰ˆæœ¬å·²åŠ è½½", "info");
      };

      // å…¨å±€é”™è¯¯å¤„ç†
      window.addEventListener("error", function (event) {
        console.error("å…¨å±€é”™è¯¯:", event.error);
        updateStatus("å‘ç”Ÿé”™è¯¯: " + event.error.message, "error");
      });

      // æœªå¤„ç†çš„Promiseæ‹’ç»
      window.addEventListener("unhandledrejection", function (event) {
        console.error("æœªå¤„ç†çš„Promiseæ‹’ç»:", event.reason);
        updateStatus("Promiseé”™è¯¯: " + event.reason, "error");
        event.preventDefault(); // é˜²æ­¢é»˜è®¤çš„é”™è¯¯å¤„ç†
      });
    </script>
  </body>
</html>
