# è·¨åŸŸé¡µé¢é€šä¿¡ï¼šç›‘å¬å…³é—­ï¼ˆä¸åŒæº/opener=nullï¼‰

## ğŸ¯ å¤æ‚åœºæ™¯

### é—®é¢˜å‡çº§

```javascript
// åœºæ™¯1ï¼šä¸åŒæº
const scenario1 = {
  pageA: 'https://a.com/page.html',
  pageB: 'https://b.com/page.html',  // ä¸åŒåŸŸå
  
  limitations: [
    'âŒ BroadcastChannel ä¸èƒ½ç”¨ï¼ˆåªèƒ½åŒæºï¼‰',
    'âŒ localStorage ä¸èƒ½ç”¨ï¼ˆåªèƒ½åŒæºï¼‰',
    'âŒ SharedWorker ä¸èƒ½ç”¨ï¼ˆåªèƒ½åŒæºï¼‰',
    'âš ï¸ window.opener å­˜åœ¨ä½†æ— æ³•è°ƒç”¨æ–¹æ³•ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰'
  ]
};

// åœºæ™¯2ï¼šopener = null
const scenario2 = {
  code: `
    // é¡µé¢A æ‰“å¼€é¡µé¢B
    const winB = window.open('pageB.html', '_blank');
    winB.opener = null;  // å®‰å…¨æªæ–½ï¼Œåˆ‡æ–­å¼•ç”¨
  `,
  
  limitations: [
    'âŒ é¡µé¢B çš„ window.opener ä¸º null',
    'âŒ æ— æ³•é€šè¿‡ opener é€šä¿¡'
  ]
};
```

---

## ğŸ“Š è·¨åŸŸ/æ—  opener çš„è§£å†³æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¸åŒæº | opener=null | å´©æºƒæ£€æµ‹ | å®æ—¶æ€§ | éš¾åº¦ | æ¨èåº¦ |
|------|-------|------------|---------|--------|------|--------|
| **æœåŠ¡å™¨ä¸­è½¬** | âœ… | âœ… | âœ… | â­â­â­â­ | ä¸­ç­‰ | â­â­â­â­â­ |
| **postMessage + è½®è¯¢** | âœ… | âš ï¸ | âœ… | â­â­â­ | ç®€å• | â­â­â­â­ |
| **URL å‚æ•° + è½®è¯¢** | âœ… | âœ… | âœ… | â­â­ | ç®€å• | â­â­â­ |
| **Service Worker** | âœ… | âœ… | âœ… | â­â­â­â­ | å¤æ‚ | â­â­â­ |

---

## 1ï¸âƒ£ æ–¹æ¡ˆ1ï¼šæœåŠ¡å™¨ä¸­è½¬ï¼ˆæœ€å¯é ï¼‰

### åŸç†

é€šè¿‡æœåŠ¡å™¨ä½œä¸ºä¸­è½¬ç«™ï¼Œä¸¤ä¸ªé¡µé¢éƒ½ä¸æœåŠ¡å™¨é€šä¿¡ã€‚

### å®Œæ•´å®ç°

```javascript
// ============================================
// æœåŠ¡å™¨ç«¯ï¼ˆNode.js + WebSocketï¼‰
// ============================================
const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 3000 });

// å­˜å‚¨æ‰€æœ‰è¿æ¥
const connections = new Map();  // pageId -> { ws, parentId }

wss.on('connection', (ws, req) => {
  let currentPageId = null;
  
  ws.on('message', (data) => {
    const message = JSON.parse(data);
    
    switch (message.type) {
      case 'REGISTER':
        // æ³¨å†Œé¡µé¢
        currentPageId = message.pageId;
        connections.set(currentPageId, {
          ws,
          parentId: message.parentId,
          role: message.role,  // 'parent' or 'child'
          timestamp: Date.now()
        });
        
        console.log('é¡µé¢æ³¨å†Œ:', currentPageId, message.role);
        break;
        
      case 'HEARTBEAT':
        // æ›´æ–°å¿ƒè·³
        const conn = connections.get(currentPageId);
        if (conn) {
          conn.timestamp = Date.now();
        }
        break;
        
      case 'CHILD_OPENED':
        // é€šçŸ¥çˆ¶é¡µé¢ï¼šå­é¡µé¢å·²æ‰“å¼€
        const parent = connections.get(message.parentId);
        if (parent && parent.ws.readyState === WebSocket.OPEN) {
          parent.ws.send(JSON.stringify({
            type: 'CHILD_OPENED',
            childId: message.childId
          }));
        }
        break;
    }
  });
  
  ws.on('close', () => {
    if (currentPageId) {
      console.log('é¡µé¢æ–­å¼€:', currentPageId);
      
      const conn = connections.get(currentPageId);
      
      // å¦‚æœæ˜¯å­é¡µé¢ï¼Œé€šçŸ¥çˆ¶é¡µé¢
      if (conn && conn.parentId) {
        const parent = connections.get(conn.parentId);
        if (parent && parent.ws.readyState === WebSocket.OPEN) {
          parent.ws.send(JSON.stringify({
            type: 'CHILD_CLOSED',
            childId: currentPageId,
            reason: 'è¿æ¥å…³é—­'
          }));
        }
      }
      
      connections.delete(currentPageId);
    }
  });
});

// å®šæœŸæ£€æŸ¥å¿ƒè·³è¶…æ—¶
setInterval(() => {
  const now = Date.now();
  
  connections.forEach((conn, pageId) => {
    if (now - conn.timestamp > 5000) {  // 5ç§’æ— å¿ƒè·³
      console.log('å¿ƒè·³è¶…æ—¶ï¼Œç§»é™¤:', pageId);
      
      // é€šçŸ¥çˆ¶é¡µé¢ï¼ˆå¦‚æœæœ‰ï¼‰
      if (conn.parentId) {
        const parent = connections.get(conn.parentId);
        if (parent && parent.ws.readyState === WebSocket.OPEN) {
          parent.ws.send(JSON.stringify({
            type: 'CHILD_CLOSED',
            childId: pageId,
            reason: 'å¿ƒè·³è¶…æ—¶ï¼ˆå¯èƒ½å´©æºƒï¼‰'
          }));
        }
      }
      
      conn.ws.terminate();
      connections.delete(pageId);
    }
  });
}, 2000);

console.log('WebSocket æœåŠ¡å™¨è¿è¡Œåœ¨ ws://localhost:3000');
```

```html
<!-- ============================================ -->
<!-- é¡µé¢Aï¼ˆçˆ¶é¡µé¢ï¼Œä»»æ„åŸŸåï¼‰-->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢A</title>
</head>
<body>
  <h1>é¡µé¢Aï¼ˆhttps://a.comï¼‰</h1>
  <button id="openB">æ‰“å¼€é¡µé¢Bï¼ˆè·¨åŸŸï¼‰</button>
  <div id="status"></div>
  <div id="log"></div>
  
  <script>
    const pageId = 'parent-' + Date.now();
    let ws = null;
    
    // è¿æ¥ WebSocket
    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:3000');
      
      ws.onopen = () => {
        console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
        
        // æ³¨å†Œä¸ºçˆ¶é¡µé¢
        ws.send(JSON.stringify({
          type: 'REGISTER',
          pageId: pageId,
          role: 'parent'
        }));
        
        // å‘é€å¿ƒè·³
        setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'HEARTBEAT',
              pageId: pageId
            }));
          }
        }, 2000);
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'CHILD_OPENED') {
          log('âœ… é¡µé¢Bå·²æ‰“å¼€: ' + data.childId);
        } else if (data.type === 'CHILD_CLOSED') {
          log('âŒ é¡µé¢Bå·²å…³é—­: ' + data.reason);
          alert('æ£€æµ‹åˆ°é¡µé¢Bå…³é—­ï¼š' + data.reason);
        }
      };
    }
    
    connectWebSocket();
    
    // æ‰“å¼€é¡µé¢Bï¼ˆå¯ä»¥æ˜¯è·¨åŸŸï¼‰
    document.getElementById('openB').addEventListener('click', () => {
      // æ‰“å¼€é¡µé¢Bï¼Œå¹¶ä¼ é€’ parentId
      window.open('https://b.com/pageB.html?parentId=' + pageId, '_blank');
    });
    
    function log(message) {
      const p = document.createElement('p');
      p.textContent = new Date().toLocaleTimeString() + ' - ' + message;
      document.getElementById('log').prepend(p);
    }
  </script>
</body>
</html>

<!-- ============================================ -->
<!-- é¡µé¢Bï¼ˆå­é¡µé¢ï¼Œä¸åŒåŸŸåï¼‰-->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢B</title>
</head>
<body>
  <h1>é¡µé¢Bï¼ˆhttps://b.comï¼‰</h1>
  <button id="close">æ­£å¸¸å…³é—­</button>
  <button id="crash">æ¨¡æ‹Ÿå´©æºƒ</button>
  
  <script>
    const pageId = 'child-' + Date.now();
    const urlParams = new URLSearchParams(window.location.search);
    const parentId = urlParams.get('parentId');
    
    let ws = null;
    
    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:3000');
      
      ws.onopen = () => {
        console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
        
        // æ³¨å†Œä¸ºå­é¡µé¢
        ws.send(JSON.stringify({
          type: 'REGISTER',
          pageId: pageId,
          parentId: parentId,
          role: 'child'
        }));
        
        // é€šçŸ¥çˆ¶é¡µé¢ï¼šæˆ‘å·²æ‰“å¼€
        ws.send(JSON.stringify({
          type: 'CHILD_OPENED',
          childId: pageId,
          parentId: parentId
        }));
        
        // å‘é€å¿ƒè·³
        setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'HEARTBEAT',
              pageId: pageId
            }));
          }
        }, 2000);
      };
    }
    
    connectWebSocket();
    
    // æ­£å¸¸å…³é—­
    document.getElementById('close').addEventListener('click', () => {
      // WebSocket æ–­å¼€ä¼šè‡ªåŠ¨é€šçŸ¥æœåŠ¡å™¨
      // æœåŠ¡å™¨ä¼šé€šçŸ¥çˆ¶é¡µé¢
      window.close();
    });
    
    // æ¨¡æ‹Ÿå´©æºƒ
    document.getElementById('crash').addEventListener('click', () => {
      // å¿ƒè·³åœæ­¢ â†’ æœåŠ¡å™¨æ£€æµ‹è¶…æ—¶ â†’ é€šçŸ¥çˆ¶é¡µé¢
      while(true) {}  // å¡æ­»
    });
  </script>
</body>
</html>
```

### ä¼˜åŠ¿

```javascript
const serverSolution = {
  advantages: [
    'âœ… æ”¯æŒè·¨åŸŸï¼ˆä»»æ„åŸŸåï¼‰',
    'âœ… ä¸ä¾èµ– window.opener',
    'âœ… å¯ä»¥æ£€æµ‹å´©æºƒï¼ˆå¿ƒè·³ï¼‰',
    'âœ… å®æ—¶æ€§å¥½ï¼ˆWebSocketï¼‰',
    'âœ… å¯æ‰©å±•ï¼ˆå¤šé¡µé¢ç®¡ç†ï¼‰'
  ],
  
  disadvantages: [
    'âŒ éœ€è¦æœåŠ¡å™¨æ”¯æŒ',
    'âŒ å®ç°è¾ƒå¤æ‚',
    'âš ï¸ éœ€è¦ç»´æŠ¤ WebSocket è¿æ¥'
  ]
};
```

---

## 2ï¸âƒ£ æ–¹æ¡ˆ2ï¼špostMessage + è½®è¯¢ï¼ˆwindow å¼•ç”¨ä»å­˜åœ¨ï¼‰

### åœºæ™¯

```javascript
// é¡µé¢A æ‰“å¼€é¡µé¢Bï¼Œä½†è®¾ç½®äº† opener = null
const winB = window.open('https://b.com/page.html', '_blank');
winB.opener = null;  // åˆ‡æ–­ opener å¼•ç”¨

// ä½†é¡µé¢A ä»ç„¶æŒæœ‰ winB çš„å¼•ç”¨ï¼
// å¯ä»¥é€šè¿‡ postMessage é€šä¿¡
```

### å®ç°

```html
<!-- ============================================ -->
<!-- é¡µé¢Aï¼ˆhttps://a.comï¼‰-->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢A</title>
</head>
<body>
  <h1>é¡µé¢A</h1>
  <button id="openB">æ‰“å¼€é¡µé¢Bï¼ˆè·¨åŸŸ + opener=nullï¼‰</button>
  <div id="log"></div>
  
  <script>
    let pageB = null;
    
    document.getElementById('openB').addEventListener('click', () => {
      // æ‰“å¼€è·¨åŸŸé¡µé¢
      pageB = window.open('https://b.com/pageB.html', '_blank');
      
      // åˆ‡æ–­ opener å¼•ç”¨ï¼ˆå®‰å…¨æªæ–½ï¼‰
      if (pageB) {
        pageB.opener = null;
        log('âœ… é¡µé¢Bå·²æ‰“å¼€ï¼ˆè·¨åŸŸï¼Œopener=nullï¼‰');
      }
      
      // ä½†é¡µé¢A ä»æŒæœ‰ pageB å¼•ç”¨
      // å¯ä»¥ç”¨ postMessage é€šä¿¡ï¼
      
      // å¼€å§‹è½®è¯¢æ£€æµ‹æ˜¯å¦å…³é—­
      startPolling(pageB);
    });
    
    // ç›‘å¬æ¥è‡ªé¡µé¢Bçš„æ¶ˆæ¯
    window.addEventListener('message', (event) => {
      // éªŒè¯æ¥æºï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
      if (event.origin !== 'https://b.com') {
        return;
      }
      
      const { type, reason } = event.data;
      
      if (type === 'PAGE_CLOSING') {
        log('ğŸ“© æ”¶åˆ°é¡µé¢Bçš„å…³é—­é€šçŸ¥ï¼š' + reason);
      } else if (type === 'HEARTBEAT') {
        log('ğŸ’“ æ”¶åˆ°å¿ƒè·³');
      }
    });
    
    // è½®è¯¢æ£€æµ‹é¡µé¢Bæ˜¯å¦å…³é—­
    function startPolling(win) {
      const pollInterval = setInterval(() => {
        if (win.closed) {
          log('ğŸ” æ£€æµ‹åˆ°é¡µé¢Bå·²å…³é—­ï¼ˆè½®è¯¢ï¼‰');
          clearInterval(pollInterval);
          
          // å¤„ç†é¡µé¢å…³é—­
          handlePageBClosed('è½®è¯¢æ£€æµ‹');
        } else {
          // å°è¯•å‘é€ pingï¼ˆå¯é€‰ï¼‰
          try {
            win.postMessage({ type: 'PING' }, 'https://b.com');
          } catch (e) {
            // è·¨åŸŸå¯èƒ½å¤±è´¥ï¼Œå¿½ç•¥
          }
        }
      }, 1000);  // æ¯ç§’æ£€æŸ¥
    }
    
    function handlePageBClosed(reason) {
      console.log('é¡µé¢Bå…³é—­å¤„ç†:', reason);
      pageB = null;
    }
    
    function log(message) {
      const p = document.createElement('p');
      p.textContent = new Date().toLocaleTimeString() + ' - ' + message;
      document.getElementById('log').prepend(p);
    }
  </script>
</body>
</html>

<!-- ============================================ -->
<!-- é¡µé¢Bï¼ˆhttps://b.comï¼‰-->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢B</title>
</head>
<body>
  <h1>é¡µé¢B</h1>
  <button id="close">æ­£å¸¸å…³é—­</button>
  <button id="crash">æ¨¡æ‹Ÿå´©æºƒ</button>
  
  <script>
    console.log('window.opener:', window.opener);  // nullï¼ˆè¢«åˆ‡æ–­äº†ï¼‰
    
    // è™½ç„¶ opener ä¸º nullï¼Œä½†å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è·å–çˆ¶é¡µé¢å¼•ç”¨
    let parentWindow = null;
    
    // æ–¹æ³•1ï¼šé€šè¿‡ window.open çš„è¿”å›å€¼ï¼ˆå¦‚æœçˆ¶é¡µé¢ä¼ é€’ï¼‰
    // æ–¹æ³•2ï¼šç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://a.com') {
        return;
      }
      
      // ä¿å­˜çˆ¶é¡µé¢çš„å¼•ç”¨
      parentWindow = event.source;
      
      if (event.data.type === 'PING') {
        // å›å¤ pongï¼ˆè¯æ˜è¿˜æ´»ç€ï¼‰
        parentWindow.postMessage({ type: 'HEARTBEAT' }, 'https://a.com');
      }
    });
    
    // æ­£å¸¸å…³é—­æ—¶é€šçŸ¥ï¼ˆå¦‚æœæœ‰çˆ¶é¡µé¢å¼•ç”¨ï¼‰
    window.addEventListener('beforeunload', () => {
      if (parentWindow) {
        parentWindow.postMessage({
          type: 'PAGE_CLOSING',
          reason: 'æ­£å¸¸å…³é—­'
        }, 'https://a.com');
      }
    });
    
    document.getElementById('close').addEventListener('click', () => {
      window.close();
    });
    
    document.getElementById('crash').addEventListener('click', () => {
      while(true) {}  // å´©æºƒ
    });
  </script>
</body>
</html>
```

### å…³é”®ç‚¹

```javascript
const postMessageSolution = {
  // å³ä½¿ opener = null
  fact: 'é¡µé¢A ä»æŒæœ‰ window.open() è¿”å›çš„å¼•ç”¨',
  
  communication: {
    aToB: 'pageB.postMessage(msg, origin)',  // âœ… å¯ä»¥
    bToA: 'event.source.postMessage(msg, origin)',  // âœ… å¯ä»¥ï¼ˆé€šè¿‡ event.sourceï¼‰
  },
  
  detection: {
    normal: 'beforeunload + postMessage',
    crash: 'è½®è¯¢ window.closed å±æ€§'
  },
  
  limitation: 'éœ€è¦é¡µé¢A ä¿æŒå¯¹ pageB çš„å¼•ç”¨'
};
```

---

## 3ï¸âƒ£ æ–¹æ¡ˆ3ï¼šURL å‚æ•° + æœåŠ¡å™¨è½®è¯¢

### åŸç†

é¡µé¢Bå®šæœŸå‘æœåŠ¡å™¨æŠ¥å‘Š"æˆ‘è¿˜æ´»ç€"ï¼Œé¡µé¢Aè½®è¯¢æœåŠ¡å™¨è¯¢é—®é¡µé¢Bçš„çŠ¶æ€ã€‚

### å®ç°

```javascript
// ============================================
// æœåŠ¡å™¨ç«¯ï¼ˆç®€å•çš„ HTTP APIï¼‰
// ============================================
const express = require('express');
const app = express();

// å­˜å‚¨é¡µé¢çŠ¶æ€
const pageStatus = new Map();  // pageId -> { lastHeartbeat, data }

// é¡µé¢B å‘é€å¿ƒè·³
app.post('/api/heartbeat/:pageId', (req, res) => {
  const { pageId } = req.params;
  
  pageStatus.set(pageId, {
    lastHeartbeat: Date.now(),
    data: req.body
  });
  
  res.json({ success: true });
});

// é¡µé¢A æŸ¥è¯¢çŠ¶æ€
app.get('/api/status/:pageId', (req, res) => {
  const { pageId } = req.params;
  const status = pageStatus.get(pageId);
  
  if (!status) {
    return res.json({ exists: false });
  }
  
  const now = Date.now();
  const isAlive = (now - status.lastHeartbeat) < 5000;
  
  res.json({
    exists: true,
    isAlive: isAlive,
    lastHeartbeat: status.lastHeartbeat,
    data: status.data
  });
});

// å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
setInterval(() => {
  const now = Date.now();
  
  pageStatus.forEach((status, pageId) => {
    if (now - status.lastHeartbeat > 60000) {
      pageStatus.delete(pageId);
    }
  });
}, 30000);

app.listen(3001);
```

```html
<!-- ============================================ -->
<!-- é¡µé¢A -->
<!-- ============================================ -->
<script>
  let childPageId = null;
  
  function openPageB() {
    childPageId = 'page-' + Date.now();
    
    // é€šè¿‡ URL å‚æ•°ä¼ é€’ pageId
    window.open(`https://b.com/pageB.html?pageId=${childPageId}`, '_blank');
    
    // å¼€å§‹è½®è¯¢æ£€æŸ¥çŠ¶æ€
    startPollingStatus(childPageId);
  }
  
  function startPollingStatus(pageId) {
    const pollInterval = setInterval(async () => {
      try {
        const response = await fetch(`https://api.example.com/api/status/${pageId}`);
        const status = await response.json();
        
        if (!status.exists || !status.isAlive) {
          console.log('âŒ é¡µé¢Bå·²å…³é—­æˆ–å´©æºƒ');
          clearInterval(pollInterval);
          handlePageClosed();
        } else {
          console.log('âœ… é¡µé¢Bä»ç„¶æ´»è·ƒ');
        }
      } catch (error) {
        console.error('è½®è¯¢é”™è¯¯:', error);
      }
    }, 2000);  // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
  }
  
  function handlePageClosed() {
    console.log('å¤„ç†é¡µé¢å…³é—­');
    childPageId = null;
  }
</script>

<!-- ============================================ -->
<!-- é¡µé¢B -->
<!-- ============================================ -->
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const pageId = urlParams.get('pageId');
  
  // å®šæœŸå‘é€å¿ƒè·³åˆ°æœåŠ¡å™¨
  setInterval(async () => {
    try {
      await fetch(`https://api.example.com/api/heartbeat/${pageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: location.href,
          timestamp: Date.now()
        })
      });
      
      console.log('ğŸ’“ å¿ƒè·³å·²å‘é€');
    } catch (error) {
      console.error('å¿ƒè·³å‘é€å¤±è´¥:', error);
    }
  }, 2000);  // æ¯2ç§’
</script>
```

---

## 4ï¸âƒ£ æ–¹æ¡ˆ4ï¼šService Workerï¼ˆé«˜çº§ï¼‰

### åŸç†

Service Worker å¯ä»¥æ‹¦æˆªæ‰€æœ‰é¡µé¢çš„ç½‘ç»œè¯·æ±‚ï¼Œä½œä¸ºä¸­é—´å±‚é€šä¿¡ã€‚

### å®ç°æ€è·¯

```javascript
// ============================================
// service-worker.js
// ============================================
const pageConnections = new Map();

self.addEventListener('message', (event) => {
  const { type, pageId, parentId } = event.data;
  
  if (type === 'REGISTER') {
    // è®°å½•é¡µé¢
    pageConnections.set(pageId, {
      client: event.source,
      parentId: parentId,
      lastHeartbeat: Date.now()
    });
    
    // å¦‚æœæœ‰çˆ¶é¡µé¢ï¼Œé€šçŸ¥å®ƒ
    if (parentId) {
      const parent = pageConnections.get(parentId);
      if (parent) {
        parent.client.postMessage({
          type: 'CHILD_OPENED',
          childId: pageId
        });
      }
    }
  } else if (type === 'HEARTBEAT') {
    const page = pageConnections.get(pageId);
    if (page) {
      page.lastHeartbeat = Date.now();
    }
  }
});

// å®šæœŸæ£€æŸ¥å¿ƒè·³
setInterval(() => {
  const now = Date.now();
  
  pageConnections.forEach((page, pageId) => {
    if (now - page.lastHeartbeat > 5000) {
      // å¿ƒè·³è¶…æ—¶ï¼Œé€šçŸ¥çˆ¶é¡µé¢
      if (page.parentId) {
        const parent = pageConnections.get(page.parentId);
        if (parent) {
          parent.client.postMessage({
            type: 'CHILD_CLOSED',
            childId: pageId,
            reason: 'å¿ƒè·³è¶…æ—¶'
          });
        }
      }
      
      pageConnections.delete(pageId);
    }
  });
}, 2000);
```

---

## ğŸ¯ æœ€ç®€å•çš„è·¨åŸŸæ–¹æ¡ˆ

### ä½¿ç”¨ window.closed è½®è¯¢ï¼ˆæœ€ç®€å•ï¼‰

```javascript
/**
 * è™½ç„¶è·¨åŸŸæˆ– opener=nullï¼Œä½† window å¼•ç”¨ä»æœ‰æ•ˆ
 * window.closed å±æ€§å¯ä»¥è®¿é—®ï¼ˆä¸å—è·¨åŸŸé™åˆ¶ï¼‰
 */

// é¡µé¢A
function openAndMonitor() {
  const pageB = window.open('https://b.com/page.html', '_blank');
  
  // å³ä½¿è®¾ç½® opener = null
  pageB.opener = null;
  
  // ä»ç„¶å¯ä»¥æ£€æµ‹ closed å±æ€§ï¼ˆä¸å—è·¨åŸŸé™åˆ¶ï¼‰
  const checkInterval = setInterval(() => {
    if (pageB.closed) {
      console.log('âœ… æ£€æµ‹åˆ°é¡µé¢Bå·²å…³é—­');
      clearInterval(checkInterval);
      
      // å¤„ç†å…³é—­
      handlePageClosed();
    }
  }, 500);  // æ¯ 500ms æ£€æŸ¥ä¸€æ¬¡
}

/**
 * ä¼˜ç‚¹ï¼š
 * âœ… æœ€ç®€å•ï¼ˆ10 è¡Œä»£ç ï¼‰
 * âœ… è·¨åŸŸå¯ç”¨
 * âœ… opener=null ä¹Ÿå¯ç”¨
 * âœ… å¯ä»¥æ£€æµ‹å´©æºƒ
 * 
 * ç¼ºç‚¹ï¼š
 * âŒ éœ€è¦è½®è¯¢ï¼ˆæ€§èƒ½å¼€é”€ï¼‰
 * âŒ æœ‰å»¶è¿Ÿï¼ˆ500msï¼‰
 * âŒ æ— æ³•è·å–å…³é—­åŸå› 
 */
```

---

## ğŸ“Š å®Œæ•´å¯¹æ¯”ï¼šè·¨åŸŸåœºæ™¯

### å„æ–¹æ¡ˆåœ¨è·¨åŸŸæƒ…å†µä¸‹çš„è¡¨ç°

| æ–¹æ¡ˆ | è·¨åŸŸ | opener=null | å´©æºƒæ£€æµ‹ | æ— éœ€è½®è¯¢ | æ¨èåº¦ |
|------|------|------------|---------|---------|--------|
| **æœåŠ¡å™¨ä¸­è½¬ï¼ˆWebSocketï¼‰** | âœ… | âœ… | âœ… | âœ… | â­â­â­â­â­ |
| **æœåŠ¡å™¨ä¸­è½¬ï¼ˆHTTPè½®è¯¢ï¼‰** | âœ… | âœ… | âœ… | âŒ | â­â­â­â­ |
| **window.closed è½®è¯¢** | âœ… | âœ… | âœ… | âŒ | â­â­â­â­ |
| **postMessage + è½®è¯¢** | âœ… | âš ï¸ | âœ… | âŒ | â­â­â­ |
| Service Worker | âœ… | âœ… | âœ… | âœ… | â­â­â­ |

---

## ğŸ’¡ å®é™…æ¨èæ–¹æ¡ˆ

### æ ¹æ®åœºæ™¯é€‰æ‹©

```javascript
const recommendations = {
  // åœºæ™¯1ï¼šåŒæº + æœ‰ opener
  sameOrigin: {
    best: 'BroadcastChannel + å¿ƒè·³æ£€æµ‹',
    code: 'è§å‰é¢çš„æ–¹æ¡ˆ'
  },
  
  // åœºæ™¯2ï¼šè·¨åŸŸï¼Œä½†æœ‰ window å¼•ç”¨
  crossOriginWithRef: {
    simple: 'window.closed è½®è¯¢',
    advanced: 'postMessage + è½®è¯¢',
    
    code: `
      const pageB = window.open('https://b.com', '_blank');
      
      setInterval(() => {
        if (pageB.closed) {
          console.log('é¡µé¢Bå·²å…³é—­');
        }
      }, 500);
    `
  },
  
  // åœºæ™¯3ï¼šè·¨åŸŸ + opener=null + æ— å¼•ç”¨
  crossOriginNoRef: {
    only: 'æœåŠ¡å™¨ä¸­è½¬ï¼ˆWebSocket æˆ– HTTP è½®è¯¢ï¼‰',
    
    code: `
      // ä¸¤ä¸ªé¡µé¢éƒ½è¿æ¥åˆ°åŒä¸€ä¸ª WebSocket æœåŠ¡å™¨
      // é€šè¿‡æœåŠ¡å™¨ä¸­è½¬æ¶ˆæ¯
    `
  },
  
  // åœºæ™¯4ï¼šç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰
  production: {
    best: 'WebSocket æœåŠ¡å™¨ä¸­è½¬',
    reason: [
      'âœ… æ”¯æŒæ‰€æœ‰åœºæ™¯',
      'âœ… å®æ—¶æ€§å¥½',
      'âœ… å¯é æ€§é«˜',
      'âœ… å¯æ‰©å±•'
    ]
  }
};
```

---

## ğŸ”§ å®ç”¨å·¥å…·ç±»ï¼ˆè·¨åŸŸç‰ˆæœ¬ï¼‰

### é€šç”¨çš„é¡µé¢ç›‘æ§å™¨

```javascript
/**
 * è·¨åŸŸé¡µé¢ç›‘æ§å™¨
 * æ”¯æŒï¼šè·¨åŸŸã€opener=nullã€å´©æºƒæ£€æµ‹
 */
class CrossOriginPageMonitor {
  constructor(wsUrl) {
    this.wsUrl = wsUrl || 'ws://localhost:3000';
    this.pageId = 'page-' + Date.now();
    this.childPages = new Map();
    this.ws = null;
    
    this.connect();
  }
  
  connect() {
    this.ws = new WebSocket(this.wsUrl);
    
    this.ws.onopen = () => {
      console.log('âœ… è¿æ¥æœåŠ¡å™¨æˆåŠŸ');
      
      this.ws.send(JSON.stringify({
        type: 'REGISTER',
        pageId: this.pageId,
        role: 'monitor'
      }));
      
      this.startHeartbeat();
    };
    
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      this.handleServerMessage(data);
    };
    
    this.ws.onerror = (error) => {
      console.error('âŒ WebSocket é”™è¯¯:', error);
    };
    
    this.ws.onclose = () => {
      console.log('ğŸ”Œ è¿æ¥å…³é—­ï¼Œ5ç§’åé‡è¿');
      setTimeout(() => this.connect(), 5000);
    };
  }
  
  startHeartbeat() {
    setInterval(() => {
      if (this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({
          type: 'HEARTBEAT',
          pageId: this.pageId
        }));
      }
    }, 2000);
  }
  
  handleServerMessage(data) {
    if (data.type === 'CHILD_OPENED') {
      console.log('ğŸ“„ å­é¡µé¢æ‰“å¼€:', data.childId);
      this.onChildOpened?.(data.childId);
    } else if (data.type === 'CHILD_CLOSED') {
      console.log('âŒ å­é¡µé¢å…³é—­:', data.childId, data.reason);
      this.onChildClosed?.(data.childId, data.reason);
    }
  }
  
  openPage(url) {
    const childId = 'child-' + Date.now();
    
    // åœ¨ URL ä¸­ä¼ é€’å¿…è¦ä¿¡æ¯
    const urlWithParams = `${url}?parentId=${this.pageId}&childId=${childId}&wsUrl=${encodeURIComponent(this.wsUrl)}`;
    
    const win = window.open(urlWithParams, '_blank');
    
    // å¯é€‰ï¼šè½®è¯¢æ£€æµ‹ï¼ˆåŒé‡ä¿éšœï¼‰
    if (win) {
      this.pollWindow(win, childId);
    }
    
    return childId;
  }
  
  pollWindow(win, childId) {
    const pollInterval = setInterval(() => {
      if (win.closed) {
        console.log('ğŸ” è½®è¯¢æ£€æµ‹åˆ°å…³é—­:', childId);
        clearInterval(pollInterval);
        this.onChildClosed?.(childId, 'è½®è¯¢æ£€æµ‹');
      }
    }, 1000);
  }
}

// ============================================
// ä½¿ç”¨
// ============================================

// é¡µé¢A
const monitor = new CrossOriginPageMonitor('ws://localhost:3000');

monitor.onChildOpened = (childId) => {
  console.log('ä¸šåŠ¡å¤„ç†ï¼šå­é¡µé¢æ‰“å¼€', childId);
};

monitor.onChildClosed = (childId, reason) => {
  console.log('ä¸šåŠ¡å¤„ç†ï¼šå­é¡µé¢å…³é—­', childId, reason);
  alert('é¡µé¢å…³é—­ï¼š' + reason);
};

document.getElementById('openB').addEventListener('click', () => {
  monitor.openPage('https://b.com/pageB.html');
});

// ============================================
// é¡µé¢Bï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
// ============================================
const params = new URLSearchParams(location.search);
const parentId = params.get('parentId');
const childId = params.get('childId');
const wsUrl = params.get('wsUrl');

if (parentId && childId) {
  const ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    // æ³¨å†Œ
    ws.send(JSON.stringify({
      type: 'REGISTER',
      pageId: childId,
      parentId: parentId,
      role: 'child'
    }));
    
    // é€šçŸ¥æ‰“å¼€
    ws.send(JSON.stringify({
      type: 'CHILD_OPENED',
      childId: childId,
      parentId: parentId
    }));
    
    // å‘é€å¿ƒè·³
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'HEARTBEAT',
          pageId: childId
        }));
      }
    }, 2000);
  };
}
```

---

## ğŸ“‹ æ€»ç»“

### è·¨åŸŸ + opener=null çš„è§£å†³æ–¹æ¡ˆ

1. **æœ€ç®€å•**ï¼š`window.closed` è½®è¯¢
   ```javascript
   const win = window.open('https://b.com', '_blank');
   win.opener = null;
   
   setInterval(() => {
     if (win.closed) {
       console.log('å…³é—­äº†');
     }
   }, 500);
   ```

2. **æœ€å¯é **ï¼šæœåŠ¡å™¨ä¸­è½¬ï¼ˆWebSocketï¼‰
   ```
   é¡µé¢A â†â†’ WebSocket æœåŠ¡å™¨ â†â†’ é¡µé¢B
   
   é¡µé¢B å´©æºƒ â†’ å¿ƒè·³åœæ­¢ â†’ æœåŠ¡å™¨æ£€æµ‹ â†’ é€šçŸ¥é¡µé¢A
   ```

3. **æœ€å®ç”¨**ï¼šHTTP è½®è¯¢
   ```
   é¡µé¢B å®šæœŸå‘æœåŠ¡å™¨æŠ¥å‘Š
   é¡µé¢A å®šæœŸæŸ¥è¯¢æœåŠ¡å™¨
   ```

### æœ€ç»ˆå»ºè®®

```javascript
const finalRecommendation = {
  // ç®€å•é¡¹ç›®
  simple: {
    method: 'window.closed è½®è¯¢',
    lines: '~20 è¡Œä»£ç ',
    features: 'æ£€æµ‹å…³é—­å’Œå´©æºƒ'
  },
  
  // ä¸­å‹é¡¹ç›®
  medium: {
    method: 'HTTP è½®è¯¢ + æœåŠ¡å™¨ API',
    lines: '~100 è¡Œä»£ç ',
    features: 'è·¨åŸŸã€å¯é ã€æ˜“å®ç°'
  },
  
  // å¤§å‹é¡¹ç›®
  large: {
    method: 'WebSocket æœåŠ¡å™¨ä¸­è½¬',
    lines: '~200 è¡Œä»£ç ',
    features: 'å®æ—¶ã€å¯é ã€å¯æ‰©å±•'
  }
};
```

### æ ¸å¿ƒè¦ç‚¹

1. **è·¨åŸŸé™åˆ¶**
   - BroadcastChannel âŒ
   - localStorage âŒ
   - window.opener.xxx() âŒ
   - window.closed âœ… **å”¯ä¸€å¯ç”¨çš„å±æ€§**

2. **opener=null é™åˆ¶**
   - window.opener âŒ
   - ä½† window.open() è¿”å›çš„å¼•ç”¨ä»æœ‰æ•ˆ âœ…
   - window.closed å¯ç”¨ âœ…
   - postMessage å¯ç”¨ âœ…

3. **å´©æºƒæ£€æµ‹å¿…é¡»**
   - å¿ƒè·³æœºåˆ¶ï¼ˆæœåŠ¡å™¨æˆ–è½®è¯¢ï¼‰

æ–‡æ¡£ä½ç½®ï¼š`è·¨åŸŸé¡µé¢é€šä¿¡-ç›‘å¬å…³é—­.md`

åŒ…å«ï¼š4ç§è·¨åŸŸæ–¹æ¡ˆã€å®Œæ•´ä»£ç ã€æœåŠ¡å™¨å®ç°ã€æœ€ä½³å®è·µï¼ğŸ‰
