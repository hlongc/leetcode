# æµè§ˆå™¨æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

## ğŸ“Š å¿«é€Ÿå¯¹æ¯”è¡¨

| ç‰¹æ€§             | Cookie            | LocalStorage   | SessionStorage   | IndexedDB      | Cache API                    |
| ---------------- | ----------------- | -------------- | ---------------- | -------------- | ---------------------------- |
| **å­˜å‚¨å¤§å°**     | 4KB               | 5-10MB         | 5-10MB           | 250MB+         | å–å†³äºç£ç›˜ç©ºé—´               |
| **ç”Ÿå‘½å‘¨æœŸ**     | å¯è®¾ç½®è¿‡æœŸæ—¶é—´    | æ°¸ä¹…           | æ ‡ç­¾é¡µå…³é—­       | æ°¸ä¹…           | æ°¸ä¹…                         |
| **ä½œç”¨åŸŸ**       | åŒæº+è·¯å¾„+åŸŸ      | åŒæº           | åŒæº+åŒæ ‡ç­¾é¡µ    | åŒæº           | åŒæº                         |
| **å¯ç”¨ä¸Šä¸‹æ–‡**   | æ‰€æœ‰ä¸Šä¸‹æ–‡        | Window         | Window           | Window/Worker  | Window/Worker/Service Worker |
| **ä¸æœåŠ¡å™¨é€šä¿¡** | è‡ªåŠ¨æºå¸¦          | å¦             | å¦               | å¦             | å¦                           |
| **API**          | `document.cookie` | `localStorage` | `sessionStorage` | å¼‚æ­¥ API       | `caches` API                 |
| **æ•°æ®ç±»å‹**     | å­—ç¬¦ä¸²            | å­—ç¬¦ä¸²         | å­—ç¬¦ä¸²           | ä»»æ„ç±»å‹       | Responseï¼ˆå¯åŒ…è£…ä»»æ„æ•°æ®ï¼‰   |
| **æ€§èƒ½**         | æ¯æ¬¡è¯·æ±‚éƒ½å‘é€    | åŒæ­¥ API       | åŒæ­¥ API         | å¼‚æ­¥ï¼Œé«˜æ€§èƒ½   | å¼‚æ­¥ï¼Œé«˜æ€§èƒ½                 |
| **é€‚ç”¨åœºæ™¯**     | èº«ä»½è®¤è¯ã€è·Ÿè¸ª    | ç”¨æˆ·åå¥½è®¾ç½®   | è¡¨å•è‰ç¨¿         | å¤§é‡ç»“æ„åŒ–æ•°æ® | ç¦»çº¿ç¼“å­˜ã€API ç¼“å­˜           |

---

## 1. Cookie ğŸª

### åŸºæœ¬ç‰¹æ€§

- **å¤§å°é™åˆ¶**ï¼šæ¯ä¸ª Cookie 4KBï¼Œæ¯ä¸ªåŸŸåçº¦ 50 ä¸ª
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šå¯è®¾ç½® `expires` æˆ– `max-age`
- **è‡ªåŠ¨å‘é€**ï¼šæ¯æ¬¡ HTTP è¯·æ±‚éƒ½ä¼šæºå¸¦ï¼ˆå½±å“æ€§èƒ½ï¼‰

### ä½¿ç”¨ç¤ºä¾‹

```javascript
// è®¾ç½® Cookie
document.cookie =
  "username=John; expires=Fri, 31 Dec 2024 23:59:59 GMT; path=/";
document.cookie = "theme=dark; max-age=2592000"; // 30å¤©åè¿‡æœŸ

// è¯»å– Cookie
const cookies = document.cookie;
console.log(cookies); // "username=John; theme=dark"

// Cookie å·¥å…·å‡½æ•°
const CookieUtil = {
  // è®¾ç½® Cookie
  set(name, value, options = {}) {
    let cookieString = `${encodeURIComponent(name)}=${encodeURIComponent(
      value
    )}`;

    if (options.expires) {
      cookieString += `; expires=${options.expires.toUTCString()}`;
    }

    if (options.maxAge) {
      cookieString += `; max-age=${options.maxAge}`;
    }

    if (options.path) {
      cookieString += `; path=${options.path}`;
    }

    if (options.domain) {
      cookieString += `; domain=${options.domain}`;
    }

    if (options.secure) {
      cookieString += "; secure";
    }

    if (options.httpOnly) {
      // æ³¨æ„ï¼šhttpOnly åªèƒ½åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®
      console.warn("httpOnly can only be set server-side");
    }

    if (options.sameSite) {
      cookieString += `; SameSite=${options.sameSite}`;
    }

    document.cookie = cookieString;
  },

  // è·å– Cookie
  get(name) {
    const cookies = document.cookie.split("; ");
    for (const cookie of cookies) {
      const [key, value] = cookie.split("=");
      if (decodeURIComponent(key) === name) {
        return decodeURIComponent(value);
      }
    }
    return null;
  },

  // åˆ é™¤ Cookie
  remove(name, options = {}) {
    this.set(name, "", {
      ...options,
      maxAge: -1,
    });
  },
};

// ä½¿ç”¨ç¤ºä¾‹
CookieUtil.set("token", "abc123", {
  maxAge: 7 * 24 * 60 * 60, // 7å¤©
  path: "/",
  secure: true,
  sameSite: "Strict",
});

const token = CookieUtil.get("token");
console.log(token); // "abc123"

CookieUtil.remove("token");
```

### Cookie å±æ€§è¯¦è§£

```javascript
/**
 * Cookie å±æ€§è¯´æ˜
 */
const cookieAttributes = {
  // è¿‡æœŸæ—¶é—´ï¼ˆGMTæ ¼å¼ï¼‰
  expires: new Date("2024-12-31"),

  // å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰- ä¼˜å…ˆçº§é«˜äº expires
  maxAge: 3600, // 1å°æ—¶

  // è·¯å¾„ - æŒ‡å®šå“ªäº›è·¯å¾„å¯ä»¥è®¿é—®
  path: "/", // æ‰€æœ‰è·¯å¾„éƒ½å¯è®¿é—®

  // åŸŸå - å­åŸŸåå…±äº«
  domain: ".example.com", // æ‰€æœ‰å­åŸŸåéƒ½å¯è®¿é—®

  // åªåœ¨ HTTPS ä¼ è¾“
  secure: true,

  // ä¸èƒ½è¢« JavaScript è®¿é—®ï¼ˆé˜²æ­¢ XSSï¼‰
  httpOnly: true, // åªèƒ½æœåŠ¡å™¨ç«¯è®¾ç½®

  // CSRF é˜²æŠ¤
  sameSite: "Strict", // Strict | Lax | None
};

/**
 * SameSite å±æ€§è¯¦è§£ï¼š
 *
 * - Strict: å®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹ Cookieï¼Œè·¨ç«™ç‚¹æ—¶ä¸ä¼šå‘é€
 *   åœºæ™¯ï¼šä» Google æœç´¢ç‚¹å‡»é“¾æ¥åˆ°ä½ çš„ç½‘ç«™ï¼ŒCookie ä¸ä¼šå‘é€
 *
 * - Lax (é»˜è®¤): å…è®¸éƒ¨åˆ†ç¬¬ä¸‰æ–¹è¯·æ±‚æºå¸¦ Cookieï¼ˆå¯¼èˆªåˆ°ç›®æ ‡ç½‘å€çš„ GET è¯·æ±‚ï¼‰
 *   åœºæ™¯ï¼šä» Google æœç´¢ç‚¹å‡»é“¾æ¥ï¼ŒCookie ä¼šå‘é€ï¼›ä½† POST è¡¨å•ä¸ä¼š
 *
 * - None: æ— è®ºæ˜¯å¦è·¨ç«™éƒ½ä¼šå‘é€ Cookieï¼ˆå¿…é¡»åŒæ—¶è®¾ç½® Secureï¼‰
 *   åœºæ™¯ï¼šç¬¬ä¸‰æ–¹æœåŠ¡éœ€è¦ä½¿ç”¨ï¼Œå¦‚åµŒå…¥çš„æ”¯ä»˜é¡µé¢
 */
```

### âœ… ä¼˜ç‚¹

- å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´
- æœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥è¯»å†™
- æ”¯æŒè·¨å­åŸŸå…±äº«
- åŸç”Ÿæ”¯æŒï¼Œå…¼å®¹æ€§å¥½

### âŒ ç¼ºç‚¹

- å®¹é‡å¤ªå°ï¼ˆ4KBï¼‰
- æ¯æ¬¡è¯·æ±‚éƒ½æºå¸¦ï¼Œå½±å“æ€§èƒ½
- API ä¸å‹å¥½ï¼ˆå­—ç¬¦ä¸²æ“ä½œï¼‰
- å®‰å…¨é£é™©ï¼ˆXSSã€CSRFï¼‰

### ğŸ¯ é€‚ç”¨åœºæ™¯

- **èº«ä»½è®¤è¯**ï¼šå­˜å‚¨ tokenã€session ID
- **ç”¨æˆ·è·Ÿè¸ª**ï¼šå¹¿å‘Šè¿½è¸ªã€åˆ†æ
- **è·¨åŸŸé€šä¿¡**ï¼šå­åŸŸåé—´æ•°æ®å…±äº«
- **è®°ä½æˆ‘åŠŸèƒ½**ï¼šä¿æŒç™»å½•çŠ¶æ€

---

## 2. LocalStorage ğŸ’¾

### åŸºæœ¬ç‰¹æ€§

- **å¤§å°é™åˆ¶**ï¼š5-10MBï¼ˆä¸åŒæµè§ˆå™¨ç•¥æœ‰å·®å¼‚ï¼‰
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ°¸ä¹…ä¿å­˜ï¼Œé™¤éæ‰‹åŠ¨æ¸…é™¤
- **åŒæ­¥ API**ï¼šç®€å•æ˜“ç”¨ï¼Œä½†å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹

### ä½¿ç”¨ç¤ºä¾‹

```javascript
// åŸºæœ¬æ“ä½œ
localStorage.setItem("username", "John");
localStorage.setItem("theme", "dark");

const username = localStorage.getItem("username");
console.log(username); // "John"

localStorage.removeItem("theme");
localStorage.clear(); // æ¸…é™¤æ‰€æœ‰æ•°æ®

// å­˜å‚¨å¯¹è±¡ï¼ˆéœ€è¦åºåˆ—åŒ–ï¼‰
const user = {
  name: "John",
  age: 30,
  preferences: {
    theme: "dark",
    language: "zh-CN",
  },
};

localStorage.setItem("user", JSON.stringify(user));
const savedUser = JSON.parse(localStorage.getItem("user"));

// LocalStorage å°è£…å·¥å…·ç±»
class LocalStorageUtil {
  /**
   * è®¾ç½®æ•°æ®ï¼ˆè‡ªåŠ¨åºåˆ—åŒ–ï¼‰
   */
  static set(key, value, expiresIn = null) {
    const data = {
      value,
      timestamp: Date.now(),
      expiresIn, // è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    };

    try {
      localStorage.setItem(key, JSON.stringify(data));
      return true;
    } catch (error) {
      console.error("LocalStorage å†™å…¥å¤±è´¥:", error);
      // å¯èƒ½æ˜¯å®¹é‡æ»¡äº†
      if (error.name === "QuotaExceededError") {
        this.cleanup();
      }
      return false;
    }
  }

  /**
   * è·å–æ•°æ®ï¼ˆè‡ªåŠ¨ååºåˆ—åŒ– + è¿‡æœŸæ£€æŸ¥ï¼‰
   */
  static get(key) {
    try {
      const item = localStorage.getItem(key);
      if (!item) return null;

      const data = JSON.parse(item);

      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (data.expiresIn) {
        const now = Date.now();
        if (now - data.timestamp > data.expiresIn) {
          this.remove(key);
          return null;
        }
      }

      return data.value;
    } catch (error) {
      console.error("LocalStorage è¯»å–å¤±è´¥:", error);
      return null;
    }
  }

  /**
   * åˆ é™¤æ•°æ®
   */
  static remove(key) {
    localStorage.removeItem(key);
  }

  /**
   * æ¸…é™¤æ‰€æœ‰æ•°æ®
   */
  static clear() {
    localStorage.clear();
  }

  /**
   * è·å–æ‰€æœ‰é”®
   */
  static keys() {
    return Object.keys(localStorage);
  }

  /**
   * è·å–å­˜å‚¨å¤§å°ï¼ˆä¼°ç®—ï¼‰
   */
  static getSize() {
    let size = 0;
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        size += localStorage[key].length + key.length;
      }
    }
    return (size / 1024).toFixed(2) + " KB";
  }

  /**
   * æ¸…ç†è¿‡æœŸæ•°æ®
   */
  static cleanup() {
    const keys = this.keys();
    keys.forEach((key) => {
      this.get(key); // get æ–¹æ³•ä¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
LocalStorageUtil.set("token", "abc123", 24 * 60 * 60 * 1000); // 24å°æ—¶åè¿‡æœŸ
LocalStorageUtil.set("userSettings", { theme: "dark", lang: "zh" });

const token = LocalStorageUtil.get("token");
const settings = LocalStorageUtil.get("userSettings");

console.log("å­˜å‚¨å¤§å°:", LocalStorageUtil.getSize());

// ç›‘å¬ storage äº‹ä»¶ï¼ˆè·¨æ ‡ç­¾é¡µé€šä¿¡ï¼‰
window.addEventListener("storage", (e) => {
  console.log("Storage å˜åŒ–:", {
    key: e.key,
    oldValue: e.oldValue,
    newValue: e.newValue,
    url: e.url,
  });
});

// è·¨æ ‡ç­¾é¡µé€šä¿¡ç¤ºä¾‹
// æ ‡ç­¾é¡µ A
LocalStorageUtil.set("message", { from: "TabA", text: "Hello" });

// æ ‡ç­¾é¡µ Bï¼ˆä¼šæ”¶åˆ° storage äº‹ä»¶ï¼‰
window.addEventListener("storage", (e) => {
  if (e.key === "message") {
    const message = JSON.parse(e.newValue);
    console.log("æ”¶åˆ°æ¶ˆæ¯:", message);
  }
});
```

### å®¹é‡æ£€æµ‹

```javascript
/**
 * æ£€æµ‹ LocalStorage å‰©ä½™å®¹é‡
 */
function checkLocalStorageQuota() {
  const testKey = "_test_";
  let data = "0";
  let size = 0;

  try {
    // ä¸æ–­å¢å¤§æ•°æ®ï¼Œç›´åˆ°æŠ›å‡ºå¼‚å¸¸
    while (true) {
      localStorage.setItem(testKey, data);
      data += data; // æŒ‡æ•°å¢é•¿
      size = data.length;
    }
  } catch (e) {
    localStorage.removeItem(testKey);
    return size / 1024; // è¿”å› KB
  }
}

console.log("å¯ç”¨ç©ºé—´çº¦:", checkLocalStorageQuota(), "KB");
```

### âœ… ä¼˜ç‚¹

- API ç®€å•æ˜“ç”¨
- å®¹é‡è¾ƒå¤§ï¼ˆ5-10MBï¼‰
- æ°¸ä¹…ä¿å­˜
- æ”¯æŒè·¨æ ‡ç­¾é¡µé€šä¿¡ï¼ˆstorage äº‹ä»¶ï¼‰

### âŒ ç¼ºç‚¹

- åŒæ­¥ APIï¼Œå¯èƒ½é˜»å¡ä¸»çº¿ç¨‹
- åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼ˆéœ€è¦åºåˆ—åŒ–ï¼‰
- æ— æ³•è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆéœ€è¦æ‰‹åŠ¨å®ç°ï¼‰
- ä¸åŒåŸŸåå®Œå…¨éš”ç¦»

### ğŸ¯ é€‚ç”¨åœºæ™¯

- **ç”¨æˆ·åå¥½è®¾ç½®**ï¼šä¸»é¢˜ã€è¯­è¨€ã€å­—ä½“å¤§å°
- **ç¼“å­˜æ•°æ®**ï¼šä¸æ•æ„Ÿçš„ç”¨æˆ·æ•°æ®
- **ç¦»çº¿åº”ç”¨**ï¼šPWA çš„çŠ¶æ€ä¿å­˜
- **è¡¨å•æ•°æ®ä¿å­˜**ï¼šé˜²æ­¢åˆ·æ–°ä¸¢å¤±

---

## 3. SessionStorage ğŸ“‘

### åŸºæœ¬ç‰¹æ€§

- **å¤§å°é™åˆ¶**ï¼š5-10MBï¼ˆä¸ LocalStorage ç›¸åŒï¼‰
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ ‡ç­¾é¡µå…³é—­å³æ¸…é™¤
- **ä½œç”¨åŸŸ**ï¼šåŒä¸€æ ‡ç­¾é¡µå†…

### ä½¿ç”¨ç¤ºä¾‹

```javascript
// API ä¸ LocalStorage å®Œå…¨ç›¸åŒ
sessionStorage.setItem("tempData", "value");
const data = sessionStorage.getItem("tempData");
sessionStorage.removeItem("tempData");
sessionStorage.clear();

// å°è£…å·¥å…·ç±»
class SessionStorageUtil {
  static set(key, value) {
    try {
      sessionStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (error) {
      console.error("SessionStorage å†™å…¥å¤±è´¥:", error);
      return false;
    }
  }

  static get(key) {
    try {
      const item = sessionStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (error) {
      console.error("SessionStorage è¯»å–å¤±è´¥:", error);
      return null;
    }
  }

  static remove(key) {
    sessionStorage.removeItem(key);
  }

  static clear() {
    sessionStorage.clear();
  }
}

// ä½¿ç”¨åœºæ™¯ï¼šå¤šæ­¥éª¤è¡¨å•
class MultiStepForm {
  constructor() {
    this.storageKey = "formData";
  }

  // ä¿å­˜å½“å‰æ­¥éª¤çš„æ•°æ®
  saveStep(step, data) {
    const formData = SessionStorageUtil.get(this.storageKey) || {};
    formData[step] = data;
    SessionStorageUtil.set(this.storageKey, formData);
  }

  // è·å–æ‰€æœ‰æ­¥éª¤çš„æ•°æ®
  getAllData() {
    return SessionStorageUtil.get(this.storageKey) || {};
  }

  // æäº¤åæ¸…é™¤
  submit() {
    const data = this.getAllData();
    // æäº¤æ•°æ®...
    SessionStorageUtil.remove(this.storageKey);
    return data;
  }
}

// ä½¿ç”¨
const form = new MultiStepForm();
form.saveStep(1, { name: "John", email: "john@example.com" });
form.saveStep(2, { address: "123 Main St" });
const finalData = form.submit();
```

### SessionStorage vs LocalStorage

```javascript
/**
 * é€‰æ‹©å»ºè®®ï¼š
 *
 * ä½¿ç”¨ SessionStorageï¼š
 * - âœ… è¡¨å•å¡«å†™è¿›åº¦ï¼ˆåˆ·æ–°ä¸ä¸¢å¤±ï¼Œå…³é—­æ¸…é™¤ï¼‰
 * - âœ… å•é¡µåº”ç”¨çš„ä¸´æ—¶çŠ¶æ€
 * - âœ… æ•æ„Ÿçš„ä¸´æ—¶æ•°æ®ï¼ˆæ ‡ç­¾é¡µå…³é—­è‡ªåŠ¨æ¸…é™¤ï¼‰
 * - âœ… è´­ç‰©è½¦ï¼ˆä»…å½“å‰ä¼šè¯ï¼‰
 *
 * ä½¿ç”¨ LocalStorageï¼š
 * - âœ… ç”¨æˆ·åå¥½è®¾ç½®ï¼ˆé•¿æœŸä¿å­˜ï¼‰
 * - âœ… ç¦»çº¿æ•°æ®ç¼“å­˜
 * - âœ… è·¨æ ‡ç­¾é¡µé€šä¿¡
 * - âœ… è®°ä½ç”¨æˆ·è¾“å…¥ï¼ˆä¸‹æ¬¡è®¿é—®ä»ç„¶å­˜åœ¨ï¼‰
 */
```

### âœ… ä¼˜ç‚¹

- API ç®€å•ï¼ˆä¸ LocalStorage ç›¸åŒï¼‰
- è‡ªåŠ¨æ¸…ç†ï¼ˆå…³é—­æ ‡ç­¾é¡µï¼‰
- é€‚åˆä¸´æ—¶æ•°æ®

### âŒ ç¼ºç‚¹

- åŒæ­¥ API
- åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²
- ä¸èƒ½è·¨æ ‡ç­¾é¡µå…±äº«

### ğŸ¯ é€‚ç”¨åœºæ™¯

- **è¡¨å•è‰ç¨¿**ï¼šé˜²æ­¢åˆ·æ–°ä¸¢å¤±ï¼Œå…³é—­è‡ªåŠ¨æ¸…é™¤
- **ä¸´æ—¶çŠ¶æ€**ï¼šå•é¡µåº”ç”¨çš„å¯¼èˆªçŠ¶æ€
- **æ•æ„Ÿä¸´æ—¶æ•°æ®**ï¼šä¸å¸Œæœ›æŒä¹…åŒ–çš„æ•°æ®
- **å¤šæ­¥éª¤æµç¨‹**ï¼šå‘å¯¼å¼æ“ä½œçš„çŠ¶æ€ä¿å­˜

---

## 4. IndexedDB ğŸ—„ï¸

### åŸºæœ¬ç‰¹æ€§

- **å¤§å°é™åˆ¶**ï¼š250MB+ (å¯åŠ¨æ€æ‰©å±•ï¼Œå–å†³äºç£ç›˜ç©ºé—´)
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ°¸ä¹…ä¿å­˜
- **å¼‚æ­¥ API**ï¼šä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹
- **æ”¯æŒç´¢å¼•**ï¼šå¯ä»¥é«˜æ•ˆæŸ¥è¯¢
- **äº‹åŠ¡æ”¯æŒ**ï¼šACID ç‰¹æ€§

### ä½¿ç”¨ç¤ºä¾‹

```javascript
/**
 * IndexedDB åŸºç¡€ä½¿ç”¨
 */
class IndexedDBManager {
  constructor(dbName, version = 1) {
    this.dbName = dbName;
    this.version = version;
    this.db = null;
  }

  /**
   * æ‰“å¼€æ•°æ®åº“
   */
  async open(storeName, keyPath = "id") {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.version);

      // æ•°æ®åº“å‡çº§ï¼ˆåˆ›å»º object storeï¼‰
      request.onupgradeneeded = (event) => {
        const db = event.target.result;

        // åˆ›å»º object storeï¼ˆç±»ä¼¼äºè¡¨ï¼‰
        if (!db.objectStoreNames.contains(storeName)) {
          const objectStore = db.createObjectStore(storeName, {
            keyPath,
            autoIncrement: true,
          });

          // åˆ›å»ºç´¢å¼•
          objectStore.createIndex("name", "name", { unique: false });
          objectStore.createIndex("age", "age", { unique: false });
        }
      };

      request.onsuccess = (event) => {
        this.db = event.target.result;
        resolve(this.db);
      };

      request.onerror = (event) => {
        reject(event.target.error);
      };
    });
  }

  /**
   * æ·»åŠ æ•°æ®
   */
  async add(storeName, data) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readwrite");
      const objectStore = transaction.objectStore(storeName);
      const request = objectStore.add(data);

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * è·å–æ•°æ®
   */
  async get(storeName, key) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readonly");
      const objectStore = transaction.objectStore(storeName);
      const request = objectStore.get(key);

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * è·å–æ‰€æœ‰æ•°æ®
   */
  async getAll(storeName) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readonly");
      const objectStore = transaction.objectStore(storeName);
      const request = objectStore.getAll();

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * æ›´æ–°æ•°æ®
   */
  async update(storeName, data) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readwrite");
      const objectStore = transaction.objectStore(storeName);
      const request = objectStore.put(data);

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * åˆ é™¤æ•°æ®
   */
  async delete(storeName, key) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readwrite");
      const objectStore = transaction.objectStore(storeName);
      const request = objectStore.delete(key);

      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * é€šè¿‡ç´¢å¼•æŸ¥è¯¢
   */
  async getByIndex(storeName, indexName, value) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readonly");
      const objectStore = transaction.objectStore(storeName);
      const index = objectStore.index(indexName);
      const request = index.get(value);

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * æ¸¸æ ‡éå†
   */
  async cursor(storeName, callback) {
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([storeName], "readonly");
      const objectStore = transaction.objectStore(storeName);
      const request = objectStore.openCursor();

      request.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
          callback(cursor.value);
          cursor.continue();
        } else {
          resolve();
        }
      };

      request.onerror = () => reject(request.error);
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
async function exampleUsage() {
  const db = new IndexedDBManager("MyDatabase", 1);
  await db.open("users", "id");

  // æ·»åŠ æ•°æ®
  await db.add("users", { name: "John", age: 30, email: "john@example.com" });
  await db.add("users", { name: "Jane", age: 25, email: "jane@example.com" });

  // è·å–æ‰€æœ‰æ•°æ®
  const allUsers = await db.getAll("users");
  console.log("æ‰€æœ‰ç”¨æˆ·:", allUsers);

  // é€šè¿‡ç´¢å¼•æŸ¥è¯¢
  const user = await db.getByIndex("users", "name", "John");
  console.log("æŸ¥è¯¢ç»“æœ:", user);

  // æ›´æ–°æ•°æ®
  await db.update("users", { id: 1, name: "John Doe", age: 31 });

  // æ¸¸æ ‡éå†
  await db.cursor("users", (user) => {
    console.log("éå†:", user);
  });

  // åˆ é™¤æ•°æ®
  await db.delete("users", 1);
}

// å®æˆ˜ï¼šç¦»çº¿Todoåº”ç”¨
class TodoDatabase {
  constructor() {
    this.db = new IndexedDBManager("TodoApp", 1);
    this.storeName = "todos";
  }

  async init() {
    await this.db.open(this.storeName, "id");
  }

  async addTodo(todo) {
    return await this.db.add(this.storeName, {
      text: todo.text,
      completed: false,
      createdAt: new Date().toISOString(),
    });
  }

  async getTodos() {
    return await this.db.getAll(this.storeName);
  }

  async toggleTodo(id) {
    const todo = await this.db.get(this.storeName, id);
    if (todo) {
      todo.completed = !todo.completed;
      await this.db.update(this.storeName, todo);
    }
  }

  async deleteTodo(id) {
    await this.db.delete(this.storeName, id);
  }
}

// ä½¿ç”¨
const todoDb = new TodoDatabase();
await todoDb.init();
await todoDb.addTodo({ text: "å­¦ä¹  IndexedDB" });
const todos = await todoDb.getTodos();
console.log(todos);
```

### âœ… ä¼˜ç‚¹

- å®¹é‡å¤§ï¼ˆ250MB+ï¼‰
- å¼‚æ­¥ APIï¼Œä¸é˜»å¡
- æ”¯æŒå¤æ‚æ•°æ®ç»“æ„
- æ”¯æŒç´¢å¼•å’Œäº‹åŠ¡
- é«˜æ€§èƒ½

### âŒ ç¼ºç‚¹

- API å¤æ‚
- å­¦ä¹ æ›²çº¿é™¡å³­
- è°ƒè¯•å›°éš¾
- å…¼å®¹æ€§éœ€è¦è€ƒè™‘

### ğŸ¯ é€‚ç”¨åœºæ™¯

- **ç¦»çº¿åº”ç”¨**ï¼šPWA çš„æ•°æ®å­˜å‚¨
- **å¤§é‡æ•°æ®**ï¼šèŠå¤©è®°å½•ã€æ–‡ç« åˆ—è¡¨
- **å¤æ‚æŸ¥è¯¢**ï¼šéœ€è¦ç´¢å¼•çš„æ•°æ®
- **æ–‡ä»¶å­˜å‚¨**ï¼šBlobã€File å¯¹è±¡

---

## 5. Cache API ğŸš€

### åŸºæœ¬ç‰¹æ€§

- **å®¹é‡**ï¼šå–å†³äºç£ç›˜ç©ºé—´
- **å¯ç”¨ä¸Šä¸‹æ–‡**ï¼šService Workerã€Windowã€Worker çº¿ç¨‹
- **å­˜å‚¨ç±»å‹**ï¼šRequest/Response å¯¹è±¡ï¼ˆå¯ä»¥åŒ…è£…ä»»æ„æ•°æ®ï¼‰
- **ä¸»è¦ç”¨é€”**ï¼šç¦»çº¿ç¼“å­˜ã€PWA

> **é‡è¦è¯´æ˜**ï¼š
>
> 1. âœ… Cache API **ä¸æ˜¯**åªèƒ½åœ¨ Service Worker ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨æ™®é€šé¡µé¢è„šæœ¬ä¸­ä½¿ç”¨
> 2. âœ… è™½ç„¶è®¾è®¡ä¸Šå­˜å‚¨ Request/Responseï¼Œä½†å¯ä»¥é€šè¿‡åŒ…è£…å­˜å‚¨ä»»æ„æ•°æ®
> 3. âš ï¸ éœ€è¦ HTTPS ç¯å¢ƒï¼ˆlocalhost é™¤å¤–ï¼‰

### ä½¿ç”¨ç¤ºä¾‹

```javascript
/**
 * Cache API åŸºç¡€ä½¿ç”¨
 */

// æ‰“å¼€ç¼“å­˜ï¼ˆå¯ä»¥åœ¨é¡µé¢ä¸­ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦ Service Workerï¼‰
const cache = await caches.open("v1");

// æ·»åŠ å•ä¸ªèµ„æº
await cache.add("/index.html");

// æ·»åŠ å¤šä¸ªèµ„æº
await cache.addAll(["/index.html", "/styles.css", "/script.js", "/logo.png"]);

// è‡ªå®šä¹‰ç¼“å­˜
const response = await fetch("/api/data");
await cache.put("/api/data", response);

// è·å–ç¼“å­˜
const cachedResponse = await cache.match("/index.html");
if (cachedResponse) {
  console.log("ä»ç¼“å­˜è¯»å–");
}

// åˆ é™¤ç¼“å­˜
await cache.delete("/old-file.js");

// è·å–æ‰€æœ‰ç¼“å­˜çš„é”®
const keys = await cache.keys();

// åˆ é™¤æ•´ä¸ªç¼“å­˜
await caches.delete("v1");
```

### åœ¨æ™®é€šé¡µé¢ä¸­ä½¿ç”¨ï¼ˆä¸éœ€è¦ Service Workerï¼‰

```javascript
/**
 * åœ¨æ™®é€šé¡µé¢è„šæœ¬ä¸­ä½¿ç”¨ Cache API
 */

// æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
if ("caches" in window) {
  console.log("âœ… Cache API å¯ç”¨");
}

// ç¼“å­˜é™æ€èµ„æº
async function cacheResources() {
  const cache = await caches.open("my-cache-v1");

  // ç¼“å­˜æ–‡ä»¶
  await cache.addAll(["/style.css", "/app.js", "/logo.png"]);

  console.log("âœ… èµ„æºå·²ç¼“å­˜");
}

// ä»ç¼“å­˜è¯»å–
async function getCachedResource(url) {
  const cache = await caches.open("my-cache-v1");
  const response = await cache.match(url);

  if (response) {
    console.log("ä»ç¼“å­˜è¯»å–:", url);
    return response;
  } else {
    console.log("ç¼“å­˜æœªå‘½ä¸­ï¼Œä»ç½‘ç»œè·å–");
    return fetch(url);
  }
}

// ä½¿ç”¨
await cacheResources();
const response = await getCachedResource("/style.css");
const css = await response.text();
console.log(css);
```

### å­˜å‚¨å­—ç¬¦ä¸²å’Œå¯¹è±¡ï¼ˆé€šè¿‡ Response åŒ…è£…ï¼‰

```javascript
/**
 * Cache API å­˜å‚¨ä»»æ„æ•°æ®
 *
 * æ ¸å¿ƒæ€è·¯ï¼šå°†æ•°æ®åŒ…è£…æˆ Response å¯¹è±¡
 */

class CacheStorageUtil {
  constructor(cacheName = "data-cache-v1") {
    this.cacheName = cacheName;
  }

  /**
   * å­˜å‚¨å­—ç¬¦ä¸²
   */
  async setString(key, value) {
    const cache = await caches.open(this.cacheName);
    const response = new Response(value, {
      headers: { "Content-Type": "text/plain" },
    });
    await cache.put(key, response);
  }

  /**
   * è·å–å­—ç¬¦ä¸²
   */
  async getString(key) {
    const cache = await caches.open(this.cacheName);
    const response = await cache.match(key);
    if (!response) return null;
    return await response.text();
  }

  /**
   * å­˜å‚¨å¯¹è±¡ï¼ˆJSONï¼‰
   */
  async setObject(key, obj) {
    const cache = await caches.open(this.cacheName);
    const json = JSON.stringify(obj);
    const response = new Response(json, {
      headers: { "Content-Type": "application/json" },
    });
    await cache.put(key, response);
  }

  /**
   * è·å–å¯¹è±¡
   */
  async getObject(key) {
    const cache = await caches.open(this.cacheName);
    const response = await cache.match(key);
    if (!response) return null;
    const json = await response.text();
    return JSON.parse(json);
  }

  /**
   * å­˜å‚¨ Blobï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
   */
  async setBlob(key, blob, contentType = "application/octet-stream") {
    const cache = await caches.open(this.cacheName);
    const response = new Response(blob, {
      headers: { "Content-Type": contentType },
    });
    await cache.put(key, response);
  }

  /**
   * è·å– Blob
   */
  async getBlob(key) {
    const cache = await caches.open(this.cacheName);
    const response = await cache.match(key);
    if (!response) return null;
    return await response.blob();
  }

  /**
   * åˆ é™¤ç¼“å­˜é¡¹
   */
  async delete(key) {
    const cache = await caches.open(this.cacheName);
    return await cache.delete(key);
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
   */
  async clear() {
    return await caches.delete(this.cacheName);
  }

  /**
   * è·å–æ‰€æœ‰é”®
   */
  async keys() {
    const cache = await caches.open(this.cacheName);
    const requests = await cache.keys();
    return requests.map((req) => req.url);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const storage = new CacheStorageUtil("my-app-cache");

// å­˜å‚¨å­—ç¬¦ä¸²
await storage.setString("/data/message", "Hello, Cache API!");
const message = await storage.getString("/data/message");
console.log(message); // "Hello, Cache API!"

// å­˜å‚¨å¯¹è±¡
await storage.setObject("/data/user", {
  name: "John",
  age: 30,
  preferences: { theme: "dark" },
});
const user = await storage.getObject("/data/user");
console.log(user); // { name: "John", age: 30, ... }

// å­˜å‚¨å›¾ç‰‡
const imageBlob = await fetch("/avatar.png").then((r) => r.blob());
await storage.setBlob("/data/avatar", imageBlob, "image/png");
const cachedImage = await storage.getBlob("/data/avatar");
console.log(cachedImage); // Blobå¯¹è±¡

// è·å–æ‰€æœ‰é”®
const allKeys = await storage.keys();
console.log(allKeys); // ["/data/message", "/data/user", "/data/avatar"]

// åˆ é™¤å•ä¸ªç¼“å­˜
await storage.delete("/data/message");

// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
await storage.clear();
```

### å®æˆ˜ï¼šå¸¦è¿‡æœŸæ—¶é—´çš„ç¼“å­˜

```javascript
/**
 * å¸¦è¿‡æœŸæ—¶é—´çš„ Cache API å°è£…
 */
class CacheWithExpiry {
  constructor(cacheName = "cache-with-expiry") {
    this.cacheName = cacheName;
  }

  /**
   * è®¾ç½®ç¼“å­˜ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
   */
  async set(key, data, expiresInMs = 3600000) {
    // é»˜è®¤1å°æ—¶
    const cache = await caches.open(this.cacheName);

    const dataWithMeta = {
      data,
      expiresAt: Date.now() + expiresInMs,
      cachedAt: Date.now(),
    };

    const response = new Response(JSON.stringify(dataWithMeta), {
      headers: {
        "Content-Type": "application/json",
        "X-Cached-At": new Date().toISOString(),
      },
    });

    await cache.put(key, response);
  }

  /**
   * è·å–ç¼“å­˜ï¼ˆè‡ªåŠ¨æ£€æŸ¥è¿‡æœŸï¼‰
   */
  async get(key) {
    const cache = await caches.open(this.cacheName);
    const response = await cache.match(key);

    if (!response) return null;

    const json = await response.text();
    const { data, expiresAt } = JSON.parse(json);

    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() > expiresAt) {
      console.log("ç¼“å­˜å·²è¿‡æœŸï¼Œåˆ é™¤:", key);
      await this.delete(key);
      return null;
    }

    return data;
  }

  /**
   * è·å–æˆ–è®¾ç½®ï¼ˆç±»ä¼¼ getOrSet æ¨¡å¼ï¼‰
   */
  async getOrFetch(key, fetchFn, expiresInMs = 3600000) {
    // å…ˆå°è¯•ä»ç¼“å­˜è·å–
    let data = await this.get(key);

    if (data !== null) {
      console.log("âœ… ä»ç¼“å­˜è¯»å–:", key);
      return data;
    }

    // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œ fetchFn
    console.log("â¬‡ï¸ ä»ç½‘ç»œè·å–:", key);
    data = await fetchFn();

    // å­˜å…¥ç¼“å­˜
    await this.set(key, data, expiresInMs);

    return data;
  }

  async delete(key) {
    const cache = await caches.open(this.cacheName);
    return await cache.delete(key);
  }

  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   */
  async cleanExpired() {
    const cache = await caches.open(this.cacheName);
    const requests = await cache.keys();

    let cleanedCount = 0;

    for (const request of requests) {
      const response = await cache.match(request);
      if (!response) continue;

      try {
        const json = await response.text();
        const { expiresAt } = JSON.parse(json);

        if (Date.now() > expiresAt) {
          await cache.delete(request);
          cleanedCount++;
        }
      } catch (e) {
        // æ•°æ®æ ¼å¼é”™è¯¯ï¼Œåˆ é™¤
        await cache.delete(request);
        cleanedCount++;
      }
    }

    console.log(`ğŸ§¹ æ¸…ç†äº† ${cleanedCount} ä¸ªè¿‡æœŸç¼“å­˜`);
    return cleanedCount;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const cache = new CacheWithExpiry("api-cache");

// ç¼“å­˜ API æ•°æ®ï¼ˆ10åˆ†é’Ÿè¿‡æœŸï¼‰
await cache.set(
  "/api/user/123",
  { id: 123, name: "John" },
  10 * 60 * 1000 // 10åˆ†é’Ÿ
);

// è¯»å–ç¼“å­˜
const userData = await cache.get("/api/user/123");
console.log(userData); // { id: 123, name: "John" }

// å¸¦è‡ªåŠ¨è·å–çš„æ¨¡å¼
const posts = await cache.getOrFetch(
  "/api/posts",
  async () => {
    const res = await fetch("/api/posts");
    return await res.json();
  },
  5 * 60 * 1000 // ç¼“å­˜5åˆ†é’Ÿ
);

// å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆæ¯”å¦‚æ¯å°æ—¶ä¸€æ¬¡ï¼‰
setInterval(() => {
  cache.cleanExpired();
}, 60 * 60 * 1000);
```

### Cache API vs LocalStorage å¯¹æ¯”

```javascript
/**
 * åŒä¸€åŠŸèƒ½çš„ä¸åŒå®ç°
 */

// æ–¹æ¡ˆ1: LocalStorageï¼ˆç®€å•ï¼Œä½†åŒæ­¥ï¼‰
function saveWithLocalStorage(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

function loadWithLocalStorage(key) {
  const json = localStorage.getItem(key);
  return json ? JSON.parse(json) : null;
}

// æ–¹æ¡ˆ2: Cache APIï¼ˆå¼‚æ­¥ï¼Œæ›´å¼ºå¤§ï¼‰
async function saveWithCache(key, data) {
  const cache = await caches.open("app-data");
  const response = new Response(JSON.stringify(data));
  await cache.put(key, response);
}

async function loadWithCache(key) {
  const cache = await caches.open("app-data");
  const response = await cache.match(key);
  if (!response) return null;
  const json = await response.text();
  return JSON.parse(json);
}

/**
 * é€‰æ‹©å»ºè®®ï¼š
 *
 * ä½¿ç”¨ LocalStorageï¼š
 * âœ… ç®€å•çš„é”®å€¼å¯¹å­˜å‚¨
 * âœ… åŒæ­¥æ“ä½œå¯æ¥å—
 * âœ… æ•°æ®é‡å°ï¼ˆ<5MBï¼‰
 *
 * ä½¿ç”¨ Cache APIï¼š
 * âœ… éœ€è¦å­˜å‚¨ HTTP å“åº”
 * âœ… å¤§é‡æ•°æ®
 * âœ… éœ€è¦ä¸ Service Worker é…åˆ
 * âœ… éœ€è¦ç¦»çº¿åŠŸèƒ½
 */
```

### Service Worker ä¸­ä½¿ç”¨

```javascript
// Service Worker ä¸­ä½¿ç”¨
self.addEventListener("install", (event) => {
  event.waitUntil(
    caches.open("v1").then((cache) => {
      return cache.addAll(["/", "/index.html", "/styles.css", "/script.js"]);
    })
  );
});

self.addEventListener("fetch", (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      // ç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç¼“å­˜
      if (response) {
        return response;
      }

      // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»ç½‘ç»œè·å–
      return fetch(event.request).then((response) => {
        // ç¼“å­˜æ–°èµ„æº
        return caches.open("v1").then((cache) => {
          cache.put(event.request, response.clone());
          return response;
        });
      });
    })
  );
});
```

### âœ… ä¼˜ç‚¹

- ä¸“ä¸ºç¦»çº¿ç¼“å­˜è®¾è®¡
- å­˜å‚¨å®Œæ•´çš„ HTTP å“åº”
- å®¹é‡å¤§ï¼ˆå–å†³äºç£ç›˜ç©ºé—´ï¼‰
- **å¯ä»¥åœ¨æ™®é€šé¡µé¢ä¸­ä½¿ç”¨**ï¼ˆä¸éœ€è¦ Service Workerï¼‰
- **å¯ä»¥å­˜å‚¨ä»»æ„æ•°æ®**ï¼ˆé€šè¿‡ Response åŒ…è£…ï¼‰
- å¼‚æ­¥ APIï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- æ”¯æŒå®Œæ•´çš„ HTTP è¯­ä¹‰ï¼ˆheadersã€status ç­‰ï¼‰

### âŒ ç¼ºç‚¹

- **åªèƒ½åœ¨ HTTPS ä¸‹ä½¿ç”¨**ï¼ˆlocalhost é™¤å¤–ï¼‰
- API ç›¸å¯¹å¤æ‚ï¼ˆéœ€è¦ç†è§£ Request/Responseï¼‰
- å­˜å‚¨æ™®é€šæ•°æ®éœ€è¦åŒ…è£…ï¼ˆä¸å¦‚ LocalStorage ç›´è§‚ï¼‰
- æµè§ˆå™¨å…¼å®¹æ€§ç•¥å·®ï¼ˆIE ä¸æ”¯æŒï¼‰

### ğŸ¯ é€‚ç”¨åœºæ™¯

- **PWA ç¦»çº¿ç¼“å­˜**ï¼šé™æ€èµ„æºã€API å“åº”
- **å¤§æ–‡ä»¶ç¼“å­˜**ï¼šå›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘
- **API å“åº”ç¼“å­˜**ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚
- **éœ€è¦å¼‚æ­¥å­˜å‚¨çš„åœºæ™¯**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹
- **éœ€è¦å­˜å‚¨ HTTP å…ƒä¿¡æ¯**ï¼šheadersã€status ç­‰

### âš ï¸ å¸¸è§è¯¯åŒº

```javascript
/**
 * è¯¯åŒº1ï¼šä»¥ä¸ºåªèƒ½åœ¨ Service Worker ä¸­ä½¿ç”¨
 */
// âŒ é”™è¯¯æƒ³æ³•
// "Cache API åªèƒ½åœ¨ Service Worker ä¸­ä½¿ç”¨"

// âœ… å®é™…æƒ…å†µï¼šå¯ä»¥åœ¨ä»»ä½•ä¸Šä¸‹æ–‡ä½¿ç”¨
// åœ¨æ™®é€šé¡µé¢ä¸­ï¼š
if ("caches" in window) {
  const cache = await caches.open("my-cache");
  // æ­£å¸¸ä½¿ç”¨
}

/**
 * è¯¯åŒº2ï¼šä»¥ä¸ºåªèƒ½å­˜å‚¨ç½‘ç»œè¯·æ±‚
 */
// âŒ é”™è¯¯æƒ³æ³•
// "Cache API åªèƒ½å­˜å‚¨ä»ç½‘ç»œè·å–çš„ Response"

// âœ… å®é™…æƒ…å†µï¼šå¯ä»¥å­˜å‚¨ä»»æ„æ•°æ®
const cache = await caches.open("data");
const response = new Response(JSON.stringify({ data: "anything" }));
await cache.put("/my-data", response);

/**
 * è¯¯åŒº3ï¼šä»¥ä¸ºå¿…é¡»ç”¨ URL ä½œä¸º key
 */
// âŒ é”™è¯¯æƒ³æ³•
// "key å¿…é¡»æ˜¯çœŸå®çš„ URL"

// âœ… å®é™…æƒ…å†µï¼šå¯ä»¥ç”¨ä»»æ„å­—ç¬¦ä¸²ä½œä¸º key
await cache.put("/data/user-123", new Response("..."));
await cache.put("custom-key-12345", new Response("..."));
```

---

## 6. Web SQL âš ï¸ (å·²åºŸå¼ƒ)

> **æ³¨æ„**ï¼šWeb SQL å·²è¢«åºŸå¼ƒï¼Œä¸æ¨èä½¿ç”¨ã€‚å»ºè®®ä½¿ç”¨ IndexedDB æ›¿ä»£ã€‚

---

## 7. å®æˆ˜åœºæ™¯é€‰æ‹©æŒ‡å—

### åœºæ™¯ 1ï¼šç”¨æˆ·è®¤è¯

```javascript
/**
 * Token å­˜å‚¨æ–¹æ¡ˆ
 */

// âŒ ä¸æ¨èï¼šLocalStorageï¼ˆæ˜“å— XSS æ”»å‡»ï¼‰
localStorage.setItem("token", "abc123");

// âœ… æ¨èï¼šHttpOnly Cookieï¼ˆé˜² XSSï¼‰
// æœåŠ¡å™¨ç«¯è®¾ç½®ï¼š
// Set-Cookie: token=abc123; HttpOnly; Secure; SameSite=Strict

// ğŸ†— å¯æ¥å—ï¼šSessionStorageï¼ˆä¼šè¯æœŸé—´ï¼‰
sessionStorage.setItem("tempToken", "xyz789");
```

### åœºæ™¯ 2ï¼šç”¨æˆ·åå¥½è®¾ç½®

```javascript
// âœ… æ¨èï¼šLocalStorageï¼ˆç®€å•ã€æŒä¹…ï¼‰
const preferences = {
  theme: "dark",
  language: "zh-CN",
  fontSize: 16,
};
localStorage.setItem("preferences", JSON.stringify(preferences));
```

### åœºæ™¯ 3ï¼šè¡¨å•è‰ç¨¿

```javascript
// âœ… æ¨èï¼šSessionStorageï¼ˆåˆ·æ–°ä¿ç•™ï¼Œå…³é—­æ¸…é™¤ï¼‰
const formData = {
  title: "æ–‡ç« æ ‡é¢˜",
  content: "æ–‡ç« å†…å®¹...",
};
sessionStorage.setItem("draft", JSON.stringify(formData));
```

### åœºæ™¯ 4ï¼šç¦»çº¿èŠå¤©åº”ç”¨

```javascript
// âœ… æ¨èï¼šIndexedDBï¼ˆå¤§å®¹é‡ã€å¤æ‚æŸ¥è¯¢ï¼‰
const db = new IndexedDBManager("ChatApp", 1);
await db.open("messages", "id");
await db.add("messages", {
  from: "user1",
  to: "user2",
  text: "Hello",
  timestamp: Date.now(),
});
```

### åœºæ™¯ 5ï¼šPWA ç¦»çº¿ç¼“å­˜

```javascript
// âœ… æ¨èï¼šCache APIï¼ˆä¸“ä¸ºç¦»çº¿è®¾è®¡ï¼‰
self.addEventListener("install", (event) => {
  event.waitUntil(
    caches.open("app-v1").then((cache) => {
      return cache.addAll(["/index.html", "/app.js", "/styles.css"]);
    })
  );
});
```

---

## 8. å®‰å…¨æ€§å¯¹æ¯”

| å­˜å‚¨æ–¹å¼           | XSS é£é™©              | CSRF é£é™© | é˜²æŠ¤æªæ–½                   |
| ------------------ | --------------------- | --------- | -------------------------- |
| **Cookie**         | ä¸­ï¼ˆå¯è®¾ç½® HttpOnlyï¼‰ | é«˜        | HttpOnlyã€Secureã€SameSite |
| **LocalStorage**   | é«˜                    | ä½        | å†…å®¹åŠ å¯†ã€è¾“å…¥éªŒè¯         |
| **SessionStorage** | é«˜                    | ä½        | å†…å®¹åŠ å¯†ã€è¾“å…¥éªŒè¯         |
| **IndexedDB**      | é«˜                    | ä½        | å†…å®¹åŠ å¯†ã€è¾“å…¥éªŒè¯         |

### å®‰å…¨æœ€ä½³å®è·µ

```javascript
/**
 * 1. æ•æ„Ÿæ•°æ®åŠ å¯†
 */
class SecureStorage {
  static encrypt(data, key) {
    // ä½¿ç”¨ Web Crypto API åŠ å¯†
    // å®é™…é¡¹ç›®ä¸­ä½¿ç”¨æˆç†Ÿçš„åŠ å¯†åº“
    return btoa(JSON.stringify(data)); // ç¤ºä¾‹ï¼ˆä¸å®‰å…¨ï¼‰
  }

  static decrypt(encrypted, key) {
    return JSON.parse(atob(encrypted));
  }

  static setSecure(key, value) {
    const encrypted = this.encrypt(value, "secret-key");
    localStorage.setItem(key, encrypted);
  }

  static getSecure(key) {
    const encrypted = localStorage.getItem(key);
    return this.decrypt(encrypted, "secret-key");
  }
}

/**
 * 2. è¾“å…¥éªŒè¯å’Œæ¸…ç†
 */
function sanitize(input) {
  // ç§»é™¤æ½œåœ¨çš„æ¶æ„è„šæœ¬
  const div = document.createElement("div");
  div.textContent = input;
  return div.innerHTML;
}

/**
 * 3. ä¸è¦å­˜å‚¨æ•æ„Ÿä¿¡æ¯
 */
// âŒ æ°¸è¿œä¸è¦è¿™æ ·åš
localStorage.setItem("password", "123456");
localStorage.setItem("creditCard", "1234-5678-9012-3456");

// âœ… åªå­˜å‚¨å¿…è¦çš„æ ‡è¯†ç¬¦
localStorage.setItem("userId", "12345");
```

---

## 9. æ€§èƒ½å¯¹æ¯”

### è¯»å†™æ€§èƒ½æµ‹è¯•

```javascript
async function performanceTest() {
  const data = { name: "Test", value: "x".repeat(1000) };
  const iterations = 1000;

  // LocalStorage (åŒæ­¥)
  console.time("LocalStorage Write");
  for (let i = 0; i < iterations; i++) {
    localStorage.setItem(`test_${i}`, JSON.stringify(data));
  }
  console.timeEnd("LocalStorage Write");

  console.time("LocalStorage Read");
  for (let i = 0; i < iterations; i++) {
    JSON.parse(localStorage.getItem(`test_${i}`));
  }
  console.timeEnd("LocalStorage Read");

  // IndexedDB (å¼‚æ­¥)
  const db = new IndexedDBManager("PerfTest", 1);
  await db.open("test", "id");

  console.time("IndexedDB Write");
  for (let i = 0; i < iterations; i++) {
    await db.add("test", { id: i, ...data });
  }
  console.timeEnd("IndexedDB Write");

  console.time("IndexedDB Read");
  for (let i = 0; i < iterations; i++) {
    await db.get("test", i);
  }
  console.timeEnd("IndexedDB Read");
}

/**
 * å…¸å‹ç»“æœï¼ˆä»…ä¾›å‚è€ƒï¼‰ï¼š
 * LocalStorage Write: ~50ms
 * LocalStorage Read: ~40ms
 * IndexedDB Write: ~200msï¼ˆå¼‚æ­¥å¼€é”€ï¼‰
 * IndexedDB Read: ~150ms
 *
 * ç»“è®ºï¼š
 * - å°é‡æ•°æ®ï¼šLocalStorage æ›´å¿«
 * - å¤§é‡æ•°æ®ï¼šIndexedDB æ›´å¿«ï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
 */
```

---

## 10. æµè§ˆå™¨å…¼å®¹æ€§

| ç‰¹æ€§           | Chrome | Firefox | Safari | Edge | IE  |
| -------------- | ------ | ------- | ------ | ---- | --- |
| Cookie         | âœ…     | âœ…      | âœ…     | âœ…   | âœ…  |
| LocalStorage   | âœ…     | âœ…      | âœ…     | âœ…   | 8+  |
| SessionStorage | âœ…     | âœ…      | âœ…     | âœ…   | 8+  |
| IndexedDB      | âœ…     | âœ…      | âœ…     | âœ…   | 10+ |
| Cache API      | âœ…     | âœ…      | âœ…     | âœ…   | âŒ  |

---

## 11. æ€»ç»“ä¸å»ºè®®

### å¿«é€Ÿå†³ç­–æ ‘

```
éœ€è¦å­˜å‚¨æ•°æ®ï¼Ÿ
â”‚
â”œâ”€ éœ€è¦æœåŠ¡å™¨è®¿é—®ï¼Ÿ
â”‚  â””â”€ æ˜¯ â†’ Cookie (HttpOnly)
â”‚
â”œâ”€ æ•°æ®é‡å¤§ï¼ˆ>5MBï¼‰ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ IndexedDB
â”‚  â””â”€ å¦ â†’ ç»§ç»­
â”‚
â”œâ”€ éœ€è¦æ°¸ä¹…ä¿å­˜ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ LocalStorage
â”‚  â””â”€ å¦ â†’ SessionStorage
â”‚
â””â”€ éœ€è¦ç¦»çº¿ç¼“å­˜ï¼Ÿ
   â””â”€ æ˜¯ â†’ Cache API + IndexedDB
```

### æœ€ä½³å®è·µæ€»ç»“

1. **Cookie**ï¼šä»…ç”¨äºèº«ä»½è®¤è¯ï¼Œè®¾ç½® HttpOnlyã€Secureã€SameSite
2. **LocalStorage**ï¼šç”¨æˆ·åå¥½ã€éæ•æ„Ÿé…ç½®
3. **SessionStorage**ï¼šè¡¨å•è‰ç¨¿ã€ä¸´æ—¶çŠ¶æ€
4. **IndexedDB**ï¼šå¤§é‡ç»“æ„åŒ–æ•°æ®ã€ç¦»çº¿åº”ç”¨
5. **Cache API**ï¼šé™æ€èµ„æºç¼“å­˜ã€PWA

### ä¸è¦åšçš„äº‹

- âŒ åœ¨ LocalStorage å­˜å‚¨å¯†ç ã€Token
- âŒ å­˜å‚¨è¶…è¿‡å®¹é‡é™åˆ¶çš„æ•°æ®
- âŒ åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Web SQL
- âŒ ä¸éªŒè¯å’Œæ¸…ç†ç”¨æˆ·è¾“å…¥
- âŒ å¿˜è®°å¤„ç†å­˜å‚¨å¤±è´¥çš„æƒ…å†µ

---

## ğŸ“š æ‰©å±•é˜…è¯»

- [MDN: Web Storage API](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Storage_API)
- [MDN: IndexedDB API](https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API)
- [MDN: Cache API](https://developer.mozilla.org/zh-CN/docs/Web/API/Cache)
- [OWASP: HTML5 Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html)
