# è·¨åŸŸé—®é¢˜å®Œå…¨è§£æ

## ğŸ¯ ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜

1. **JSONP ä¸ºä»€ä¹ˆå¯ä»¥å®ç°è·¨åŸŸï¼Ÿ**
2. **é™¤äº† script æ ‡ç­¾ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾æ”¯æŒè·¨åŸŸï¼Ÿ**
3. **è¡¨å•æäº¤ä¼šæœ‰è·¨åŸŸé—®é¢˜å—ï¼Ÿ**

---

## ğŸ“– é—®é¢˜1ï¼šJSONP ä¸ºä»€ä¹ˆå¯ä»¥è·¨åŸŸï¼Ÿ

### æ ¸å¿ƒåŸç†

**å› ä¸º `<script>` æ ‡ç­¾ä¸å—åŒæºç­–ç•¥é™åˆ¶ï¼**

```javascript
/**
 * åŒæºç­–ç•¥ï¼ˆSame-Origin Policyï¼‰
 * 
 * é™åˆ¶çš„å†…å®¹ï¼š
 * âœ… XMLHttpRequest / Fetch API      â† ä¸¥æ ¼é™åˆ¶è·¨åŸŸ
 * âœ… Ajax è¯·æ±‚                       â† ä¸¥æ ¼é™åˆ¶è·¨åŸŸ
 * âœ… è¯»å–è·¨åŸŸçš„ Cookie/LocalStorage  â† ä¸¥æ ¼é™åˆ¶
 * 
 * ä¸é™åˆ¶çš„å†…å®¹ï¼š
 * âŒ <script src="è·¨åŸŸURL">          â† å¯ä»¥è·¨åŸŸï¼
 * âŒ <img src="è·¨åŸŸURL">             â† å¯ä»¥è·¨åŸŸï¼
 * âŒ <link href="è·¨åŸŸURL">           â† å¯ä»¥è·¨åŸŸï¼
 */

const sameOriginPolicy = {
  purpose: 'ä¿æŠ¤ç”¨æˆ·æ•°æ®å®‰å…¨',
  restriction: 'é™åˆ¶ä¸åŒæºä¹‹é—´çš„èµ„æºè®¿é—®',
  
  blocked: {
    ajax: 'XMLHttpRequest è·¨åŸŸè¯·æ±‚ â†’ è¢«é˜»æ­¢',
    example: `
      // å½“å‰é¡µé¢ï¼šhttps://a.com
      fetch('https://b.com/api')  // âŒ è·¨åŸŸé”™è¯¯
    `
  },
  
  allowed: {
    script: '<script> æ ‡ç­¾å¯ä»¥åŠ è½½è·¨åŸŸèµ„æº',
    example: `
      <script src="https://cdn.com/jquery.js"></script>  âœ… å…è®¸
    `
  }
};
```

### JSONP å®ç°åŸç†

```javascript
/**
 * JSONP (JSON with Padding) åŸç†
 * 
 * æ ¸å¿ƒæ€è·¯ï¼šåˆ©ç”¨ <script> æ ‡ç­¾å¯ä»¥è·¨åŸŸçš„ç‰¹æ€§
 */

// ============================================
// åœºæ™¯ï¼šç½‘ç«™ A (http://a.com) æƒ³è·å–ç½‘ç«™ B (http://b.com) çš„æ•°æ®
// ============================================

// æ­¥éª¤1ï¼šå®¢æˆ·ç«¯ï¼ˆa.comï¼‰å®šä¹‰å›è°ƒå‡½æ•°
function handleData(data) {
  console.log('æ”¶åˆ°æ•°æ®:', data);
  document.getElementById('result').textContent = data.name;
}

// æ­¥éª¤2ï¼šåŠ¨æ€åˆ›å»º <script> æ ‡ç­¾ï¼Œè¯·æ±‚è·¨åŸŸæ•°æ®
function fetchJSONP(url, callbackName) {
  const script = document.createElement('script');
  
  // åœ¨ URL ä¸­å‘Šè¯‰æœåŠ¡å™¨å›è°ƒå‡½æ•°å
  script.src = `${url}?callback=${callbackName}`;
  
  document.head.appendChild(script);
  
  // åŠ è½½å®Œæˆåç§»é™¤ script
  script.onload = () => {
    script.remove();
  };
}

// è°ƒç”¨
fetchJSONP('http://b.com/api/user', 'handleData');

// ============================================
// æ­¥éª¤3ï¼šæœåŠ¡å™¨ç«¯ï¼ˆb.comï¼‰è¿”å›çš„ä¸æ˜¯çº¯ JSONï¼Œè€Œæ˜¯å‡½æ•°è°ƒç”¨
// ============================================

// ä¼ ç»Ÿ JSON å“åº”ï¼ˆä¼šè·¨åŸŸï¼‰
// Content-Type: application/json
// { "name": "John", "age": 30 }  â† fetch æ— æ³•è¯»å–ï¼ˆè·¨åŸŸï¼‰

// JSONP å“åº”ï¼ˆä¸ä¼šè·¨åŸŸï¼‰
// Content-Type: application/javascript
handleData({ "name": "John", "age": 30 });  // âœ… ä½œä¸º JS æ‰§è¡Œ

/**
 * å®Œæ•´æµç¨‹ï¼š
 * 
 * 1. å®¢æˆ·ç«¯åˆ›å»º <script src="http://b.com/api?callback=handleData">
 * 2. æµè§ˆå™¨åŠ è½½è¿™ä¸ªè„šæœ¬ï¼ˆè·¨åŸŸï¼Œä½†å…è®¸ï¼ï¼‰
 * 3. æœåŠ¡å™¨è¿”å›ï¼šhandleData({"name":"John"})
 * 4. æµè§ˆå™¨æ‰§è¡Œè¿™æ®µ JS
 * 5. è°ƒç”¨å®¢æˆ·ç«¯é¢„å…ˆå®šä¹‰çš„ handleData å‡½æ•°
 * 6. æ•°æ®ä¼ é€’æˆåŠŸï¼
 */
```

### å®Œæ•´çš„ JSONP å®ç°

```javascript
// ============================================
// å®¢æˆ·ç«¯ï¼šå®Œæ•´çš„ JSONP å°è£…
// ============================================
function jsonp(url, params = {}, callbackName = 'jsonpCallback') {
  return new Promise((resolve, reject) => {
    // ç”Ÿæˆå”¯ä¸€çš„å›è°ƒå‡½æ•°å
    const uniqueCallback = callbackName + '_' + Date.now() + '_' + Math.random().toString(36).substr(2);
    
    // å®šä¹‰å…¨å±€å›è°ƒå‡½æ•°
    window[uniqueCallback] = function(data) {
      // æ”¶åˆ°æ•°æ®åæ¸…ç†
      delete window[uniqueCallback];
      script.remove();
      resolve(data);
    };
    
    // æ„å»º URL
    const queryParams = { ...params, callback: uniqueCallback };
    const queryString = Object.entries(queryParams)
      .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
      .join('&');
    
    const fullUrl = `${url}?${queryString}`;
    
    // åˆ›å»º script æ ‡ç­¾
    const script = document.createElement('script');
    script.src = fullUrl;
    
    // é”™è¯¯å¤„ç†
    script.onerror = () => {
      delete window[uniqueCallback];
      script.remove();
      reject(new Error('JSONP request failed'));
    };
    
    // è¶…æ—¶å¤„ç†
    setTimeout(() => {
      if (window[uniqueCallback]) {
        delete window[uniqueCallback];
        script.remove();
        reject(new Error('JSONP request timeout'));
      }
    }, 10000); // 10ç§’è¶…æ—¶
    
    // å‘èµ·è¯·æ±‚
    document.head.appendChild(script);
  });
}

// ä½¿ç”¨ç¤ºä¾‹
jsonp('http://api.example.com/user', { id: 123 })
  .then(data => {
    console.log('ç”¨æˆ·æ•°æ®:', data);
  })
  .catch(error => {
    console.error('è¯·æ±‚å¤±è´¥:', error);
  });
```

### æœåŠ¡å™¨ç«¯å®ç°

```javascript
// ============================================
// Node.js / Express æœåŠ¡å™¨
// ============================================
app.get('/api/user', (req, res) => {
  const callbackName = req.query.callback; // è·å–å›è°ƒå‡½æ•°å
  const userId = req.query.id;
  
  // æŸ¥è¯¢æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
  const userData = {
    id: userId,
    name: 'John Doe',
    email: 'john@example.com'
  };
  
  // è¿”å› JSONP æ ¼å¼ï¼ˆJS ä»£ç ï¼Œä¸æ˜¯ JSONï¼‰
  res.setHeader('Content-Type', 'application/javascript');
  res.send(`${callbackName}(${JSON.stringify(userData)})`);
  
  // å®é™…è¿”å›ï¼š
  // jsonpCallback_1234567890_abc({"id":"123","name":"John Doe","email":"john@example.com"})
});

/**
 * å¯¹æ¯”ï¼š
 * 
 * æ™®é€š JSON API:
 * GET /api/user?id=123
 * Response: {"id":"123","name":"John"}  â† è·¨åŸŸæ—¶æ— æ³•è¯»å–
 * 
 * JSONP API:
 * GET /api/user?id=123&callback=handleData
 * Response: handleData({"id":"123","name":"John"})  â† ä½œä¸º JS æ‰§è¡Œï¼Œå¯ä»¥è·¨åŸŸ
 */
```

### JSONP çš„ä¼˜ç¼ºç‚¹

```javascript
const jsonpAnalysis = {
  // âœ… ä¼˜ç‚¹
  pros: {
    crossOrigin: 'âœ… å¯ä»¥è·¨åŸŸ',
    compatibility: 'âœ… å…¼å®¹æ€§å¥½ï¼ˆæ”¯æŒè€æµè§ˆå™¨ï¼‰',
    simple: 'âœ… å®ç°ç®€å•'
  },
  
  // âŒ ç¼ºç‚¹
  cons: {
    onlyGET: 'âŒ åªæ”¯æŒ GET è¯·æ±‚ï¼ˆä¸èƒ½ POST/PUT/DELETEï¼‰',
    security: 'âŒ å®‰å…¨æ€§å·®ï¼ˆå®¹æ˜“è¢« XSS æ”»å‡»ï¼‰',
    errorHandling: 'âŒ é”™è¯¯å¤„ç†å›°éš¾',
    trustIssue: 'âŒ éœ€è¦å®Œå…¨ä¿¡ä»»æœåŠ¡å™¨ï¼ˆæ‰§è¡ŒæœåŠ¡å™¨è¿”å›çš„ä»£ç ï¼‰'
  },
  
  // ç°ä»£æ›¿ä»£æ–¹æ¡ˆ
  modern: {
    cors: 'âœ… CORSï¼ˆæ¨èï¼‰',
    postMessage: 'âœ… window.postMessage',
    proxy: 'âœ… æœåŠ¡å™¨ä»£ç†'
  }
};
```

---

## ğŸ“‹ é—®é¢˜2ï¼šå“ªäº›æ ‡ç­¾æ”¯æŒè·¨åŸŸï¼Ÿ

### å¤©ç„¶æ”¯æŒè·¨åŸŸçš„æ ‡ç­¾

```html
<!-- ============================================ -->
<!-- 1. <script> - åŠ è½½è·¨åŸŸè„šæœ¬ -->
<!-- ============================================ -->
<script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
<!-- âœ… å¯ä»¥è·¨åŸŸåŠ è½½å’Œæ‰§è¡Œ -->
<!-- ç”¨é€”ï¼šCDN åŠ è½½åº“ã€JSONP -->

<!-- ============================================ -->
<!-- 2. <link> - åŠ è½½è·¨åŸŸæ ·å¼è¡¨ -->
<!-- ============================================ -->
<link rel="stylesheet" href="https://cdn.com/bootstrap.css">
<!-- âœ… å¯ä»¥è·¨åŸŸåŠ è½½ CSS -->
<!-- ç”¨é€”ï¼šCDN åŠ è½½æ ·å¼ã€å­—ä½“ -->

<!-- ============================================ -->
<!-- 3. <img> - åŠ è½½è·¨åŸŸå›¾ç‰‡ -->
<!-- ============================================ -->
<img src="https://example.com/avatar.jpg" alt="å¤´åƒ">
<!-- âœ… å¯ä»¥è·¨åŸŸåŠ è½½å›¾ç‰‡ -->
<!-- âš ï¸ ä½†æ— æ³•é€šè¿‡ JS è¯»å–å›¾ç‰‡å†…å®¹ï¼ˆcanvas æ±¡æŸ“ï¼‰ -->

<!-- ============================================ -->
<!-- 4. <video> / <audio> - åŠ è½½è·¨åŸŸåª’ä½“ -->
<!-- ============================================ -->
<video src="https://video.com/movie.mp4"></video>
<audio src="https://music.com/song.mp3"></audio>
<!-- âœ… å¯ä»¥è·¨åŸŸåŠ è½½å’Œæ’­æ”¾ -->

<!-- ============================================ -->
<!-- 5. <iframe> - åµŒå…¥è·¨åŸŸé¡µé¢ -->
<!-- ============================================ -->
<iframe src="https://example.com/page.html"></iframe>
<!-- âœ… å¯ä»¥è·¨åŸŸåµŒå…¥ -->
<!-- âš ï¸ ä½†æ— æ³•é€šè¿‡ JS è®¿é—® iframe å†…å®¹ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰ -->

<!-- ============================================ -->
<!-- 6. <object> / <embed> - åµŒå…¥è·¨åŸŸå¯¹è±¡ -->
<!-- ============================================ -->
<object data="https://example.com/file.pdf"></object>
<embed src="https://example.com/animation.swf">
<!-- âœ… å¯ä»¥è·¨åŸŸåµŒå…¥ -->

<!-- ============================================ -->
<!-- 7. <source> - åª’ä½“èµ„æº -->
<!-- ============================================ -->
<video>
  <source src="https://cdn.com/video.mp4" type="video/mp4">
</video>
<!-- âœ… å¯ä»¥è·¨åŸŸ -->

<!-- ============================================ -->
<!-- 8. @font-face - åŠ è½½è·¨åŸŸå­—ä½“ -->
<!-- ============================================ -->
<style>
  @font-face {
    font-family: 'MyFont';
    src: url('https://fonts.com/font.woff2');
  }
</style>
<!-- âš ï¸ éœ€è¦æœåŠ¡å™¨è®¾ç½® CORS å¤´ -->

<!-- ============================================ -->
<!-- 9. <track> - å­—å¹•æ–‡ä»¶ -->
<!-- ============================================ -->
<video>
  <track src="https://example.com/subtitles.vtt" kind="subtitles">
</video>
<!-- âš ï¸ éœ€è¦ CORS -->
```

### åˆ†ç±»æ€»ç»“

```javascript
const crossOriginTags = {
  // ç±»å‹1ï¼šå®Œå…¨å…è®¸è·¨åŸŸï¼ˆæ— éœ€ CORSï¼‰
  fullyAllowed: {
    tags: ['<script>', '<link>', '<img>', '<video>', '<audio>', '<iframe>', '<object>', '<embed>'],
    reason: 'è¿™äº›èµ„æºä¸æ¶‰åŠæ•æ„Ÿæ•°æ®è¯»å–',
    limitation: 'å¯ä»¥åŠ è½½ï¼Œä½† JS å¯èƒ½æ— æ³•è¯»å–å†…å®¹'
  },
  
  // ç±»å‹2ï¼šéœ€è¦ CORS æ”¯æŒ
  needsCORS: {
    tags: ['<canvas>ï¼ˆè¯»å–è·¨åŸŸå›¾ç‰‡ï¼‰', '@font-face', '<track>'],
    reason: 'JS éœ€è¦è¯»å–èµ„æºå†…å®¹',
    requirement: 'æœåŠ¡å™¨å¿…é¡»è¿”å› Access-Control-Allow-Origin å¤´'
  },
  
  // ç±»å‹3ï¼šä¸¥æ ¼é™åˆ¶
  strictlyBlocked: {
    apis: ['fetch()', 'XMLHttpRequest', 'import()'],
    reason: 'ç›´æ¥æ¶‰åŠæ•°æ®è¯»å–',
    requirement: 'å¿…é¡»æœ‰ CORS å¤´æˆ–ä½¿ç”¨ JSONP ç­‰æŠ€å·§'
  }
};
```

### æ ‡ç­¾è·¨åŸŸè¯¦ç»†è¯´æ˜

```javascript
/**
 * å„æ ‡ç­¾çš„è·¨åŸŸç‰¹æ€§
 */

// 1. <script> - æœ€è‡ªç”±
const scriptTag = {
  crossOrigin: 'âœ… å®Œå…¨å…è®¸',
  canExecute: 'âœ… å¯ä»¥æ‰§è¡Œè·¨åŸŸè„šæœ¬',
  canRead: 'âŒ æ— æ³•è¯»å–è„šæœ¬å†…å®¹ï¼ˆé™¤éæ‰§è¡Œï¼‰',
  
  example: `
    <script src="https://cdn.com/lib.js"></script>
    // âœ… åŠ è½½å¹¶æ‰§è¡Œ
    
    // âŒ ä½†æ— æ³•è¿™æ ·è¯»å–
    fetch('https://cdn.com/lib.js')
      .then(res => res.text())  // è·¨åŸŸé”™è¯¯
  `,
  
  usage: 'JSONPã€CDN åŠ è½½åº“'
};

// 2. <img> - å¯ä»¥åŠ è½½ï¼Œä½†è¯»å–å—é™
const imgTag = {
  crossOrigin: 'âœ… å¯ä»¥è·¨åŸŸåŠ è½½',
  canDisplay: 'âœ… å¯ä»¥æ˜¾ç¤º',
  canRead: 'âŒ Canvas è¯»å–ä¼šæ±¡æŸ“',
  
  example: `
    <img src="https://example.com/pic.jpg">
    // âœ… å¯ä»¥æ˜¾ç¤º
    
    const img = new Image();
    img.src = 'https://example.com/pic.jpg';
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    
    ctx.getImageData(0, 0, 100, 100);
    // âŒ é”™è¯¯ï¼šcanvas has been tainted by cross-origin data
  `,
  
  solution: `
    // éœ€è¦æœåŠ¡å™¨æ”¯æŒ CORS å¹¶è®¾ç½® crossOrigin å±æ€§
    const img = new Image();
    img.crossOrigin = 'anonymous';  // è¯·æ±‚ CORS
    img.src = 'https://example.com/pic.jpg';
    
    // æœåŠ¡å™¨è¿”å›ï¼š
    // Access-Control-Allow-Origin: *
    
    // ç„¶åæ‰èƒ½è¯»å–
    ctx.getImageData(0, 0, 100, 100);  âœ…
  `
};

// 3. <link> - CSS å¯ä»¥è·¨åŸŸ
const linkTag = {
  crossOrigin: 'âœ… å¯ä»¥è·¨åŸŸåŠ è½½',
  canApply: 'âœ… æ ·å¼ä¼šåº”ç”¨',
  canRead: 'âŒ æ— æ³•é€šè¿‡ JS è¯»å– CSS å†…å®¹ï¼ˆé™¤éåŒæºï¼‰',
  
  example: `
    <link rel="stylesheet" href="https://cdn.com/style.css">
    // âœ… æ ·å¼ä¼šåº”ç”¨
    
    // âŒ ä½†æ— æ³•è¯»å–
    const sheet = document.styleSheets[0];
    const rules = sheet.cssRules;  // è·¨åŸŸæ—¶ä¸º null
  `
};

// 4. <iframe> - å¯ä»¥åµŒå…¥ï¼Œä½†å†…å®¹éš”ç¦»
const iframeTag = {
  crossOrigin: 'âœ… å¯ä»¥è·¨åŸŸåµŒå…¥',
  canDisplay: 'âœ… å¯ä»¥æ˜¾ç¤º',
  canRead: 'âŒ æ— æ³•è®¿é—®å†…å®¹ï¼ˆpostMessage é™¤å¤–ï¼‰',
  
  example: `
    <iframe src="https://example.com/page.html"></iframe>
    // âœ… å¯ä»¥åµŒå…¥
    
    const iframe = document.querySelector('iframe');
    iframe.contentWindow.document;
    // âŒ é”™è¯¯ï¼šBlocked by CORS policy
    
    // âœ… åªèƒ½é€šè¿‡ postMessage é€šä¿¡
    iframe.contentWindow.postMessage('hello', 'https://example.com');
  `
};
```

---

## ğŸ“‹ é—®é¢˜3ï¼šè¡¨å•æäº¤ä¼šæœ‰è·¨åŸŸé—®é¢˜å—ï¼Ÿ

### ç­”æ¡ˆï¼šè¡¨å•æäº¤**ä¸ä¼š**è¢«åŒæºç­–ç•¥é˜»æ­¢ï¼

```html
<!-- ============================================ -->
<!-- è¡¨å•å¯ä»¥è·¨åŸŸæäº¤ï¼ˆä¸å—åŒæºç­–ç•¥é™åˆ¶ï¼‰-->
<!-- ============================================ -->

<!-- å½“å‰é¡µé¢ï¼šhttps://a.com -->
<form action="https://b.com/api/submit" method="POST">
  <input type="text" name="username" value="john">
  <input type="password" name="password" value="secret">
  <button type="submit">æäº¤</button>
</form>

<!-- 
  ç‚¹å‡»æäº¤ï¼š
  âœ… è¡¨å•ä¼šæˆåŠŸæäº¤åˆ° https://b.com
  âœ… ä¸ä¼šæœ‰è·¨åŸŸé”™è¯¯
  âš ï¸ ä½†ä¼šè·³è½¬åˆ° b.comï¼ˆé¡µé¢åˆ·æ–°ï¼‰
-->
```

### ä¸ºä»€ä¹ˆè¡¨å•å¯ä»¥è·¨åŸŸï¼Ÿ

```javascript
/**
 * è¡¨å•è·¨åŸŸçš„åŸç†
 */
const formCrossOrigin = {
  reason: 'è¡¨å•æäº¤æ˜¯é¡µé¢å¯¼èˆªè¡Œä¸ºï¼Œä¸æ˜¯èµ„æºè¯»å–',
  
  comparison: {
    ajax: {
      action: 'fetch() å‘é€ POST è¯·æ±‚',
      behavior: 'åœ¨å½“å‰é¡µé¢å‘èµ·è¯·æ±‚å¹¶è¯»å–å“åº”',
      security: 'âŒ è·¨åŸŸæ—¶è¢«é˜»æ­¢ï¼ˆé˜²æ­¢è¯»å–å…¶ä»–ç½‘ç«™æ•°æ®ï¼‰'
    },
    
    form: {
      action: '<form> æäº¤',
      behavior: 'å‘é€è¯·æ±‚åè·³è½¬åˆ°ç›®æ ‡é¡µé¢',
      security: 'âœ… å…è®¸ï¼ˆå› ä¸ºä¼šè·³è½¬ï¼Œä¸åœ¨åŸé¡µé¢è¯»å–æ•°æ®ï¼‰'
    }
  },
  
  key: 'è¡¨å•æäº¤åé¡µé¢ä¼šè·³è½¬æˆ–åˆ·æ–°ï¼Œä¸å­˜åœ¨"è¯»å–è·¨åŸŸæ•°æ®"çš„é—®é¢˜'
};
```

### è¡¨å•çš„"ä¼ªè·¨åŸŸ"æ”»å‡»ï¼šCSRF

```javascript
/**
 * è™½ç„¶è¡¨å•å¯ä»¥è·¨åŸŸæäº¤ï¼Œä½†å­˜åœ¨ CSRF é£é™©
 */

// æ”»å‡»åœºæ™¯ï¼šCSRF (Cross-Site Request Forgery)
const csrfAttack = {
  // ç”¨æˆ·å·²ç™»å½•é“¶è¡Œç½‘ç«™ bank.com
  userLoggedIn: 'bank.com (æœ‰ Cookie)',
  
  // æ”»å‡»è€…çš„æ¶æ„é¡µé¢
  attackPage: `
    <!-- åœ¨ evil.com é¡µé¢ä¸Š -->
    <form action="https://bank.com/transfer" method="POST">
      <input type="hidden" name="to" value="attacker-account">
      <input type="hidden" name="amount" value="10000">
    </form>
    
    <script>
      // è‡ªåŠ¨æäº¤è¡¨å•
      document.forms[0].submit();
    </script>
  `,
  
  attack: `
    1. ç”¨æˆ·è®¿é—® evil.com
    2. æ¶æ„é¡µé¢è‡ªåŠ¨æäº¤è¡¨å•åˆ° bank.com
    3. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ bank.com çš„ Cookie
    4. é“¶è¡ŒæœåŠ¡å™¨è®¤ä¸ºæ˜¯åˆæ³•è¯·æ±‚ï¼ˆæœ‰ Cookieï¼‰
    5. è½¬è´¦æˆåŠŸï¼ğŸ’¥
  `,
  
  // é˜²å¾¡æªæ–½
  defense: {
    csrfToken: 'âœ… ä½¿ç”¨ CSRF Token',
    sameSite: 'âœ… Cookie SameSite å±æ€§',
    refererCheck: 'âœ… æ£€æŸ¥ Referer å¤´',
    customHeader: 'âœ… è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆè¡¨å•æ— æ³•è®¾ç½®ï¼‰'
  }
};
```

### é˜²æ­¢ CSRF æ”»å‡»

```javascript
// ============================================
// é˜²å¾¡æ–¹æ³•1ï¼šCSRF Token
// ============================================

// æœåŠ¡å™¨ç”Ÿæˆ Token
app.get('/form', (req, res) => {
  const csrfToken = generateToken();
  req.session.csrfToken = csrfToken;
  
  res.send(`
    <form action="/submit" method="POST">
      <input type="hidden" name="csrf" value="${csrfToken}">
      <input type="text" name="data">
      <button type="submit">æäº¤</button>
    </form>
  `);
});

// éªŒè¯ Token
app.post('/submit', (req, res) => {
  const csrfToken = req.body.csrf;
  
  if (csrfToken !== req.session.csrfToken) {
    return res.status(403).send('Invalid CSRF token');
  }
  
  // å¤„ç†è¡¨å•
  res.send('Success');
});

// ============================================
// é˜²å¾¡æ–¹æ³•2ï¼šCookie SameSite
// ============================================

// è®¾ç½® Cookie æ—¶æ·»åŠ  SameSite å±æ€§
res.cookie('sessionId', 'abc123', {
  httpOnly: true,
  secure: true,
  sameSite: 'Strict'  // æˆ– 'Lax'
});

/**
 * SameSite å±æ€§ï¼š
 * 
 * Strict: å®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹ç½‘ç«™å‘é€ Cookie
 *   evil.com çš„è¡¨å•æäº¤åˆ° bank.com â†’ Cookie ä¸ä¼šå‘é€
 * 
 * Lax: å…è®¸éƒ¨åˆ†åœºæ™¯ï¼ˆå¯¼èˆªï¼‰
 *   ä» evil.com è·³è½¬åˆ° bank.com â†’ Cookie ä¼šå‘é€
 *   evil.com çš„è¡¨å• POST åˆ° bank.com â†’ Cookie ä¸ä¼šå‘é€
 * 
 * None: æ€»æ˜¯å‘é€ï¼ˆéœ€è¦ Secureï¼‰
 */

// ============================================
// é˜²å¾¡æ–¹æ³•3ï¼šæ£€æŸ¥ Referer
// ============================================

app.post('/submit', (req, res) => {
  const referer = req.headers.referer || '';
  const allowedOrigins = ['https://mysite.com'];
  
  const isValidReferer = allowedOrigins.some(origin => 
    referer.startsWith(origin)
  );
  
  if (!isValidReferer) {
    return res.status(403).send('Invalid referer');
  }
  
  // å¤„ç†è¡¨å•
});
```

### è¡¨å•è·¨åŸŸçš„é™åˆ¶

```javascript
/**
 * è¡¨å•è™½ç„¶å¯ä»¥è·¨åŸŸæäº¤ï¼Œä½†æœ‰é™åˆ¶
 */
const formLimitations = {
  // é™åˆ¶1ï¼šåªèƒ½æ˜¯ç®€å•è¯·æ±‚
  simpleRequest: {
    methods: ['GET', 'POST'],  // âœ… å…è®¸
    contentTypes: [
      'application/x-www-form-urlencoded',  // âœ…
      'multipart/form-data',                // âœ…
      'text/plain'                          // âœ…
    ],
    customHeaders: 'âŒ ä¸èƒ½è®¾ç½®è‡ªå®šä¹‰è¯·æ±‚å¤´'
  },
  
  // é™åˆ¶2ï¼šä¼šè·³è½¬é¡µé¢
  pageNavigation: {
    behavior: 'æäº¤åé¡µé¢ä¼šè·³è½¬æˆ–åˆ·æ–°',
    workaround: 'ä½¿ç”¨éšè—çš„ <iframe> æäº¤'
  },
  
  // é™åˆ¶3ï¼šæ— æ³•è¯»å–å“åº”
  noResponse: {
    issue: 'æ— æ³•é€šè¿‡ JS è¯»å–è·¨åŸŸçš„å“åº”',
    reason: 'é¡µé¢å·²ç»è·³è½¬äº†',
    alternative: 'AJAX + CORS'
  }
};
```

### ä½¿ç”¨éšè— iframe çš„æŠ€å·§

```html
<!-- ============================================ -->
<!-- è¡¨å•è·¨åŸŸæäº¤ä½†ä¸è·³è½¬é¡µé¢ -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<body>
  <!-- éšè—çš„ iframe -->
  <iframe name="hidden-frame" style="display:none;"></iframe>
  
  <!-- è¡¨å• target æŒ‡å‘ iframe -->
  <form action="https://api.example.com/submit" 
        method="POST" 
        target="hidden-frame">
    <input type="text" name="username">
    <button type="submit">æäº¤</button>
  </form>
  
  <script>
    // ç›‘å¬ iframe çš„åŠ è½½äº‹ä»¶ï¼ˆåŒæºæ—¶æ‰èƒ½è®¿é—®ï¼‰
    const iframe = document.querySelector('iframe[name="hidden-frame"]');
    
    iframe.onload = function() {
      try {
        // âš ï¸ è·¨åŸŸæ—¶æ— æ³•è®¿é—® iframe å†…å®¹
        const response = iframe.contentDocument.body.textContent;
        console.log('å“åº”:', response);
      } catch (error) {
        console.log('âŒ è·¨åŸŸï¼Œæ— æ³•è¯»å–å“åº”');
      }
    };
  </script>
</body>
</html>
```

---

## ğŸ†š Ajax vs è¡¨å•è·¨åŸŸå¯¹æ¯”

### å®Œæ•´å¯¹æ¯”è¡¨

| ç‰¹æ€§ | Ajax (fetch/XHR) | è¡¨å•æäº¤ (form) |
|------|-----------------|----------------|
| **è·¨åŸŸæäº¤** | âŒ é»˜è®¤é˜»æ­¢ï¼ˆéœ€ CORSï¼‰ | âœ… å…è®¸ |
| **è¯»å–å“åº”** | âœ… å¯ä»¥è¯»å– | âŒ è·¨åŸŸæ—¶æ— æ³•è¯»å– |
| **é¡µé¢è·³è½¬** | âŒ ä¸è·³è½¬ï¼ˆAJAXï¼‰ | âœ… ä¼šè·³è½¬ |
| **æ”¯æŒæ–¹æ³•** | GET/POST/PUT/DELETE/... | GET/POST |
| **è‡ªå®šä¹‰å¤´** | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| **Content-Type** | ä»»æ„ | åªèƒ½æ˜¯è¡¨å•ç±»å‹ |
| **å®‰å…¨é£é™©** | XSS | CSRF |

### å®é™…ç¤ºä¾‹å¯¹æ¯”

```javascript
// ============================================
// åœºæ™¯ï¼šä» a.com å‘ b.com å‘é€æ•°æ®
// ============================================

// æ–¹å¼1ï¼šAjaxï¼ˆä¼šè·¨åŸŸæŠ¥é”™ï¼‰
fetch('https://b.com/api/submit', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name: 'John' })
})
.then(res => res.json())
.then(data => console.log(data));

/**
 * ç»“æœï¼š
 * âŒ CORS é”™è¯¯ï¼
 * Access to fetch at 'https://b.com/api/submit' from origin 'https://a.com'
 * has been blocked by CORS policy
 * 
 * é™¤é b.com æœåŠ¡å™¨è¿”å›ï¼š
 * Access-Control-Allow-Origin: https://a.com
 */

// æ–¹å¼2ï¼šè¡¨å•æäº¤ï¼ˆä¸ä¼šè·¨åŸŸæŠ¥é”™ï¼‰
const form = document.createElement('form');
form.action = 'https://b.com/api/submit';
form.method = 'POST';

const input = document.createElement('input');
input.name = 'name';
input.value = 'John';
form.appendChild(input);

document.body.appendChild(form);
form.submit();

/**
 * ç»“æœï¼š
 * âœ… æäº¤æˆåŠŸï¼
 * âš ï¸ ä½†é¡µé¢ä¼šè·³è½¬åˆ° b.com
 * âŒ æ— æ³•é€šè¿‡ JS è¯»å–å“åº”
 */
```

---

## ğŸ¨ è·¨åŸŸè§£å†³æ–¹æ¡ˆæ±‡æ€»

### æ–¹æ¡ˆå¯¹æ¯”

```javascript
const crossOriginSolutions = {
  // 1. JSONPï¼ˆåˆ©ç”¨ script æ ‡ç­¾ï¼‰
  jsonp: {
    principle: '<script> å¯ä»¥è·¨åŸŸ',
    pros: ['âœ… å…¼å®¹æ€§å¥½', 'âœ… ç®€å•'],
    cons: ['âŒ åªæ”¯æŒ GET', 'âŒ å®‰å…¨æ€§å·®'],
    usage: 'è€é¡¹ç›®ã€ç®€å•åœºæ™¯'
  },
  
  // 2. CORSï¼ˆç°ä»£æ ‡å‡†ï¼‰
  cors: {
    principle: 'æœåŠ¡å™¨è¿”å› Access-Control-Allow-Origin å¤´',
    pros: ['âœ… æ”¯æŒæ‰€æœ‰æ–¹æ³•', 'âœ… å®‰å…¨', 'âœ… æ ‡å‡†'],
    cons: ['âŒ éœ€è¦æœåŠ¡å™¨é…åˆ', 'âŒ ä¸æ”¯æŒè€æµè§ˆå™¨'],
    usage: 'æ¨èä½¿ç”¨ï¼'
  },
  
  // 3. æœåŠ¡å™¨ä»£ç†
  proxy: {
    principle: 'åŒæºæœåŠ¡å™¨è½¬å‘è¯·æ±‚',
    pros: ['âœ… å‰ç«¯æ— æ„ŸçŸ¥', 'âœ… å®‰å…¨'],
    cons: ['âŒ å¢åŠ æœåŠ¡å™¨è´Ÿæ‹…'],
    usage: 'å¼€å‘ç¯å¢ƒã€æ— æ³•ä¿®æ”¹ç›®æ ‡æœåŠ¡å™¨æ—¶'
  },
  
  // 4. postMessage
  postMessage: {
    principle: 'iframe è·¨åŸŸé€šä¿¡',
    pros: ['âœ… å®‰å…¨', 'âœ… åŒå‘é€šä¿¡'],
    cons: ['âŒ å¤æ‚', 'âŒ åªé€‚ç”¨äº iframe'],
    usage: 'åµŒå…¥ç¬¬ä¸‰æ–¹é¡µé¢é€šä¿¡'
  },
  
  // 5. WebSocket
  websocket: {
    principle: 'WebSocket ä¸å—åŒæºç­–ç•¥é™åˆ¶',
    pros: ['âœ… å®æ—¶åŒå‘é€šä¿¡', 'âœ… è·¨åŸŸ'],
    cons: ['âŒ éœ€è¦æœåŠ¡å™¨æ”¯æŒ'],
    usage: 'å®æ—¶é€šä¿¡åœºæ™¯'
  },
  
  // 6. è¡¨å•æäº¤
  form: {
    principle: 'è¡¨å•æäº¤æ˜¯å¯¼èˆªè¡Œä¸ºï¼Œä¸å—é™åˆ¶',
    pros: ['âœ… ç®€å•', 'âœ… å…¼å®¹æ€§å¥½'],
    cons: ['âŒ é¡µé¢è·³è½¬', 'âŒ æ— æ³•è¯»å–å“åº”', 'âŒ CSRF é£é™©'],
    usage: 'ç®€å•çš„è·¨åŸŸæäº¤ï¼ˆä¸éœ€è¦å“åº”ï¼‰'
  }
};
```

### CORS è¯¦è§£ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

```javascript
// ============================================
// CORS (Cross-Origin Resource Sharing)
// ============================================

// æœåŠ¡å™¨ç«¯ï¼ˆNode.js/Expressï¼‰
app.use((req, res, next) => {
  // å…è®¸çš„æºï¼ˆ* è¡¨ç¤ºæ‰€æœ‰ï¼Œç”Ÿäº§ç¯å¢ƒåº”æŒ‡å®šå…·ä½“åŸŸåï¼‰
  res.setHeader('Access-Control-Allow-Origin', 'https://trusted-site.com');
  
  // å…è®¸çš„æ–¹æ³•
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
  
  // å…è®¸çš„è¯·æ±‚å¤´
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  // å…è®¸æºå¸¦ Cookie
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  
  // é¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´
  res.setHeader('Access-Control-Max-Age', '86400'); // 24å°æ—¶
  
  // å¤„ç†é¢„æ£€è¯·æ±‚
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  next();
});

// å®¢æˆ·ç«¯ï¼ˆè·¨åŸŸè¯·æ±‚ï¼‰
fetch('https://api.example.com/data', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123'
  },
  credentials: 'include', // æºå¸¦ Cookie
  body: JSON.stringify({ data: 'test' })
})
.then(res => res.json())
.then(data => console.log(data));  // âœ… å¯ä»¥è¯»å–å“åº”
```

### ä»£ç†æ–¹æ¡ˆ

```javascript
// ============================================
// å¼€å‘ç¯å¢ƒä»£ç†ï¼ˆVite/Webpackï¼‰
// ============================================

// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'https://api.example.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
};

// ä½¿ç”¨
fetch('/api/user')  // å®é™…è¯·æ±‚ï¼šhttps://api.example.com/user
// âœ… åŒæºï¼ˆéƒ½æ˜¯å‘å¼€å‘æœåŠ¡å™¨è¯·æ±‚ï¼‰
// âœ… å¼€å‘æœåŠ¡å™¨è½¬å‘åˆ°ç›®æ ‡æœåŠ¡å™¨

// webpack.config.js
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'https://api.example.com',
        changeOrigin: true,
        pathRewrite: { '^/api': '' }
      }
    }
  }
};
```

---

## ğŸ“Š æ€»ç»“

### ä¸‰ä¸ªé—®é¢˜çš„ç­”æ¡ˆ

#### 1. JSONP ä¸ºä»€ä¹ˆå¯ä»¥è·¨åŸŸï¼Ÿ

**ç­”**ï¼šå› ä¸º `<script>` æ ‡ç­¾ä¸å—åŒæºç­–ç•¥é™åˆ¶ï¼Œå¯ä»¥åŠ è½½å¹¶æ‰§è¡Œè·¨åŸŸè„šæœ¬ã€‚

```javascript
// åŸç†
<script src="https://api.com?callback=handleData"></script>
// âœ… å…è®¸è·¨åŸŸ
// æœåŠ¡å™¨è¿”å›ï¼šhandleData({data: 'value'})
// âœ… ä½œä¸º JS æ‰§è¡Œï¼Œæ•°æ®ä¼ é€’æˆåŠŸ
```

#### 2. å“ªäº›æ ‡ç­¾æ”¯æŒè·¨åŸŸï¼Ÿ

**ç­”**ï¼šä»¥ä¸‹æ ‡ç­¾å¤©ç„¶æ”¯æŒè·¨åŸŸï¼ˆæ— éœ€ CORSï¼‰ï¼š

```html
âœ… <script src="è·¨åŸŸ">      - è„šæœ¬
âœ… <link href="è·¨åŸŸ">        - æ ·å¼
âœ… <img src="è·¨åŸŸ">          - å›¾ç‰‡
âœ… <video src="è·¨åŸŸ">        - è§†é¢‘
âœ… <audio src="è·¨åŸŸ">        - éŸ³é¢‘
âœ… <iframe src="è·¨åŸŸ">       - æ¡†æ¶
âœ… <object data="è·¨åŸŸ">      - å¯¹è±¡
âœ… <embed src="è·¨åŸŸ">        - åµŒå…¥

âš ï¸ <canvas> è¯»å–å›¾ç‰‡       - éœ€è¦ CORS
âš ï¸ @font-face             - éœ€è¦ CORS
âš ï¸ <track>                - éœ€è¦ CORS
```

#### 3. è¡¨å•æäº¤ä¼šæœ‰è·¨åŸŸé—®é¢˜å—ï¼Ÿ

**ç­”**ï¼š**ä¸ä¼š**æœ‰è·¨åŸŸé”™è¯¯ï¼Œä½†æœ‰å…¶ä»–é—®é¢˜ï¼š

```javascript
// âœ… å¯ä»¥è·¨åŸŸæäº¤
<form action="https://other-site.com/api" method="POST">
  <button type="submit">æäº¤</button>
</form>

// âš ï¸ ä½†å­˜åœ¨çš„é—®é¢˜
{
  navigation: 'ä¼šè·³è½¬é¡µé¢',
  noResponse: 'æ— æ³•è¯»å–å“åº”æ•°æ®',
  csrfRisk: 'å­˜åœ¨ CSRF æ”»å‡»é£é™©',
  
  solution: {
    needResponse: 'ä½¿ç”¨ AJAX + CORS',
    preventCSRF: 'ä½¿ç”¨ CSRF Token + SameSite Cookie'
  }
}
```

### ç°ä»£è·¨åŸŸæœ€ä½³å®è·µ

```
1. ä¼˜å…ˆä½¿ç”¨ CORSï¼ˆæœåŠ¡å™¨é…åˆï¼‰
2. å¼€å‘ç¯å¢ƒä½¿ç”¨ä»£ç†
3. ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ JSONPï¼ˆåªè¯»ã€GET è¯·æ±‚ï¼‰
4. é¿å…ä½¿ç”¨è¡¨å•è·¨åŸŸï¼ˆCSRF é£é™©ï¼‰
5. iframe é€šä¿¡ä½¿ç”¨ postMessage
```

æ–‡æ¡£ä½ç½®ï¼š`è·¨åŸŸé—®é¢˜è¯¦è§£.md`

åŒ…å«ï¼šJSONP åŸç†ã€æ‰€æœ‰è·¨åŸŸæ ‡ç­¾ã€è¡¨å•è·¨åŸŸã€CSRF é˜²å¾¡ã€å®Œæ•´ä»£ç ç¤ºä¾‹ï¼ğŸ‰
