# ä»»åŠ¡è°ƒåº¦ç›¸å…³ API

## 1. å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰API

### 1.1 queueMicrotask()

**åŸºæœ¬ç”¨æ³•:**

```javascript
queueMicrotask(() => {
  console.log("è¿™æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡");
});
```

**ç‰¹ç‚¹:**

- åœ¨å½“å‰ä»»åŠ¡ç»“æŸåã€ä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹å‰æ‰§è¡Œ
- æ¯” `Promise.then()` æ›´ç›´æ¥åœ°åˆ›å»ºå¾®ä»»åŠ¡
- æ‰§è¡Œæ—¶æœºï¼šåœ¨æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œåœ¨äº‹ä»¶å¾ªç¯çš„æ£€æŸ¥ç‚¹æ‰§è¡Œ
- å¾®ä»»åŠ¡ä¼šåœ¨å½“å‰æ‰§è¡Œæ ˆæ¸…ç©ºåç«‹å³æ‰§è¡Œï¼Œæ—©äºä»»ä½•å®ä»»åŠ¡

**ä½¿ç”¨åœºæ™¯:**

- éœ€è¦åœ¨å½“å‰ JavaScript æ‰§è¡Œæ ˆå®Œæˆåç«‹å³æ‰§è¡ŒæŸäº›æ“ä½œ
- æ‰¹é‡æ›´æ–° DOM æˆ–çŠ¶æ€
- ç¡®ä¿æŸäº›æ“ä½œåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“å‰å®Œæˆ

**ç¤ºä¾‹:**

```javascript
console.log("å¼€å§‹");

queueMicrotask(() => {
  console.log("å¾®ä»»åŠ¡ 1");
});

queueMicrotask(() => {
  console.log("å¾®ä»»åŠ¡ 2");
});

console.log("ç»“æŸ");

// è¾“å‡ºé¡ºåº:
// å¼€å§‹
// ç»“æŸ
// å¾®ä»»åŠ¡ 1
// å¾®ä»»åŠ¡ 2
```

### 1.2 Promise.then/catch/finally

**åŸºæœ¬ç”¨æ³•:**

```javascript
Promise.resolve().then(() => {
  console.log("Promise å¾®ä»»åŠ¡");
});
```

**ç‰¹ç‚¹:**

- Promise çš„å›è°ƒå‡½æ•°ä¼šè¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—
- å³ä½¿ Promise å·²ç» resolvedï¼Œthen/catch ä¹Ÿä¼šå¼‚æ­¥æ‰§è¡Œ
- é“¾å¼è°ƒç”¨çš„æ¯ä¸ª then éƒ½ä¼šåˆ›å»ºæ–°çš„å¾®ä»»åŠ¡

**ç¤ºä¾‹:**

```javascript
console.log("1");

Promise.resolve()
  .then(() => console.log("2"))
  .then(() => console.log("3"));

queueMicrotask(() => console.log("4"));

console.log("5");

// è¾“å‡º: 1, 5, 2, 4, 3
```

### 1.3 MutationObserver

**åŸºæœ¬ç”¨æ³•:**

```javascript
const observer = new MutationObserver((mutations) => {
  console.log("DOM å˜åŒ–äº†", mutations);
});

observer.observe(document.body, {
  childList: true,
  subtree: true,
  attributes: true,
});
```

**ç‰¹ç‚¹:**

- å›è°ƒå‡½æ•°åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ
- ç”¨äºç›‘å¬ DOM å˜åŒ–
- æ‰¹é‡å¤„ç†å¤šä¸ª DOM å˜åŒ–

## 2. å®ä»»åŠ¡ï¼ˆMacrotaskï¼‰API

### 2.1 setTimeout / setInterval

**åŸºæœ¬ç”¨æ³•:**

```javascript
// setTimeout - å»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡
setTimeout(() => {
  console.log("å»¶è¿Ÿæ‰§è¡Œ");
}, 1000);

// setInterval - é‡å¤æ‰§è¡Œ
const intervalId = setInterval(() => {
  console.log("é‡å¤æ‰§è¡Œ");
}, 1000);

// æ¸…é™¤å®šæ—¶å™¨
clearInterval(intervalId);
```

**ç‰¹ç‚¹:**

- åˆ›å»ºå®ä»»åŠ¡
- æœ€å°å»¶è¿Ÿæ—¶é—´é€šå¸¸ä¸º 4msï¼ˆåµŒå¥—å®šæ—¶å™¨ï¼‰
- ä¸ç²¾ç¡®ï¼Œå—äº‹ä»¶å¾ªç¯å½±å“
- æµè§ˆå™¨ä¼šå¯¹åå°æ ‡ç­¾é¡µçš„å®šæ—¶å™¨è¿›è¡ŒèŠ‚æµ

### 2.2 setImmediate (Node.js)

**åŸºæœ¬ç”¨æ³•:**

```javascript
setImmediate(() => {
  console.log("ç«‹å³æ‰§è¡Œçš„å®ä»»åŠ¡");
});
```

**ç‰¹ç‚¹:**

- Node.js ä¸“æœ‰ APIï¼ˆéƒ¨åˆ†æµè§ˆå™¨ä¹Ÿæ”¯æŒï¼‰
- åœ¨ I/O äº‹ä»¶å›è°ƒä¹‹åï¼Œå®šæ—¶å™¨å›è°ƒä¹‹å‰æ‰§è¡Œ
- æ¯” `setTimeout(fn, 0)` æ›´ä¼˜å…ˆ

### 2.3 requestAnimationFrame (rAF)

**åŸºæœ¬ç”¨æ³•:**

```javascript
requestAnimationFrame((timestamp) => {
  console.log("åœ¨ä¸‹æ¬¡é‡ç»˜å‰æ‰§è¡Œ", timestamp);
});
```

**ç‰¹ç‚¹:**

- åœ¨æµè§ˆå™¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œ
- é€šå¸¸æ¯ç§’ 60 æ¬¡ï¼ˆ60fpsï¼‰
- è‡ªåŠ¨ä¸æµè§ˆå™¨åˆ·æ–°ç‡åŒæ­¥
- åå°æ ‡ç­¾é¡µä¼šæš‚åœæ‰§è¡Œ
- é€‚åˆåšåŠ¨ç”»

**ç¤ºä¾‹:**

```javascript
let start = null;

function step(timestamp) {
  if (!start) start = timestamp;
  const progress = timestamp - start;

  element.style.transform = `translateX(${Math.min(progress / 10, 200)}px)`;

  if (progress < 2000) {
    requestAnimationFrame(step);
  }
}

requestAnimationFrame(step);
```

### 2.4 requestIdleCallback (rIC)

**åŸºæœ¬ç”¨æ³•:**

```javascript
requestIdleCallback(
  (deadline) => {
    console.log("ç©ºé—²æ—¶é—´:", deadline.timeRemaining());

    while (deadline.timeRemaining() > 0 && tasks.length > 0) {
      doWork(tasks.shift());
    }
  },
  { timeout: 1000 }
);
```

**ç‰¹ç‚¹:**

- åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œ
- é€‚åˆæ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡
- `deadline.timeRemaining()` è¿”å›å‰©ä½™ç©ºé—²æ—¶é—´
- `timeout` å‚æ•°æŒ‡å®šæœ€é•¿ç­‰å¾…æ—¶é—´
- ä¸é€‚åˆå¤„ç† DOM æ›´æ–°ï¼ˆå¯èƒ½å·²ç»æ¸²æŸ“å®Œæˆï¼‰

**ä½¿ç”¨åœºæ™¯:**

- åˆ†æå’Œä¸ŠæŠ¥æ•°æ®
- é¢„åŠ è½½èµ„æº
- éå…³é”®è®¡ç®—
- åå°åŒæ­¥

## 3. ç°ä»£è°ƒåº¦ API

### 3.1 Scheduler.postTask (å®éªŒæ€§)

**åŸºæœ¬ç”¨æ³•:**

```javascript
// è°ƒåº¦ä¸€ä¸ªç”¨æˆ·é˜»å¡ä»»åŠ¡
scheduler.postTask(
  () => {
    console.log("ç”¨æˆ·é˜»å¡çº§åˆ«ä»»åŠ¡");
  },
  { priority: "user-blocking" }
);

// è°ƒåº¦ä¸€ä¸ªåå°ä»»åŠ¡
scheduler.postTask(
  () => {
    console.log("åå°ä»»åŠ¡");
  },
  { priority: "background" }
);
```

**ä¼˜å…ˆçº§çº§åˆ«:**

- `user-blocking`: ç”¨æˆ·é˜»å¡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- `user-visible`: ç”¨æˆ·å¯è§ï¼ˆé»˜è®¤ï¼‰
- `background`: åå°ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰

**ç‰¹ç‚¹:**

- æä¾›æ›´ç»†ç²’åº¦çš„ä»»åŠ¡ä¼˜å…ˆçº§æ§åˆ¶
- è¿”å› Promise
- å¯ä»¥ä¸­æ­¢ä»»åŠ¡
- æ”¯æŒä¿¡å·é‡ï¼ˆAbortSignalï¼‰

**å®Œæ•´ç¤ºä¾‹:**

```javascript
const controller = new TaskController({ priority: "user-visible" });

const task = scheduler.postTask(
  async () => {
    console.log("å¼€å§‹æ‰§è¡Œä»»åŠ¡");
    await heavyComputation();
    console.log("ä»»åŠ¡å®Œæˆ");
    return "ç»“æœ";
  },
  {
    signal: controller.signal,
    priority: "user-blocking",
  }
);

// æ”¹å˜ä¼˜å…ˆçº§
controller.setPriority("background");

// ä¸­æ­¢ä»»åŠ¡
// controller.abort();

// ç­‰å¾…ä»»åŠ¡å®Œæˆ
task
  .then((result) => {
    console.log("ä»»åŠ¡ç»“æœ:", result);
  })
  .catch((error) => {
    if (error.name === "AbortError") {
      console.log("ä»»åŠ¡è¢«ä¸­æ­¢");
    }
  });
```

### 3.2 Scheduler.yield (ææ¡ˆé˜¶æ®µ)

**åŸºæœ¬ç”¨æ³•:**

```javascript
async function processLargeArray(array) {
  for (let i = 0; i < array.length; i++) {
    processItem(array[i]);

    // å®šæœŸè®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
    if (i % 100 === 0) {
      await scheduler.yield();
    }
  }
}
```

**ç‰¹ç‚¹:**

- å…è®¸é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ
- é¿å…é˜»å¡ä¸»çº¿ç¨‹
- ä¿æŒä»»åŠ¡çš„ä¼˜å…ˆçº§å’Œä¸Šä¸‹æ–‡
- æ¯” `setTimeout(0)` æ›´é«˜æ•ˆ

## 4. ä»»åŠ¡æ‰§è¡Œé¡ºåºæ€»ç»“

```javascript
console.log("1. åŒæ­¥ä»£ç ");

setTimeout(() => {
  console.log("6. setTimeout (å®ä»»åŠ¡)");
}, 0);

Promise.resolve().then(() => {
  console.log("4. Promise.then (å¾®ä»»åŠ¡)");
});

queueMicrotask(() => {
  console.log("5. queueMicrotask (å¾®ä»»åŠ¡)");
});

requestAnimationFrame(() => {
  console.log("7. requestAnimationFrame");
});

requestIdleCallback(() => {
  console.log("8. requestIdleCallback");
});

scheduler.postTask(
  () => {
    console.log("3. postTask user-blocking");
  },
  { priority: "user-blocking" }
);

console.log("2. åŒæ­¥ä»£ç ç»“æŸ");

// æ‰§è¡Œé¡ºåº:
// 1. åŒæ­¥ä»£ç 
// 2. åŒæ­¥ä»£ç ç»“æŸ
// 3. postTask user-blocking
// 4. Promise.then (å¾®ä»»åŠ¡)
// 5. queueMicrotask (å¾®ä»»åŠ¡)
// 6. setTimeout (å®ä»»åŠ¡)
// 7. requestAnimationFrame (åœ¨ä¸‹æ¬¡é‡ç»˜å‰)
// 8. requestIdleCallback (ç©ºé—²æ—¶)
```

## 5. æ‰§è¡Œä¼˜å…ˆçº§

### ä»é«˜åˆ°ä½:

1. **åŒæ­¥ä»£ç ** - ç«‹å³æ‰§è¡Œ
2. **å¾®ä»»åŠ¡é˜Ÿåˆ—** (Microtask Queue)
   - `queueMicrotask()`
   - `Promise.then/catch/finally`
   - `MutationObserver`
   - `process.nextTick()` (Node.js, æœ€é«˜ä¼˜å…ˆçº§å¾®ä»»åŠ¡)
3. **å®ä»»åŠ¡é˜Ÿåˆ—** (Macrotask Queue)
   - `setTimeout/setInterval`
   - `setImmediate` (Node.js)
   - I/O æ“ä½œ
   - UI æ¸²æŸ“
   - `MessageChannel`
4. **requestAnimationFrame** - ä¸‹æ¬¡é‡ç»˜å‰
5. **requestIdleCallback** - æµè§ˆå™¨ç©ºé—²æ—¶

## 6. ä½¿ç”¨å»ºè®®

### é€‰æ‹© `queueMicrotask` çš„åœºæ™¯:

- éœ€è¦åœ¨å½“å‰æ‰§è¡Œæ ˆç»“æŸåç«‹å³æ‰§è¡Œ
- æ‰¹é‡å¤„ç†çŠ¶æ€æ›´æ–°
- éœ€è¦åœ¨ DOM æ¸²æŸ“å‰æ‰§è¡Œ

### é€‰æ‹© `Promise` çš„åœºæ™¯:

- å¼‚æ­¥æ“ä½œé“¾å¼è°ƒç”¨
- éœ€è¦å¤„ç†æˆåŠŸ/å¤±è´¥çŠ¶æ€
- ä¸ async/await é…åˆä½¿ç”¨

### é€‰æ‹© `setTimeout` çš„åœºæ™¯:

- éœ€è¦å»¶è¿Ÿæ‰§è¡Œ
- åˆ†è§£é•¿ä»»åŠ¡é¿å…é˜»å¡ï¼ˆè™½ç„¶ `scheduler.yield` æ›´å¥½ï¼‰
- å®šæ—¶æ‰§è¡Œä»»åŠ¡

### é€‰æ‹© `requestAnimationFrame` çš„åœºæ™¯:

- DOM åŠ¨ç”»
- Canvas åŠ¨ç”»
- å¹³æ»‘çš„è§†è§‰æ›´æ–°

### é€‰æ‹© `requestIdleCallback` çš„åœºæ™¯:

- éå…³é”®æ•°æ®åˆ†æ
- é¢„åŠ è½½èµ„æº
- åå°æ•°æ®åŒæ­¥
- ä½ä¼˜å…ˆçº§è®¡ç®—

### é€‰æ‹© `scheduler.postTask` çš„åœºæ™¯:

- éœ€è¦ç²¾ç¡®æ§åˆ¶ä»»åŠ¡ä¼˜å…ˆçº§
- éœ€è¦ä¸­æ­¢ä»»åŠ¡çš„èƒ½åŠ›
- å¤æ‚çš„ä»»åŠ¡è°ƒåº¦åœºæ™¯
- éœ€è¦åŠ¨æ€è°ƒæ•´ä¼˜å…ˆçº§

## 7. æµè§ˆå™¨å…¼å®¹æ€§æ³¨æ„äº‹é¡¹

| API                    | Chrome  | Firefox | Safari  | Edge    | Node.js |
| ---------------------- | ------- | ------- | ------- | ------- | ------- |
| queueMicrotask         | 71+     | 69+     | 12.1+   | 79+     | 11.0+   |
| Promise                | 32+     | 29+     | 8+      | 12+     | 0.12+   |
| setTimeout/setInterval | âœ…      | âœ…      | âœ…      | âœ…      | âœ…      |
| requestAnimationFrame  | 24+     | 23+     | 6.1+    | 12+     | âŒ      |
| requestIdleCallback    | 47+     | âŒ      | æœªæ”¯æŒ  | 79+     | âŒ      |
| scheduler.postTask     | 94+     | âŒ      | æœªæ”¯æŒ  | 94+     | âŒ      |
| scheduler.yield        | ğŸš§ ææ¡ˆ | ğŸš§ ææ¡ˆ | ğŸš§ ææ¡ˆ | ğŸš§ ææ¡ˆ | âŒ      |

**å»ºè®®:**

- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ polyfill æˆ–ç‰¹æ€§æ£€æµ‹
- `requestIdleCallback` å¯ä»¥ç”¨ `setTimeout` é™çº§
- `scheduler.postTask` å°šåœ¨å®éªŒé˜¶æ®µï¼Œä½¿ç”¨å‰æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
