# é¡µé¢é—´é€šä¿¡ï¼šç›‘å¬å­é¡µé¢å…³é—­

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**ä»é¡µé¢Aæ‰“å¼€é¡µé¢Bï¼Œå¦‚ä½•åœ¨Bå…³é—­æ—¶ï¼ˆåŒ…æ‹¬æ„å¤–å´©æºƒï¼‰é€šçŸ¥é¡µé¢Aï¼Ÿ**

---

## ğŸ“Š è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ­£å¸¸å…³é—­ | æ„å¤–å´©æºƒ | å®ç°éš¾åº¦ | å…¼å®¹æ€§ | æ¨èåº¦ |
|------|---------|---------|---------|--------|--------|
| **window.opener** | âœ… | âŒ | ç®€å• | âœ… å¥½ | â­â­â­ |
| **BroadcastChannel** | âœ… | âŒ | ç®€å• | ğŸ”¶ ä¸­ | â­â­â­â­ |
| **localStorage + å¿ƒè·³** | âœ… | âœ… | ä¸­ç­‰ | âœ… å¥½ | â­â­â­â­â­ |
| **SharedWorker** | âœ… | âœ… | å¤æ‚ | âš ï¸ å·® | â­â­ |
| **Service Worker** | âœ… | âœ… | å¤æ‚ | ğŸ”¶ ä¸­ | â­â­â­ |
| **è½®è¯¢æ£€æµ‹** | âœ… | âœ… | ç®€å• | âœ… å¥½ | â­â­â­â­ |

---

## 1ï¸âƒ£ æ–¹æ¡ˆ1ï¼šwindow.openerï¼ˆæœ€ç®€å•ï¼‰

### åŸç†

é¡µé¢Bé€šè¿‡ `window.opener` å¼•ç”¨æ‰“å¼€å®ƒçš„é¡µé¢Aï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨Açš„å‡½æ•°ã€‚

### å®ç°

```html
<!-- ============================================ -->
<!-- é¡µé¢Aï¼šæ‰“å¼€è€… -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢A</title>
</head>
<body>
  <h1>é¡µé¢Aï¼ˆä¸»é¡µé¢ï¼‰</h1>
  <button id="openB">æ‰“å¼€é¡µé¢B</button>
  <div id="status">é¡µé¢BçŠ¶æ€ï¼šæœªæ‰“å¼€</div>
  
  <script>
    let pageB = null;
    
    // æ‰“å¼€é¡µé¢B
    document.getElementById('openB').addEventListener('click', () => {
      pageB = window.open('pageB.html', 'pageB', 'width=600,height=400');
      
      updateStatus('é¡µé¢Bå·²æ‰“å¼€');
      
      // å¯é€‰ï¼šå®šæœŸæ£€æŸ¥Bæ˜¯å¦è¿˜å­˜åœ¨
      const checkInterval = setInterval(() => {
        if (pageB && pageB.closed) {
          console.log('æ£€æµ‹åˆ°é¡µé¢Bå·²å…³é—­');
          updateStatus('é¡µé¢Bå·²å…³é—­ï¼ˆæ£€æµ‹ï¼‰');
          clearInterval(checkInterval);
        }
      }, 1000);
    });
    
    // ä¾›é¡µé¢Bè°ƒç”¨çš„å‡½æ•°
    window.onPageBClosed = function(reason) {
      console.log('é¡µé¢Bé€šçŸ¥å…³é—­ï¼ŒåŸå› :', reason);
      updateStatus('é¡µé¢Bå·²å…³é—­ï¼š' + reason);
    };
    
    function updateStatus(status) {
      document.getElementById('status').textContent = 'é¡µé¢BçŠ¶æ€ï¼š' + status;
    }
  </script>
</body>
</html>

<!-- ============================================ -->
<!-- é¡µé¢Bï¼šè¢«æ‰“å¼€çš„é¡µé¢ -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢B</title>
</head>
<body>
  <h1>é¡µé¢Bï¼ˆå­é¡µé¢ï¼‰</h1>
  <button id="close">æ­£å¸¸å…³é—­</button>
  <button id="crash">æ¨¡æ‹Ÿå´©æºƒ</button>
  
  <script>
    // æ­£å¸¸å…³é—­æ—¶é€šçŸ¥é¡µé¢A
    document.getElementById('close').addEventListener('click', () => {
      notifyParentAndClose('ç”¨æˆ·ä¸»åŠ¨å…³é—­');
    });
    
    // ç›‘å¬ beforeunloadï¼ˆç”¨æˆ·å…³é—­æ ‡ç­¾é¡µï¼‰
    window.addEventListener('beforeunload', () => {
      if (window.opener && !window.opener.closed) {
        window.opener.onPageBClosed('ç”¨æˆ·å…³é—­æ ‡ç­¾é¡µ');
      }
    });
    
    // æ¨¡æ‹Ÿå´©æºƒï¼ˆæ— æ³•é€šçŸ¥ï¼‰
    document.getElementById('crash').addEventListener('click', () => {
      throw new Error('å´©æºƒäº†');
      // âŒ å´©æºƒæ—¶æ— æ³•æ‰§è¡Œ beforeunload
      // âŒ æ— æ³•é€šçŸ¥é¡µé¢A
    });
    
    function notifyParentAndClose(reason) {
      if (window.opener && !window.opener.closed) {
        window.opener.onPageBClosed(reason);
      }
      window.close();
    }
  </script>
</body>
</html>
```

### ä¼˜ç¼ºç‚¹

```javascript
const openerSolution = {
  // âœ… ä¼˜ç‚¹
  pros: [
    'å®ç°ç®€å•',
    'ç›´æ¥è°ƒç”¨ï¼Œå®æ—¶æ€§å¥½',
    'å…¼å®¹æ€§å¥½'
  ],
  
  // âŒ ç¼ºç‚¹
  cons: [
    'âŒ å´©æºƒæ—¶æ— æ³•é€šçŸ¥ï¼ˆbeforeunload ä¸æ‰§è¡Œï¼‰',
    'âŒ åªèƒ½åœ¨åŒæºé¡µé¢é—´ä½¿ç”¨',
    'âŒ éœ€è¦è½®è¯¢æ£€æŸ¥ closed å±æ€§'
  ]
};
```

---

## 2ï¸âƒ£ æ–¹æ¡ˆ2ï¼šBroadcastChannelï¼ˆæ¨èï¼‰

### åŸç†

ä½¿ç”¨æµè§ˆå™¨çš„å¹¿æ’­é€šé“ APIï¼ŒåŒæºé¡µé¢é—´é€šä¿¡ã€‚

### å®ç°

```html
<!-- ============================================ -->
<!-- é¡µé¢A -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢A</title>
</head>
<body>
  <h1>é¡µé¢A</h1>
  <button id="openB">æ‰“å¼€é¡µé¢B</button>
  <div id="log"></div>
  
  <script>
    // åˆ›å»ºå¹¿æ’­é¢‘é“
    const channel = new BroadcastChannel('page-lifecycle');
    
    // ç›‘å¬æ¶ˆæ¯
    channel.addEventListener('message', (event) => {
      const { type, pageId, reason } = event.data;
      
      if (type === 'PAGE_OPENED') {
        log(`é¡µé¢ ${pageId} å·²æ‰“å¼€`);
      } else if (type === 'PAGE_CLOSED') {
        log(`é¡µé¢ ${pageId} å·²å…³é—­ï¼š${reason}`);
      } else if (type === 'HEARTBEAT') {
        log(`é¡µé¢ ${pageId} å¿ƒè·³`);
      }
    });
    
    document.getElementById('openB').addEventListener('click', () => {
      window.open('pageB.html', '_blank');
    });
    
    function log(message) {
      const p = document.createElement('p');
      p.textContent = new Date().toLocaleTimeString() + ' - ' + message;
      document.getElementById('log').appendChild(p);
    }
  </script>
</body>
</html>

<!-- ============================================ -->
<!-- é¡µé¢B -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢B</title>
</head>
<body>
  <h1>é¡µé¢B</h1>
  <button id="close">å…³é—­</button>
  
  <script>
    const pageId = 'page-' + Date.now();
    const channel = new BroadcastChannel('page-lifecycle');
    
    // é€šçŸ¥æ‰“å¼€
    channel.postMessage({
      type: 'PAGE_OPENED',
      pageId: pageId,
      timestamp: Date.now()
    });
    
    // æ­£å¸¸å…³é—­æ—¶é€šçŸ¥
    window.addEventListener('beforeunload', () => {
      channel.postMessage({
        type: 'PAGE_CLOSED',
        pageId: pageId,
        reason: 'ç”¨æˆ·å…³é—­',
        timestamp: Date.now()
      });
    });
    
    // å…³é—­æŒ‰é’®
    document.getElementById('close').addEventListener('click', () => {
      window.close();
    });
  </script>
</body>
</html>
```

### ä¼˜ç¼ºç‚¹

```javascript
const broadcastChannelSolution = {
  pros: [
    'âœ… ç®€å•æ˜“ç”¨',
    'âœ… ç°ä»£æµè§ˆå™¨åŸç”Ÿæ”¯æŒ',
    'âœ… åŒæºæ‰€æœ‰é¡µé¢éƒ½èƒ½æ”¶åˆ°',
    'âœ… ä¸éœ€è¦è½®è¯¢'
  ],
  
  cons: [
    'âŒ å´©æºƒæ—¶æ— æ³•é€šçŸ¥',
    'âŒ å…¼å®¹æ€§ä¸€èˆ¬ï¼ˆIE ä¸æ”¯æŒï¼‰',
    'âŒ åªèƒ½åŒæº'
  ]
};
```

---

## 3ï¸âƒ£ æ–¹æ¡ˆ3ï¼šlocalStorage + å¿ƒè·³æ£€æµ‹ï¼ˆæœ€å¯é ï¼‰

### åŸç†

é¡µé¢Bå®šæœŸå‘é€å¿ƒè·³åˆ° localStorageï¼Œé¡µé¢Aç›‘å¬å¿ƒè·³ï¼Œè¶…æ—¶åˆ™è®¤ä¸ºBå·²å…³é—­ã€‚

### å®Œæ•´å®ç°

```html
<!-- ============================================ -->
<!-- é¡µé¢Aï¼šç›‘å¬è€… -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢A</title>
</head>
<body>
  <h1>é¡µé¢A</h1>
  <button id="openB">æ‰“å¼€é¡µé¢B</button>
  <div id="status"></div>
  <div id="log"></div>
  
  <script>
    class PageMonitor {
      constructor() {
        this.pages = new Map();  // å­˜å‚¨æ‰€æœ‰å­é¡µé¢çš„çŠ¶æ€
        this.checkInterval = null;
        this.heartbeatTimeout = 3000;  // 3ç§’æ— å¿ƒè·³è§†ä¸ºå…³é—­
        
        this.startMonitoring();
      }
      
      startMonitoring() {
        // ç›‘å¬ storage äº‹ä»¶ï¼ˆå…¶ä»–é¡µé¢ä¿®æ”¹ localStorageï¼‰
        window.addEventListener('storage', (e) => {
          if (e.key && e.key.startsWith('page-heartbeat-')) {
            const pageId = e.key.replace('page-heartbeat-', '');
            const data = JSON.parse(e.newValue || '{}');
            
            console.log('æ”¶åˆ°é¡µé¢å¿ƒè·³:', pageId, data);
            this.updateHeartbeat(pageId, data);
          }
          
          if (e.key && e.key.startsWith('page-closed-')) {
            const pageId = e.key.replace('page-closed-', '');
            const reason = e.newValue;
            
            console.log('é¡µé¢ä¸»åŠ¨å…³é—­:', pageId, reason);
            this.handlePageClosed(pageId, reason);
          }
        });
        
        // å®šæœŸæ£€æŸ¥å¿ƒè·³è¶…æ—¶
        this.checkInterval = setInterval(() => {
          this.checkHeartbeats();
        }, 1000);
      }
      
      updateHeartbeat(pageId, data) {
        const now = Date.now();
        
        if (!this.pages.has(pageId)) {
          this.log(`ğŸ“„ é¡µé¢ ${pageId} å·²æ‰“å¼€`);
        }
        
        this.pages.set(pageId, {
          lastHeartbeat: now,
          data: data
        });
        
        this.updateStatus();
      }
      
      checkHeartbeats() {
        const now = Date.now();
        
        this.pages.forEach((info, pageId) => {
          const timeSinceLastHeartbeat = now - info.lastHeartbeat;
          
          if (timeSinceLastHeartbeat > this.heartbeatTimeout) {
            console.log(`ğŸ’” é¡µé¢ ${pageId} å¿ƒè·³è¶…æ—¶`);
            this.handlePageClosed(pageId, 'å¿ƒè·³è¶…æ—¶ï¼ˆå¯èƒ½å´©æºƒï¼‰');
          }
        });
      }
      
      handlePageClosed(pageId, reason) {
        if (this.pages.has(pageId)) {
          this.pages.delete(pageId);
          this.log(`âŒ é¡µé¢ ${pageId} å·²å…³é—­ï¼š${reason}`);
          this.updateStatus();
          
          // æ¸…ç† localStorage
          localStorage.removeItem('page-heartbeat-' + pageId);
          localStorage.removeItem('page-closed-' + pageId);
        }
      }
      
      updateStatus() {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = `
          <h3>æ‰“å¼€çš„é¡µé¢æ•°é‡ï¼š${this.pages.size}</h3>
          ${Array.from(this.pages.entries()).map(([id, info]) => `
            <div>é¡µé¢ ${id}ï¼ˆæœ€åå¿ƒè·³ï¼š${new Date(info.lastHeartbeat).toLocaleTimeString()}ï¼‰</div>
          `).join('')}
        `;
      }
      
      log(message) {
        const p = document.createElement('p');
        p.textContent = new Date().toLocaleTimeString() + ' - ' + message;
        document.getElementById('log').prepend(p);
      }
    }
    
    const monitor = new PageMonitor();
    
    document.getElementById('openB').addEventListener('click', () => {
      window.open('pageB.html', '_blank');
    });
  </script>
</body>
</html>

<!-- ============================================ -->
<!-- é¡µé¢Bï¼šå‘é€å¿ƒè·³ -->
<!-- ============================================ -->
<!DOCTYPE html>
<html>
<head>
  <title>é¡µé¢B</title>
</head>
<body>
  <h1>é¡µé¢Bï¼ˆå­é¡µé¢ï¼‰</h1>
  <p>é¡µé¢IDï¼š<span id="pageId"></span></p>
  <button id="close">æ­£å¸¸å…³é—­</button>
  <button id="crash">æ¨¡æ‹Ÿå´©æºƒ</button>
  
  <script>
    class PageHeartbeat {
      constructor() {
        this.pageId = 'page-' + Date.now() + '-' + Math.random().toString(36).substr(2);
        this.heartbeatInterval = null;
        
        document.getElementById('pageId').textContent = this.pageId;
        
        this.startHeartbeat();
        this.setupCloseHandler();
      }
      
      startHeartbeat() {
        // ç«‹å³å‘é€ä¸€æ¬¡
        this.sendHeartbeat();
        
        // æ¯ç§’å‘é€å¿ƒè·³
        this.heartbeatInterval = setInterval(() => {
          this.sendHeartbeat();
        }, 1000);
        
        console.log('ğŸ’“ å¿ƒè·³å·²å¯åŠ¨');
      }
      
      sendHeartbeat() {
        localStorage.setItem('page-heartbeat-' + this.pageId, JSON.stringify({
          timestamp: Date.now(),
          url: location.href
        }));
      }
      
      setupCloseHandler() {
        // æ­£å¸¸å…³é—­æ—¶é€šçŸ¥
        window.addEventListener('beforeunload', () => {
          console.log('é¡µé¢å³å°†å…³é—­');
          
          // åœæ­¢å¿ƒè·³
          clearInterval(this.heartbeatInterval);
          
          // é€šçŸ¥å…³é—­
          localStorage.setItem('page-closed-' + this.pageId, 'æ­£å¸¸å…³é—­');
          
          // æ¸…ç†å¿ƒè·³è®°å½•
          localStorage.removeItem('page-heartbeat-' + this.pageId);
        });
      }
      
      close(reason = 'æ‰‹åŠ¨å…³é—­') {
        localStorage.setItem('page-closed-' + this.pageId, reason);
        clearInterval(this.heartbeatInterval);
        localStorage.removeItem('page-heartbeat-' + this.pageId);
        window.close();
      }
    }
    
    const heartbeat = new PageHeartbeat();
    
    // æ­£å¸¸å…³é—­
    document.getElementById('close').addEventListener('click', () => {
      heartbeat.close('ç”¨æˆ·ç‚¹å‡»å…³é—­');
    });
    
    // æ¨¡æ‹Ÿå´©æºƒï¼ˆæ— æ³•æ‰§è¡Œ beforeunloadï¼‰
    document.getElementById('crash').addEventListener('click', () => {
      // ç›´æ¥å´©æºƒï¼Œå¿ƒè·³åœæ­¢
      // é¡µé¢A ä¼šåœ¨ 3 ç§’åæ£€æµ‹åˆ°å¿ƒè·³è¶…æ—¶
      while(true) {}  // é¡µé¢å¡æ­»
    });
  </script>
</body>
</html>
```

### ä¼˜ç¼ºç‚¹

```javascript
const heartbeatSolution = {
  pros: [
    'âœ… å¯ä»¥æ£€æµ‹å´©æºƒï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰',
    'âœ… å…¼å®¹æ€§å¥½',
    'âœ… å¯é æ€§é«˜',
    'âœ… å¯ä»¥ä¼ é€’é¢å¤–ä¿¡æ¯'
  ],
  
  cons: [
    'âš ï¸ éœ€è¦å®šæœŸå‘é€å¿ƒè·³ï¼ˆè½»å¾®æ€§èƒ½å¼€é”€ï¼‰',
    'âš ï¸ æ£€æµ‹å»¶è¿Ÿï¼ˆå¿ƒè·³é—´éš” + è¶…æ—¶æ—¶é—´ï¼‰',
    'âŒ åªèƒ½åŒæº'
  ],
  
  recommendation: 'â­â­â­â­â­ æœ€æ¨èï¼ˆå¯æ£€æµ‹å´©æºƒï¼‰'
};
```

---

## 4ï¸âƒ£ æ–¹æ¡ˆ4ï¼šBroadcastChannel + å¿ƒè·³ï¼ˆæ¨èï¼‰

### ç»„åˆæ–¹æ¡ˆ

```javascript
// ============================================
// é¡µé¢Aï¼šç›‘å¬
// ============================================
class PageLifecycleMonitor {
  constructor() {
    this.channel = new BroadcastChannel('page-lifecycle');
    this.pages = new Map();
    
    this.setupListeners();
    this.startHeartbeatCheck();
  }
  
  setupListeners() {
    this.channel.addEventListener('message', (event) => {
      const { type, pageId, data } = event.data;
      
      switch (type) {
        case 'OPENED':
          this.handlePageOpened(pageId, data);
          break;
        case 'CLOSED':
          this.handlePageClosed(pageId, data.reason);
          break;
        case 'HEARTBEAT':
          this.handleHeartbeat(pageId, data);
          break;
      }
    });
  }
  
  handlePageOpened(pageId, data) {
    console.log('ğŸ“„ é¡µé¢æ‰“å¼€:', pageId);
    this.pages.set(pageId, {
      openedAt: Date.now(),
      lastHeartbeat: Date.now(),
      data: data
    });
  }
  
  handlePageClosed(pageId, reason) {
    console.log('âŒ é¡µé¢å…³é—­:', pageId, reason);
    this.pages.delete(pageId);
  }
  
  handleHeartbeat(pageId, data) {
    if (this.pages.has(pageId)) {
      this.pages.get(pageId).lastHeartbeat = Date.now();
    } else {
      // é¦–æ¬¡æ”¶åˆ°å¿ƒè·³ï¼Œæ·»åŠ é¡µé¢
      this.pages.set(pageId, {
        openedAt: Date.now(),
        lastHeartbeat: Date.now(),
        data: data
      });
    }
  }
  
  startHeartbeatCheck() {
    setInterval(() => {
      const now = Date.now();
      
      this.pages.forEach((info, pageId) => {
        const silence = now - info.lastHeartbeat;
        
        if (silence > 3000) {  // 3ç§’æ— å¿ƒè·³
          console.log('ğŸ’” é¡µé¢å¿ƒè·³è¶…æ—¶ï¼ˆå¯èƒ½å´©æºƒï¼‰:', pageId);
          this.handlePageClosed(pageId, 'å¿ƒè·³è¶…æ—¶');
        }
      });
    }, 1000);
  }
  
  getOpenPages() {
    return Array.from(this.pages.keys());
  }
}

const monitor = new PageLifecycleMonitor();

// ============================================
// é¡µé¢Bï¼šå‘é€å¿ƒè·³å’Œé€šçŸ¥
// ============================================
class PageLifecycle {
  constructor() {
    this.pageId = 'page-' + Date.now();
    this.channel = new BroadcastChannel('page-lifecycle');
    this.heartbeatTimer = null;
    
    this.notifyOpened();
    this.startHeartbeat();
    this.setupCloseHandler();
  }
  
  notifyOpened() {
    this.channel.postMessage({
      type: 'OPENED',
      pageId: this.pageId,
      data: {
        url: location.href,
        timestamp: Date.now()
      }
    });
  }
  
  startHeartbeat() {
    this.heartbeatTimer = setInterval(() => {
      this.channel.postMessage({
        type: 'HEARTBEAT',
        pageId: this.pageId,
        data: {
          timestamp: Date.now()
        }
      });
    }, 1000);  // æ¯ç§’ä¸€æ¬¡
  }
  
  setupCloseHandler() {
    window.addEventListener('beforeunload', () => {
      clearInterval(this.heartbeatTimer);
      
      this.channel.postMessage({
        type: 'CLOSED',
        pageId: this.pageId,
        data: {
          reason: 'æ­£å¸¸å…³é—­',
          timestamp: Date.now()
        }
      });
    });
  }
}

const lifecycle = new PageLifecycle();
```

---

## 5ï¸âƒ£ æ–¹æ¡ˆ5ï¼šè½®è¯¢æ£€æµ‹ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰

### ä½¿ç”¨ window.closed å±æ€§

```javascript
// ============================================
// é¡µé¢Aï¼šè½®è¯¢æ£€æŸ¥
// ============================================
class PageBMonitor {
  constructor() {
    this.childWindows = [];
  }
  
  openPageB() {
    const pageB = window.open('pageB.html', '_blank');
    
    if (pageB) {
      const pageInfo = {
        window: pageB,
        id: 'page-' + Date.now(),
        openedAt: Date.now()
      };
      
      this.childWindows.push(pageInfo);
      console.log('âœ… é¡µé¢Bå·²æ‰“å¼€:', pageInfo.id);
      
      // å¼€å§‹ç›‘æ§è¿™ä¸ªé¡µé¢
      this.monitorPage(pageInfo);
    }
  }
  
  monitorPage(pageInfo) {
    const checkInterval = setInterval(() => {
      if (pageInfo.window.closed) {
        console.log('âŒ é¡µé¢Bå·²å…³é—­:', pageInfo.id);
        
        // ä»åˆ—è¡¨ä¸­ç§»é™¤
        const index = this.childWindows.indexOf(pageInfo);
        if (index > -1) {
          this.childWindows.splice(index, 1);
        }
        
        // åœæ­¢ç›‘æ§
        clearInterval(checkInterval);
        
        // è§¦å‘å›è°ƒ
        this.onPageClosed?.(pageInfo.id);
      }
    }, 500);  // æ¯ 500ms æ£€æŸ¥ä¸€æ¬¡
  }
  
  onPageClosed(pageId) {
    console.log('é¡µé¢å…³é—­å›è°ƒ:', pageId);
    alert('é¡µé¢ ' + pageId + ' å·²å…³é—­');
  }
}

const monitor = new PageBMonitor();

document.getElementById('openB').addEventListener('click', () => {
  monitor.openPageB();
});
```

### ä¼˜ç¼ºç‚¹

```javascript
const pollingSource = {
  pros: [
    'âœ… å¯ä»¥æ£€æµ‹å´©æºƒï¼ˆclosed å±æ€§ä¼šå˜ä¸º trueï¼‰',
    'âœ… å…¼å®¹æ€§æå¥½',
    'âœ… å®ç°ç®€å•'
  ],
  
  cons: [
    'âŒ éœ€è¦è½®è¯¢ï¼ˆæ€§èƒ½å¼€é”€ï¼‰',
    'âŒ æ£€æµ‹å»¶è¿Ÿï¼ˆè½®è¯¢é—´éš”ï¼‰',
    'âŒ éœ€è¦ä¿æŒ window å¼•ç”¨'
  ]
};
```

---

## ğŸ¯ ç»¼åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

### ç»„åˆå¤šç§æ–¹æ³•

```javascript
/**
 * ç»¼åˆæ–¹æ¡ˆï¼šBroadcastChannel + å¿ƒè·³ + window.closed è½®è¯¢
 * 
 * ä¼˜ç‚¹ï¼š
 * - æ­£å¸¸å…³é—­ï¼šBroadcastChannel ç«‹å³é€šçŸ¥ï¼ˆ0 å»¶è¿Ÿï¼‰
 * - æ„å¤–å´©æºƒï¼šå¿ƒè·³è¶…æ—¶æ£€æµ‹ï¼ˆ3 ç§’å»¶è¿Ÿï¼‰
 * - é™çº§æ”¯æŒï¼šè½®è¯¢ window.closedï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
 */

class RobustPageMonitor {
  constructor() {
    this.pages = new Map();
    this.childWindows = [];
    
    // ä¼˜å…ˆä½¿ç”¨ BroadcastChannel
    if ('BroadcastChannel' in window) {
      this.channel = new BroadcastChannel('page-lifecycle');
      this.setupBroadcastChannel();
    } else {
      console.warn('BroadcastChannel ä¸æ”¯æŒï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');
    }
    
    // å¯åŠ¨å¿ƒè·³æ£€æŸ¥ï¼ˆæ£€æµ‹å´©æºƒï¼‰
    this.startHeartbeatCheck();
  }
  
  setupBroadcastChannel() {
    this.channel.addEventListener('message', (event) => {
      const { type, pageId, data } = event.data;
      
      switch (type) {
        case 'OPENED':
          this.onPageOpened(pageId, data);
          break;
        case 'CLOSED':
          this.onPageClosed(pageId, data?.reason || 'æ­£å¸¸å…³é—­');
          break;
        case 'HEARTBEAT':
          this.onHeartbeat(pageId);
          break;
      }
    });
  }
  
  startHeartbeatCheck() {
    setInterval(() => {
      const now = Date.now();
      
      this.pages.forEach((info, pageId) => {
        const silence = now - info.lastHeartbeat;
        
        if (silence > 3000) {
          console.log('ğŸ’” æ£€æµ‹åˆ°å´©æºƒ:', pageId);
          this.onPageClosed(pageId, 'å´©æºƒæˆ–æ— å“åº”');
        }
      });
      
      // æ£€æŸ¥ window.closedï¼ˆé™çº§æ–¹æ¡ˆï¼‰
      this.childWindows.forEach((win, index) => {
        if (win.closed) {
          console.log('ğŸ” è½®è¯¢æ£€æµ‹åˆ°å…³é—­');
          const pageId = 'window-' + index;
          this.onPageClosed(pageId, 'æ£€æµ‹åˆ° closed');
          this.childWindows.splice(index, 1);
        }
      });
    }, 1000);
  }
  
  openPage(url) {
    const win = window.open(url, '_blank');
    
    if (win) {
      this.childWindows.push(win);
      console.log('âœ… é¡µé¢å·²æ‰“å¼€');
    }
  }
  
  onPageOpened(pageId, data) {
    console.log('ğŸ“„ é¡µé¢æ‰“å¼€:', pageId);
    this.pages.set(pageId, {
      openedAt: Date.now(),
      lastHeartbeat: Date.now(),
      data: data
    });
  }
  
  onPageClosed(pageId, reason) {
    console.log('âŒ é¡µé¢å…³é—­:', pageId, reason);
    this.pages.delete(pageId);
    
    // ä¸šåŠ¡é€»è¾‘
    this.handleBusinessLogic(pageId, reason);
  }
  
  onHeartbeat(pageId) {
    if (this.pages.has(pageId)) {
      this.pages.get(pageId).lastHeartbeat = Date.now();
    }
  }
  
  handleBusinessLogic(pageId, reason) {
    // è¿™é‡Œå¤„ç†é¡µé¢å…³é—­åçš„ä¸šåŠ¡é€»è¾‘
    console.log('å¤„ç†ä¸šåŠ¡é€»è¾‘:', pageId, reason);
    
    // ç¤ºä¾‹ï¼š
    // - æ¸…ç†ç›¸å…³èµ„æº
    // - æ›´æ–°UIçŠ¶æ€
    // - ä¿å­˜æ•°æ®
    // - é€šçŸ¥ç”¨æˆ·
  }
}

// ä½¿ç”¨
const monitor = new RobustPageMonitor();

document.getElementById('openB').addEventListener('click', () => {
  monitor.openPage('pageB.html');
});
```

---

## ğŸ“± å…¶ä»–é€šä¿¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ6ï¼šSharedWorkerï¼ˆé«˜çº§ï¼‰

```javascript
// ============================================
// shared-worker.js
// ============================================
const connections = [];

self.addEventListener('connect', (e) => {
  const port = e.ports[0];
  connections.push(port);
  
  console.log('æ–°è¿æ¥ï¼Œå½“å‰è¿æ¥æ•°:', connections.length);
  
  port.addEventListener('message', (event) => {
    const { type, pageId } = event.data;
    
    if (type === 'CLOSED') {
      // å¹¿æ’­ç»™æ‰€æœ‰å…¶ä»–é¡µé¢
      connections.forEach(conn => {
        if (conn !== port) {
          conn.postMessage({
            type: 'PAGE_CLOSED',
            pageId: pageId
          });
        }
      });
      
      // ç§»é™¤è¿æ¥
      const index = connections.indexOf(port);
      if (index > -1) {
        connections.splice(index, 1);
      }
    }
  });
  
  port.start();
  
  // è¿æ¥æ–­å¼€æ—¶ï¼ˆé¡µé¢å…³é—­æˆ–å´©æºƒï¼‰
  // æ³¨æ„ï¼šSharedWorker æ— æ³•å¯é æ£€æµ‹è¿æ¥æ–­å¼€
});

// ============================================
// é¡µé¢ä½¿ç”¨ SharedWorker
// ============================================
const worker = new SharedWorker('shared-worker.js');

worker.port.addEventListener('message', (event) => {
  if (event.data.type === 'PAGE_CLOSED') {
    console.log('å…¶ä»–é¡µé¢å…³é—­:', event.data.pageId);
  }
});

worker.port.start();

// å…³é—­æ—¶é€šçŸ¥
window.addEventListener('beforeunload', () => {
  worker.port.postMessage({
    type: 'CLOSED',
    pageId: myPageId
  });
});
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### æ¨èæ–¹æ¡ˆï¼šBroadcastChannel + å¿ƒè·³

```javascript
/**
 * å®Œæ•´çš„ç”Ÿäº§çº§å®ç°
 */

// ============================================
// utils/page-monitor.jsï¼ˆå¯å¤ç”¨ï¼‰
// ============================================
export class PageMonitor {
  constructor(options = {}) {
    this.heartbeatInterval = options.heartbeatInterval || 1000;
    this.heartbeatTimeout = options.heartbeatTimeout || 3000;
    this.onPageOpened = options.onPageOpened || (() => {});
    this.onPageClosed = options.onPageClosed || (() => {});
    
    this.pages = new Map();
    this.channel = new BroadcastChannel('page-lifecycle');
    
    this.init();
  }
  
  init() {
    // ç›‘å¬å¹¿æ’­
    this.channel.addEventListener('message', (e) => {
      this.handleMessage(e.data);
    });
    
    // æ£€æŸ¥å¿ƒè·³
    setInterval(() => this.checkHeartbeats(), 1000);
  }
  
  handleMessage(data) {
    const { type, pageId, payload } = data;
    
    if (type === 'OPENED') {
      this.pages.set(pageId, {
        ...payload,
        lastHeartbeat: Date.now()
      });
      this.onPageOpened(pageId, payload);
    } else if (type === 'CLOSED') {
      this.pages.delete(pageId);
      this.onPageClosed(pageId, payload.reason);
    } else if (type === 'HEARTBEAT') {
      if (this.pages.has(pageId)) {
        this.pages.get(pageId).lastHeartbeat = Date.now();
      }
    }
  }
  
  checkHeartbeats() {
    const now = Date.now();
    
    this.pages.forEach((info, pageId) => {
      if (now - info.lastHeartbeat > this.heartbeatTimeout) {
        this.pages.delete(pageId);
        this.onPageClosed(pageId, 'å¿ƒè·³è¶…æ—¶ï¼ˆå´©æºƒï¼‰');
      }
    });
  }
  
  getOpenPages() {
    return Array.from(this.pages.keys());
  }
}

// ============================================
// utils/page-lifecycle.jsï¼ˆå¯å¤ç”¨ï¼‰
// ============================================
export class PageLifecycle {
  constructor(pageId = 'page-' + Date.now()) {
    this.pageId = pageId;
    this.channel = new BroadcastChannel('page-lifecycle');
    
    this.init();
  }
  
  init() {
    // é€šçŸ¥æ‰“å¼€
    this.broadcast('OPENED', {
      url: location.href,
      timestamp: Date.now()
    });
    
    // å‘é€å¿ƒè·³
    this.heartbeatTimer = setInterval(() => {
      this.broadcast('HEARTBEAT');
    }, 1000);
    
    // å…³é—­æ—¶é€šçŸ¥
    window.addEventListener('beforeunload', () => {
      clearInterval(this.heartbeatTimer);
      this.broadcast('CLOSED', { reason: 'æ­£å¸¸å…³é—­' });
    });
  }
  
  broadcast(type, payload = {}) {
    this.channel.postMessage({
      type,
      pageId: this.pageId,
      payload
    });
  }
}

// ============================================
// é¡µé¢A ä½¿ç”¨
// ============================================
import { PageMonitor } from './utils/page-monitor.js';

const monitor = new PageMonitor({
  onPageOpened: (pageId) => {
    console.log('æ–°é¡µé¢æ‰“å¼€:', pageId);
    updateUI();
  },
  
  onPageClosed: (pageId, reason) => {
    console.log('é¡µé¢å…³é—­:', pageId, reason);
    updateUI();
    
    // ä¸šåŠ¡é€»è¾‘
    if (reason.includes('å´©æºƒ')) {
      alert('æ£€æµ‹åˆ°é¡µé¢å´©æºƒ');
    }
  }
});

// ============================================
// é¡µé¢B ä½¿ç”¨
// ============================================
import { PageLifecycle } from './utils/page-lifecycle.js';

const lifecycle = new PageLifecycle();
```

---

## ğŸ“‹ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ­£å¸¸å…³é—­**
   - ä½¿ç”¨ `beforeunload` äº‹ä»¶
   - é€šè¿‡ BroadcastChannel æˆ– localStorage é€šçŸ¥
   - å»¶è¿Ÿ < 100ms

2. **æ„å¤–å´©æºƒ**
   - beforeunload ä¸ä¼šè§¦å‘
   - å¿…é¡»ä½¿ç”¨å¿ƒè·³æ£€æµ‹
   - å»¶è¿Ÿ = å¿ƒè·³é—´éš” + è¶…æ—¶æ—¶é—´ï¼ˆçº¦ 3-5 ç§’ï¼‰

3. **æ£€æµ‹æ–¹æ³•**
   - window.closed è½®è¯¢ï¼ˆæœ€ç®€å•ï¼Œå¯æ£€æµ‹å´©æºƒï¼‰
   - å¿ƒè·³è¶…æ—¶æ£€æµ‹ï¼ˆæœ€å¯é ï¼Œå¯æ£€æµ‹å´©æºƒï¼‰
   - BroadcastChannelï¼ˆæœ€ç°ä»£ï¼Œæ— æ³•æ£€æµ‹å´©æºƒï¼‰

### æ¨èæ–¹æ¡ˆ

```javascript
// æœ€ä½³ç»„åˆï¼šBroadcastChannel + å¿ƒè·³
const recommendation = {
  normal: 'BroadcastChannel ç«‹å³é€šçŸ¥ï¼ˆ0 å»¶è¿Ÿï¼‰',
  crash: 'å¿ƒè·³è¶…æ—¶æ£€æµ‹ï¼ˆ3ç§’å»¶è¿Ÿï¼‰',
  fallback: 'window.closed è½®è¯¢ï¼ˆå…¼å®¹æ€§ï¼‰',
  
  implementation: 'PageMonitor + PageLifecycle ç±»'
};
```

### å®æ–½å»ºè®®

1. ä½¿ç”¨ BroadcastChannelï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
2. æ·»åŠ å¿ƒè·³æœºåˆ¶ï¼ˆæ£€æµ‹å´©æºƒï¼‰
3. å¿ƒè·³é—´éš”ï¼š1 ç§’
4. è¶…æ—¶åˆ¤å®šï¼š3 ç§’
5. é™çº§æ–¹æ¡ˆï¼šlocalStorage + storage äº‹ä»¶

æ–‡æ¡£ä½ç½®ï¼š`é¡µé¢é—´é€šä¿¡-ç›‘å¬å…³é—­.md`

åŒ…å«ï¼š6ç§æ–¹æ¡ˆã€å®Œæ•´ä»£ç ã€ä¼˜ç¼ºç‚¹å¯¹æ¯”ã€æœ€ä½³å®è·µï¼ğŸ‰
