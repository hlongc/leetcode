# SharedWorker æ¼”ç¤ºæ–‡æ¡£

## ğŸ¯ ä»€ä¹ˆæ˜¯ SharedWorkerï¼Ÿ

**SharedWorker** æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Web Workerï¼Œå¯ä»¥è¢«å¤šä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆæ ‡ç­¾é¡µã€iframeã€çª—å£ï¼‰åŒæ—¶è®¿é—®å’Œå…±äº«ã€‚

### ä¸æ™®é€š Worker çš„åŒºåˆ«

| ç‰¹æ€§     | Worker             | SharedWorker           |
| -------- | ------------------ | ---------------------- |
| ä½œç”¨åŸŸ   | å•ä¸ªé¡µé¢           | å¤šä¸ªé¡µé¢/æ ‡ç­¾é¡µ        |
| ç”Ÿå‘½å‘¨æœŸ | éšé¡µé¢å…³é—­è€Œç»“æŸ   | æœ€åä¸€ä¸ªè¿æ¥æ–­å¼€åç»“æŸ |
| é€šä¿¡     | ç›´æ¥æ¶ˆæ¯ä¼ é€’       | é€šè¿‡ç«¯å£ (MessagePort) |
| ä½¿ç”¨åœºæ™¯ | å•é¡µé¢è®¡ç®—å¯†é›†ä»»åŠ¡ | è·¨æ ‡ç­¾é¡µæ•°æ®å…±äº«       |

## ğŸ“‹ ä½¿ç”¨åœºæ™¯

### 1. **è·¨æ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥**

- å¤šä¸ªæ ‡ç­¾é¡µå…±äº«ç™»å½•çŠ¶æ€
- åŒæ­¥è´­ç‰©è½¦æ•°æ®
- å®æ—¶æ›´æ–°é€šçŸ¥æ•°é‡

### 2. **å‡å°‘èµ„æºå ç”¨**

- å¤šä¸ªæ ‡ç­¾é¡µå…±äº«åŒä¸€ä¸ª WebSocket è¿æ¥
- å…±äº«ç¼“å­˜æ•°æ®
- é¿å…é‡å¤çš„ç½‘ç»œè¯·æ±‚

### 3. **è·¨æ ‡ç­¾é¡µé€šä¿¡**

- æ ‡ç­¾é¡µä¹‹é—´å‘é€æ¶ˆæ¯
- åè°ƒå¤šä¸ªé¡µé¢çš„æ“ä½œ
- å¹¿æ’­äº‹ä»¶åˆ°æ‰€æœ‰é¡µé¢

## ğŸš€ æ¼”ç¤ºåŠŸèƒ½

æœ¬æ¼”ç¤ºåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. **å…±äº«è®¡æ•°å™¨**

- âœ… åœ¨ä»»æ„æ ‡ç­¾é¡µä¸­ä¿®æ”¹è®¡æ•°å™¨
- âœ… æ‰€æœ‰æ ‡ç­¾é¡µå®æ—¶åŒæ­¥
- âœ… æ˜¾ç¤ºæ˜¯è°ä¿®æ”¹äº†è®¡æ•°å™¨

### 2. **è·¨æ ‡ç­¾é¡µæ¶ˆæ¯**

- âœ… åœ¨ä»»æ„æ ‡ç­¾é¡µå‘é€æ¶ˆæ¯
- âœ… æ‰€æœ‰æ ‡ç­¾é¡µå®æ—¶æ¥æ”¶
- âœ… åŒºåˆ†è‡ªå·±å’Œä»–äººçš„æ¶ˆæ¯

### 3. **è¿æ¥ç»Ÿè®¡**

- âœ… æ˜¾ç¤ºå½“å‰æ´»è·ƒæ ‡ç­¾é¡µæ•°é‡
- âœ… è®°å½•æ¶ˆæ¯æ€»æ•°
- âœ… å®æ—¶äº‹ä»¶æ—¥å¿—

## ğŸ’» å¦‚ä½•ä½¿ç”¨

### æ­¥éª¤ 1ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
cd /Users/hulongchao/Documents/code/2025/leetcode/question/ES5/socket
node server.js
```

### æ­¥éª¤ 2ï¼šæ‰“å¼€é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š

```
http://localhost:3000/shared-worker-demo.html
```

### æ­¥éª¤ 3ï¼šæ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µ

1. å¤åˆ¶å½“å‰é¡µé¢ URL
2. æŒ‰ `Ctrl+T` (Windows) æˆ– `Cmd+T` (Mac) æ‰“å¼€æ–°æ ‡ç­¾é¡µ
3. ç²˜è´´ URL å¹¶æ‰“å¼€
4. é‡å¤æ­¥éª¤ï¼Œæ‰“å¼€ 3-5 ä¸ªæ ‡ç­¾é¡µ

### æ­¥éª¤ 4ï¼šä½“éªŒåŠŸèƒ½

1. **æµ‹è¯•è®¡æ•°å™¨**ï¼šåœ¨ä»»æ„æ ‡ç­¾é¡µç‚¹å‡» "å¢åŠ " æˆ– "å‡å°‘"
2. **å‘é€æ¶ˆæ¯**ï¼šåœ¨è¾“å…¥æ¡†è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
3. **è§‚å¯ŸåŒæ­¥**ï¼šåˆ‡æ¢æ ‡ç­¾é¡µï¼Œçœ‹æ‰€æœ‰æ•°æ®å®æ—¶åŒæ­¥

## ğŸ”§ æŠ€æœ¯å®ç°

### SharedWorker è„šæœ¬ (shared-worker.js)

```javascript
// ç›‘å¬è¿æ¥
self.onconnect = (e) => {
  const port = e.ports[0];

  // ç›‘å¬æ¶ˆæ¯
  port.onmessage = (event) => {
    // å¤„ç†æ¶ˆæ¯
  };

  // å¯åŠ¨ç«¯å£
  port.start();
};
```

### å®¢æˆ·ç«¯ä»£ç  (HTML)

```javascript
// åˆ›å»º SharedWorker
const worker = new SharedWorker("shared-worker.js");
const port = worker.port;

// å¯åŠ¨ç«¯å£
port.start();

// ç›‘å¬æ¶ˆæ¯
port.onmessage = (event) => {
  console.log("æ”¶åˆ°æ¶ˆæ¯:", event.data);
};

// å‘é€æ¶ˆæ¯
port.postMessage({ type: "increment" });
```

## ğŸ“ å…³é”®æ¦‚å¿µ

### 1. **MessagePort**

SharedWorker ä½¿ç”¨ MessagePort è¿›è¡Œé€šä¿¡ï¼Œæ¯ä¸ªè¿æ¥éƒ½æœ‰ç‹¬ç«‹çš„ç«¯å£ã€‚

### 2. **å¹¿æ’­æ¶ˆæ¯**

SharedWorker éœ€è¦ç»´æŠ¤æ‰€æœ‰ç«¯å£çš„åˆ—è¡¨ï¼Œæ‰èƒ½å‘æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯ã€‚

```javascript
const ports = [];

self.onconnect = (e) => {
  const port = e.ports[0];
  ports.push(port);

  // å¹¿æ’­å‡½æ•°
  function broadcast(message) {
    ports.forEach((p) => p.postMessage(message));
  }
};
```

### 3. **ç”Ÿå‘½å‘¨æœŸ**

- SharedWorker åœ¨ç¬¬ä¸€ä¸ªè¿æ¥å»ºç«‹æ—¶åˆ›å»º
- åœ¨æœ€åä¸€ä¸ªè¿æ¥æ–­å¼€åè‡ªåŠ¨é”€æ¯
- ä¸èƒ½ä¸»åŠ¨æ£€æµ‹ç«¯å£æ–­å¼€ï¼ˆéœ€è¦å¿ƒè·³æœºåˆ¶ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **æµè§ˆå™¨æ”¯æŒ**

- âœ… Chrome/Edge
- âœ… Firefox
- âŒ Safari (éƒ¨åˆ†æ”¯æŒ)
- âŒ IE (ä¸æ”¯æŒ)

### 2. **åŒæºç­–ç•¥**

SharedWorker åªèƒ½åœ¨åŒæºçš„é¡µé¢ä¹‹é—´å…±äº«ï¼ˆç›¸åŒåè®®ã€åŸŸåã€ç«¯å£ï¼‰ã€‚

### 3. **è°ƒè¯•**

Chrome DevTools ä¸­æŸ¥çœ‹ SharedWorkerï¼š

1. æ‰“å¼€ `chrome://inspect/#workers`
2. æ‰¾åˆ°å¯¹åº”çš„ SharedWorker
3. ç‚¹å‡» "inspect" è¿›è¡Œè°ƒè¯•

### 4. **ç«¯å£å¿…é¡»å¯åŠ¨**

å¿…é¡»è°ƒç”¨ `port.start()` æ‰èƒ½æ¥æ”¶æ¶ˆæ¯ã€‚

## ğŸ¨ å®é™…åº”ç”¨ç¤ºä¾‹

### 1. **å…±äº« WebSocket è¿æ¥**

```javascript
// SharedWorker ä¸­ç»´æŠ¤ä¸€ä¸ª WebSocket è¿æ¥
let ws = new WebSocket("ws://localhost:3000");

self.onconnect = (e) => {
  const port = e.ports[0];

  // è½¬å‘ WebSocket æ¶ˆæ¯åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
  ws.onmessage = (msg) => {
    port.postMessage(msg.data);
  };

  // æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯å¹¶å‘é€åˆ° WebSocket
  port.onmessage = (e) => {
    ws.send(e.data);
  };
};
```

### 2. **è·¨æ ‡ç­¾é¡µç™»å½•çŠ¶æ€**

```javascript
// ä¸€ä¸ªæ ‡ç­¾é¡µç™»å½•åï¼Œé€šçŸ¥æ‰€æœ‰æ ‡ç­¾é¡µ
port.postMessage({ type: "login", user: userData });

// ä¸€ä¸ªæ ‡ç­¾é¡µé€€å‡ºåï¼Œæ‰€æœ‰æ ‡ç­¾é¡µéƒ½é€€å‡º
port.postMessage({ type: "logout" });
```

### 3. **èµ„æºç¼“å­˜å…±äº«**

```javascript
// SharedWorker ä¸­ç»´æŠ¤ç¼“å­˜
const cache = new Map();

port.onmessage = (e) => {
  if (e.data.type === "get") {
    port.postMessage(cache.get(e.data.key));
  } else if (e.data.type === "set") {
    cache.set(e.data.key, e.data.value);
  }
};
```

## ğŸ†š å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆ

| æ–¹æ¡ˆ                        | ä¼˜ç‚¹                         | ç¼ºç‚¹                 |
| --------------------------- | ---------------------------- | -------------------- |
| SharedWorker                | çœŸæ­£çš„è·¨æ ‡ç­¾é¡µé€šä¿¡ï¼Œç‹¬ç«‹çº¿ç¨‹ | æµè§ˆå™¨æ”¯æŒæœ‰é™       |
| localStorage + storage äº‹ä»¶ | å…¼å®¹æ€§å¥½                     | åªèƒ½åœ¨æ•°æ®å˜åŒ–æ—¶è§¦å‘ |
| BroadcastChannel            | ç®€å•æ˜“ç”¨                     | Safari ä¸æ”¯æŒ        |
| Service Worker              | åŠŸèƒ½å¼ºå¤§ï¼Œå¯ç¦»çº¿             | ä¸»è¦ç”¨äºç¼“å­˜å’Œæ¨é€   |

## ğŸ”— ç›¸å…³èµ„æº

- [MDN - SharedWorker](https://developer.mozilla.org/zh-CN/docs/Web/API/SharedWorker)
- [MDN - Using Web Workers](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)
- [Can I use - SharedWorker](https://caniuse.com/sharedworkers)

## ğŸ“ æ€»ç»“

SharedWorker æ˜¯å®ç°è·¨æ ‡ç­¾é¡µé€šä¿¡å’Œæ•°æ®å…±äº«çš„å¼ºå¤§å·¥å…·ï¼Œç‰¹åˆ«é€‚åˆï¼š

- éœ€è¦åœ¨å¤šä¸ªæ ‡ç­¾é¡µä¹‹é—´åŒæ­¥çŠ¶æ€
- éœ€è¦å‡å°‘èµ„æºå ç”¨ï¼ˆå¦‚å…±äº« WebSocketï¼‰
- éœ€è¦åè°ƒå¤šä¸ªé¡µé¢çš„æ“ä½œ

ä½†è¦æ³¨æ„æµè§ˆå™¨å…¼å®¹æ€§ï¼Œå¯¹äºä¸æ”¯æŒçš„æµè§ˆå™¨éœ€è¦æä¾›é™çº§æ–¹æ¡ˆã€‚
