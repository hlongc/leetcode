# SharedWorker ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ç®¡ç† - å®Œæ•´æŒ‡å—

## ğŸ¯ é—®é¢˜åœºæ™¯

**ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå½“ä½ éƒ¨ç½²äº†æ–°ç‰ˆæœ¬çš„ shared-worker.jsï¼š**

- âŒ ç”¨æˆ·ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
- âŒ æ—§ç‰ˆæœ¬ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°æ‰€æœ‰æ ‡ç­¾é¡µå…³é—­
- âŒ å¯èƒ½å¯¼è‡´åŠŸèƒ½å¼‚å¸¸æˆ–æ•°æ®ä¸ä¸€è‡´

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆå·²å®ç°ï¼‰

æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿï¼

### ğŸ“ æ–°å¢æ–‡ä»¶

1. **`worker-config.js`** - ç‰ˆæœ¬é…ç½®æ–‡ä»¶
2. **`shared-worker-production.html`** - å¸¦ç‰ˆæœ¬æ£€æµ‹çš„æ¼”ç¤ºé¡µé¢
3. **`PRODUCTION-UPDATE.md`** - è¯¦ç»†æ–¹æ¡ˆæ–‡æ¡£
4. **`VERSION-MANAGEMENT-GUIDE.md`** - ä½¿ç”¨æŒ‡å—ï¼ˆæœ¬æ–‡ä»¶ï¼‰

### ğŸ”„ å·²ä¿®æ”¹çš„æ–‡ä»¶

1. **`shared-worker.js`**

   - âœ… æ·»åŠ äº†ç‰ˆæœ¬å·å¸¸é‡ `WORKER_VERSION`
   - âœ… æ·»åŠ äº†æ„å»ºæ—¶é—´ `BUILD_TIME`
   - âœ… åˆå§‹åŒ–æ—¶å‘é€ç‰ˆæœ¬ä¿¡æ¯ç»™å®¢æˆ·ç«¯

2. **`server.js`**
   - âœ… æ·»åŠ äº† `/api/worker-version` API ç«¯ç‚¹
   - âœ… è¿”å›å½“å‰éƒ¨ç½²çš„ Worker ç‰ˆæœ¬å·

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
cd /Users/hulongchao/Documents/code/2025/leetcode/question/ES5/socket
node server.js
```

### æ­¥éª¤ 2ï¼šæ‰“å¼€æ¼”ç¤ºé¡µé¢

```
http://localhost:3000/shared-worker-production.html
```

### æ­¥éª¤ 3ï¼šæµ‹è¯•ç‰ˆæœ¬æ›´æ–°

#### 3.1 æ¨¡æ‹Ÿå‘å¸ƒæ–°ç‰ˆæœ¬

æ‰“å¼€ `shared-worker.js`ï¼Œä¿®æ”¹ç‰ˆæœ¬å·ï¼š

```javascript
// shared-worker.jsï¼ˆç¬¬6è¡Œï¼‰
const WORKER_VERSION = "1.0.1"; // ä» 1.0.0 æ”¹ä¸º 1.0.1
```

ä¿å­˜æ–‡ä»¶ã€‚

#### 3.2 æ£€æŸ¥æ›´æ–°

åœ¨é¡µé¢ä¸­ç‚¹å‡» **"ğŸ”„ æ£€æŸ¥æ›´æ–°"** æŒ‰é’®ã€‚

#### 3.3 çœ‹åˆ°æ•ˆæœ

- âœ… é¡µé¢ä¼šå¼¹å‡ºæ›´æ–°æç¤º
- âœ… æ˜¾ç¤ºæ–°æ—§ç‰ˆæœ¬å·å¯¹æ¯”
- âœ… æä¾›"ç«‹å³æ›´æ–°"æŒ‰é’®

#### 3.4 æ›´æ–°åˆ°æ–°ç‰ˆæœ¬

ç‚¹å‡» **"ç«‹å³æ›´æ–°"** æŒ‰é’®ï¼Œé¡µé¢åˆ·æ–°åï¼š

- âœ… è‡ªåŠ¨è¿æ¥åˆ°æ–°ç‰ˆæœ¬çš„ SharedWorker
- âœ… ç‰ˆæœ¬å·æ˜¾ç¤ºä¸º 1.0.1
- âœ… åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### 1. ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º

é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå››ä¸ªå…³é”®ä¿¡æ¯ï¼š

| å­—æ®µ      | è¯´æ˜                       |
| --------- | -------------------------- |
| æœŸæœ›ç‰ˆæœ¬  | é¡µé¢ä»£ç æœŸæœ›çš„ Worker ç‰ˆæœ¬ |
| å®é™…ç‰ˆæœ¬  | å½“å‰è¿è¡Œçš„ Worker ç‰ˆæœ¬     |
| æ„å»ºæ—¶é—´  | Worker çš„æ„å»º/éƒ¨ç½²æ—¶é—´     |
| å®¢æˆ·ç«¯ ID | å½“å‰é¡µé¢çš„å”¯ä¸€æ ‡è¯†         |

**ç‰ˆæœ¬ä¸åŒ¹é…æ—¶ï¼š**

- ğŸŸ¡ "å®é™…ç‰ˆæœ¬"èƒŒæ™¯å˜ä¸ºé»„è‰²
- âš ï¸ è‡ªåŠ¨å¼¹å‡ºæ›´æ–°æç¤º

### 2. è‡ªåŠ¨æ›´æ–°æ£€æŸ¥

- âœ… æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
- âœ… å‘ç°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨æç¤º
- âœ… å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"ç«‹å³æ£€æŸ¥

### 3. æ›´æ–°é€šçŸ¥

å½“æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬æ—¶ï¼Œä¼šå¼¹å‡ºé€šçŸ¥æ¡†ï¼š

```
âš ï¸ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬
æ–°ç‰ˆæœ¬ 1.0.1 å¯ç”¨ã€‚å»ºè®®åˆ·æ–°é¡µé¢ä»¥ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ SharedWorkerã€‚

[ğŸ”„ ç«‹å³æ›´æ–°]  [ç¨å]
```

### 4. æ“ä½œæ—¥å¿—

é¡µé¢åº•éƒ¨æ˜¾ç¤ºå®æ—¶æ—¥å¿—ï¼š

```
[14:30:22] æ­£åœ¨è¿æ¥åˆ° SharedWorker...
[14:30:23] å·²è¿æ¥ï¼Œå®¢æˆ·ç«¯ ID: 1
[14:30:23] Worker ç‰ˆæœ¬: 1.0.0
[14:30:23] ç‰ˆæœ¬åŒ¹é…ï¼Œè¿è¡Œæ­£å¸¸
[14:35:23] å®šæœŸæ£€æŸ¥æ›´æ–°...
[14:35:23] å‘ç°æ–°ç‰ˆæœ¬: 1.0.1ï¼Œå½“å‰ç‰ˆæœ¬: 1.0.0
[14:35:23] å·²æ˜¾ç¤ºæ›´æ–°æç¤º
```

## ğŸ¨ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹

### æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨ç®¡ç†ç‰ˆæœ¬å·ï¼ˆç®€å•ï¼‰

#### 1. ä¿®æ”¹ç‰ˆæœ¬å·

æ¯æ¬¡éƒ¨ç½²å‰ï¼Œæ‰‹åŠ¨æ›´æ–°ä¸¤å¤„ï¼š

**shared-worker.jsï¼š**

```javascript
const WORKER_VERSION = "1.0.1"; // æ›´æ–°è¿™é‡Œ
const BUILD_TIME = "2025-10-20T15:00:00Z"; // æ›´æ–°è¿™é‡Œ
```

**shared-worker-production.htmlï¼š**

```javascript
const EXPECTED_VERSION = "1.0.1"; // æ›´æ–°è¿™é‡Œï¼ˆä¸ä¸Šé¢ä¿æŒä¸€è‡´ï¼‰
```

**server.jsï¼š**

```javascript
app.get("/api/worker-version", (req, res) => {
  res.json({
    version: "1.0.1", // æ›´æ–°è¿™é‡Œ
    buildTime: "2025-10-20T15:00:00Z", // æ›´æ–°è¿™é‡Œ
  });
});
```

#### 2. éƒ¨ç½²æ–‡ä»¶

```bash
# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp shared-worker.js server:/var/www/app/
scp shared-worker-production.html server:/var/www/app/
scp server.js server:/var/www/app/

# é‡å¯æœåŠ¡
ssh server "pm2 restart app"
```

#### 3. ç”¨æˆ·è‡ªåŠ¨è·å¾—æ–°ç‰ˆæœ¬

- âœ… ç”¨æˆ·ä¸‹æ¬¡åˆ·æ–°é¡µé¢æ—¶è‡ªåŠ¨æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬
- âœ… æ˜¾ç¤ºæ›´æ–°æç¤º
- âœ… ç”¨æˆ·ç¡®è®¤ååˆ·æ–°ï¼Œä½¿ç”¨æ–°ç‰ˆæœ¬

### æ–¹æ¡ˆ Bï¼šè‡ªåŠ¨åŒ–æ„å»ºï¼ˆæ¨èï¼‰

#### 1. ä½¿ç”¨ package.json ç®¡ç†ç‰ˆæœ¬

**package.jsonï¼š**

```json
{
  "name": "my-app",
  "version": "1.0.1"
}
```

#### 2. æ„å»ºè„šæœ¬è‡ªåŠ¨æ›¿æ¢

**build.jsï¼š**

```javascript
const fs = require("fs");
const { version } = require("./package.json");
const buildTime = new Date().toISOString();

// æ›¿æ¢ shared-worker.js ä¸­çš„ç‰ˆæœ¬å·
let workerContent = fs.readFileSync("shared-worker.js", "utf8");
workerContent = workerContent.replace(
  /const WORKER_VERSION = ["'].+?["']/,
  `const WORKER_VERSION = "${version}"`
);
workerContent = workerContent.replace(
  /const BUILD_TIME = ["'].+?["']/,
  `const BUILD_TIME = "${buildTime}"`
);
fs.writeFileSync("dist/shared-worker.js", workerContent);

// æ›¿æ¢ HTML ä¸­çš„ç‰ˆæœ¬å·
let htmlContent = fs.readFileSync("shared-worker-production.html", "utf8");
htmlContent = htmlContent.replace(
  /const EXPECTED_VERSION = ["'].+?["']/,
  `const EXPECTED_VERSION = "${version}"`
);
fs.writeFileSync("dist/shared-worker-production.html", htmlContent);

console.log(`âœ… æ„å»ºå®Œæˆï¼Œç‰ˆæœ¬: ${version}`);
```

#### 3. æ·»åŠ  npm è„šæœ¬

**package.jsonï¼š**

```json
{
  "scripts": {
    "build": "node build.js",
    "deploy": "npm run build && rsync -avz dist/ server:/var/www/app/"
  }
}
```

#### 4. éƒ¨ç½²æµç¨‹

```bash
# æ›´æ–°ç‰ˆæœ¬å·
npm version patch  # 1.0.0 -> 1.0.1
# æˆ–
npm version minor  # 1.0.1 -> 1.1.0
# æˆ–
npm version major  # 1.1.0 -> 2.0.0

# æ„å»ºå¹¶éƒ¨ç½²
npm run deploy

# è‡ªåŠ¨å®Œæˆï¼š
# âœ… æ›´æ–° package.json ç‰ˆæœ¬å·
# âœ… æ›¿æ¢æ‰€æœ‰æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
# âœ… ä¸Šä¼ åˆ°æœåŠ¡å™¨
```

### æ–¹æ¡ˆ Cï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæœ€çµæ´»ï¼‰

#### 1. ç¯å¢ƒå˜é‡é…ç½®

**.env.productionï¼š**

```env
WORKER_VERSION=1.0.1
BUILD_TIME=2025-10-20T15:00:00Z
```

#### 2. æœåŠ¡å™¨è¯»å–ç¯å¢ƒå˜é‡

**server.jsï¼š**

```javascript
require("dotenv").config();

app.get("/api/worker-version", (req, res) => {
  res.json({
    version: process.env.WORKER_VERSION || "1.0.0",
    buildTime: process.env.BUILD_TIME || new Date().toISOString(),
  });
});
```

#### 3. å®¢æˆ·ç«¯åŠ¨æ€è·å–

**shared-worker-production.htmlï¼š**

```javascript
// é¡µé¢åŠ è½½æ—¶ä» API è·å–æœŸæœ›ç‰ˆæœ¬
async function fetchExpectedVersion() {
  const response = await fetch("/api/worker-version");
  const { version } = await response.json();
  return version;
}
```

## ğŸ” ç›‘æ§å’Œå‘Šè­¦

### 1. ç‰ˆæœ¬ä¸åŒ¹é…æ—¥å¿—

åœ¨æœåŠ¡å™¨ç«¯è®°å½•ç‰ˆæœ¬ä¸åŒ¹é…çš„ç”¨æˆ·ï¼š

```javascript
app.post("/api/version-mismatch", (req, res) => {
  const { clientVersion, workerVersion, userId } = req.body;

  console.warn("ç‰ˆæœ¬ä¸åŒ¹é…", {
    clientVersion,
    workerVersion,
    userId,
    timestamp: new Date().toISOString(),
  });

  // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Sentryã€DataDogï¼‰

  res.json({ status: "logged" });
});
```

### 2. æ›´æ–°æˆåŠŸç‡ç»Ÿè®¡

```javascript
app.post("/api/update-completed", (req, res) => {
  const { oldVersion, newVersion, userId } = req.body;

  console.log("ç”¨æˆ·æ›´æ–°æˆåŠŸ", {
    oldVersion,
    newVersion,
    userId,
  });

  res.json({ status: "recorded" });
});
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç‰ˆæœ¬å·åŒæ­¥

ç¡®ä¿ä¸‰ä¸ªåœ°æ–¹çš„ç‰ˆæœ¬å·ä¸€è‡´ï¼š

- âœ… `shared-worker.js` ä¸­çš„ `WORKER_VERSION`
- âœ… `shared-worker-production.html` ä¸­çš„ `EXPECTED_VERSION`
- âœ… `/api/worker-version` è¿”å›çš„ `version`

**å»ºè®®ï¼š** ä½¿ç”¨è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬ç»Ÿä¸€ç®¡ç†ã€‚

### 2. æ¸è¿›å¼æ›´æ–°

å¯¹äºå¤§é‡ç”¨æˆ·ï¼Œè€ƒè™‘åˆ†æ‰¹æ›´æ–°ï¼š

```javascript
// åªå¯¹ 20% ç”¨æˆ·æç¤ºæ›´æ–°
const shouldShowUpdate = Math.random() < 0.2;
if (shouldShowUpdate && hasNewVersion) {
  showUpdateNotification();
}
```

### 3. å¼ºåˆ¶æ›´æ–°é˜ˆå€¼

æŸäº›é‡è¦æ›´æ–°éœ€è¦å¼ºåˆ¶ç”¨æˆ·æ›´æ–°ï¼š

```javascript
const FORCE_UPDATE_VERSION = "2.0.0"; // é‡å¤§ç‰ˆæœ¬

if (actualVersion < FORCE_UPDATE_VERSION) {
  // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œä¸å…è®¸å…³é—­
  showForceUpdateModal();
}
```

### 4. å›é€€æœºåˆ¶

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¿«é€Ÿå›é€€ï¼š

```bash
# æœåŠ¡å™¨ä¸Šä¿ç•™ä¸Šä¸€ä¸ªç‰ˆæœ¬
cp shared-worker.js shared-worker.js.backup

# å‡ºé—®é¢˜æ—¶å¿«é€Ÿå›é€€
mv shared-worker.js.backup shared-worker.js
pm2 restart app
```

## ğŸ“Š å®é™…æ•ˆæœ

### æ­£å¸¸æƒ…å†µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœŸæœ›ç‰ˆæœ¬: 1.0.0  å®é™…ç‰ˆæœ¬: 1.0.0   â”‚
â”‚ çŠ¶æ€: âœ… å·²è¿æ¥  ç‰ˆæœ¬åŒ¹é…           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœŸæœ›ç‰ˆæœ¬: 1.0.1  å®é™…ç‰ˆæœ¬: 1.0.0   â”‚
â”‚ çŠ¶æ€: âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ›´æ–°é€šçŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬                     â”‚
â”‚ æ–°ç‰ˆæœ¬ 1.0.1 å¯ç”¨ã€‚                  â”‚
â”‚ å»ºè®®åˆ·æ–°é¡µé¢ä»¥ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚        â”‚
â”‚                                      â”‚
â”‚ [ğŸ”„ ç«‹å³æ›´æ–°]  [ç¨å]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ€»ç»“

### ä½ ç°åœ¨æ‹¥æœ‰çš„åŠŸèƒ½ï¼š

âœ… **è‡ªåŠ¨ç‰ˆæœ¬æ£€æµ‹** - æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥
âœ… **æ›´æ–°æç¤º** - ç”¨æˆ·å‹å¥½çš„é€šçŸ¥ç•Œé¢
âœ… **ç‰ˆæœ¬å¯¹æ¯”** - æ¸…æ¥šæ˜¾ç¤ºæœŸæœ›ç‰ˆæœ¬ vs å®é™…ç‰ˆæœ¬
âœ… **æ“ä½œæ—¥å¿—** - å®æ—¶è®°å½•æ‰€æœ‰æ“ä½œ
âœ… **æ‰‹åŠ¨æ£€æŸ¥** - å¯ä»¥ç«‹å³æ£€æŸ¥æ›´æ–°
âœ… **API æ”¯æŒ** - `/api/worker-version` ç«¯ç‚¹

### æ¨èçš„ç”Ÿäº§ç¯å¢ƒç­–ç•¥ï¼š

1. **å¼€å‘é˜¶æ®µ** - ä½¿ç”¨ `isDev = true`ï¼Œå¿«é€Ÿè¿­ä»£
2. **æµ‹è¯•é˜¶æ®µ** - ä½¿ç”¨ç‰ˆæœ¬æ£€æµ‹ï¼Œç¡®ä¿æ›´æ–°æœºåˆ¶æ­£å¸¸
3. **ç”Ÿäº§éƒ¨ç½²** - ä½¿ç”¨è‡ªåŠ¨åŒ–æ„å»ºï¼Œç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬å·
4. **ç›‘æ§ç»´æŠ¤** - è®°å½•ç‰ˆæœ¬ä¸åŒ¹é…å’Œæ›´æ–°æˆåŠŸç‡

### å¿«é€Ÿæµ‹è¯•ï¼š

```bash
# 1. å¯åŠ¨æœåŠ¡
node server.js

# 2. æ‰“å¼€é¡µé¢
open http://localhost:3000/shared-worker-production.html

# 3. ä¿®æ”¹ç‰ˆæœ¬å·ï¼ˆshared-worker.jsï¼‰
WORKER_VERSION = "1.0.1"

# 4. ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"
# 5. æŸ¥çœ‹æ›´æ–°æç¤º
# 6. ç‚¹å‡»"ç«‹å³æ›´æ–°"
# 7. âœ… å®Œæˆï¼
```

---

**ç¥ä½ éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹ `PRODUCTION-UPDATE.md` äº†è§£æ›´å¤šæ–¹æ¡ˆã€‚
