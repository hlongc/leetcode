<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SharedWorker - ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ç®¡ç†</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 20px;
      }

      .version-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .version-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #6366f1;
      }

      .version-item .label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .version-item .value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        font-family: monospace;
      }

      .version-item.mismatch {
        background: #fff3cd;
        border-left-color: #ffc107;
      }

      .version-item.mismatch .value {
        color: #856404;
      }

      /* æ›´æ–°é€šçŸ¥ */
      .update-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        padding: 20px;
        max-width: 400px;
        animation: slideIn 0.3s ease;
        z-index: 1000;
        border-left: 5px solid #ff9800;
      }

      @keyframes slideIn {
        from {
          transform: translateX(450px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .update-notification .title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .update-notification .message {
        color: #666;
        margin-bottom: 15px;
        font-size: 14px;
      }

      .update-notification .buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #6366f1;
        color: white;
      }

      .btn-primary:hover {
        background: #4f46e5;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #d1d5db;
      }

      .counter-display {
        text-align: center;
        padding: 40px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 10px;
        margin: 20px 0;
      }

      .counter-value {
        font-size: 72px;
        font-weight: bold;
        color: white;
        font-family: "Courier New", monospace;
      }

      .counter-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        margin-top: 10px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-badge.connected {
        background: #d4edda;
        color: #155724;
      }

      .status-badge.checking {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.outdated {
        background: #f8d7da;
        color: #721c24;
      }

      .info-box {
        background: #e7f3ff;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        font-size: 14px;
      }

      .info-box strong {
        display: block;
        margin-bottom: 5px;
        color: #004085;
      }

      .log-container {
        background: #263238;
        color: #aed581;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .log-entry {
        margin: 3px 0;
      }

      .log-entry.info {
        color: #64b5f6;
      }

      .log-entry.success {
        color: #81c784;
      }

      .log-entry.warning {
        color: #ffb74d;
      }

      .log-entry.error {
        color: #e57373;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>ğŸ”§ SharedWorker ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ç®¡ç†</h1>
        <p class="subtitle">
          æ¼”ç¤ºå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç† SharedWorker ç‰ˆæœ¬æ›´æ–°
          <span class="status-badge connected" id="connectionStatus"
            >å·²è¿æ¥</span
          >
        </p>

        <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
        <div class="version-info">
          <div class="version-item">
            <div class="label">æœŸæœ›ç‰ˆæœ¬</div>
            <div class="value" id="expectedVersion">1.0.0</div>
          </div>
          <div class="version-item" id="actualVersionCard">
            <div class="label">å®é™…ç‰ˆæœ¬</div>
            <div class="value" id="actualVersion">è¿æ¥ä¸­...</div>
          </div>
          <div class="version-item">
            <div class="label">æ„å»ºæ—¶é—´</div>
            <div class="value" id="buildTime">--</div>
          </div>
          <div class="version-item">
            <div class="label">å®¢æˆ·ç«¯ ID</div>
            <div class="value" id="clientId">--</div>
          </div>
        </div>

        <!-- æµ‹è¯•åŠŸèƒ½ -->
        <div class="counter-display">
          <div class="counter-value" id="counterValue">0</div>
          <div class="counter-label">å…±äº«è®¡æ•°å™¨ï¼ˆæµ‹è¯•è·¨æ ‡ç­¾é¡µåŒæ­¥ï¼‰</div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="incrementBtn">+ å¢åŠ </button>
          <button class="btn btn-primary" id="decrementBtn">- å‡å°‘</button>
          <button class="btn btn-secondary" id="resetBtn">é‡ç½®</button>
          <button class="btn btn-secondary" id="checkUpdateBtn">
            ğŸ”„ æ£€æŸ¥æ›´æ–°
          </button>
        </div>

        <!-- è¯´æ˜ -->
        <div class="info-box">
          <strong>ğŸ’¡ æµ‹è¯•ç‰ˆæœ¬æ›´æ–°ï¼š</strong>
          1. ä¿®æ”¹ <code>shared-worker.js</code> ä¸­çš„
          <code>WORKER_VERSION</code>ï¼ˆå¦‚æ”¹ä¸º 1.0.1ï¼‰<br />
          2. ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"æŒ‰é’®<br />
          3. ä¼šå¼¹å‡ºæ›´æ–°æç¤º<br />
          4. ç‚¹å‡»"ç«‹å³æ›´æ–°"åˆ·æ–°é¡µé¢<br />
          <br />
          <strong>ğŸ“ ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š</strong>
          â€¢ ä½¿ç”¨æ„å»ºå·¥å…·è‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬å·<br />
          â€¢ å®šæœŸè‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼ˆå·²å®ç°ï¼šæ¯5åˆ†é’Ÿï¼‰<br />
          â€¢ æä¾›ç”¨æˆ·å‹å¥½çš„æ›´æ–°æç¤º
        </div>

        <!-- æ—¥å¿— -->
        <div class="log-container" id="logContainer">
          <div class="log-entry info">ç­‰å¾…æ—¥å¿—...</div>
        </div>
      </div>
    </div>

    <script>
      // ==================== é…ç½® ====================
      const EXPECTED_VERSION = "1.0.0"; // æœŸæœ›çš„ Worker ç‰ˆæœ¬
      const CHECK_INTERVAL = 5 * 60 * 1000; // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      // ==============================================

      let worker;
      let port;
      let actualWorkerVersion = null;
      let checkUpdateTimer = null;

      // DOM å…ƒç´ 
      const expectedVersionEl = document.getElementById("expectedVersion");
      const actualVersionEl = document.getElementById("actualVersion");
      const actualVersionCard = document.getElementById("actualVersionCard");
      const buildTimeEl = document.getElementById("buildTime");
      const clientIdEl = document.getElementById("clientId");
      const counterValueEl = document.getElementById("counterValue");
      const connectionStatusEl = document.getElementById("connectionStatus");
      const logContainer = document.getElementById("logContainer");

      // æ—¥å¿—å‡½æ•°
      function addLog(type, message) {
        const log = document.createElement("div");
        log.className = `log-entry ${type}`;
        log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(log);
        logContainer.scrollTop = logContainer.scrollHeight;

        // é™åˆ¶æ—¥å¿—æ•°é‡
        const logs = logContainer.querySelectorAll(".log-entry");
        if (logs.length > 50) {
          logs[0].remove();
        }
      }

      // è¿æ¥åˆ° SharedWorker
      function connectToWorker() {
        addLog("info", "æ­£åœ¨è¿æ¥åˆ° SharedWorker...");

        // ç”Ÿäº§ç¯å¢ƒï¼šä¸ä½¿ç”¨ç‰ˆæœ¬å·ï¼ˆå¤šæ ‡ç­¾é¡µå…±äº«ï¼‰
        // å¼€å‘ç¯å¢ƒï¼šå¯ä»¥æ·»åŠ ç‰ˆæœ¬å·ï¼ˆæ¯æ¬¡åˆ·æ–°éƒ½æ˜¯æ–°çš„ï¼‰
        const isDev = false; // ç”Ÿäº§ç¯å¢ƒè®¾ä¸º false
        const workerUrl = isDev
          ? `shared-worker.js?v=${Date.now()}`
          : "shared-worker.js";

        worker = new SharedWorker(workerUrl);
        port = worker.port;

        port.onmessage = (event) => {
          const { type, ...data } = event.data;

          switch (type) {
            case "init":
              // åˆå§‹åŒ–
              actualWorkerVersion = data.version;
              clientIdEl.textContent = data.clientId;
              actualVersionEl.textContent = data.version;
              buildTimeEl.textContent = new Date(data.buildTime).toLocaleString(
                "zh-CN"
              );
              counterValueEl.textContent = data.counter;

              addLog("success", `å·²è¿æ¥ï¼Œå®¢æˆ·ç«¯ ID: ${data.clientId}`);
              addLog("info", `Worker ç‰ˆæœ¬: ${data.version}`);

              // æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦åŒ¹é…
              checkVersionMatch(data.version);

              // å¼€å§‹å®šæœŸæ£€æŸ¥æ›´æ–°
              startUpdateChecker();
              break;

            case "counter-update":
              counterValueEl.textContent = data.counter;
              addLog(
                "info",
                `è®¡æ•°å™¨æ›´æ–°ä¸º ${data.counter} (å®¢æˆ·ç«¯ ${data.updatedBy})`
              );
              break;

            case "client-connected":
              addLog(
                "success",
                `æ–°å®¢æˆ·ç«¯è¿æ¥ (ID: ${data.clientId})ï¼Œæ€»è¿æ¥æ•°: ${data.totalConnections}`
              );
              break;

            default:
              console.log("æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:", type, data);
          }
        };

        port.start();
      }

      // æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦åŒ¹é…
      function checkVersionMatch(actualVersion) {
        if (actualVersion !== EXPECTED_VERSION) {
          actualVersionCard.classList.add("mismatch");
          connectionStatusEl.textContent = "ç‰ˆæœ¬ä¸åŒ¹é…";
          connectionStatusEl.className = "status-badge outdated";
          addLog(
            "warning",
            `ç‰ˆæœ¬ä¸åŒ¹é…ï¼æœŸæœ›: ${EXPECTED_VERSION}ï¼Œå®é™…: ${actualVersion}`
          );
          showUpdateNotification(actualVersion);
        } else {
          actualVersionCard.classList.remove("mismatch");
          connectionStatusEl.textContent = "å·²è¿æ¥";
          connectionStatusEl.className = "status-badge connected";
          addLog("success", "ç‰ˆæœ¬åŒ¹é…ï¼Œè¿è¡Œæ­£å¸¸");
        }
      }

      // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
      function showUpdateNotification(newVersion = null) {
        // é¿å…é‡å¤æ˜¾ç¤º
        if (document.querySelector(".update-notification")) {
          return;
        }

        const notification = document.createElement("div");
        notification.className = "update-notification";
        notification.innerHTML = `
          <div class="title">
            <span>âš ï¸</span>
            <span>æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬</span>
          </div>
          <div class="message">
            ${newVersion ? `æ–°ç‰ˆæœ¬ ${newVersion} å¯ç”¨ã€‚` : ""}
            å»ºè®®åˆ·æ–°é¡µé¢ä»¥ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ SharedWorkerã€‚
          </div>
          <div class="buttons">
            <button class="btn btn-primary" onclick="location.reload()">
              ğŸ”„ ç«‹å³æ›´æ–°
            </button>
            <button class="btn btn-secondary" onclick="this.closest('.update-notification').remove()">
              ç¨å
            </button>
          </div>
        `;
        document.body.appendChild(notification);
        addLog("warning", "å·²æ˜¾ç¤ºæ›´æ–°æç¤º");
      }

      // æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°
      async function checkForUpdates() {
        connectionStatusEl.textContent = "æ£€æŸ¥æ›´æ–°ä¸­...";
        connectionStatusEl.className = "status-badge checking";
        addLog("info", "æ­£åœ¨æ£€æŸ¥æ›´æ–°...");

        try {
          // æ–¹æ¡ˆ1ï¼šè¯·æ±‚åç«¯APIè·å–æœ€æ–°ç‰ˆæœ¬å·
          // const response = await fetch('/api/worker-version');
          // const { version } = await response.json();

          // æ–¹æ¡ˆ2ï¼šç›´æ¥è¯»å– worker æ–‡ä»¶å†…å®¹ï¼ˆä»…å¼€å‘æµ‹è¯•ç”¨ï¼‰
          const response = await fetch(`shared-worker.js?t=${Date.now()}`, {
            cache: "no-cache",
          });
          const text = await response.text();
          const match = text.match(/const WORKER_VERSION = ["'](.+?)["']/);

          if (match && match[1] !== actualWorkerVersion) {
            const newVersion = match[1];
            addLog(
              "warning",
              `å‘ç°æ–°ç‰ˆæœ¬: ${newVersion}ï¼Œå½“å‰ç‰ˆæœ¬: ${actualWorkerVersion}`
            );
            showUpdateNotification(newVersion);
            connectionStatusEl.textContent = "æœ‰æ–°ç‰ˆæœ¬";
            connectionStatusEl.className = "status-badge outdated";
          } else {
            addLog("success", "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬");
            connectionStatusEl.textContent = "å·²è¿æ¥";
            connectionStatusEl.className = "status-badge connected";
          }
        } catch (error) {
          addLog("error", "æ£€æŸ¥æ›´æ–°å¤±è´¥: " + error.message);
          connectionStatusEl.textContent = "æ£€æŸ¥å¤±è´¥";
          connectionStatusEl.className = "status-badge outdated";
        }
      }

      // å®šæœŸæ£€æŸ¥æ›´æ–°
      function startUpdateChecker() {
        if (checkUpdateTimer) {
          clearInterval(checkUpdateTimer);
        }

        checkUpdateTimer = setInterval(() => {
          addLog("info", "å®šæœŸæ£€æŸ¥æ›´æ–°...");
          checkForUpdates();
        }, CHECK_INTERVAL);

        addLog(
          "info",
          `å·²å¯åŠ¨è‡ªåŠ¨æ›´æ–°æ£€æŸ¥ï¼ˆé—´éš” ${CHECK_INTERVAL / 60000} åˆ†é’Ÿï¼‰`
        );
      }

      // å‘é€æ¶ˆæ¯åˆ° Worker
      function sendToWorker(type, data = null) {
        port.postMessage({ type, data });
      }

      // æŒ‰é’®äº‹ä»¶
      document.getElementById("incrementBtn").addEventListener("click", () => {
        sendToWorker("increment");
      });

      document.getElementById("decrementBtn").addEventListener("click", () => {
        sendToWorker("decrement");
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        sendToWorker("reset");
      });

      document
        .getElementById("checkUpdateBtn")
        .addEventListener("click", () => {
          checkForUpdates();
        });

      // é¡µé¢å…³é—­æ—¶æ¸…ç†
      window.addEventListener("beforeunload", () => {
        if (checkUpdateTimer) {
          clearInterval(checkUpdateTimer);
        }
      });

      // åˆå§‹åŒ–
      expectedVersionEl.textContent = EXPECTED_VERSION;
      connectToWorker();
    </script>
  </body>
</html>
