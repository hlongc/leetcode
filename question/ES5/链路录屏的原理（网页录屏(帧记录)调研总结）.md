# ç½‘é¡µå½•å±åŸç†ä¸å®ç°

## æ¦‚è¿°

ç½‘é¡µå½•å±ä¸»è¦æœ‰ä¸¤ç§æŠ€æœ¯è·¯çº¿ï¼š

| æŠ€æœ¯æ–¹æ¡ˆ     | åŸç†                         | ä¼˜ç‚¹               | ç¼ºç‚¹             | é€‚ç”¨åœºæ™¯               |
| ------------ | ---------------------------- | ------------------ | ---------------- | ---------------------- |
| **è§†é¢‘å½•åˆ¶** | MediaRecorder API å½•åˆ¶è§†é¢‘æµ | çœŸå®è¿˜åŸã€å®ç°ç®€å• | æ–‡ä»¶å¤§ã€ä¸å¯ç¼–è¾‘ | æ¼”ç¤ºã€æ•™ç¨‹             |
| **DOM å¿«ç…§** | è®°å½• DOM å˜åŒ–å’Œäº‹ä»¶          | æ–‡ä»¶å°ã€å¯å›æ”¾ç¼–è¾‘ | éœ€è¦è¿˜åŸé€»è¾‘     | ç”¨æˆ·è¡Œä¸ºåˆ†æã€bug å¤ç° |

---

## æ–¹æ¡ˆä¸€ï¼šMediaRecorder APIï¼ˆè§†é¢‘å½•åˆ¶ï¼‰

### åŸºæœ¬å®ç°

```javascript
// screen-recorder.js
class ScreenRecorder {
  constructor(options = {}) {
    this.stream = null;
    this.mediaRecorder = null;
    this.chunks = [];
    this.options = {
      mimeType: "video/webm;codecs=vp9",
      videoBitsPerSecond: 2500000, // 2.5 Mbps
      ...options,
    };
  }

  // å¼€å§‹å½•åˆ¶
  async start() {
    try {
      // è¯·æ±‚å±å¹•æ•è·
      this.stream = await navigator.mediaDevices.getDisplayMedia({
        video: {
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          frameRate: { ideal: 30 },
        },
        audio: false,
      });

      // åˆ›å»º MediaRecorder
      this.mediaRecorder = new MediaRecorder(this.stream, this.options);

      // ç›‘å¬æ•°æ®
      this.mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          this.chunks.push(event.data);
        }
      };

      // ç›‘å¬åœæ­¢
      this.mediaRecorder.onstop = () => {
        this.handleStop();
      };

      // å¼€å§‹å½•åˆ¶
      this.mediaRecorder.start(1000); // æ¯ç§’è§¦å‘ä¸€æ¬¡ dataavailable

      console.log("âœ… å½•åˆ¶å·²å¼€å§‹");
    } catch (error) {
      console.error("å½•åˆ¶å¤±è´¥:", error);
      throw error;
    }
  }

  // åœæ­¢å½•åˆ¶
  stop() {
    if (this.mediaRecorder && this.mediaRecorder.state !== "inactive") {
      this.mediaRecorder.stop();

      // åœæ­¢æ‰€æœ‰è½¨é“
      this.stream.getTracks().forEach((track) => track.stop());
    }
  }

  // å¤„ç†å½•åˆ¶å®Œæˆ
  handleStop() {
    const blob = new Blob(this.chunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);

    console.log("âœ… å½•åˆ¶å®Œæˆ");
    console.log("æ–‡ä»¶å¤§å°:", (blob.size / 1024 / 1024).toFixed(2), "MB");

    // ä¸‹è½½è§†é¢‘
    const a = document.createElement("a");
    a.href = url;
    a.download = `recording-${Date.now()}.webm`;
    a.click();

    // æ¸…ç†
    URL.revokeObjectURL(url);
    this.chunks = [];
  }

  // è·å–å½•åˆ¶çŠ¶æ€
  getState() {
    return this.mediaRecorder?.state || "inactive";
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const recorder = new ScreenRecorder();

document.getElementById("startBtn").addEventListener("click", () => {
  recorder.start();
});

document.getElementById("stopBtn").addEventListener("click", () => {
  recorder.stop();
});
```

---

## æ–¹æ¡ˆäºŒï¼šDOM å¿«ç…§å½•åˆ¶ï¼ˆrrweb åŸç†ï¼‰â­â­â­â­â­

è¿™æ˜¯ç›®å‰æœ€æµè¡Œçš„æ–¹æ¡ˆï¼Œç”¨äºç”¨æˆ·è¡Œä¸ºåˆ†æã€bug å¤ç°ç­‰ã€‚

### æ ¸å¿ƒåŸç†

```
å½•åˆ¶é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å…¨é‡å¿«ç…§ï¼ˆåˆå§‹ DOM ç»“æ„ï¼‰      â”‚
â”‚    - åºåˆ—åŒ–æ•´ä¸ª DOM æ ‘            â”‚
â”‚    - è®°å½• CSS æ ·å¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å¢é‡å¿«ç…§ï¼ˆDOM å˜åŒ–ï¼‰           â”‚
â”‚    - ç›‘å¬ MutationObserver        â”‚
â”‚    - è®°å½• DOM å¢åˆ æ”¹              â”‚
â”‚    - è®°å½•å±æ€§å˜åŒ–                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. äº‹ä»¶è®°å½•                       â”‚
â”‚    - é¼ æ ‡ç§»åŠ¨ã€ç‚¹å‡»               â”‚
â”‚    - é”®ç›˜è¾“å…¥                     â”‚
â”‚    - æ»šåŠ¨äº‹ä»¶                     â”‚
â”‚    - çª—å£å¤§å°å˜åŒ–                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›æ”¾é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é‡å»ºåˆå§‹ DOM                   â”‚
â”‚    - æ ¹æ®å…¨é‡å¿«ç…§åˆ›å»º DOM         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æŒ‰æ—¶é—´è½´å›æ”¾äº‹ä»¶               â”‚
â”‚    - åº”ç”¨ DOM å˜åŒ–                â”‚
â”‚    - æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŸºç¡€å®ç°

```javascript
// simple-dom-recorder.js
class SimpleDOMRecorder {
  constructor() {
    this.events = [];
    this.startTime = null;
    this.observers = [];
  }

  // å¼€å§‹å½•åˆ¶
  start() {
    this.startTime = Date.now();
    this.events = [];

    // 1. è®°å½•åˆå§‹å¿«ç…§
    this.recordSnapshot();

    // 2. ç›‘å¬ DOM å˜åŒ–
    this.observeDOM();

    // 3. ç›‘å¬ç”¨æˆ·äº‹ä»¶
    this.observeEvents();

    console.log("âœ… DOM å½•åˆ¶å·²å¼€å§‹");
  }

  // è®°å½•å…¨é‡å¿«ç…§
  recordSnapshot() {
    const snapshot = {
      type: "full-snapshot",
      timestamp: 0,
      data: {
        html: document.documentElement.outerHTML,
        href: window.location.href,
        width: window.innerWidth,
        height: window.innerHeight,
      },
    };

    this.events.push(snapshot);
  }

  // ç›‘å¬ DOM å˜åŒ–
  observeDOM() {
    const observer = new MutationObserver((mutations) => {
      const changes = [];

      mutations.forEach((mutation) => {
        if (mutation.type === "childList") {
          // èŠ‚ç‚¹å¢åˆ 
          mutation.addedNodes.forEach((node) => {
            changes.push({
              type: "add",
              parentId: this.getNodeId(mutation.target),
              html: node.outerHTML || node.textContent,
            });
          });

          mutation.removedNodes.forEach((node) => {
            changes.push({
              type: "remove",
              nodeId: this.getNodeId(node),
            });
          });
        } else if (mutation.type === "attributes") {
          // å±æ€§å˜åŒ–
          changes.push({
            type: "attribute",
            nodeId: this.getNodeId(mutation.target),
            attribute: mutation.attributeName,
            value: mutation.target.getAttribute(mutation.attributeName),
          });
        } else if (mutation.type === "characterData") {
          // æ–‡æœ¬å˜åŒ–
          changes.push({
            type: "text",
            nodeId: this.getNodeId(mutation.target),
            value: mutation.target.textContent,
          });
        }
      });

      if (changes.length > 0) {
        this.recordEvent({
          type: "incremental-snapshot",
          data: {
            source: "mutation",
            changes: changes,
          },
        });
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeOldValue: true,
      characterData: true,
      characterDataOldValue: true,
    });

    this.observers.push(observer);
  }

  // ç›‘å¬ç”¨æˆ·äº‹ä»¶
  observeEvents() {
    // é¼ æ ‡ç§»åŠ¨
    const mouseMoveHandler = (e) => {
      this.recordEvent({
        type: "incremental-snapshot",
        data: {
          source: "mousemove",
          x: e.clientX,
          y: e.clientY,
        },
      });
    };

    // é¼ æ ‡ç‚¹å‡»
    const clickHandler = (e) => {
      this.recordEvent({
        type: "incremental-snapshot",
        data: {
          source: "click",
          x: e.clientX,
          y: e.clientY,
          target: this.getNodeId(e.target),
        },
      });
    };

    // æ»šåŠ¨
    const scrollHandler = (e) => {
      this.recordEvent({
        type: "incremental-snapshot",
        data: {
          source: "scroll",
          x: window.scrollX,
          y: window.scrollY,
        },
      });
    };

    // è¾“å…¥
    const inputHandler = (e) => {
      this.recordEvent({
        type: "incremental-snapshot",
        data: {
          source: "input",
          target: this.getNodeId(e.target),
          value: e.target.value,
        },
      });
    };

    // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
    document.addEventListener("mousemove", mouseMoveHandler, true);
    document.addEventListener("click", clickHandler, true);
    document.addEventListener("scroll", scrollHandler, true);
    document.addEventListener("input", inputHandler, true);

    // ä¿å­˜å¼•ç”¨ä»¥ä¾¿æ¸…ç†
    this.eventHandlers = [
      { type: "mousemove", handler: mouseMoveHandler },
      { type: "click", handler: clickHandler },
      { type: "scroll", handler: scrollHandler },
      { type: "input", handler: inputHandler },
    ];
  }

  // è®°å½•äº‹ä»¶
  recordEvent(event) {
    this.events.push({
      ...event,
      timestamp: Date.now() - this.startTime,
    });
  }

  // è·å–èŠ‚ç‚¹ IDï¼ˆç®€åŒ–ç‰ˆï¼‰
  getNodeId(node) {
    if (!node) return null;
    if (!node.__recordId) {
      node.__recordId = `node-${Math.random().toString(36).substr(2, 9)}`;
    }
    return node.__recordId;
  }

  // åœæ­¢å½•åˆ¶
  stop() {
    // æ–­å¼€ MutationObserver
    this.observers.forEach((observer) => observer.disconnect());

    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    this.eventHandlers?.forEach(({ type, handler }) => {
      document.removeEventListener(type, handler, true);
    });

    console.log("âœ… å½•åˆ¶å·²åœæ­¢");
    console.log("äº‹ä»¶æ•°é‡:", this.events.length);

    return this.events;
  }

  // å¯¼å‡ºå½•åˆ¶æ•°æ®
  export() {
    const data = {
      events: this.events,
      meta: {
        startTime: this.startTime,
        duration: Date.now() - this.startTime,
        userAgent: navigator.userAgent,
        url: window.location.href,
      },
    };

    return JSON.stringify(data);
  }

  // ä¸‹è½½å½•åˆ¶æ–‡ä»¶
  download() {
    const data = this.export();
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `session-${Date.now()}.json`;
    a.click();

    URL.revokeObjectURL(url);
  }
}

// ä½¿ç”¨
const recorder = new SimpleDOMRecorder();
recorder.start();

// å½•åˆ¶ 30 ç§’ååœæ­¢
setTimeout(() => {
  recorder.stop();
  recorder.download();
}, 30000);
```

---

## rrweb æ·±åº¦è§£æï¼ˆä¸šç•Œæ ‡å‡†ï¼‰

### rrweb æ¶æ„

```
rrweb ç”Ÿæ€ç³»ç»Ÿï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ rrweb (æ ¸å¿ƒå½•åˆ¶åº“)               â”‚
â”‚ - åºåˆ—åŒ– DOM                     â”‚
â”‚ - ç›‘å¬å˜åŒ–                       â”‚
â”‚ - ç”Ÿæˆäº‹ä»¶æµ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ rrweb-snapshot (å¿«ç…§åº“)          â”‚
â”‚ - DOM åºåˆ—åŒ–                     â”‚
â”‚ - å»æ•æ„Ÿä¿¡æ¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ rrweb-player (æ’­æ”¾å™¨)            â”‚
â”‚ - å›æ”¾äº‹ä»¶                       â”‚
â”‚ - æ—¶é—´è½´æ§åˆ¶                     â”‚
â”‚ - å€é€Ÿæ’­æ”¾                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½¿ç”¨ rrweb

```javascript
// å®‰è£…
// npm install rrweb

import rrweb from "rrweb";

// å¼€å§‹å½•åˆ¶
let events = [];

const stopFn = rrweb.record({
  // å½•åˆ¶é…ç½®
  emit(event) {
    // ä¿å­˜äº‹ä»¶
    events.push(event);

    // å¯ä»¥å®æ—¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
    if (events.length % 10 === 0) {
      sendToServer(events);
      events = [];
    }
  },

  // é‡‡æ ·é…ç½®
  sampling: {
    // é¼ æ ‡ç§»åŠ¨é‡‡æ ·ï¼ˆé™ä½æ•°æ®é‡ï¼‰
    mousemove: true,
    mouseInteraction: {
      MouseUp: false,
      MouseDown: false,
      Click: true,
      ContextMenu: false,
      DblClick: true,
    },
    // æ»šåŠ¨é‡‡æ ·
    scroll: 150, // æ¯ 150ms è®°å½•ä¸€æ¬¡
    // è¾“å…¥é‡‡æ ·
    input: "last", // åªè®°å½•æœ€åçš„å€¼
  },

  // éšç§é…ç½®
  maskAllInputs: true, // éšè—æ‰€æœ‰è¾“å…¥
  maskTextSelector: ".sensitive", // éšè—æ•æ„Ÿæ–‡æœ¬
  blockClass: "rr-block", // é˜»æ­¢å½•åˆ¶çš„å…ƒç´ 
  ignoreClass: "rr-ignore", // å¿½ç•¥çš„å…ƒç´ 

  // æ€§èƒ½é…ç½®
  checkoutEveryNms: 10 * 60 * 1000, // æ¯ 10 åˆ†é’Ÿåšä¸€æ¬¡å®Œæ•´å¿«ç…§
  slimDOMOptions: {
    script: true, // ç§»é™¤ script æ ‡ç­¾
    comment: true, // ç§»é™¤æ³¨é‡Š
    headFavicon: true, // ç§»é™¤ favicon
    headMetaDescKeywords: true, // ç§»é™¤ meta æ ‡ç­¾
  },
});

// åœæ­¢å½•åˆ¶
document.getElementById("stopBtn").addEventListener("click", () => {
  stopFn();
  console.log("å½•åˆ¶å·²åœæ­¢ï¼Œäº‹ä»¶æ•°é‡:", events.length);

  // ä¸‹è½½å½•åˆ¶æ–‡ä»¶
  downloadRecording(events);
});

function downloadRecording(events) {
  const data = JSON.stringify(events);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `session-${Date.now()}.json`;
  a.click();

  URL.revokeObjectURL(url);
}
```

### rrweb å›æ”¾

```html
<!DOCTYPE html>
<html>
  <head>
    <title>rrweb å›æ”¾</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css"
    />
  </head>
  <body>
    <div id="player"></div>

    <script src="https://cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>

    <script>
      // åŠ è½½å½•åˆ¶æ•°æ®
      fetch("./session-123456.json")
        .then((res) => res.json())
        .then((events) => {
          // åˆ›å»ºæ’­æ”¾å™¨
          const player = new rrwebPlayer({
            target: document.getElementById("player"),
            props: {
              events,
              width: 1024,
              height: 768,
              autoPlay: true,
              speedOption: [1, 2, 4, 8], // å€é€Ÿé€‰é¡¹
              showController: true, // æ˜¾ç¤ºæ§åˆ¶å™¨
              tags: {
                // å¯ä»¥æ·»åŠ æ ‡ç­¾
                "user-click": "ç”¨æˆ·ç‚¹å‡»",
                error: "é”™è¯¯å‘ç”Ÿ",
              },
            },
          });

          // ç›‘å¬æ’­æ”¾äº‹ä»¶
          player.addEventListener("finish", () => {
            console.log("å›æ”¾ç»“æŸ");
          });
        });
    </script>
  </body>
</html>
```

---

## rrweb æ•°æ®ç»“æ„

### äº‹ä»¶ç±»å‹

```typescript
// rrweb çš„äº‹ä»¶ç±»å‹
enum EventType {
  DomContentLoaded = 0,
  Load = 1,
  FullSnapshot = 2, // å…¨é‡å¿«ç…§
  IncrementalSnapshot = 3, // å¢é‡å¿«ç…§
  Meta = 4, // å…ƒæ•°æ®
  Custom = 5, // è‡ªå®šä¹‰äº‹ä»¶
  Plugin = 6, // æ’ä»¶äº‹ä»¶
}

// å¢é‡å¿«ç…§çš„æ¥æº
enum IncrementalSource {
  Mutation = 0, // DOM å˜åŒ–
  MouseMove = 1, // é¼ æ ‡ç§»åŠ¨
  MouseInteraction = 2, // é¼ æ ‡äº¤äº’
  Scroll = 3, // æ»šåŠ¨
  ViewportResize = 4, // çª—å£å¤§å°å˜åŒ–
  Input = 5, // è¾“å…¥
  TouchMove = 6, // è§¦æ‘¸ç§»åŠ¨
  MediaInteraction = 7, // åª’ä½“äº¤äº’
  StyleSheetRule = 8, // æ ·å¼è§„åˆ™
  CanvasMutation = 9, // Canvas å˜åŒ–
  Font = 10, // å­—ä½“åŠ è½½
  Log = 11, // æ—¥å¿—
  Drag = 12, // æ‹–æ‹½
  StyleDeclaration = 13, // æ ·å¼å£°æ˜
}
```

### æ•°æ®ç¤ºä¾‹

```json
[
  {
    "type": 4,
    "data": {
      "href": "https://example.com",
      "width": 1920,
      "height": 1080
    },
    "timestamp": 1635840000000
  },
  {
    "type": 2,
    "data": {
      "node": {
        "type": 0,
        "childNodes": [
          {
            "type": 1,
            "name": "html",
            "attributes": {},
            "childNodes": [...]
          }
        ],
        "id": 1
      },
      "initialOffset": {
        "top": 0,
        "left": 0
      }
    },
    "timestamp": 1635840000100
  },
  {
    "type": 3,
    "data": {
      "source": 1,
      "positions": [
        { "x": 100, "y": 200, "timeOffset": 50 },
        { "x": 105, "y": 205, "timeOffset": 100 }
      ]
    },
    "timestamp": 1635840000200
  }
]
```

---

## è‡ªå®šä¹‰å®ç°ï¼šè½»é‡çº§å½•å±åº“

### å®Œæ•´å®ç°

```javascript
// lightweight-recorder.js
class LightweightRecorder {
  constructor(options = {}) {
    this.options = {
      recordMouse: true,
      recordScroll: true,
      recordInput: true,
      sampleRate: 100, // é¼ æ ‡ç§»åŠ¨é‡‡æ ·é—´éš”ï¼ˆmsï¼‰
      ...options,
    };

    this.events = [];
    this.startTime = null;
    this.nodeMap = new WeakMap(); // èŠ‚ç‚¹ â†’ ID æ˜ å°„
    this.idMap = new Map(); // ID â†’ èŠ‚ç‚¹æ˜ å°„
    this.currentId = 1;
  }

  start() {
    this.startTime = performance.now();
    this.events = [];

    // è®°å½•åˆå§‹çŠ¶æ€
    this.captureFullSnapshot();

    // ç›‘å¬å˜åŒ–
    this.setupObservers();

    console.log("ğŸ¬ å½•åˆ¶å¼€å§‹");
  }

  captureFullSnapshot() {
    const snapshot = {
      type: "full-snapshot",
      timestamp: 0,
      data: this.serializeNode(document.documentElement),
    };

    this.events.push(snapshot);
  }

  serializeNode(node) {
    // åˆ†é… ID
    const id = this.getOrAssignId(node);

    if (node.nodeType === Node.TEXT_NODE) {
      return {
        type: "text",
        id: id,
        textContent: node.textContent,
      };
    }

    if (node.nodeType === Node.ELEMENT_NODE) {
      const serialized = {
        type: "element",
        id: id,
        tagName: node.tagName.toLowerCase(),
        attributes: {},
        childNodes: [],
      };

      // åºåˆ—åŒ–å±æ€§
      Array.from(node.attributes || []).forEach((attr) => {
        serialized.attributes[attr.name] = attr.value;
      });

      // åºåˆ—åŒ–å­èŠ‚ç‚¹
      Array.from(node.childNodes).forEach((child) => {
        serialized.childNodes.push(this.serializeNode(child));
      });

      return serialized;
    }

    return null;
  }

  getOrAssignId(node) {
    if (this.nodeMap.has(node)) {
      return this.nodeMap.get(node);
    }

    const id = this.currentId++;
    this.nodeMap.set(node, id);
    this.idMap.set(id, node);

    return id;
  }

  setupObservers() {
    // MutationObserver
    const mutationObserver = new MutationObserver((mutations) => {
      const timestamp = performance.now() - this.startTime;

      mutations.forEach((mutation) => {
        this.recordMutation(mutation, timestamp);
      });
    });

    mutationObserver.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      characterData: true,
    });

    // é¼ æ ‡äº‹ä»¶ï¼ˆèŠ‚æµï¼‰
    if (this.options.recordMouse) {
      let lastMouseMove = 0;

      document.addEventListener(
        "mousemove",
        (e) => {
          const now = performance.now();
          if (now - lastMouseMove < this.options.sampleRate) {
            return;
          }

          lastMouseMove = now;

          this.events.push({
            type: "mouse-move",
            timestamp: now - this.startTime,
            data: { x: e.clientX, y: e.clientY },
          });
        },
        true
      );

      document.addEventListener(
        "click",
        (e) => {
          this.events.push({
            type: "click",
            timestamp: performance.now() - this.startTime,
            data: {
              x: e.clientX,
              y: e.clientY,
              target: this.getOrAssignId(e.target),
            },
          });
        },
        true
      );
    }

    // æ»šåŠ¨äº‹ä»¶
    if (this.options.recordScroll) {
      document.addEventListener(
        "scroll",
        (e) => {
          this.events.push({
            type: "scroll",
            timestamp: performance.now() - this.startTime,
            data: {
              x: window.scrollX,
              y: window.scrollY,
            },
          });
        },
        true
      );
    }

    // è¾“å…¥äº‹ä»¶
    if (this.options.recordInput) {
      document.addEventListener(
        "input",
        (e) => {
          this.events.push({
            type: "input",
            timestamp: performance.now() - this.startTime,
            data: {
              target: this.getOrAssignId(e.target),
              value: e.target.value,
            },
          });
        },
        true
      );
    }
  }

  recordMutation(mutation, timestamp) {
    const event = {
      type: "mutation",
      timestamp: timestamp,
      data: {},
    };

    if (mutation.type === "childList") {
      event.data.addedNodes = Array.from(mutation.addedNodes).map((node) =>
        this.serializeNode(node)
      );

      event.data.removedNodes = Array.from(mutation.removedNodes).map((node) =>
        this.getOrAssignId(node)
      );

      event.data.target = this.getOrAssignId(mutation.target);
    } else if (mutation.type === "attributes") {
      event.data.target = this.getOrAssignId(mutation.target);
      event.data.attributeName = mutation.attributeName;
      event.data.value = mutation.target.getAttribute(mutation.attributeName);
    } else if (mutation.type === "characterData") {
      event.data.target = this.getOrAssignId(mutation.target);
      event.data.value = mutation.target.textContent;
    }

    this.events.push(event);
  }

  stop() {
    console.log("ğŸ›‘ å½•åˆ¶åœæ­¢");
    return this.events;
  }

  export() {
    return {
      events: this.events,
      meta: {
        duration: performance.now() - this.startTime,
        url: window.location.href,
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight,
        },
      },
    };
  }
}
```

---

## Canvas å½•åˆ¶

### æ–¹æ¡ˆï¼šæ•è· Canvas æ“ä½œ

```javascript
// canvas-recorder.js
class CanvasRecorder {
  constructor(canvas) {
    this.canvas = canvas;
    this.events = [];
    this.startTime = null;
    this.originalMethods = {};
  }

  start() {
    this.startTime = performance.now();
    this.events = [];

    // åŠ«æŒ Canvas API
    this.hijackCanvasAPI();

    console.log("ğŸ¨ Canvas å½•åˆ¶å¼€å§‹");
  }

  hijackCanvasAPI() {
    const ctx = this.canvas.getContext("2d");

    // ä¿å­˜åŸå§‹æ–¹æ³•
    const methodsToHijack = [
      "fillRect",
      "strokeRect",
      "fillText",
      "strokeText",
      "drawImage",
      "arc",
      "lineTo",
      "moveTo",
      "beginPath",
      "closePath",
      "stroke",
      "fill",
    ];

    methodsToHijack.forEach((method) => {
      this.originalMethods[method] = ctx[method];

      ctx[method] = (...args) => {
        // è®°å½•æ“ä½œ
        this.recordCanvasCall(method, args);

        // è°ƒç”¨åŸå§‹æ–¹æ³•
        return this.originalMethods[method].apply(ctx, args);
      };
    });

    // åŠ«æŒå±æ€§è®¾ç½®
    const propertiesToHijack = ["fillStyle", "strokeStyle", "lineWidth", "font"];

    propertiesToHijack.forEach((prop) => {
      let value = ctx[prop];

      Object.defineProperty(ctx, prop, {
        get() {
          return value;
        },
        set(newValue) {
          this.recordPropertyChange(prop, newValue);
          value = newValue;
        }.bind(this),
      });
    });
  }

  recordCanvasCall(method, args) {
    this.events.push({
      type: "canvas-call",
      timestamp: performance.now() - this.startTime,
      method: method,
      args: args,
    });
  }

  recordPropertyChange(prop, value) {
    this.events.push({
      type: "canvas-property",
      timestamp: performance.now() - this.startTime,
      property: prop,
      value: value,
    });
  }

  stop() {
    // æ¢å¤åŸå§‹æ–¹æ³•
    const ctx = this.canvas.getContext("2d");

    Object.keys(this.originalMethods).forEach((method) => {
      ctx[method] = this.originalMethods[method];
    });

    console.log("ğŸ›‘ Canvas å½•åˆ¶åœæ­¢");
    return this.events;
  }

  // å›æ”¾
  replay(targetCanvas) {
    const ctx = targetCanvas.getContext("2d");
    let currentIndex = 0;

    const playNextEvent = () => {
      if (currentIndex >= this.events.length) {
        console.log("âœ… å›æ”¾å®Œæˆ");
        return;
      }

      const event = this.events[currentIndex];
      const nextEvent = this.events[currentIndex + 1];

      // æ‰§è¡Œäº‹ä»¶
      if (event.type === "canvas-call") {
        ctx[event.method](...event.args);
      } else if (event.type === "canvas-property") {
        ctx[event.property] = event.value;
      }

      currentIndex++;

      // è®¡ç®—ä¸‹ä¸€ä¸ªäº‹ä»¶çš„å»¶è¿Ÿ
      const delay = nextEvent ? nextEvent.timestamp - event.timestamp : 0;

      if (delay > 0) {
        setTimeout(playNextEvent, delay);
      } else {
        playNextEvent();
      }
    };

    playNextEvent();
  }
}

// ä½¿ç”¨
const canvas = document.getElementById("myCanvas");
const recorder = new CanvasRecorder(canvas);

// å¼€å§‹å½•åˆ¶
recorder.start();

// ç»˜åˆ¶ä¸€äº›å†…å®¹
const ctx = canvas.getContext("2d");
ctx.fillStyle = "red";
ctx.fillRect(10, 10, 100, 100);

// åœæ­¢å½•åˆ¶
setTimeout(() => {
  const events = recorder.stop();

  // å›æ”¾åˆ°å¦ä¸€ä¸ª canvas
  const replayCanvas = document.getElementById("replayCanvas");
  recorder.replay(replayCanvas);
}, 5000);
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. äº‹ä»¶å‹ç¼©

```javascript
class EventCompressor {
  constructor() {
    this.buffer = [];
    this.flushInterval = 1000; // æ¯ç§’åˆ·æ–°ä¸€æ¬¡
  }

  // å‹ç¼©é¼ æ ‡ç§»åŠ¨äº‹ä»¶
  compressMouseMove(events) {
    const compressed = [];
    let batch = [];

    events.forEach((event) => {
      if (event.type === "mouse-move") {
        batch.push(event);

        // æ¯ 10 ä¸ªé¼ æ ‡ç§»åŠ¨åˆå¹¶ä¸ºä¸€ä¸ª
        if (batch.length >= 10) {
          compressed.push({
            type: "mouse-move-batch",
            timestamp: batch[0].timestamp,
            positions: batch.map((e) => e.data),
          });
          batch = [];
        }
      } else {
        // å…ˆåˆ·æ–°é¼ æ ‡ç§»åŠ¨æ‰¹æ¬¡
        if (batch.length > 0) {
          compressed.push({
            type: "mouse-move-batch",
            timestamp: batch[0].timestamp,
            positions: batch.map((e) => e.data),
          });
          batch = [];
        }

        compressed.push(event);
      }
    });

    return compressed;
  }

  // å»é‡ç›¸åŒçš„äº‹ä»¶
  deduplicateEvents(events) {
    const deduplicated = [];
    let lastEvent = null;

    events.forEach((event) => {
      // å¦‚æœä¸ä¸Šä¸€ä¸ªäº‹ä»¶ç›¸åŒï¼Œè·³è¿‡
      if (lastEvent && this.isSameEvent(event, lastEvent)) {
        return;
      }

      deduplicated.push(event);
      lastEvent = event;
    });

    return deduplicated;
  }

  isSameEvent(e1, e2) {
    return (
      e1.type === e2.type && JSON.stringify(e1.data) === JSON.stringify(e2.data)
    );
  }
}
```

### 2. å¢é‡ä¸Šä¼ 

```javascript
class IncrementalUploader {
  constructor(endpoint) {
    this.endpoint = endpoint;
    this.buffer = [];
    this.uploadInterval = 5000; // æ¯ 5 ç§’ä¸Šä¼ ä¸€æ¬¡
    this.timer = null;
  }

  start() {
    this.timer = setInterval(() => {
      this.flush();
    }, this.uploadInterval);
  }

  add(event) {
    this.buffer.push(event);

    // ç¼“å†²åŒºæ»¡äº†ï¼Œç«‹å³ä¸Šä¼ 
    if (this.buffer.length >= 100) {
      this.flush();
    }
  }

  async flush() {
    if (this.buffer.length === 0) return;

    const events = this.buffer.splice(0);

    try {
      await fetch(this.endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          events: events,
          sessionId: this.sessionId,
          timestamp: Date.now(),
        }),
      });

      console.log(`âœ… ä¸Šä¼  ${events.length} ä¸ªäº‹ä»¶`);
    } catch (error) {
      console.error("ä¸Šä¼ å¤±è´¥:", error);
      // å¯ä»¥é‡æ–°åŠ å…¥ç¼“å†²åŒºé‡è¯•
      this.buffer.unshift(...events);
    }
  }

  stop() {
    clearInterval(this.timer);
    this.flush(); // æœ€åä¸€æ¬¡åˆ·æ–°
  }
}

// ä½¿ç”¨
const uploader = new IncrementalUploader("/api/recording");
uploader.start();

// å½•åˆ¶äº‹ä»¶æ—¶æ·»åŠ åˆ°ä¸Šä¼ å™¨
recorder.emit = (event) => {
  uploader.add(event);
};
```

---

## å®é™…åº”ç”¨åœºæ™¯

### 1. ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆHotjar, FullStoryï¼‰

```javascript
// user-session-recorder.js
import rrweb from "rrweb";

class UserSessionRecorder {
  constructor(config) {
    this.apiEndpoint = config.apiEndpoint;
    this.sessionId = this.generateSessionId();
    this.events = [];
  }

  start() {
    this.stopFn = rrweb.record({
      emit: (event) => {
        this.events.push(event);

        // æ¯ 50 ä¸ªäº‹ä»¶ä¸Šä¼ ä¸€æ¬¡
        if (this.events.length >= 50) {
          this.uploadEvents();
        }
      },
      sampling: {
        mousemove: true,
        scroll: 150,
      },
      maskAllInputs: true, // éšç§ä¿æŠ¤
    });

    // ç›‘å¬é”™è¯¯
    window.addEventListener("error", (e) => {
      this.recordError(e);
    });

    console.log("ğŸ“Š ç”¨æˆ·ä¼šè¯å½•åˆ¶å¯åŠ¨, Session ID:", this.sessionId);
  }

  recordError(error) {
    this.events.push({
      type: "custom",
      timestamp: Date.now(),
      data: {
        tag: "error",
        payload: {
          message: error.message,
          filename: error.filename,
          lineno: error.lineno,
          colno: error.colno,
          stack: error.error?.stack,
        },
      },
    });

    // ç«‹å³ä¸Šä¼ é”™è¯¯
    this.uploadEvents();
  }

  async uploadEvents() {
    const eventsToUpload = this.events.splice(0);

    try {
      await fetch(this.apiEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId: this.sessionId,
          events: eventsToUpload,
          meta: {
            url: window.location.href,
            userAgent: navigator.userAgent,
            viewport: {
              width: window.innerWidth,
              height: window.innerHeight,
            },
          },
        }),
        keepalive: true,
      });
    } catch (error) {
      console.error("ä¸Šä¼ å¤±è´¥:", error);
    }
  }

  generateSessionId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  stop() {
    this.stopFn?.();
    this.uploadEvents(); // ä¸Šä¼ å‰©ä½™äº‹ä»¶
  }
}

// åˆå§‹åŒ–
const recorder = new UserSessionRecorder({
  apiEndpoint: "/api/user-sessions",
});

recorder.start();

// é¡µé¢å¸è½½æ—¶åœæ­¢
window.addEventListener("beforeunload", () => {
  recorder.stop();
});
```

### 2. Bug å¤ç°ç³»ç»Ÿ

```javascript
// bug-replay-system.js
class BugReplaySystem {
  constructor() {
    this.recorder = null;
    this.isRecording = false;
  }

  // è‡ªåŠ¨å½•åˆ¶ï¼ˆå§‹ç»ˆå¼€å¯ï¼‰
  autoRecord() {
    this.recorder = rrweb.record({
      emit: (event, isCheckout) => {
        // åªä¿ç•™æœ€è¿‘ 3 åˆ†é’Ÿçš„å½•åˆ¶
        if (isCheckout) {
          this.events = [event]; // é‡ç½®
        } else {
          this.events.push(event);

          // é™åˆ¶äº‹ä»¶æ•°é‡
          if (this.events.length > 10000) {
            this.events.shift();
          }
        }
      },
      checkoutEveryNms: 3 * 60 * 1000, // æ¯ 3 åˆ†é’Ÿåšä¸€æ¬¡å®Œæ•´å¿«ç…§
    });

    // ç›‘å¬é”™è¯¯
    window.addEventListener("error", (e) => {
      this.reportBugWithRecording(e);
    });

    // ç›‘å¬ Promise é”™è¯¯
    window.addEventListener("unhandledrejection", (e) => {
      this.reportBugWithRecording(e);
    });
  }

  // ä¸ŠæŠ¥ bug å¹¶é™„å¸¦å½•åˆ¶
  async reportBugWithRecording(error) {
    const bugReport = {
      error: {
        message: error.message,
        stack: error.error?.stack,
        filename: error.filename,
        lineno: error.lineno,
      },
      recording: this.events, // é™„å¸¦æœ€è¿‘ 3 åˆ†é’Ÿçš„å½•åˆ¶
      meta: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now(),
      },
    };

    // ä¸Šä¼ åˆ°æœåŠ¡å™¨
    await fetch("/api/bug-report", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bugReport),
      keepalive: true,
    });

    console.log("ğŸ› Bug å·²ä¸ŠæŠ¥ï¼ˆåŒ…å«å½•åˆ¶ï¼‰");
  }
}

// åˆå§‹åŒ–
const bugSystem = new BugReplaySystem();
bugSystem.autoRecord();
```

---

## æ•°æ®å‹ç¼©å’Œå­˜å‚¨

### 1. å‹ç¼©å½•åˆ¶æ•°æ®

```javascript
// ä½¿ç”¨ pako å‹ç¼©
import pako from "pako";

function compressRecording(events) {
  const json = JSON.stringify(events);
  const compressed = pako.gzip(json);

  console.log("åŸå§‹å¤§å°:", (json.length / 1024).toFixed(2), "KB");
  console.log("å‹ç¼©å:", (compressed.length / 1024).toFixed(2), "KB");
  console.log(
    "å‹ç¼©ç‡:",
    ((1 - compressed.length / json.length) * 100).toFixed(2),
    "%"
  );

  return compressed;
}

function decompressRecording(compressed) {
  const decompressed = pako.ungzip(compressed, { to: "string" });
  return JSON.parse(decompressed);
}

// ä½¿ç”¨
const events = recorder.export();
const compressed = compressRecording(events);

// ä¿å­˜åˆ° IndexedDB
const db = await openDB("recordings", 1, {
  upgrade(db) {
    db.createObjectStore("sessions");
  },
});

await db.put("sessions", compressed, sessionId);
```

### 2. IndexedDB å­˜å‚¨

```javascript
// indexeddb-storage.js
class RecordingStorage {
  constructor(dbName = "RecordingDB") {
    this.dbName = dbName;
    this.db = null;
  }

  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, 1);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };

      request.onupgradeneeded = (event) => {
        const db = event.target.result;

        // åˆ›å»ºå¯¹è±¡å­˜å‚¨
        if (!db.objectStoreNames.contains("recordings")) {
          const store = db.createObjectStore("recordings", { keyPath: "id" });
          store.createIndex("timestamp", "timestamp", { unique: false });
          store.createIndex("url", "url", { unique: false });
        }
      };
    });
  }

  async save(recording) {
    const transaction = this.db.transaction(["recordings"], "readwrite");
    const store = transaction.objectStore("recordings");

    const record = {
      id: `session-${Date.now()}`,
      timestamp: Date.now(),
      url: window.location.href,
      events: recording.events,
      meta: recording.meta,
    };

    return new Promise((resolve, reject) => {
      const request = store.add(record);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  async getAll() {
    const transaction = this.db.transaction(["recordings"], "readonly");
    const store = transaction.objectStore("recordings");

    return new Promise((resolve, reject) => {
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  async delete(id) {
    const transaction = this.db.transaction(["recordings"], "readwrite");
    const store = transaction.objectStore("recordings");

    return new Promise((resolve, reject) => {
      const request = store.delete(id);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }
}
```

---

## å®Œæ•´çš„å½•å±ç³»ç»Ÿ

### å‰ç«¯ SDK

```javascript
// recording-sdk.js
class RecordingSDK {
  constructor(config) {
    this.config = {
      apiEndpoint: config.apiEndpoint,
      autoRecord: config.autoRecord !== false,
      uploadInterval: config.uploadInterval || 10000,
      maxEvents: config.maxEvents || 10000,
      ...config,
    };

    this.sessionId = this.generateSessionId();
    this.events = [];
    this.stopFn = null;

    if (this.config.autoRecord) {
      this.start();
    }
  }

  start() {
    this.stopFn = rrweb.record({
      emit: (event, isCheckout) => {
        if (isCheckout) {
          this.events = [event];
        } else {
          this.events.push(event);
        }

        // é™åˆ¶äº‹ä»¶æ•°é‡
        if (this.events.length > this.config.maxEvents) {
          this.events.shift();
        }
      },
      checkoutEveryNms: this.config.uploadInterval,
      sampling: {
        mousemove: true,
        scroll: 150,
        input: "last",
      },
      maskAllInputs: true,
    });

    // å®šæœŸä¸Šä¼ 
    this.uploadTimer = setInterval(() => {
      this.upload();
    }, this.config.uploadInterval);

    // ç›‘å¬é”™è¯¯å¹¶ä¸Šä¼ 
    window.addEventListener("error", (e) => {
      this.recordCustomEvent("error", {
        message: e.message,
        stack: e.error?.stack,
      });
      this.upload(); // ç«‹å³ä¸Šä¼ 
    });

    // é¡µé¢å¸è½½æ—¶ä¸Šä¼ 
    window.addEventListener("beforeunload", () => {
      this.upload(true);
    });

    console.log("ğŸ¬ Recording SDK å¯åŠ¨, Session:", this.sessionId);
  }

  recordCustomEvent(tag, payload) {
    this.events.push({
      type: 5, // Custom
      timestamp: Date.now(),
      data: { tag, payload },
    });
  }

  async upload(useBeacon = false) {
    if (this.events.length === 0) return;

    const data = JSON.stringify({
      sessionId: this.sessionId,
      events: this.events,
      meta: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now(),
      },
    });

    if (useBeacon) {
      navigator.sendBeacon(this.config.apiEndpoint, data);
    } else {
      try {
        await fetch(this.config.apiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: data,
          keepalive: true,
        });

        console.log(`ğŸ“¤ ä¸Šä¼  ${this.events.length} ä¸ªäº‹ä»¶`);
        this.events = [];
      } catch (error) {
        console.error("ä¸Šä¼ å¤±è´¥:", error);
      }
    }
  }

  stop() {
    this.stopFn?.();
    clearInterval(this.uploadTimer);
    this.upload(true); // æœ€åä¸€æ¬¡ä¸Šä¼ 
  }

  generateSessionId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
}

// åˆå§‹åŒ–
window.RecordingSDK = new RecordingSDK({
  apiEndpoint: "/api/recordings",
  autoRecord: true,
});
```

### åç«¯æ¥æ”¶å’Œå­˜å‚¨

```javascript
// server.js
const express = require("express");
const fs = require("fs");
const path = require("path");
const zlib = require("zlib");

const app = express();
app.use(express.json({ limit: "10mb" }));

// æ¥æ”¶å½•åˆ¶æ•°æ®
app.post("/api/recordings", async (req, res) => {
  try {
    const { sessionId, events, meta } = req.body;

    // å‹ç¼©æ•°æ®
    const jsonData = JSON.stringify({ events, meta });
    const compressed = zlib.gzipSync(jsonData);

    // ä¿å­˜åˆ°æ–‡ä»¶
    const filename = `${sessionId}.json.gz`;
    const filepath = path.join(__dirname, "recordings", filename);

    fs.writeFileSync(filepath, compressed);

    console.log(`âœ… ä¿å­˜å½•åˆ¶: ${sessionId}, äº‹ä»¶æ•°: ${events.length}`);

    res.json({ success: true, sessionId });
  } catch (error) {
    console.error("ä¿å­˜å¤±è´¥:", error);
    res.status(500).json({ error: error.message });
  }
});

// è·å–å½•åˆ¶åˆ—è¡¨
app.get("/api/recordings", (req, res) => {
  const recordingsDir = path.join(__dirname, "recordings");
  const files = fs.readdirSync(recordingsDir);

  const recordings = files.map((file) => {
    const filepath = path.join(recordingsDir, file);
    const stats = fs.statSync(filepath);

    return {
      sessionId: file.replace(".json.gz", ""),
      size: stats.size,
      createdAt: stats.birthtime,
    };
  });

  res.json(recordings);
});

// è·å–å•ä¸ªå½•åˆ¶
app.get("/api/recordings/:sessionId", (req, res) => {
  const { sessionId } = req.params;
  const filepath = path.join(__dirname, "recordings", `${sessionId}.json.gz`);

  if (!fs.existsSync(filepath)) {
    return res.status(404).json({ error: "Recording not found" });
  }

  // è§£å‹å¹¶è¿”å›
  const compressed = fs.readFileSync(filepath);
  const decompressed = zlib.gunzipSync(compressed).toString();

  res.json(JSON.parse(decompressed));
});

app.listen(3000, () => {
  console.log("å½•åˆ¶æœåŠ¡è¿è¡Œåœ¨ http://localhost:3000");
});
```

---

## æ€»ç»“

### æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ              | æ–‡ä»¶å¤§å°   | è¿˜åŸåº¦ | å¯ç¼–è¾‘ | éšç§ | é€‚ç”¨åœºæ™¯           |
| ----------------- | ---------- | ------ | ------ | ---- | ------------------ |
| **MediaRecorder** | å¤§ï¼ˆè§†é¢‘ï¼‰ | 100%   | âŒ     | ä½   | æ¼”ç¤ºã€æ•™ç¨‹         |
| **DOM å¿«ç…§**      | å°ï¼ˆJSONï¼‰ | 95%    | âœ…     | é«˜   | è¡Œä¸ºåˆ†æã€bug å¤ç° |
| **Canvas å½•åˆ¶**   | ä¸­         | 100%   | éƒ¨åˆ†   | ä¸­   | æ¸¸æˆã€ç»˜å›¾åº”ç”¨     |

### æ¨èæ–¹æ¡ˆ

| åœºæ™¯             | æ¨èæŠ€æœ¯            | åº“                  |
| ---------------- | ------------------- | ------------------- |
| **ç”¨æˆ·è¡Œä¸ºåˆ†æ** | DOM å¿«ç…§            | rrweb, rrweb-player |
| **Bug å¤ç°**     | DOM å¿«ç…§ + é”™è¯¯ç›‘æ§ | rrweb + Sentry      |
| **å±å¹•å…±äº«**     | MediaRecorder       | åŸç”Ÿ API            |
| **æ¸¸æˆå½•åˆ¶**     | Canvas å½•åˆ¶         | è‡ªå®šä¹‰å®ç°          |

### å…³é”®æŠ€æœ¯ç‚¹

âœ… **å½•åˆ¶é˜¶æ®µ**

1. å…¨é‡å¿«ç…§ï¼ˆåˆå§‹ DOMï¼‰
2. å¢é‡å¿«ç…§ï¼ˆDOM å˜åŒ– - MutationObserverï¼‰
3. äº‹ä»¶è®°å½•ï¼ˆé¼ æ ‡ã€é”®ç›˜ã€æ»šåŠ¨ï¼‰
4. é‡‡æ ·ä¼˜åŒ–ï¼ˆé™ä½æ•°æ®é‡ï¼‰

âœ… **å›æ”¾é˜¶æ®µ**

1. é‡å»ºåˆå§‹ DOM
2. æŒ‰æ—¶é—´è½´åº”ç”¨å˜åŒ–
3. æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ
4. å€é€Ÿæ’­æ”¾æ§åˆ¶

âœ… **æ€§èƒ½ä¼˜åŒ–**

- äº‹ä»¶é‡‡æ ·ï¼ˆé¼ æ ‡ç§»åŠ¨èŠ‚æµï¼‰
- æ•°æ®å‹ç¼©ï¼ˆgzipï¼‰
- å¢é‡ä¸Šä¼ ï¼ˆé¿å…ä¸¢å¤±ï¼‰
- ç¼“å†²åŒºç®¡ç†

âœ… **éšç§ä¿æŠ¤**

- è¾“å…¥æ¡†è„±æ•
- æ•æ„Ÿä¿¡æ¯é®ç½©
- ç™½åå•é…ç½®

### æ ¸å¿ƒä»£ç ï¼ˆæœ€ç®€å®ç°ï¼‰

```javascript
// å½•åˆ¶
import rrweb from "rrweb";

const events = [];
const stopFn = rrweb.record({
  emit: (event) => events.push(event),
});

// åœæ­¢å¹¶ä¿å­˜
stopFn();
localStorage.setItem("recording", JSON.stringify(events));

// å›æ”¾
import rrwebPlayer from "rrweb-player";

const events = JSON.parse(localStorage.getItem("recording"));
new rrwebPlayer({
  target: document.getElementById("player"),
  props: { events },
});
```

æŒæ¡è¿™äº›æŠ€æœ¯ï¼Œå°±èƒ½å®ç°åŠŸèƒ½å®Œå–„çš„ç½‘é¡µå½•å±å’Œå›æ”¾ç³»ç»Ÿï¼

---

## æ³•åŠ¡ä¸åˆè§„é—®é¢˜

### æ ¸å¿ƒæ³•å¾‹æ³•è§„

| æ³•è§„               | åœ°åŒº     | ä¸»è¦è¦æ±‚                     |
| ------------------ | -------- | ---------------------------- |
| **GDPR**           | æ¬§ç›Ÿ     | ç”¨æˆ·åŒæ„ã€æ•°æ®æœ€å°åŒ–ã€åˆ é™¤æƒ |
| **CCPA**           | ç¾å›½åŠ å· | çŸ¥æƒ…æƒã€åˆ é™¤æƒã€é€€å‡ºæƒ       |
| **ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•** | ä¸­å›½     | æ˜ç¡®å‘ŠçŸ¥ã€ç”¨æˆ·åŒæ„ã€å®‰å…¨ä¿æŠ¤ |
| **PIPL**           | ä¸­å›½     | ä¸ªäººä¿¡æ¯å¤„ç†è§„åˆ™             |

---

## åˆè§„è§£å†³æ–¹æ¡ˆ

### 1. ç”¨æˆ·æ˜ç¡®åŒæ„ï¼ˆæœ€é‡è¦ï¼‰â­â­â­â­â­

#### å®ç°åŒæ„å¼¹çª—

```javascript
// consent-manager.js
class ConsentManager {
  constructor() {
    this.consentKey = "user-recording-consent";
    this.consentVersion = "v1.0"; // éšç§æ”¿ç­–ç‰ˆæœ¬
  }

  // æ£€æŸ¥æ˜¯å¦å·²åŒæ„
  hasConsent() {
    const consent = localStorage.getItem(this.consentKey);
    if (!consent) return false;

    const data = JSON.parse(consent);
    // æ£€æŸ¥ç‰ˆæœ¬ï¼Œå¦‚æœéšç§æ”¿ç­–æ›´æ–°ï¼Œéœ€è¦é‡æ–°åŒæ„
    return data.version === this.consentVersion && data.agreed === true;
  }

  // æ˜¾ç¤ºåŒæ„å¼¹çª—
  async requestConsent() {
    if (this.hasConsent()) {
      return true;
    }

    return new Promise((resolve) => {
      const modal = this.createConsentModal();
      document.body.appendChild(modal);

      // åŒæ„æŒ‰é’®
      document.getElementById("consent-agree").addEventListener("click", () => {
        this.saveConsent(true);
        modal.remove();
        resolve(true);
      });

      // æ‹’ç»æŒ‰é’®
      document
        .getElementById("consent-decline")
        .addEventListener("click", () => {
          this.saveConsent(false);
          modal.remove();
          resolve(false);
        });
    });
  }

  createConsentModal() {
    const modal = document.createElement("div");
    modal.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 500px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          <h2>éšç§é€šçŸ¥</h2>
          <p>ä¸ºäº†æ”¹å–„æ‚¨çš„ä½¿ç”¨ä½“éªŒå’Œæ’æŸ¥é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šè®°å½•æ‚¨çš„æ“ä½œè¡Œä¸ºï¼ŒåŒ…æ‹¬ï¼š</p>
          <ul>
            <li>é¡µé¢æµè§ˆè®°å½•</li>
            <li>ç‚¹å‡»å’Œæ»šåŠ¨æ“ä½œ</li>
            <li>è¡¨å•è¾“å…¥ï¼ˆå·²è„±æ•å¤„ç†ï¼‰</li>
          </ul>
          <p><strong>æˆ‘ä»¬æ‰¿è¯ºï¼š</strong></p>
          <ul>
            <li>âœ… æ•°æ®ä»…ç”¨äºäº§å“æ”¹è¿›å’ŒæŠ€æœ¯æ”¯æŒ</li>
            <li>âœ… æ•æ„Ÿä¿¡æ¯ä¼šè‡ªåŠ¨é®ç½©</li>
            <li>âœ… æ•°æ®åŠ å¯†ä¼ è¾“å’Œå­˜å‚¨</li>
            <li>âœ… æ‚¨å¯ä»¥éšæ—¶æ’¤å›åŒæ„</li>
            <li>âœ… æ•°æ®ä¿ç•™ 30 å¤©åè‡ªåŠ¨åˆ é™¤</li>
          </ul>
          <p>è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ <a href="/privacy" target="_blank">éšç§æ”¿ç­–</a></p>
          
          <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="consent-decline" style="
              padding: 10px 20px;
              border: 1px solid #ddd;
              background: white;
              border-radius: 4px;
              cursor: pointer;
            ">æ‹’ç»</button>
            <button id="consent-agree" style="
              padding: 10px 20px;
              border: none;
              background: #1890ff;
              color: white;
              border-radius: 4px;
              cursor: pointer;
            ">åŒæ„</button>
          </div>
        </div>
      </div>
    `;

    return modal;
  }

  saveConsent(agreed) {
    const data = {
      agreed: agreed,
      version: this.consentVersion,
      timestamp: Date.now(),
    };

    localStorage.setItem(this.consentKey, JSON.stringify(data));

    // ä¸ŠæŠ¥åˆ°æœåŠ¡å™¨
    fetch("/api/consent", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: this.getUserId(),
        agreed: agreed,
        version: this.consentVersion,
        timestamp: Date.now(),
      }),
      keepalive: true,
    });
  }

  getUserId() {
    // è·å–æˆ–ç”ŸæˆåŒ¿åç”¨æˆ· ID
    let userId = localStorage.getItem("anonymous-user-id");
    if (!userId) {
      userId = `anon-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      localStorage.setItem("anonymous-user-id", userId);
    }
    return userId;
  }

  // æ’¤å›åŒæ„
  revokeConsent() {
    localStorage.removeItem(this.consentKey);

    // é€šçŸ¥æœåŠ¡å™¨åˆ é™¤æ•°æ®
    fetch("/api/consent/revoke", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: this.getUserId(),
      }),
      keepalive: true,
    });

    alert("æ‚¨å·²æ’¤å›å½•åˆ¶åŒæ„ï¼Œæˆ‘ä»¬å°†åˆ é™¤æ‚¨çš„æ‰€æœ‰å½•åˆ¶æ•°æ®");
  }
}

// ä½¿ç”¨
const consentManager = new ConsentManager();

// åœ¨å¯åŠ¨å½•åˆ¶å‰è¯·æ±‚åŒæ„
consentManager.requestConsent().then((agreed) => {
  if (agreed) {
    // ç”¨æˆ·åŒæ„ï¼Œå¯åŠ¨å½•åˆ¶
    recorder.start();
    console.log("âœ… ç”¨æˆ·å·²åŒæ„å½•åˆ¶");
  } else {
    // ç”¨æˆ·æ‹’ç»
    console.log("âŒ ç”¨æˆ·æ‹’ç»å½•åˆ¶");
  }
});
```

---

### 2. æ•æ„Ÿä¿¡æ¯è„±æ•ï¼ˆå¿…é¡»ï¼‰â­â­â­â­â­

#### å®Œæ•´çš„è„±æ•ç­–ç•¥

```javascript
// privacy-mask.js
class PrivacyMask {
  constructor(options = {}) {
    this.config = {
      // è¾“å…¥æ¡†è„±æ•
      maskInputs: true,
      maskInputTypes: ["password", "email", "tel", "text", "number"],

      // æ–‡æœ¬è„±æ•
      maskTextSelectors: [
        ".sensitive",
        ".password",
        ".ssn",
        ".credit-card",
        '[data-sensitive="true"]',
      ],

      // å›¾ç‰‡è„±æ•
      maskImages: false,
      maskImageSelectors: [".avatar", '[data-mask="true"]'],

      // å®Œå…¨é˜»æ­¢å½•åˆ¶çš„å…ƒç´ 
      blockSelectors: [
        ".payment-form",
        ".admin-panel",
        '[data-recording="false"]',
      ],

      ...options,
    };
  }

  // åº”ç”¨åˆ° rrweb é…ç½®
  getRRWebConfig() {
    return {
      // é®ç½©æ‰€æœ‰è¾“å…¥
      maskAllInputs: this.config.maskInputs,

      // é®ç½©ç‰¹å®šè¾“å…¥ç±»å‹
      maskInputOptions: {
        password: true,
        email: true,
        tel: true,
      },

      // é®ç½©æ–‡æœ¬é€‰æ‹©å™¨
      maskTextSelector: this.config.maskTextSelectors.join(","),

      // é˜»æ­¢å½•åˆ¶çš„å…ƒç´ 
      blockClass: "rr-block",
      blockSelector: this.config.blockSelectors.join(","),

      // å¿½ç•¥çš„å…ƒç´ ï¼ˆä¸è®°å½•å˜åŒ–ï¼‰
      ignoreClass: "rr-ignore",

      // è„±æ•å‡½æ•°ï¼ˆè‡ªå®šä¹‰ï¼‰
      maskTextFn: (text, element) => {
        // é‚®ç®±è„±æ•
        if (element.classList.contains("email")) {
          return text.replace(/[a-zA-Z0-9]/g, "*");
        }

        // æ‰‹æœºå·è„±æ•
        if (element.classList.contains("phone")) {
          return text.replace(/\d/g, "*");
        }

        // èº«ä»½è¯è„±æ•
        if (element.classList.contains("id-card")) {
          return text.substring(0, 6) + "********" + text.substring(14);
        }

        return text;
      },

      // è¾“å…¥å€¼è„±æ•
      maskInputFn: (text, element) => {
        const type = element.type;

        // å¯†ç å®Œå…¨é®ç½©
        if (type === "password") {
          return "*".repeat(text.length);
        }

        // é‚®ç®±éƒ¨åˆ†é®ç½©
        if (type === "email") {
          const [name, domain] = text.split("@");
          if (name && domain) {
            return name[0] + "***@" + domain;
          }
        }

        // æ‰‹æœºå·è„±æ•
        if (type === "tel") {
          return text.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
        }

        return text;
      },
    };
  }
}

// ä½¿ç”¨
const privacyMask = new PrivacyMask({
  maskInputs: true,
  maskTextSelectors: [".sensitive", ".private"],
  blockSelectors: [".admin-only"],
});

// åº”ç”¨åˆ°å½•åˆ¶
const stopFn = rrweb.record({
  ...privacyMask.getRRWebConfig(),
  emit: (event) => {
    events.push(event);
  },
});
```

#### HTML æ ‡è®°æ•æ„Ÿä¿¡æ¯

```html
<!-- å®Œå…¨é˜»æ­¢å½•åˆ¶ -->
<div class="rr-block">
  è¿™éƒ¨åˆ†å†…å®¹ä¸ä¼šè¢«å½•åˆ¶
  <input type="text" value="admin password" />
</div>

<!-- å¿½ç•¥å˜åŒ–ï¼ˆåˆå§‹å¿«ç…§ä¼šè®°å½•ï¼Œä½†åç»­å˜åŒ–ä¸è®°å½•ï¼‰ -->
<div class="rr-ignore">
  <span>è¿™éƒ¨åˆ†çš„å˜åŒ–ä¸ä¼šè¢«è®°å½•</span>
</div>

<!-- æ–‡æœ¬è„±æ• -->
<div class="sensitive">ç”¨æˆ·é‚®ç®±: user@example.com ï¼ˆä¼šè¢«é®ç½©ï¼‰</div>

<!-- ä½¿ç”¨ data å±æ€§ -->
<input type="text" data-sensitive="true" value="secret" />

<!-- è‡ªå®šä¹‰è„±æ• -->
<span data-mask-type="phone">13800138000</span>
```

---

### 3. éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®

#### éšç§æ”¿ç­–æ¨¡æ¿

```markdown
# å½•åˆ¶åŠŸèƒ½éšç§æ”¿ç­–

## 1. æˆ‘ä»¬æ”¶é›†ä»€ä¹ˆä¿¡æ¯

### 1.1 æ“ä½œè¡Œä¸ºæ•°æ®

- é¡µé¢æµè§ˆè®°å½•
- é¼ æ ‡ç§»åŠ¨å’Œç‚¹å‡»ä½ç½®
- æ»šåŠ¨è¡Œä¸º
- é¡µé¢åœç•™æ—¶é—´

### 1.2 ä¸æ”¶é›†çš„ä¿¡æ¯

âŒ å¯†ç å­—æ®µï¼ˆè‡ªåŠ¨é®ç½©ï¼‰
âŒ æ”¯ä»˜ä¿¡æ¯ï¼ˆé˜»æ­¢å½•åˆ¶ï¼‰
âŒ ä¸ªäººèº«ä»½è¯å·ï¼ˆè„±æ•å¤„ç†ï¼‰
âŒ ç§å¯†å¯¹è¯å†…å®¹

## 2. ä¿¡æ¯å¦‚ä½•ä½¿ç”¨

âœ… æ”¹è¿›äº§å“åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒ
âœ… è¯Šæ–­å’Œä¿®å¤æŠ€æœ¯é—®é¢˜
âœ… åˆ†æç”¨æˆ·è¡Œä¸ºæ¨¡å¼
âŒ ä¸ä¼šå‡ºå”®ç»™ç¬¬ä¸‰æ–¹
âŒ ä¸ä¼šç”¨äºè¥é”€æ¨é€

## 3. æ•°æ®å®‰å…¨æªæ–½

- ğŸ”’ HTTPS åŠ å¯†ä¼ è¾“
- ğŸ”’ æ•°æ®åº“åŠ å¯†å­˜å‚¨
- ğŸ”’ è®¿é—®æƒé™æ§åˆ¶
- ğŸ”’ å®šæœŸå®‰å…¨å®¡è®¡

## 4. æ•°æ®ä¿ç•™æœŸé™

- å½•åˆ¶æ•°æ®ä¿ç•™ **30 å¤©**
- 30 å¤©åè‡ªåŠ¨åˆ é™¤
- æ‚¨å¯ä»¥éšæ—¶è¦æ±‚åˆ é™¤

## 5. æ‚¨çš„æƒåˆ©

### 5.1 è®¿é—®æƒ

æ‚¨å¯ä»¥è¦æ±‚æŸ¥çœ‹æˆ‘ä»¬æ”¶é›†çš„å…³äºæ‚¨çš„æ•°æ®

### 5.2 åˆ é™¤æƒ

æ‚¨å¯ä»¥è¦æ±‚åˆ é™¤æ‚¨çš„æ‰€æœ‰å½•åˆ¶æ•°æ®

### 5.3 æ’¤å›åŒæ„æƒ

æ‚¨å¯ä»¥éšæ—¶æ’¤å›å½•åˆ¶åŒæ„

### 5.4 æ•°æ®å¯¼å‡ºæƒ

æ‚¨å¯ä»¥è¦æ±‚å¯¼å‡ºæ‚¨çš„æ•°æ®å‰¯æœ¬

## 6. è”ç³»æ–¹å¼

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»ï¼šprivacy@example.com
```

#### åŒæ„è®°å½•ç³»ç»Ÿ

```javascript
// consent-logger.js
class ConsentLogger {
  constructor(apiEndpoint) {
    this.apiEndpoint = apiEndpoint;
  }

  // è®°å½•ç”¨æˆ·åŒæ„
  async logConsent(userId, agreed, metadata = {}) {
    const record = {
      userId: userId,
      agreed: agreed,
      version: "v1.0", // éšç§æ”¿ç­–ç‰ˆæœ¬
      timestamp: new Date().toISOString(),
      ip: await this.getClientIP(),
      userAgent: navigator.userAgent,
      url: window.location.href,
      ...metadata,
    };

    // å‘é€åˆ°æœåŠ¡å™¨
    await fetch(`${this.apiEndpoint}/consent/log`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(record),
    });

    // æœ¬åœ°ä¹Ÿä¿å­˜ä¸€ä»½
    const consents = JSON.parse(
      localStorage.getItem("consent-history") || "[]"
    );
    consents.push(record);
    localStorage.setItem("consent-history", JSON.stringify(consents));

    console.log("âœ… åŒæ„è®°å½•å·²ä¿å­˜");
  }

  async getClientIP() {
    try {
      const response = await fetch("https://api.ipify.org?format=json");
      const data = await response.json();
      return data.ip;
    } catch {
      return "unknown";
    }
  }

  // æ’¤å›åŒæ„
  async revokeConsent(userId) {
    await fetch(`${this.apiEndpoint}/consent/revoke`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: userId,
        timestamp: new Date().toISOString(),
      }),
    });

    console.log("âœ… åŒæ„å·²æ’¤å›");
  }
}
```

---

### 4. æ•°æ®å­˜å‚¨å’Œå®‰å…¨

#### æœåŠ¡å™¨ç«¯æ•°æ®å¤„ç†

```javascript
// server-security.js
const express = require("express");
const crypto = require("crypto");
const rateLimit = require("express-rate-limit");

const app = express();

// 1. é™æµä¿æŠ¤
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 100, // æœ€å¤š 100 ä¸ªè¯·æ±‚
  message: "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
});

app.use("/api/recordings", limiter);

// 2. æ•°æ®åŠ å¯†å­˜å‚¨
class EncryptedStorage {
  constructor(encryptionKey) {
    this.algorithm = "aes-256-gcm";
    this.key = crypto.scryptSync(encryptionKey, "salt", 32);
  }

  encrypt(data) {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(this.algorithm, this.key, iv);

    let encrypted = cipher.update(JSON.stringify(data), "utf8", "hex");
    encrypted += cipher.final("hex");

    const authTag = cipher.getAuthTag();

    return {
      encrypted: encrypted,
      iv: iv.toString("hex"),
      authTag: authTag.toString("hex"),
    };
  }

  decrypt(encryptedData) {
    const decipher = crypto.createDecipheriv(
      this.algorithm,
      this.key,
      Buffer.from(encryptedData.iv, "hex")
    );

    decipher.setAuthTag(Buffer.from(encryptedData.authTag, "hex"));

    let decrypted = decipher.update(encryptedData.encrypted, "hex", "utf8");
    decrypted += decipher.final("utf8");

    return JSON.parse(decrypted);
  }
}

const storage = new EncryptedStorage(process.env.ENCRYPTION_KEY);

// 3. ä¿å­˜å½•åˆ¶æ•°æ®
app.post("/api/recordings", async (req, res) => {
  try {
    const { sessionId, events, meta } = req.body;

    // éªŒè¯ç”¨æˆ·åŒæ„
    const hasConsent = await checkUserConsent(sessionId);
    if (!hasConsent) {
      return res.status(403).json({ error: "ç”¨æˆ·æœªåŒæ„å½•åˆ¶" });
    }

    // åŠ å¯†æ•°æ®
    const encrypted = storage.encrypt({ events, meta });

    // ä¿å­˜åˆ°æ•°æ®åº“
    await saveToDatabase({
      sessionId: sessionId,
      data: encrypted,
      createdAt: new Date(),
      expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 å¤©åè¿‡æœŸ
    });

    res.json({ success: true });
  } catch (error) {
    console.error("ä¿å­˜å¤±è´¥:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// 4. è‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®
async function cleanupExpiredData() {
  const now = new Date();

  await db.query(
    `
    DELETE FROM recordings
    WHERE expiresAt < $1
  `,
    [now]
  );

  console.log("âœ… è¿‡æœŸæ•°æ®å·²æ¸…ç†");
}

// æ¯å¤©è¿è¡Œä¸€æ¬¡æ¸…ç†
setInterval(cleanupExpiredData, 24 * 60 * 60 * 1000);
```

---

### 5. ç”¨æˆ·æ•°æ®æ§åˆ¶æƒ

#### å®ç°æ•°æ®ç®¡ç†ç•Œé¢

```javascript
// user-data-control.js
class UserDataControl {
  constructor(apiEndpoint) {
    this.apiEndpoint = apiEndpoint;
  }

  // æŸ¥çœ‹æˆ‘çš„æ•°æ®
  async viewMyData(userId) {
    const response = await fetch(
      `${this.apiEndpoint}/user/${userId}/recordings`
    );
    const data = await response.json();

    return data.recordings.map((r) => ({
      sessionId: r.sessionId,
      date: new Date(r.createdAt).toLocaleString(),
      duration: r.duration,
      url: r.url,
      eventsCount: r.eventsCount,
    }));
  }

  // å¯¼å‡ºæˆ‘çš„æ•°æ®ï¼ˆGDPR è¦æ±‚ï¼‰
  async exportMyData(userId) {
    const response = await fetch(`${this.apiEndpoint}/user/${userId}/export`, {
      method: "POST",
    });

    const blob = await response.blob();

    // ä¸‹è½½
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `my-data-${userId}-${Date.now()}.zip`;
    a.click();

    URL.revokeObjectURL(url);

    console.log("âœ… æ•°æ®å·²å¯¼å‡º");
  }

  // åˆ é™¤æˆ‘çš„æ•°æ®ï¼ˆGDPR è¦æ±‚ï¼‰
  async deleteMyData(userId) {
    const confirmed = confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å½•åˆ¶æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚");

    if (!confirmed) return;

    await fetch(`${this.apiEndpoint}/user/${userId}/recordings`, {
      method: "DELETE",
    });

    alert("âœ… æ‚¨çš„æ‰€æœ‰å½•åˆ¶æ•°æ®å·²åˆ é™¤");
    console.log("âœ… æ•°æ®å·²åˆ é™¤");
  }

  // æ’¤å›å½•åˆ¶åŒæ„
  async revokeConsent(userId) {
    await fetch(`${this.apiEndpoint}/consent/revoke`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId }),
    });

    // åŒæ—¶åˆ é™¤æ•°æ®
    await this.deleteMyData(userId);

    console.log("âœ… åŒæ„å·²æ’¤å›ï¼Œæ•°æ®å·²åˆ é™¤");
  }
}

// ç”¨æˆ·æ•°æ®ç®¡ç†é¡µé¢
function createUserDataPanel() {
  const panel = document.createElement("div");
  panel.innerHTML = `
    <div class="data-control-panel">
      <h2>æˆ‘çš„æ•°æ®ç®¡ç†</h2>
      
      <div class="control-section">
        <h3>å½•åˆ¶åŒæ„çŠ¶æ€</h3>
        <p id="consent-status">æ­£åœ¨æ£€æŸ¥...</p>
        <button id="revoke-consent">æ’¤å›åŒæ„</button>
      </div>
      
      <div class="control-section">
        <h3>æˆ‘çš„å½•åˆ¶è®°å½•</h3>
        <div id="recordings-list">åŠ è½½ä¸­...</div>
        <button id="view-data">æŸ¥çœ‹è¯¦æƒ…</button>
      </div>
      
      <div class="control-section">
        <h3>æ•°æ®æ“ä½œ</h3>
        <button id="export-data">å¯¼å‡ºæˆ‘çš„æ•°æ®</button>
        <button id="delete-data" style="background: #f5222d;">åˆ é™¤æ‰€æœ‰æ•°æ®</button>
      </div>
    </div>
  `;

  return panel;
}
```

---

### 6. åŒºåŸŸåˆè§„å·®å¼‚

#### ä¸åŒåœ°åŒºçš„ç‰¹æ®Šè¦æ±‚

```javascript
// regional-compliance.js
class RegionalCompliance {
  constructor() {
    this.region = this.detectRegion();
  }

  detectRegion() {
    // é€šè¿‡æ—¶åŒºæˆ– IP æ£€æµ‹åœ°åŒº
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    if (timezone.includes("Europe")) return "EU";
    if (timezone.includes("America/Los_Angeles")) return "CA"; // åŠ å·
    if (timezone.includes("Asia/Shanghai")) return "CN";

    return "OTHER";
  }

  getComplianceConfig() {
    const configs = {
      // æ¬§ç›Ÿ GDPR
      EU: {
        requireExplicitConsent: true, // å¿…é¡»æ˜ç¡®åŒæ„
        allowOptOut: true, // å…è®¸é€€å‡º
        dataRetentionDays: 30,
        mustProvideDataExport: true, // å¿…é¡»æä¾›æ•°æ®å¯¼å‡º
        mustAllowDeletion: true, // å¿…é¡»å…è®¸åˆ é™¤
        consentText: "æˆ‘åŒæ„æ”¶é›†æˆ‘çš„æ“ä½œè¡Œä¸ºæ•°æ®ç”¨äºæ”¹è¿›äº§å“",
        privacyPolicyUrl: "/privacy-eu",
      },

      // ç¾å›½åŠ å· CCPA
      CA: {
        requireExplicitConsent: false, // å¯ä»¥é»˜è®¤å¼€å¯
        allowOptOut: true, // ä½†å¿…é¡»æä¾›é€€å‡ºé€‰é¡¹
        dataRetentionDays: 365,
        mustProvideDataExport: true,
        mustAllowDeletion: true,
        consentText: "äº†è§£æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨æ‚¨çš„æ•°æ®",
        privacyPolicyUrl: "/privacy-ccpa",
      },

      // ä¸­å›½ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•
      CN: {
        requireExplicitConsent: true,
        allowOptOut: true,
        dataRetentionDays: 30,
        mustProvideDataExport: true,
        mustAllowDeletion: true,
        consentText: "æˆ‘åŒæ„ã€Šç”¨æˆ·å½•åˆ¶æœåŠ¡åè®®ã€‹å’Œã€Šéšç§æ”¿ç­–ã€‹",
        privacyPolicyUrl: "/privacy-cn",
      },

      // å…¶ä»–åœ°åŒº
      OTHER: {
        requireExplicitConsent: true, // é»˜è®¤æœ€ä¸¥æ ¼
        allowOptOut: true,
        dataRetentionDays: 30,
        mustProvideDataExport: true,
        mustAllowDeletion: true,
        consentText: "æˆ‘åŒæ„å½•åˆ¶æˆ‘çš„æ“ä½œè¡Œä¸º",
        privacyPolicyUrl: "/privacy",
      },
    };

    return configs[this.region] || configs.OTHER;
  }

  async requestConsent() {
    const config = this.getComplianceConfig();

    // å¦‚æœä¸éœ€è¦æ˜ç¡®åŒæ„ï¼ˆå¦‚åŠ å·ï¼‰ï¼Œæ˜¾ç¤ºé€šçŸ¥å³å¯
    if (!config.requireExplicitConsent) {
      this.showNotice(config);
      return true;
    }

    // éœ€è¦æ˜ç¡®åŒæ„
    return this.showConsentDialog(config);
  }

  showNotice(config) {
    const notice = document.createElement("div");
    notice.innerHTML = `
      <div style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 400px;
        z-index: 999999;
      ">
        <p>æˆ‘ä»¬ä½¿ç”¨å½•åˆ¶æŠ€æœ¯æ¥æ”¹è¿›äº§å“ã€‚</p>
        <p><a href="${config.privacyPolicyUrl}" target="_blank">éšç§æ”¿ç­–</a></p>
        ${config.allowOptOut ? '<button id="opt-out">é€‰æ‹©é€€å‡º</button>' : ""}
        <button id="got-it">çŸ¥é“äº†</button>
      </div>
    `;

    document.body.appendChild(notice);

    if (config.allowOptOut) {
      document.getElementById("opt-out").addEventListener("click", () => {
        this.saveConsent(false);
        notice.remove();
      });
    }

    document.getElementById("got-it").addEventListener("click", () => {
      notice.remove();
    });
  }

  async showConsentDialog(config) {
    // å®ç°åŒæ„å¯¹è¯æ¡†ï¼ˆå‚è€ƒå‰é¢çš„ ConsentManagerï¼‰
    return new Promise((resolve) => {
      // ... å¼¹çª—å®ç°
    });
  }

  saveConsent(agreed) {
    localStorage.setItem(
      "recording-consent",
      JSON.stringify({
        agreed: agreed,
        region: this.region,
        timestamp: Date.now(),
      })
    );
  }
}

// ä½¿ç”¨
const compliance = new RegionalCompliance();
compliance.requestConsent().then((agreed) => {
  if (agreed) {
    startRecording();
  }
});
```

---

### 7. åˆè§„æ£€æŸ¥æ¸…å•

#### å¯åŠ¨å½•åˆ¶å‰çš„æ£€æŸ¥

```javascript
// compliance-checker.js
class ComplianceChecker {
  constructor() {
    this.checks = [];
  }

  async runAllChecks() {
    const results = [];

    // 1. æ£€æŸ¥ç”¨æˆ·åŒæ„
    results.push({
      name: "ç”¨æˆ·åŒæ„",
      passed: await this.checkConsent(),
      required: true,
    });

    // 2. æ£€æŸ¥éšç§æ”¿ç­–
    results.push({
      name: "éšç§æ”¿ç­–é“¾æ¥",
      passed: this.checkPrivacyPolicy(),
      required: true,
    });

    // 3. æ£€æŸ¥è„±æ•é…ç½®
    results.push({
      name: "æ•æ„Ÿä¿¡æ¯è„±æ•",
      passed: this.checkMaskingConfig(),
      required: true,
    });

    // 4. æ£€æŸ¥æ•°æ®åŠ å¯†
    results.push({
      name: "æ•°æ®åŠ å¯†ä¼ è¾“",
      passed: this.checkEncryption(),
      required: true,
    });

    // 5. æ£€æŸ¥æ•°æ®ä¿ç•™æœŸé™
    results.push({
      name: "æ•°æ®ä¿ç•™æœŸé™",
      passed: this.checkRetentionPolicy(),
      required: true,
    });

    // 6. æ£€æŸ¥é€€å‡ºæœºåˆ¶
    results.push({
      name: "ç”¨æˆ·é€€å‡ºé€‰é¡¹",
      passed: this.checkOptOutMechanism(),
      required: true,
    });

    const allPassed = results.every((r) => !r.required || r.passed);

    return {
      passed: allPassed,
      results: results,
    };
  }

  async checkConsent() {
    // æ£€æŸ¥æ˜¯å¦æœ‰åŒæ„æœºåˆ¶
    const hasConsentManager = typeof window.ConsentManager !== "undefined";
    const hasStoredConsent = localStorage.getItem("user-recording-consent");

    return hasConsentManager && hasStoredConsent;
  }

  checkPrivacyPolicy() {
    // æ£€æŸ¥éšç§æ”¿ç­–é“¾æ¥æ˜¯å¦å­˜åœ¨
    const privacyLink = document.querySelector('a[href*="privacy"]');
    return privacyLink !== null;
  }

  checkMaskingConfig() {
    // æ£€æŸ¥æ˜¯å¦é…ç½®äº†è„±æ•
    // æ£€æŸ¥å…³é”®çš„è„±æ•é€‰é¡¹
    return true; // ç®€åŒ–å®ç°
  }

  checkEncryption() {
    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ HTTPS
    return window.location.protocol === "https:";
  }

  checkRetentionPolicy() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ä¿ç•™æœŸé™é…ç½®
    return true; // ç®€åŒ–å®ç°
  }

  checkOptOutMechanism() {
    // æ£€æŸ¥æ˜¯å¦æœ‰é€€å‡ºé€‰é¡¹
    const optOutButton = document.getElementById("opt-out-recording");
    return optOutButton !== null;
  }
}

// å¯åŠ¨å½•åˆ¶å‰æ£€æŸ¥
async function startRecordingWithCompliance() {
  const checker = new ComplianceChecker();
  const result = await checker.runAllChecks();

  console.table(result.results);

  if (!result.passed) {
    console.error("âŒ åˆè§„æ£€æŸ¥æœªé€šè¿‡ï¼Œæ— æ³•å¯åŠ¨å½•åˆ¶");
    console.error(
      "æœªé€šè¿‡çš„é¡¹:",
      result.results.filter((r) => !r.passed)
    );
    return;
  }

  console.log("âœ… åˆè§„æ£€æŸ¥é€šè¿‡ï¼Œå¯åŠ¨å½•åˆ¶");
  recorder.start();
}
```

---

### 8. å®Œæ•´çš„åˆè§„æ–¹æ¡ˆå®æ–½

#### å‰ç«¯å®Œæ•´å®ç°

```javascript
// compliant-recorder.js
import rrweb from "rrweb";

class CompliantRecorder {
  constructor(config) {
    this.config = config;
    this.consentManager = new ConsentManager();
    this.privacyMask = new PrivacyMask();
    this.compliance = new RegionalCompliance();
    this.recorder = null;
  }

  async initialize() {
    // 1. æ£€æŸ¥åœ°åŒºåˆè§„è¦æ±‚
    const complianceConfig = this.compliance.getComplianceConfig();
    console.log("åˆè§„é…ç½®:", complianceConfig);

    // 2. è¯·æ±‚ç”¨æˆ·åŒæ„
    const agreed = await this.compliance.requestConsent();

    if (!agreed) {
      console.log("âŒ ç”¨æˆ·æœªåŒæ„ï¼Œä¸å¯åŠ¨å½•åˆ¶");
      return false;
    }

    // 3. è®°å½•åŒæ„
    await this.logConsent(agreed);

    // 4. å¯åŠ¨å½•åˆ¶
    this.startRecording();

    // 5. æä¾›ç”¨æˆ·æ§åˆ¶é€‰é¡¹
    this.setupUserControls();

    return true;
  }

  async logConsent(agreed) {
    const logger = new ConsentLogger(this.config.apiEndpoint);
    await logger.logConsent(this.getUserId(), agreed, {
      region: this.compliance.region,
      privacyVersion: "v1.0",
    });
  }

  startRecording() {
    const events = [];

    this.recorder = rrweb.record({
      // åº”ç”¨éšç§é…ç½®
      ...this.privacyMask.getRRWebConfig(),

      emit: (event) => {
        events.push(event);

        // æ¯ 50 ä¸ªäº‹ä»¶ä¸Šä¼ ä¸€æ¬¡
        if (events.length >= 50) {
          this.uploadEvents(events.splice(0));
        }
      },

      // é‡‡æ ·é…ç½®
      sampling: {
        mousemove: true,
        scroll: 150,
        input: "last",
      },

      // å®šæœŸåšå®Œæ•´å¿«ç…§
      checkoutEveryNms: 5 * 60 * 1000, // æ¯ 5 åˆ†é’Ÿ
    });

    console.log("âœ… åˆè§„å½•åˆ¶å·²å¯åŠ¨");
  }

  async uploadEvents(events) {
    try {
      await fetch(`${this.config.apiEndpoint}/recordings`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-User-Consent": "true",
          "X-Privacy-Version": "v1.0",
        },
        body: JSON.stringify({
          sessionId: this.getSessionId(),
          userId: this.getUserId(),
          events: events,
          meta: {
            consentVersion: "v1.0",
            region: this.compliance.region,
          },
        }),
        keepalive: true,
      });
    } catch (error) {
      console.error("ä¸Šä¼ å¤±è´¥:", error);
    }
  }

  setupUserControls() {
    // æ·»åŠ æ§åˆ¶é¢æ¿
    const panel = document.createElement("div");
    panel.innerHTML = `
      <div id="recording-controls" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 999999;
      ">
        <div style="margin-bottom: 10px;">
          <span style="color: #52c41a;">â— å½•åˆ¶ä¸­</span>
        </div>
        <button id="stop-recording">åœæ­¢å½•åˆ¶</button>
        <button id="view-privacy">éšç§æ”¿ç­–</button>
        <button id="opt-out">é€€å‡ºå½•åˆ¶</button>
      </div>
    `;

    document.body.appendChild(panel);

    // ç»‘å®šäº‹ä»¶
    document.getElementById("stop-recording").addEventListener("click", () => {
      this.stop();
    });

    document.getElementById("view-privacy").addEventListener("click", () => {
      window.open(this.compliance.getComplianceConfig().privacyPolicyUrl);
    });

    document.getElementById("opt-out").addEventListener("click", async () => {
      await this.optOut();
    });
  }

  async optOut() {
    const confirmed = confirm("ç¡®å®šè¦é€€å‡ºå½•åˆ¶å—ï¼Ÿæˆ‘ä»¬å°†åˆ é™¤æ‚¨çš„æ‰€æœ‰å½•åˆ¶æ•°æ®ã€‚");

    if (confirmed) {
      // åœæ­¢å½•åˆ¶
      this.stop();

      // æ’¤å›åŒæ„
      this.consentManager.revokeConsent();

      // åˆ é™¤æ•°æ®
      await fetch(
        `${this.config.apiEndpoint}/user/${this.getUserId()}/recordings`,
        {
          method: "DELETE",
        }
      );

      alert("âœ… å·²é€€å‡ºå½•åˆ¶ï¼Œæ‚¨çš„æ•°æ®å·²åˆ é™¤");
    }
  }

  stop() {
    this.recorder?.();
    console.log("ğŸ›‘ å½•åˆ¶å·²åœæ­¢");
  }

  getUserId() {
    return localStorage.getItem("anonymous-user-id") || "unknown";
  }

  getSessionId() {
    return `session-${Date.now()}`;
  }
}

// åˆå§‹åŒ–
const compliantRecorder = new CompliantRecorder({
  apiEndpoint: "/api",
});

compliantRecorder.initialize();
```

---

## åˆè§„æœ€ä½³å®è·µæ€»ç»“

### å¿…é¡»å®æ–½çš„æªæ–½

| æªæ–½             | é‡è¦æ€§     | è¯´æ˜                       |
| ---------------- | ---------- | -------------------------- |
| **æ˜ç¡®åŒæ„**     | â­â­â­â­â­ | å½•åˆ¶å‰å¿…é¡»è·å¾—ç”¨æˆ·æ˜ç¡®åŒæ„ |
| **éšç§æ”¿ç­–**     | â­â­â­â­â­ | æ¸…æ¥šè¯´æ˜æ”¶é›†ä»€ä¹ˆã€å¦‚ä½•ä½¿ç”¨ |
| **æ•æ„Ÿä¿¡æ¯è„±æ•** | â­â­â­â­â­ | å¯†ç ã€æ”¯ä»˜ä¿¡æ¯å¿…é¡»é®ç½©     |
| **æ•°æ®åŠ å¯†**     | â­â­â­â­â­ | ä¼ è¾“å’Œå­˜å‚¨éƒ½è¦åŠ å¯†         |
| **å®šæœŸåˆ é™¤**     | â­â­â­â­   | è®¾ç½®æ•°æ®ä¿ç•™æœŸé™           |
| **ç”¨æˆ·æ§åˆ¶æƒ**   | â­â­â­â­â­ | æŸ¥çœ‹ã€å¯¼å‡ºã€åˆ é™¤æ•°æ®       |
| **é€€å‡ºæœºåˆ¶**     | â­â­â­â­â­ | å…è®¸ç”¨æˆ·éšæ—¶é€€å‡º           |
| **è®¿é—®æ—¥å¿—**     | â­â­â­     | è®°å½•è°è®¿é—®äº†å½•åˆ¶æ•°æ®       |

### å®æ–½æ­¥éª¤

```javascript
// 1. å¯åŠ¨å‰æ£€æŸ¥
âœ… æ˜¯å¦æœ‰éšç§æ”¿ç­–ï¼Ÿ
âœ… æ˜¯å¦æœ‰ç”¨æˆ·åŒæ„æœºåˆ¶ï¼Ÿ
âœ… æ˜¯å¦é…ç½®äº†è„±æ•ï¼Ÿ
âœ… æ˜¯å¦ä½¿ç”¨ HTTPSï¼Ÿ

// 2. å½•åˆ¶æœŸé—´
âœ… å®æ—¶è„±æ•æ•æ„Ÿä¿¡æ¯
âœ… åŠ å¯†ä¸Šä¼ æ•°æ®
âœ… æä¾›é€€å‡ºé€‰é¡¹

// 3. æ•°æ®å­˜å‚¨
âœ… åŠ å¯†å­˜å‚¨
âœ… è®¾ç½®è¿‡æœŸæ—¶é—´
âœ… å®šæœŸæ¸…ç†

// 4. ç”¨æˆ·æƒåˆ©
âœ… æä¾›æŸ¥çœ‹å…¥å£
âœ… æä¾›å¯¼å‡ºåŠŸèƒ½
âœ… æä¾›åˆ é™¤åŠŸèƒ½
```

### ä»£ç æ¨¡æ¿ï¼ˆå¼€ç®±å³ç”¨ï¼‰

```javascript
// å®Œæ•´çš„åˆè§„å¯åŠ¨æµç¨‹
async function startCompliantRecording() {
  // 1. æ£€æŸ¥ç”¨æˆ·åŒæ„
  const consentManager = new ConsentManager();
  const agreed = await consentManager.requestConsent();

  if (!agreed) {
    console.log("ç”¨æˆ·æ‹’ç»å½•åˆ¶");
    return;
  }

  // 2. é…ç½®éšç§ä¿æŠ¤
  const privacyConfig = {
    maskAllInputs: true,
    maskTextSelector: ".sensitive, .private",
    blockSelector: ".payment-form, .admin-panel",
    maskInputFn: (text, element) => {
      // è‡ªå®šä¹‰è„±æ•é€»è¾‘
      if (element.type === "password") return "***";
      if (element.type === "email") return "***@***.com";
      return text;
    },
  };

  // 3. å¯åŠ¨å½•åˆ¶
  const events = [];
  const stopFn = rrweb.record({
    ...privacyConfig,
    emit: (event) => {
      events.push(event);
    },
  });

  // 4. æä¾›ç”¨æˆ·æ§åˆ¶
  window.stopRecording = () => {
    stopFn();
    console.log("å½•åˆ¶å·²åœæ­¢");
  };

  window.deleteMyRecordings = async () => {
    const userId = getUserId();
    await fetch(`/api/user/${userId}/recordings`, { method: "DELETE" });
    alert("æ‚¨çš„å½•åˆ¶æ•°æ®å·²åˆ é™¤");
  };

  console.log("âœ… åˆè§„å½•åˆ¶å·²å¯åŠ¨");
}

// å¯åŠ¨
startCompliantRecording();
```

---

## é£é™©å’Œæ³¨æ„äº‹é¡¹

### âš ï¸ æ³•å¾‹é£é™©

1. **æœªç»åŒæ„å½•åˆ¶** â†’ è¿å GDPRã€ä¸ªä¿æ³•ï¼Œæœ€é«˜ç½šæ¬¾æ•°ç™¾ä¸‡æ¬§å…ƒ
2. **æ³„éœ²æ•æ„Ÿä¿¡æ¯** â†’ æ•°æ®æ³„éœ²è´£ä»»ï¼Œèµ”å¿å’Œç½šæ¬¾
3. **è·¨å¢ƒæ•°æ®ä¼ è¾“** â†’ éœ€è¦é¢å¤–å®¡æ‰¹å’Œä¿æŠ¤æªæ–½
4. **æœªæä¾›åˆ é™¤æƒ** â†’ è¿åç”¨æˆ·æƒåˆ©ï¼Œé¢ä¸´ç›‘ç®¡å¤„ç½š

### âœ… ä¿æŠ¤æªæ–½

```javascript
// å®Œæ•´çš„ä¿æŠ¤æªæ–½æ¸…å•
const protectionMeasures = {
  technical: [
    "æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨é®ç½©",
    "HTTPS åŠ å¯†ä¼ è¾“",
    "æ•°æ®åº“åŠ å¯†å­˜å‚¨",
    "è®¿é—®æƒé™æ§åˆ¶",
    "å®šæœŸå®‰å…¨å®¡è®¡",
  ],

  legal: [
    "æ˜ç¡®çš„éšç§æ”¿ç­–",
    "ç”¨æˆ·åŒæ„æœºåˆ¶",
    "æ•°æ®ä¿ç•™æœŸé™",
    "åˆ é™¤å’Œå¯¼å‡ºåŠŸèƒ½",
    "åˆè§„æ£€æŸ¥æµç¨‹",
  ],

  operational: [
    "å‘˜å·¥åŸ¹è®­",
    "æ•°æ®è®¿é—®æ—¥å¿—",
    "å®šæœŸåˆè§„å®¡æŸ¥",
    "äº‹ä»¶å“åº”è®¡åˆ’",
    "æ•°æ®æ³„éœ²é¢„æ¡ˆ",
  ],
};

console.table(protectionMeasures);
```

---

## æ€»ç»“ï¼šåˆè§„å½•åˆ¶çš„å®Œæ•´æ–¹æ¡ˆ

### å®æ–½è·¯çº¿å›¾

```
ç¬¬ 1 å‘¨ï¼šæ³•å¾‹å’¨è¯¢
â”œâ”€ å’¨è¯¢å¾‹å¸ˆï¼Œäº†è§£é€‚ç”¨æ³•è§„
â”œâ”€ å‡†å¤‡éšç§æ”¿ç­–
â””â”€ è®¾è®¡ç”¨æˆ·åŒæ„æµç¨‹

ç¬¬ 2 å‘¨ï¼šæŠ€æœ¯å®æ–½
â”œâ”€ å®ç°åŒæ„ç®¡ç†å™¨
â”œâ”€ é…ç½®è„±æ•è§„åˆ™
â”œâ”€ å®ç°æ•°æ®åŠ å¯†
â””â”€ è®¾ç½®è‡ªåŠ¨åˆ é™¤

ç¬¬ 3 å‘¨ï¼šç”¨æˆ·æƒåˆ©
â”œâ”€ å®ç°æ•°æ®æŸ¥çœ‹åŠŸèƒ½
â”œâ”€ å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½
â”œâ”€ å®ç°æ•°æ®åˆ é™¤åŠŸèƒ½
â””â”€ å®ç°é€€å‡ºæœºåˆ¶

ç¬¬ 4 å‘¨ï¼šæµ‹è¯•å’Œå®¡æŸ¥
â”œâ”€ åˆè§„æ€§æµ‹è¯•
â”œâ”€ å®‰å…¨æµ‹è¯•
â”œâ”€ éšç§å½±å“è¯„ä¼°
â””â”€ æ³•å¾‹å®¡æŸ¥
```

### å…³é”®è¦ç‚¹

**å¿…é¡»åšçš„ï¼ˆæ³•å¾‹è¦æ±‚ï¼‰**ï¼š

1. âœ… **è·å¾—æ˜ç¡®åŒæ„** - ä¸èƒ½é»˜è®¤å¼€å¯
2. âœ… **æ¸…æ™°å‘ŠçŸ¥** - æ”¶é›†ä»€ä¹ˆã€å¦‚ä½•ä½¿ç”¨
3. âœ… **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤** - å¯†ç ã€æ”¯ä»˜å¿…é¡»é®ç½©
4. âœ… **ç”¨æˆ·æƒåˆ©** - æŸ¥çœ‹ã€åˆ é™¤ã€å¯¼å‡º
5. âœ… **æ•°æ®å®‰å…¨** - åŠ å¯†ä¼ è¾“å’Œå­˜å‚¨
6. âœ… **å®šæœŸåˆ é™¤** - ä¸èƒ½æ— é™æœŸä¿å­˜

**å»ºè®®åšçš„ï¼ˆæœ€ä½³å®è·µï¼‰**ï¼š

1. ğŸ’¡ **æœ€å°åŒ–æ”¶é›†** - åªæ”¶é›†å¿…è¦çš„æ•°æ®
2. ğŸ’¡ **åŒ¿ååŒ–å¤„ç†** - ä¸å…³è”ä¸ªäººèº«ä»½
3. ğŸ’¡ **é€æ˜åº¦** - å‘ŠçŸ¥ç”¨æˆ·æ­£åœ¨å½•åˆ¶
4. ğŸ’¡ **å®‰å…¨å®¡è®¡** - å®šæœŸæ£€æŸ¥å’Œæ›´æ–°
5. ğŸ’¡ **æ•°æ®æœ¬åœ°åŒ–** - éµå®ˆè·¨å¢ƒä¼ è¾“è§„å®š

éµå¾ªè¿™äº›åˆè§„æªæ–½ï¼Œå°±èƒ½åœ¨æ³•å¾‹æ¡†æ¶å†…å®‰å…¨åœ°ä½¿ç”¨å½•å±æŠ€æœ¯ï¼

---

## å®é™…ä¸šç•Œåšæ³•ï¼ˆSentry ç­‰å·¥å…·ï¼‰

### Sentry Session Replay çš„åˆè§„ç­–ç•¥

ä½ æåˆ°çš„é—®é¢˜å¾ˆå…³é”®ï¼Sentry ç¡®å®é€šå¸¸**ä¸ä¼šæ˜¾ç¤ºæ˜ç¡®çš„åŒæ„å¼¹çª—**ï¼Œä½†å®ƒé‡‡ç”¨äº†ä»¥ä¸‹ç­–ç•¥ï¼š

#### 1. éšç§æ”¿ç­–ä¸­çš„"éšå¼åŒæ„"

```html
<!-- ç½‘ç«™çš„éšç§æ”¿ç­–ä¸­ä¼šåŒ…å«ç±»ä¼¼å†…å®¹ -->
<p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ç¬¬ä¸‰æ–¹æœåŠ¡æ¥æ”¹è¿›äº§å“ï¼š</p>
<ul>
  <li>Sentry - ç”¨äºé”™è¯¯ç›‘æ§å’Œä¼šè¯é‡æ”¾</li>
  <li>Google Analytics - ç”¨äºç½‘ç«™åˆ†æ</li>
</ul>
<p>ç»§ç»­ä½¿ç”¨æœ¬ç½‘ç«™ï¼Œå³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„éšç§æ”¿ç­–ã€‚</p>
```

**æ³•å¾‹ä¾æ®**ï¼š

- æ¬§ç›Ÿï¼šå¯èƒ½ä¾èµ–"åˆæ³•åˆ©ç›Š"ï¼ˆLegitimate Interestï¼‰è€Œéæ˜ç¡®åŒæ„
- ç¾å›½ï¼šé‡‡ç”¨ opt-out æ¨¡å¼ï¼ˆå…è®¸é€€å‡ºï¼‰
- ä¸­å›½ï¼šå¯èƒ½å­˜åœ¨åˆè§„é£é™©

#### 2. Sentry çš„é»˜è®¤éšç§é…ç½®

```javascript
// Sentry çš„ Session Replay é»˜è®¤é…ç½®
Sentry.init({
  dsn: "your-dsn",

  integrations: [
    new Sentry.Replay({
      // âœ… é»˜è®¤é®ç½©æ‰€æœ‰è¾“å…¥
      maskAllInputs: true,

      // âœ… é»˜è®¤é®ç½©æ‰€æœ‰æ–‡æœ¬
      maskAllText: false, // ä½†é»˜è®¤ä¸é®ç½©æ–‡æœ¬ï¼ˆå¯èƒ½æœ‰é£é™©ï¼‰

      // âœ… é˜»æ­¢å½•åˆ¶ç‰¹å®šå…ƒç´ 
      blockAllMedia: true, // é˜»æ­¢åª’ä½“å…ƒç´ 

      // è‡ªå®šä¹‰é®ç½©
      block: [".sensitive", ".private"],
      mask: [".user-info"],

      // âœ… ç½‘ç»œè¯·æ±‚é®ç½©
      networkDetailAllowUrls: [], // é»˜è®¤ä¸è®°å½•è¯·æ±‚è¯¦æƒ…
      networkCaptureBodies: false, // ä¸æ•è·è¯·æ±‚ä½“
    }),
  ],

  // âœ… é‡‡æ ·ç‡ï¼ˆä¸æ˜¯æ‰€æœ‰ä¼šè¯éƒ½å½•åˆ¶ï¼‰
  replaysSessionSampleRate: 0.1, // åªå½•åˆ¶ 10% çš„ä¼šè¯
  replaysOnErrorSampleRate: 1.0, // å‘ç”Ÿé”™è¯¯æ—¶ 100% å½•åˆ¶
});
```

**å…³é”®ç‚¹**ï¼š

- Sentry é»˜è®¤é…ç½®å·²ç»åšäº†å¤§é‡éšç§ä¿æŠ¤
- åªåœ¨å‘ç”Ÿé”™è¯¯æ—¶å½•åˆ¶ï¼ˆå‡å°‘éšç§é£é™©ï¼‰
- é‡‡æ ·ç‡æ§åˆ¶ï¼ˆä¸æ˜¯æ‰€æœ‰ç”¨æˆ·éƒ½è¢«å½•åˆ¶ï¼‰

#### 3. åœ°åŒºå·®å¼‚åŒ–ç­–ç•¥

```javascript
// æ ¹æ®åœ°åŒºè°ƒæ•´ Sentry é…ç½®
class RegionalSentryConfig {
  static getConfig() {
    const region = this.detectRegion();

    const configs = {
      // æ¬§ç›Ÿï¼šæœ€ä¸¥æ ¼
      EU: {
        enabled: false, // é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦ç”¨æˆ·åŒæ„åå¯ç”¨
        requireConsent: true,
        maskAllText: true,
        maskAllInputs: true,
        sampleRate: 0.01, // åªå½•åˆ¶ 1%
      },

      // ç¾å›½ï¼šè¾ƒå®½æ¾
      US: {
        enabled: true, // é»˜è®¤å¯ç”¨
        requireConsent: false,
        maskAllText: false,
        maskAllInputs: true,
        sampleRate: 0.1,
        showOptOut: true, // æä¾›é€€å‡ºé€‰é¡¹
      },

      // ä¸­å›½ï¼šä¸­ç­‰ä¸¥æ ¼
      CN: {
        enabled: false, // å»ºè®®é»˜è®¤ç¦ç”¨
        requireConsent: true,
        maskAllText: true,
        maskAllInputs: true,
        sampleRate: 0.05,
      },
    };

    return configs[region] || configs.EU; // é»˜è®¤æœ€ä¸¥æ ¼
  }

  static detectRegion() {
    // æ£€æµ‹ç”¨æˆ·åœ°åŒºï¼ˆç®€åŒ–ï¼‰
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if (timezone.includes("Europe")) return "EU";
    if (timezone.includes("America")) return "US";
    if (timezone.includes("Asia/Shanghai")) return "CN";
    return "EU";
  }
}

// ä½¿ç”¨
const config = RegionalSentryConfig.getConfig();

if (config.requireConsent) {
  // éœ€è¦å¾å¾—åŒæ„
  requestUserConsent().then((agreed) => {
    if (agreed) {
      initSentry(config);
    }
  });
} else {
  // ç›´æ¥å¯åŠ¨ï¼ˆä½†æä¾›é€€å‡ºé€‰é¡¹ï¼‰
  initSentry(config);

  if (config.showOptOut) {
    showOptOutOption();
  }
}
```

---

### å®é™…æ“ä½œçš„ä¸‰ç§æ¨¡å¼

#### æ¨¡å¼ 1ï¼šOpt-inï¼ˆæ˜ç¡®åŒæ„ï¼‰â­ æœ€å®‰å…¨

```javascript
// æ¬§ç›Ÿ GDPR è¦æ±‚çš„æ¨¡å¼
class OptInRecorder {
  async start() {
    // 1. æ˜¾ç¤ºåŒæ„å¼¹çª—
    const agreed = await this.showConsentDialog();

    if (!agreed) {
      console.log("ç”¨æˆ·æ‹’ç»ï¼Œä¸å¯åŠ¨å½•åˆ¶");
      return;
    }

    // 2. è®°å½•åŒæ„
    this.logConsent(true);

    // 3. å¯åŠ¨ Sentry
    Sentry.init({
      integrations: [new Sentry.Replay()],
      replaysSessionSampleRate: 0.1,
    });
  }
}

// ç‰¹ç‚¹ï¼š
// âœ… åˆè§„æ€§æœ€é«˜
// âœ… ç”¨æˆ·æ˜ç¡®çŸ¥æƒ…
// âŒ å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒï¼ˆå¼¹çª—ï¼‰
// âŒ åŒæ„ç‡å¯èƒ½è¾ƒä½
```

#### æ¨¡å¼ 2ï¼šOpt-outï¼ˆå…è®¸é€€å‡ºï¼‰â­â­ ç¾å›½å¸¸ç”¨

```javascript
// åŠ å· CCPA å…è®¸çš„æ¨¡å¼
class OptOutRecorder {
  start() {
    // 1. ç›´æ¥å¯åŠ¨å½•åˆ¶ï¼ˆéšç§æ”¿ç­–ä¸­å·²è¯´æ˜ï¼‰
    Sentry.init({
      integrations: [
        new Sentry.Replay({
          maskAllInputs: true,
          blockAllMedia: true,
        }),
      ],
      replaysSessionSampleRate: 0.1,
    });

    // 2. æä¾›æ˜æ˜¾çš„é€€å‡ºé€‰é¡¹
    this.showOptOutOption();

    // 3. åœ¨éšç§æ”¿ç­–ä¸­è¯´æ˜
    console.log("å½•åˆ¶å·²å¯åŠ¨ï¼Œè¯¦è§éšç§æ”¿ç­–");
  }

  showOptOutOption() {
    // åœ¨é¡µé¢åº•éƒ¨æˆ–è®¾ç½®ä¸­æä¾›é€€å‡ºé€‰é¡¹
    const notice = document.createElement("div");
    notice.innerHTML = `
      <div style="position: fixed; bottom: 0; width: 100%; background: #f0f0f0; padding: 10px; text-align: center;">
        æˆ‘ä»¬ä½¿ç”¨ä¼šè¯å½•åˆ¶æ¥æ”¹è¿›äº§å“ã€‚
        <a href="/privacy">éšç§æ”¿ç­–</a> |
        <button id="opt-out-recording">é€‰æ‹©é€€å‡º</button>
      </div>
    `;

    document.body.appendChild(notice);

    document
      .getElementById("opt-out-recording")
      .addEventListener("click", () => {
        this.disableRecording();
        notice.remove();
        alert("å·²é€€å‡ºå½•åˆ¶");
      });
  }

  disableRecording() {
    // ç¦ç”¨å½•åˆ¶
    localStorage.setItem("recording-opt-out", "true");

    // é€šçŸ¥æœåŠ¡å™¨
    fetch("/api/opt-out", {
      method: "POST",
      body: JSON.stringify({ userId: getUserId() }),
    });
  }
}

// ç‰¹ç‚¹ï¼š
// âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆæ— å¼¹çª—ï¼‰
// âœ… è¦†ç›–ç‡é«˜ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
// âš ï¸ åˆè§„æ€§å–å†³äºåœ°åŒº
// âœ… æä¾›äº†é€€å‡ºé€‰é¡¹
```

#### æ¨¡å¼ 3ï¼šæ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰â­â­â­

```javascript
// æ ¹æ®åœ°åŒºå’Œç”¨æˆ·ç±»å‹é‡‡ç”¨ä¸åŒç­–ç•¥
class HybridRecorder {
  async start() {
    const region = this.detectRegion();
    const userType = this.getUserType(); // 'new' æˆ– 'returning'

    // æ¬§ç›Ÿï¼šå¿…é¡»æ˜ç¡®åŒæ„
    if (region === "EU") {
      const agreed = await this.showConsentDialog();
      if (agreed) {
        this.enableRecording();
      }
      return;
    }

    // ç¾å›½ï¼šæ£€æŸ¥æ˜¯å¦å·²é€€å‡º
    if (region === "US") {
      const hasOptedOut = localStorage.getItem("recording-opt-out");

      if (!hasOptedOut) {
        this.enableRecording();

        // é¦–æ¬¡è®¿é—®æ˜¾ç¤ºé€šçŸ¥
        if (userType === "new") {
          this.showPrivacyNotice();
        }
      }
      return;
    }

    // å…¶ä»–åœ°åŒºï¼šä¿å®ˆç­–ç•¥ï¼Œé»˜è®¤ç¦ç”¨
    const agreed = await this.showConsentDialog();
    if (agreed) {
      this.enableRecording();
    }
  }

  showPrivacyNotice() {
    const notice = document.createElement("div");
    notice.className = "privacy-notice";
    notice.innerHTML = `
      <div style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        max-width: 400px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 999999;
      ">
        <h4>éšç§é€šçŸ¥</h4>
        <p>æˆ‘ä»¬ä½¿ç”¨ä¼šè¯å½•åˆ¶æ¥æ”¹è¿›äº§å“å’Œè¯Šæ–­é—®é¢˜ã€‚</p>
        <p><a href="/privacy" target="_blank">æŸ¥çœ‹éšç§æ”¿ç­–</a></p>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button id="privacy-ok" style="
            flex: 1;
            padding: 8px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          ">çŸ¥é“äº†</button>
          <button id="privacy-opt-out" style="
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
          ">é€€å‡ºå½•åˆ¶</button>
        </div>
      </div>
    `;

    document.body.appendChild(notice);

    document.getElementById("privacy-ok").addEventListener("click", () => {
      notice.remove();

      // æ ‡è®°ç”¨æˆ·å·²çœ‹è¿‡é€šçŸ¥
      localStorage.setItem("privacy-notice-seen", "true");
    });

    document.getElementById("privacy-opt-out").addEventListener("click", () => {
      this.disableRecording();
      notice.remove();
    });

    // 10 ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(() => {
      if (notice.parentNode) {
        notice.remove();
      }
    }, 10000);
  }
}
```

---

### Sentry çš„å®é™…åˆè§„ä¾æ®

#### 1. åˆæ³•åˆ©ç›Šï¼ˆLegitimate Interestï¼‰

Sentry å¯èƒ½ä¾æ® GDPR ç¬¬ 6 æ¡çš„"åˆæ³•åˆ©ç›Š"æ¡æ¬¾ï¼š

```javascript
// GDPR Article 6(1)(f) - åˆæ³•åˆ©ç›Š
// ä¼ä¸šæœ‰"åˆæ³•åˆ©ç›Š"å¤„ç†æ•°æ®ï¼Œå¦‚æœï¼š
// 1. æœ‰åˆæ³•çš„å•†ä¸šç†ç”±ï¼ˆå¦‚æ”¹è¿›äº§å“ã€è¯Šæ–­ bugï¼‰
// 2. ä¸ä¼šè¿‡åº¦ä¾µçŠ¯ç”¨æˆ·éšç§
// 3. ç”¨æˆ·å¯ä»¥åå¯¹ï¼ˆopt-outï¼‰

// Sentry çš„è®ºç‚¹ï¼š
const legitimateInterest = {
  purpose: "è¯Šæ–­æŠ€æœ¯é—®é¢˜ï¼Œä¿éšœæœåŠ¡è´¨é‡",
  necessity: "æ²¡æœ‰å½•åˆ¶æ— æ³•æœ‰æ•ˆå¤ç°å’Œä¿®å¤ bug",
  balancing: "é‡‡å–äº†å¤§é‡éšç§ä¿æŠ¤æªæ–½ï¼ˆè„±æ•ã€é‡‡æ ·ï¼‰",
  userRights: "ç”¨æˆ·å¯ä»¥é€šè¿‡éšç§è®¾ç½®é€€å‡º",
};

// âš ï¸ ä½†è¿™åœ¨ä¸åŒåœ°åŒºçš„æ³•å¾‹è§£é‡Šä¸åŒ
```

#### 2. B2B åœºæ™¯çš„ç‰¹æ®Šæ€§

```javascript
// B2B SaaS äº§å“çš„ç‰¹æ®Šæƒ…å†µ
class B2BRecordingCompliance {
  // ä¼ä¸šå®¢æˆ·è´­ä¹°äº†æœåŠ¡
  // å½•åˆ¶æ˜¯æœåŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åˆåŒä¸­å·²è¯´æ˜

  initialize() {
    // 1. åœ¨æœåŠ¡æ¡æ¬¾ä¸­è¯´æ˜
    // "æœ¬æœåŠ¡åŒ…å«ä¼šè¯å½•åˆ¶åŠŸèƒ½ï¼Œç”¨äºæŠ€æœ¯æ”¯æŒå’Œäº§å“æ”¹è¿›"

    // 2. ä¼ä¸šç®¡ç†å‘˜å¯ä»¥æ§åˆ¶
    const companySettings = getCompanySettings();

    if (companySettings.enableSessionReplay) {
      this.startRecording({
        // ä¼ä¸šçº§é…ç½®
        dataResidency: companySettings.region, // æ•°æ®å­˜å‚¨åœ°åŒº
        retentionDays: companySettings.retentionDays || 30,

        // ä»ç„¶éœ€è¦éšç§ä¿æŠ¤
        maskAllInputs: true,
        blockClass: "sensitive",
      });
    }

    // 3. ç»ˆç«¯ç”¨æˆ·é€šçŸ¥
    this.showEnterpriseNotice();
  }

  showEnterpriseNotice() {
    // å¯¹äº B2Bï¼Œå¯ä»¥æ˜¾ç¤ºç®€å•é€šçŸ¥è€ŒéåŒæ„è¯·æ±‚
    console.log("æœ¬æœåŠ¡åŒ…å«ä¼šè¯å½•åˆ¶åŠŸèƒ½ï¼ˆç”±æ‚¨çš„ç»„ç»‡å¯ç”¨ï¼‰");

    // å¯é€‰ï¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå°å›¾æ ‡
    const indicator = document.createElement("div");
    indicator.innerHTML = `
      <div style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
        ğŸ”´ å½•åˆ¶ä¸­
      </div>
    `;
    document.body.appendChild(indicator);
  }
}

// B2B åœºæ™¯çš„æ³•å¾‹é€»è¾‘ï¼š
// - ä¼ä¸šæ˜¯æ•°æ®æ§åˆ¶è€…ï¼Œè´­ä¹°äº†æœåŠ¡
// - ç»ˆç«¯ç”¨æˆ·æ˜¯ä¼ä¸šå‘˜å·¥ï¼Œå—é›‡ä½£åè®®çº¦æŸ
// - ä¼ä¸šéœ€è¦åœ¨å‘˜å·¥æ‰‹å†Œä¸­è¯´æ˜ç›‘æ§æ”¿ç­–
```

#### 3. Cookie åŒæ„æ¨ªå¹…æ•´åˆ

```javascript
// è®¸å¤šç½‘ç«™å°†å½•åˆ¶åŒæ„æ•´åˆåˆ° Cookie æ¨ªå¹…ä¸­
class CookieBannerIntegration {
  showCookieBanner() {
    const banner = document.createElement("div");
    banner.innerHTML = `
      <div class="cookie-banner" style="
        position: fixed;
        bottom: 0;
        width: 100%;
        background: white;
        padding: 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 999999;
      ">
        <h3>Cookie å’Œéšç§è®¾ç½®</h3>
        <p>æˆ‘ä»¬ä½¿ç”¨ Cookie å’Œç±»ä¼¼æŠ€æœ¯ï¼ˆåŒ…æ‹¬ä¼šè¯å½•åˆ¶ï¼‰æ¥æ”¹è¿›æ‚¨çš„ä½“éªŒã€‚</p>
        
        <div style="margin: 15px 0;">
          <label>
            <input type="checkbox" checked disabled /> å¿…è¦çš„ Cookieï¼ˆå¿…éœ€ï¼‰
          </label><br>
          
          <label>
            <input type="checkbox" id="analytics-consent" checked />
            åˆ†æå’Œæ€§èƒ½ï¼ˆåŒ…æ‹¬ Sentry ä¼šè¯å½•åˆ¶ï¼‰
          </label><br>
          
          <label>
            <input type="checkbox" id="marketing-consent" />
            è¥é”€ Cookie
          </label>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button id="accept-all">å…¨éƒ¨æ¥å—</button>
          <button id="accept-selected">ä»…æ¥å—å·²é€‰</button>
          <button id="reject-all">å…¨éƒ¨æ‹’ç»</button>
        </div>
        
        <a href="/privacy" target="_blank">éšç§æ”¿ç­–</a> | 
        <a href="/cookie-policy" target="_blank">Cookie æ”¿ç­–</a>
      </div>
    `;

    document.body.appendChild(banner);

    // å¤„ç†æŒ‰é’®ç‚¹å‡»
    document.getElementById("accept-all").addEventListener("click", () => {
      this.savePreferences({
        necessary: true,
        analytics: true, // âœ… åŒ…å« Sentry å½•åˆ¶
        marketing: true,
      });

      this.enableSentry();
      banner.remove();
    });

    document.getElementById("accept-selected").addEventListener("click", () => {
      const analyticsConsent =
        document.getElementById("analytics-consent").checked;

      this.savePreferences({
        necessary: true,
        analytics: analyticsConsent,
        marketing: document.getElementById("marketing-consent").checked,
      });

      if (analyticsConsent) {
        this.enableSentry(); // âœ… ç”¨æˆ·åŒæ„äº†åˆ†æç±»
      }

      banner.remove();
    });

    document.getElementById("reject-all").addEventListener("click", () => {
      this.savePreferences({
        necessary: true,
        analytics: false, // âŒ ä¸å¯ç”¨ Sentry
        marketing: false,
      });

      banner.remove();
    });
  }

  enableSentry() {
    Sentry.init({
      integrations: [new Sentry.Replay()],
      replaysSessionSampleRate: 0.1,
    });

    console.log("âœ… Sentry å½•åˆ¶å·²å¯ç”¨");
  }
}
```

---

### å®é™…é£é™©å’Œæƒè¡¡

#### ä¸åŒåšæ³•çš„é£é™©è¯„ä¼°

| åšæ³•                 | åˆè§„æ€§ | æ•°æ®è¦†ç›–ç‡            | ç”¨æˆ·ä½“éªŒ      | æ³•å¾‹é£é™© |
| -------------------- | ------ | --------------------- | ------------- | -------- |
| **æ˜ç¡®åŒæ„å¼¹çª—**     | ğŸŸ¢ é«˜  | ğŸ”´ ä½ï¼ˆ30-50%ï¼‰       | ğŸ”´ æœ‰å¼¹çª—å¹²æ‰° | ğŸŸ¢ æä½  |
| **Cookie æ¨ªå¹…æ•´åˆ**  | ğŸŸ¡ ä¸­  | ğŸŸ¡ ä¸­ï¼ˆ60-70%ï¼‰       | ğŸŸ¡ æ ‡å‡†ä½“éªŒ   | ğŸŸ¡ è¾ƒä½  |
| **éšç§æ”¿ç­–éšå¼åŒæ„** | ğŸ”´ ä½  | ğŸŸ¢ é«˜ï¼ˆ90%+ï¼‰         | ğŸŸ¢ æ— å¹²æ‰°     | ğŸ”´ è¾ƒé«˜  |
| **ä»…é”™è¯¯æ—¶å½•åˆ¶**     | ğŸŸ¡ ä¸­  | ğŸŸ¡ ä¸­ï¼ˆå–å†³äºé”™è¯¯ç‡ï¼‰ | ğŸŸ¢ æ— å¹²æ‰°     | ğŸŸ¡ ä¸­    |

#### Sentry çš„å®é™…ç­–ç•¥ï¼ˆæ¨æµ‹ï¼‰

```javascript
// Sentry å¯èƒ½é‡‡ç”¨çš„ç»¼åˆç­–ç•¥
const sentryStrategy = {
  // 1. é»˜è®¤é«˜åº¦è„±æ•
  privacy: {
    maskAllInputs: true,
    blockAllMedia: true,
    maskAllText: false, // ä½†å…è®¸é…ç½®
  },

  // 2. ä»…åœ¨é”™è¯¯æ—¶å½•åˆ¶ï¼ˆé™ä½é£é™©ï¼‰
  sampling: {
    normalSession: 0, // æ­£å¸¸æƒ…å†µä¸å½•åˆ¶
    errorSession: 1.0, // é”™è¯¯æ—¶ 100% å½•åˆ¶
  },

  // 3. ä¾èµ–å®¢æˆ·çš„éšç§æ”¿ç­–
  legalBasis: "å®¢æˆ·åœ¨è‡ªå·±çš„éšç§æ”¿ç­–ä¸­è¯´æ˜ä½¿ç”¨ Sentry",

  // 4. æä¾›è¯¦ç»†çš„éšç§é…ç½®
  customerControl: {
    canDisable: true,
    canConfigureMasking: true,
    canSetRetention: true,
    canChooseRegion: true,
  },

  // 5. åˆåŒçº¦æŸ
  agreement: "åœ¨æœåŠ¡æ¡æ¬¾ä¸­è¯´æ˜å½•åˆ¶åŠŸèƒ½",
};
```

---

### æ¨èçš„å®é™…åšæ³•

#### å¯¹äºä¸åŒåœºæ™¯çš„å»ºè®®

```javascript
// 1. é¢å‘æ¶ˆè´¹è€…çš„äº§å“ï¼ˆB2Cï¼‰
if (isConsumerProduct) {
  if (region === "EU" || region === "CN") {
    // âœ… å¿…é¡»ï¼šæ˜ç¡®åŒæ„
    await requestExplicitConsent();
  } else if (region === "US") {
    // âœ… å¯ä»¥ï¼šOpt-out + Cookie æ¨ªå¹…
    showCookieBanner();
    enableRecordingWithOptOut();
  }
}

// 2. ä¼ä¸šäº§å“ï¼ˆB2B SaaSï¼‰
if (isEnterpriseProduct) {
  // âœ… åœ¨æœåŠ¡åˆåŒä¸­è¯´æ˜
  // âœ… ä¼ä¸šç®¡ç†å‘˜æ§åˆ¶
  // âœ… ä»ç„¶éœ€è¦éšç§ä¿æŠ¤æªæ–½

  if (adminSettings.enableRecording) {
    enableRecording({
      // é«˜åº¦è„±æ•
      maskAllInputs: true,
      maskAllText: true,

      // é€šçŸ¥å‘˜å·¥
      showEmployeeNotice: true,
    });
  }
}

// 3. å¼€å‘/æµ‹è¯•ç¯å¢ƒ
if (isDevelopment) {
  // âœ… å¯ä»¥è‡ªç”±å½•åˆ¶ï¼ˆå†…éƒ¨å›¢é˜Ÿï¼‰
  // âš ï¸ ä½†ä»éœ€æ³¨æ„ä¸è¦æ³„éœ²æµ‹è¯•æ•°æ®
  enableRecording({
    maskAllInputs: false, // å¼€å‘ç¯å¢ƒå¯èƒ½éœ€è¦çœ‹çœŸå®æ•°æ®
  });
}
```

#### æœ€ä¿é™©çš„åšæ³•

```javascript
// æ¨èï¼šåˆ†çº§å½•åˆ¶ç­–ç•¥
class TieredRecordingStrategy {
  async initialize() {
    // ç¬¬ 1 å±‚ï¼šåŸºç¡€é¥æµ‹ï¼ˆæ— å½•åˆ¶ï¼‰
    // å§‹ç»ˆå¯ç”¨ï¼Œè®°å½•åŸºç¡€æŒ‡æ ‡
    this.enableBasicTelemetry(); // é¡µé¢è®¿é—®ã€é”™è¯¯æ•°é‡ç­‰

    // ç¬¬ 2 å±‚ï¼šé”™è¯¯æ—¶å½•åˆ¶
    // å‘ç”Ÿé”™è¯¯æ—¶è¯·æ±‚åŒæ„
    window.addEventListener("error", async (e) => {
      const agreed = await this.requestErrorRecording();

      if (agreed) {
        // åªå½•åˆ¶è¿™ä¸€æ¬¡ä¼šè¯
        this.enableOneTimeRecording();
      }
    });

    // ç¬¬ 3 å±‚ï¼šå®Œæ•´å½•åˆ¶ï¼ˆéœ€è¦æ˜ç¡®åŒæ„ï¼‰
    const fullConsent = await this.checkFullRecordingConsent();

    if (fullConsent) {
      this.enableFullRecording();
    }
  }

  async requestErrorRecording() {
    return new Promise((resolve) => {
      const dialog = document.createElement("div");
      dialog.innerHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999999;">
          <h3>âš ï¸ æ£€æµ‹åˆ°é”™è¯¯</h3>
          <p>æ˜¯å¦å…è®¸æˆ‘ä»¬å½•åˆ¶æ‚¨åˆšæ‰çš„æ“ä½œä»¥å¸®åŠ©ä¿®å¤é—®é¢˜ï¼Ÿ</p>
          <p style="font-size: 12px; color: #666;">å½•åˆ¶å°†åœ¨é—®é¢˜ä¿®å¤åç«‹å³åˆ é™¤</p>
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button id="error-allow">å…è®¸</button>
            <button id="error-deny">æ‹’ç»</button>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      document.getElementById("error-allow").addEventListener("click", () => {
        dialog.remove();
        resolve(true);
      });

      document.getElementById("error-deny").addEventListener("click", () => {
        dialog.remove();
        resolve(false);
      });

      // 5 ç§’åè‡ªåŠ¨æ‹’ç»
      setTimeout(() => {
        if (dialog.parentNode) {
          dialog.remove();
          resolve(false);
        }
      }, 5000);
    });
  }
}
```

---

### æ€»ç»“ï¼šå®é™…æ“ä½œå»ºè®®

#### å¯¹äºæ–°é¡¹ç›®

```javascript
// æ¨èåšæ³•ï¼ˆå¹³è¡¡åˆè§„å’Œæ•°æ®æ”¶é›†ï¼‰

// 1. æ˜¾ç¤º Cookie æ¨ªå¹…ï¼ˆæ•´åˆå½•åˆ¶åŒæ„ï¼‰
showCookieBanner({
  categories: {
    necessary: { required: true },
    analytics: {
      includes: ["Sentry Session Replay"],
      default: false, // é»˜è®¤ä¸å‹¾é€‰
    },
  },
});

// 2. åªåœ¨ç”¨æˆ·åŒæ„åˆ†æç±» Cookie åå¯ç”¨
if (userConsent.analytics) {
  Sentry.init({
    integrations: [
      new Sentry.Replay({
        // é«˜åº¦è„±æ•
        maskAllInputs: true,
        blockAllMedia: true,

        // ä»…é”™è¯¯æ—¶å½•åˆ¶
        replaysSessionSampleRate: 0,
        replaysOnErrorSampleRate: 1.0,
      }),
    ],
  });
}

// 3. æä¾›æ¸…æ™°çš„é€€å‡ºå’Œç®¡ç†é€‰é¡¹
showPrivacyControls();
```

#### å¯¹äºå·²æœ‰é¡¹ç›®ï¼ˆSentry å·²é›†æˆï¼‰

```javascript
// å¦‚ä½•æ”¹é€ ç°æœ‰çš„ Sentry é›†æˆ

// âŒ ä¹‹å‰ï¼šç›´æ¥å¯ç”¨
Sentry.init({
  integrations: [new Sentry.Replay()],
  replaysSessionSampleRate: 0.1,
});

// âœ… æ”¹é€ åï¼šæ¡ä»¶å¯ç”¨
async function initSentryCompliant() {
  // 1. æ£€æŸ¥åœ°åŒº
  const region = detectUserRegion();

  // 2. æ ¹æ®åœ°åŒºå†³å®šç­–ç•¥
  let enableReplay = false;

  if (region === "EU" || region === "CN") {
    // ä¸¥æ ¼åœ°åŒºï¼šéœ€è¦æ˜ç¡®åŒæ„
    const consent = await requestConsent();
    enableReplay = consent;
  } else {
    // å…¶ä»–åœ°åŒºï¼šæ£€æŸ¥æ˜¯å¦é€€å‡º
    const optedOut = localStorage.getItem("sentry-replay-opt-out");
    enableReplay = !optedOut;

    // é¦–æ¬¡è®¿é—®æ˜¾ç¤ºé€šçŸ¥
    if (!localStorage.getItem("privacy-notice-shown")) {
      showPrivacyNotice();
      localStorage.setItem("privacy-notice-shown", "true");
    }
  }

  // 3. å¯ç”¨ Sentry
  Sentry.init({
    integrations: enableReplay
      ? [
          new Sentry.Replay({
            maskAllInputs: true,
            blockAllMedia: true,
            replaysSessionSampleRate: 0, // æ­£å¸¸ä¸å½•
            replaysOnErrorSampleRate: 1.0, // é”™è¯¯æ—¶å½•
          }),
        ]
      : [],
  });
}

initSentryCompliant();
```

---

### å…³é”®å»ºè®®

**åˆè§„å»ºè®®ï¼ˆä»ä¿å®ˆåˆ°æ¿€è¿›ï¼‰**ï¼š

1. **æœ€ä¿å®ˆï¼ˆ100% åˆè§„ï¼‰**ï¼š

   - âœ… æ‰€æœ‰åœ°åŒºéƒ½æ˜¾ç¤ºæ˜ç¡®åŒæ„å¼¹çª—
   - âœ… é»˜è®¤ç¦ç”¨ï¼Œç”¨æˆ·åŒæ„åå¯ç”¨
   - âœ… æä¾›å®Œæ•´çš„ç”¨æˆ·æ§åˆ¶é¢æ¿
   - âŒ ç¼ºç‚¹ï¼šæ•°æ®è¦†ç›–ç‡ä½ï¼ˆ30-50%ï¼‰

2. **å¹³è¡¡æ–¹æ¡ˆï¼ˆæ¨èï¼‰**ï¼š

   - âœ… æ¬§ç›Ÿ/ä¸­å›½ï¼šæ˜ç¡®åŒæ„
   - âœ… ç¾å›½ï¼šOpt-out + é€šçŸ¥
   - âœ… æ•´åˆåˆ° Cookie æ¨ªå¹…
   - âœ… ä»…é”™è¯¯æ—¶å½•åˆ¶
   - âœ… é«˜åº¦è„±æ•
   - âš¡ è¦†ç›–ç‡ï¼š60-80%

3. **æ¿€è¿›æ–¹æ¡ˆï¼ˆæœ‰é£é™©ï¼‰**ï¼š
   - âš ï¸ éšç§æ”¿ç­–ä¸­è¯´æ˜
   - âš ï¸ é»˜è®¤å¯ç”¨
   - âš ï¸ ä¾èµ–"åˆæ³•åˆ©ç›Š"
   - âš ï¸ æä¾›é€€å‡ºé€‰é¡¹
   - âŒ é£é™©ï¼šå¯èƒ½è¿å GDPR/ä¸ªä¿æ³•

**å®é™…æ“ä½œ**ï¼š

```javascript
// å¤§å¤šæ•°å…¬å¸çš„å®é™…åšæ³•ï¼ˆåŒ…æ‹¬ä½¿ç”¨ Sentry çš„ï¼‰
const practicalApproach = {
  // 1. åœ¨éšç§æ”¿ç­–ä¸­è¯´æ˜ï¼ˆè¯¦ç»†ï¼‰
  privacyPolicy: "æ˜ç¡®åˆ—å‡ºä½¿ç”¨ Sentry ç­‰å·¥å…·",

  // 2. Cookie æ¨ªå¹…ä¸­æ•´åˆåŒæ„
  cookieBanner: "å°†å½•åˆ¶å½’ç±»ä¸º'åˆ†æç±» Cookie'",

  // 3. é»˜è®¤é«˜åº¦è„±æ•
  defaultConfig: {
    maskAllInputs: true,
    blockPaymentPages: true,
  },

  // 4. ä»…é”™è¯¯æ—¶å½•åˆ¶
  errorOnly: true, // é™ä½éšç§é£é™©

  // 5. æä¾›é€€å‡ºé€‰é¡¹
  optOut: "åœ¨éšç§è®¾ç½®ä¸­æä¾›é€€å‡ºé€‰é¡¹",

  // 6. æ•°æ®è‡ªåŠ¨åˆ é™¤
  retention: "30 å¤©åè‡ªåŠ¨åˆ é™¤",
};

// âš ï¸ æ³¨æ„ï¼š
// - è¿™ç§åšæ³•åœ¨æ¬§ç›Ÿå¯èƒ½ä»æœ‰é£é™©
// - å»ºè®®å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆ
// - æŒç»­å…³æ³¨æ³•è§„å˜åŒ–
```

---

### æ³•å¾‹å…è´£å£°æ˜

**é‡è¦æç¤º**ï¼š

> âš ï¸ **æœ¬æ–‡æ¡£ä»…ä¾›æŠ€æœ¯å‚è€ƒï¼Œä¸æ„æˆæ³•å¾‹å»ºè®®**
>
> - ä¸åŒå›½å®¶å’Œåœ°åŒºçš„æ³•å¾‹è¦æ±‚ä¸åŒ
> - æ³•å¾‹æ³•è§„æŒç»­æ›´æ–°å˜åŒ–
> - å…·ä½“å®æ–½å‰è¯·å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆ
> - ä½œè€…ä¸å¯¹å› ä½¿ç”¨æœ¬æ–‡æ¡£å¯¼è‡´çš„æ³•å¾‹åæœè´Ÿè´£
>
> å»ºè®®ï¼š
>
> 1. å’¨è¯¢å½“åœ°éšç§æ³•å¾‹ä¸“å®¶
> 2. è¿›è¡Œéšç§å½±å“è¯„ä¼°ï¼ˆPIA/DPIAï¼‰
> 3. å®šæœŸå®¡æŸ¥å’Œæ›´æ–°éšç§æ”¿ç­–
> 4. ä¿æŒå¯¹æ³•è§„å˜åŒ–çš„å…³æ³¨

**ç»“è®º**ï¼šSentry ç­‰å·¥å…·è™½ç„¶å¸¸å¸¸æ²¡æœ‰æ˜ç¡®çš„åŒæ„å¼¹çª—ï¼Œä½†å®ƒä»¬é€šè¿‡**éšç§æ”¿ç­–è¯´æ˜ + é«˜åº¦è„±æ• + ä»…é”™è¯¯æ—¶å½•åˆ¶ + æä¾›é€€å‡ºé€‰é¡¹**ç­‰æ–¹å¼æ¥å¹³è¡¡åˆè§„æ€§å’Œæ•°æ®æ”¶é›†ã€‚ä¸è¿‡ï¼Œæœ€å®‰å…¨çš„åšæ³•ä»ç„¶æ˜¯**æ˜ç¡®å¾å¾—ç”¨æˆ·åŒæ„**ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¬§ç›Ÿå’Œä¸­å›½ç­‰éšç§æ³•è§„ä¸¥æ ¼çš„åœ°åŒºã€‚
