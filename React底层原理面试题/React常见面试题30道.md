# React å¸¸è§é¢è¯•é¢˜ 30 é“ï¼ˆå®æˆ˜ç¯‡ï¼‰

> ç»“åˆ React åº•å±‚åŸç†ï¼Œæ·±å…¥è§£æ 30 ä¸ªæœ€å¸¸è§çš„ React é¢è¯•é¢˜
>
> **ç‰ˆæœ¬è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åŸºäº **React 19** ç¼–å†™ï¼ŒåŒ…å« React 19 çš„æœ€æ–°ç‰¹æ€§å’Œå˜åŒ–ã€‚

---

## ğŸ“‹ ç›®å½•

### çŠ¶æ€ç®¡ç†ç±»ï¼ˆ5 é¢˜ï¼‰

1. setState æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ
2. ä¸ºä»€ä¹ˆå¤šæ¬¡ setState åªä¼š render ä¸€æ¬¡ï¼Ÿ
3. å‡½æ•°å¼ setState å’Œç›´æ¥ä¼ å€¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
4. setState ä¹‹åå¦‚ä½•ç«‹å³è·å–æ›´æ–°åçš„å€¼ï¼Ÿ
5. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä¿®æ”¹ stateï¼Ÿ

### ç»„ä»¶å’Œæ¸²æŸ“ç±»ï¼ˆ5 é¢˜ï¼‰

6. React ç»„ä»¶ä»€ä¹ˆæ—¶å€™ä¼šé‡æ–°æ¸²æŸ“ï¼Ÿ
7. çˆ¶ç»„ä»¶ renderï¼Œå­ç»„ä»¶ä¸€å®šä¼š render å—ï¼Ÿ
8. å¦‚ä½•é¿å…ç»„ä»¶ä¸å¿…è¦çš„æ¸²æŸ“ï¼Ÿ
9. React å¦‚ä½•åˆ¤æ–­ä½•æ—¶é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Ÿ
10. è™šæ‹Ÿ DOM ä¸€å®šæ¯”çœŸå® DOM å¿«å—ï¼Ÿ

### Hooks ä½¿ç”¨ç±»ï¼ˆ6 é¢˜ï¼‰

11. useEffect å’Œ useLayoutEffect çš„åŒºåˆ«ï¼Ÿ
12. useEffect çš„ä¾èµ–æ•°ç»„ä¸ºç©ºä¼šæ€æ ·ï¼Ÿ
13. useEffect çš„ cleanup å‡½æ•°ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ
14. ä¸ºä»€ä¹ˆ Hook å¿…é¡»åœ¨é¡¶å±‚è°ƒç”¨ï¼Ÿ
15. è‡ªå®šä¹‰ Hook æœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ
16. useCallback å’Œ useMemo ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ

### äº‹ä»¶ç³»ç»Ÿç±»ï¼ˆ3 é¢˜ï¼‰

17. React äº‹ä»¶å’ŒåŸç”Ÿäº‹ä»¶çš„åŒºåˆ«ï¼Ÿ
18. React äº‹ä»¶ä¸­çš„ event å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿ
19. å¦‚ä½•é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Ÿ

### æ€§èƒ½ä¼˜åŒ–ç±»ï¼ˆ5 é¢˜ï¼‰

20. React.memo æœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ
21. key çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç”¨ indexï¼Ÿ
22. å¦‚ä½•ä¼˜åŒ–é•¿åˆ—è¡¨æ€§èƒ½ï¼Ÿ
23. ä»€ä¹ˆæ˜¯ React çš„æ‰¹å¤„ç†ï¼Ÿ
24. å¦‚ä½•é¿å…å†…è”å‡½æ•°å’Œå¯¹è±¡ï¼Ÿ

### Refs å’Œ DOM ç±»ï¼ˆ2 é¢˜ï¼‰

25. ref çš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯ï¼Ÿ
26. React 19 ä¸­ ref çš„æ–°ç‰¹æ€§ï¼ŸforwardRef è¿˜éœ€è¦å—ï¼Ÿ

### Context å’Œé€šä¿¡ç±»ï¼ˆ2 é¢˜ï¼‰

27. Context å¦‚ä½•å·¥ä½œï¼Ÿæœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Ÿ
28. ç»„ä»¶é€šä¿¡æœ‰å“ªäº›æ–¹å¼ï¼Ÿ

### é”™è¯¯å¤„ç†ç±»ï¼ˆ1 é¢˜ï¼‰

29. ErrorBoundary çš„åŸç†å’Œä½¿ç”¨ï¼Ÿ

### æœ€ä½³å®è·µç±»ï¼ˆ1 é¢˜ï¼‰

30. React å¼€å‘æœ‰å“ªäº›æœ€ä½³å®è·µï¼Ÿ

---

## ä¸€ã€çŠ¶æ€ç®¡ç†ç±»

### 1. setState æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ

**ç­”æ¡ˆï¼šåœ¨ React 18 ä¸­ï¼ŒsetState çš„è¡Œä¸ºå–å†³äºè°ƒç”¨ä½ç½®ï¼Œä½†è¡¨ç°ä¸Šéƒ½æ˜¯"å¼‚æ­¥"çš„ï¼ˆæ‰¹å¤„ç†ï¼‰ã€‚**

#### æ·±å…¥è§£æ

**React 18 çš„æ‰¹å¤„ç†æœºåˆ¶**ï¼ˆè¯¦è§ç¬¬ 13 é¢˜ï¼‰ï¼š

```javascript
function Component() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    console.log("before:", count); // 0

    setCount(1);
    console.log("after:", count); // ä»ç„¶æ˜¯0ï¼ˆä¸æ˜¯1ï¼‰

    setCount(2);
    console.log("after:", count); // ä»ç„¶æ˜¯0ï¼ˆä¸æ˜¯2ï¼‰
  };

  console.log("render:", count); // åªæ‰“å°ä¸€æ¬¡ï¼š2

  return <button onClick={handleClick}>Click</button>;
}
```

**åŸç†è¯´æ˜**ï¼š

```javascript
// setStateçš„æ‰§è¡Œè¿‡ç¨‹ï¼ˆåº•å±‚åŸç†è§ç¬¬9é¢˜ï¼‰

1. setCount(1)
   â†’ åˆ›å»ºupdateå¯¹è±¡ {action: 1, lane: SyncLane}
   â†’ åŠ å…¥updateQueue
   â†’ è°ƒåº¦å¾®ä»»åŠ¡ï¼ˆensureRootIsScheduledï¼‰
   â†’ ç«‹å³è¿”å›ï¼ˆåŒæ­¥ï¼‰

2. setCount(2)
   â†’ åˆ›å»ºupdateå¯¹è±¡ {action: 2}
   â†’ åŠ å…¥updateQueue
   â†’ didScheduleMicrotask = trueï¼Œè·³è¿‡è°ƒåº¦
   â†’ ç«‹å³è¿”å›ï¼ˆåŒæ­¥ï¼‰

3. åŒæ­¥ä»£ç æ‰§è¡Œå®Œ

4. å¾®ä»»åŠ¡æ‰§è¡Œ
   â†’ processRootScheduleInMicrotask
   â†’ renderé˜¶æ®µ
   â†’ å¤„ç†updateQueueï¼šupdate1(1) â†’ update2(2)
   â†’ æœ€ç»ˆstate = 2

5. commit
   â†’ ç”¨æˆ·çœ‹åˆ°count = 2

å…³é”®ï¼š
- setStateæœ¬èº«æ˜¯åŒæ­¥å‡½æ•°
- ä½†stateæ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼ˆåœ¨å¾®ä»»åŠ¡ä¸­ï¼‰
- React 18çš„è‡ªåŠ¨æ‰¹å¤„ç†ä¿è¯æ€§èƒ½
```

**ç‰¹æ®Šæƒ…å†µï¼šflushSync å¼ºåˆ¶åŒæ­¥**

```javascript
import { flushSync } from "react-dom";

function Component() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    flushSync(() => {
      setCount(1);
    });
    console.log(count); // ä»ç„¶æ˜¯0ï¼ˆé—­åŒ…ï¼‰

    // ä½†DOMå·²ç»æ›´æ–°äº†
    const button = document.querySelector("button");
    console.log(button.textContent); // "Count: 1"
  };

  return <button onClick={handleClick}>Count: {count}</button>;
}
```

**æ€»ç»“**ï¼š

- âœ… setState å‡½æ•°æœ¬èº«æ˜¯åŒæ­¥çš„
- âœ… state çš„æ›´æ–°æ˜¯æ‰¹å¤„ç†çš„ï¼ˆçœ‹èµ·æ¥åƒå¼‚æ­¥ï¼‰
- âœ… React 18 æ‰€æœ‰åœºæ™¯éƒ½è‡ªåŠ¨æ‰¹å¤„ç†
- âœ… ä½¿ç”¨ flushSync å¯ä»¥å¼ºåˆ¶åŒæ­¥æ›´æ–° DOM

---

### 2. ä¸ºä»€ä¹ˆå¤šæ¬¡ setState åªä¼š render ä¸€æ¬¡ï¼Ÿ

**ç­”æ¡ˆï¼šReact çš„æ‰¹å¤„ç†æœºåˆ¶ï¼ˆBatchingï¼‰ä¼šåˆå¹¶å¤šä¸ª setStateã€‚**

#### æ·±å…¥è§£æ

**æ‰¹å¤„ç†çš„å®ç°**ï¼ˆè¯¦è§ç¬¬ 13 é¢˜ï¼‰ï¼š

```javascript
function SignupForm() {
  const [username, setUsername] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const handleSubmit = async () => {
    const data = await api.signup({ username, email, password });

    // React 18: è¿™4ä¸ªsetStateæ‰¹å¤„ç†ï¼Œåªrender 1æ¬¡
    setUsername("");
    setEmail("");
    setPassword("");
    setErrors({});

    console.log("render"); // åªæ‰“å°ä¸€æ¬¡
  };

  return <form onSubmit={handleSubmit}>...</form>;
}
```

**åº•å±‚åŸç†**ï¼š

```
æ‰¹å¤„ç†çš„å…³é”®æœºåˆ¶ï¼š

1. å¾®ä»»åŠ¡è°ƒåº¦æ ‡è®°ï¼ˆdidScheduleMicrotaskï¼‰
   ç¬¬1ä¸ªsetState:
     â†’ didScheduleMicrotask = false
     â†’ queueMicrotask(processRootScheduleInMicrotask)
     â†’ didScheduleMicrotask = true

   ç¬¬2-4ä¸ªsetState:
     â†’ didScheduleMicrotask = true
     â†’ è·³è¿‡è°ƒåº¦ï¼Œå¤ç”¨åŒä¸€ä¸ªå¾®ä»»åŠ¡

2. updateé˜Ÿåˆ—
   æ‰€æœ‰setStateçš„updateå¯¹è±¡éƒ½åŠ å…¥åŒä¸€ä¸ªé˜Ÿåˆ—ï¼š
   queue.pending = update4 â†’ update1 â†’ update2 â†’ update3 â†’ update4

3. æ‰¹é‡å¤„ç†
   å¾®ä»»åŠ¡æ‰§è¡Œæ—¶ï¼š
   â†’ processRootScheduleInMicrotask
   â†’ renderé˜¶æ®µ
   â†’ processUpdateQueueä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰update
   â†’ è®¡ç®—æœ€ç»ˆstate
   â†’ ä¸€æ¬¡render

æ€§èƒ½æå‡ï¼š
4æ¬¡setState â†’ 1æ¬¡render
èŠ‚çœ3æ¬¡renderï¼ˆ75%æ€§èƒ½æå‡ï¼‰
```

**React 17 vs React 18**ï¼š

```javascript
// React 17ï¼šåªåœ¨äº‹ä»¶ä¸­æ‰¹å¤„ç†
<button onClick={() => {
  setCount(1);
  setFlag(true);
  // æ‰¹å¤„ç†ï¼Œ1æ¬¡render âœ…
}}>

setTimeout(() => {
  setCount(1);
  setFlag(true);
  // ä¸æ‰¹å¤„ç†ï¼Œ2æ¬¡render âŒ
}, 100);

// React 18ï¼šæ‰€æœ‰åœºæ™¯éƒ½æ‰¹å¤„ç†
setTimeout(() => {
  setCount(1);
  setFlag(true);
  // æ‰¹å¤„ç†ï¼Œ1æ¬¡render âœ…
}, 100);

Promise.then(() => {
  setCount(1);
  setFlag(true);
  // æ‰¹å¤„ç†ï¼Œ1æ¬¡render âœ…
});
```

---

### 3. å‡½æ•°å¼ setState å’Œç›´æ¥ä¼ å€¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼šå‡½æ•°å¼ setState åŸºäºæœ€æ–° state è®¡ç®—ï¼Œé¿å…é—­åŒ…é™·é˜±ï¼›ç›´æ¥ä¼ å€¼ä½¿ç”¨æ•è·çš„é—­åŒ…å€¼ã€‚**

#### æ·±å…¥è§£æ

**é—®é¢˜ç¤ºä¾‹**ï¼š

```javascript
function Counter() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    // âŒ é”™è¯¯ï¼šç›´æ¥ä¼ å€¼
    setCount(count + 1); // count = 0
    setCount(count + 1); // count = 0
    setCount(count + 1); // count = 0

    // ç»“æœï¼šcountå˜æˆ1ï¼ˆä¸æ˜¯3ï¼‰
  };

  console.log("render:", count);

  return <button onClick={handleClick}>Count: {count}</button>;
}
```

**åº•å±‚åŸç†**ï¼ˆè¯¦è§ç¬¬ 9 é¢˜ï¼‰ï¼š

```javascript
// ç›´æ¥ä¼ å€¼çš„å¤„ç†
update1: {action: 0 + 1 = 1}
update2: {action: 0 + 1 = 1}
update3: {action: 0 + 1 = 1}

processUpdateQueue:
  newState = baseState  // 0
  update1: newState = 1
  update2: newState = 1
  update3: newState = 1
  æœ€ç»ˆï¼š1

// basicStateReducerçš„å®ç°
function basicStateReducer(state, action) {
  return typeof action === 'function' ? action(state) : action;
}
```

**æ­£ç¡®åšæ³•ï¼šå‡½æ•°å¼æ›´æ–°**

```javascript
const handleClickCorrect = () => {
  // âœ… æ­£ç¡®ï¼šå‡½æ•°å¼æ›´æ–°
  setCount(c => c + 1);  // cæ˜¯æœ€æ–°å€¼
  setCount(c => c + 1);
  setCount(c => c + 1);

  // ç»“æœï¼šcountå˜æˆ3 âœ“
};

// åº•å±‚å¤„ç†
update1: {action: (c) => c + 1}
update2: {action: (c) => c + 1}
update3: {action: (c) => c + 1}

processUpdateQueue:
  newState = baseState  // 0
  update1: newState = (c => c + 1)(0) = 1
  update2: newState = (c => c + 1)(1) = 2
  update3: newState = (c => c + 1)(2) = 3
  æœ€ç»ˆï¼š3
```

**é—­åŒ…é™·é˜±ç¤ºä¾‹**ï¼ˆè¯¦è§ç¬¬ 10 é¢˜ï¼‰ï¼š

```javascript
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => {
      // âŒ é”™è¯¯ï¼šé—­åŒ…æ•è·count = 0
      setCount(count + 1);
    }, 1000);

    return () => clearInterval(timer);
  }, []); // ç©ºä¾èµ–ï¼Œeffectåªæ‰§è¡Œä¸€æ¬¡

  // ç»“æœï¼šcountæ°¸è¿œåœ¨0å’Œ1ä¹‹é—´è·³åŠ¨
}

// âœ… æ­£ç¡®ï¼šå‡½æ•°å¼æ›´æ–°
useEffect(() => {
  const timer = setInterval(() => {
    setCount((c) => c + 1); // cæ˜¯æœ€æ–°å€¼
  }, 1000);

  return () => clearInterval(timer);
}, []); // countæ­£å¸¸é€’å¢
```

**æ€»ç»“**ï¼š

- ç›´æ¥ä¼ å€¼ï¼šä½¿ç”¨é—­åŒ…æ•è·çš„å€¼
- å‡½æ•°å¼æ›´æ–°ï¼šåŸºäºæœ€æ–° state è®¡ç®—
- æ¨èï¼šæœ‰ä¾èµ–å…³ç³»æ—¶ä½¿ç”¨å‡½æ•°å¼æ›´æ–°

---

### 4. setState ä¹‹åå¦‚ä½•ç«‹å³è·å–æ›´æ–°åçš„å€¼ï¼Ÿ

**ç­”æ¡ˆï¼šæ— æ³•ç«‹å³è·å–ï¼ˆé—­åŒ…é™åˆ¶ï¼‰ï¼Œä½†å¯ä»¥ç”¨ useEffectã€useRef æˆ– flushSyncã€‚**

#### æ–¹æ¡ˆå¯¹æ¯”

**æ–¹æ¡ˆ 1ï¼šuseEffectï¼ˆæ¨èï¼‰**

```javascript
function Component() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    // countæ›´æ–°åæ‰§è¡Œ
    console.log("countå·²æ›´æ–°ä¸º:", count);

    // å¯ä»¥æ‰§è¡Œä¾èµ–æ–°å€¼çš„æ“ä½œ
    if (count > 10) {
      alert("countè¶…è¿‡10äº†ï¼");
    }
  }, [count]); // countå˜åŒ–æ—¶æ‰§è¡Œ

  const handleClick = () => {
    setCount(count + 1);
    // è¿™é‡Œæ— æ³•ç«‹å³è·å–æ–°å€¼
  };

  return <button onClick={handleClick}>{count}</button>;
}
```

**æ–¹æ¡ˆ 2ï¼šuseRef ä¿å­˜æœ€æ–°å€¼**

```javascript
function Component() {
  const [count, setCount] = useState(0);
  const countRef = useRef(count);

  // ä¿æŒrefåŒæ­¥
  useEffect(() => {
    countRef.current = count;
  }, [count]);

  const handleAsync = () => {
    setCount(count + 1);

    // åœ¨å¼‚æ­¥å›è°ƒä¸­ä½¿ç”¨ref
    setTimeout(() => {
      console.log("æœ€æ–°count:", countRef.current);
    }, 1000);
  };

  return <button onClick={handleAsync}>{count}</button>;
}
```

**æ–¹æ¡ˆ 3ï¼šflushSync ç«‹å³æ›´æ–° DOM**

```javascript
import { flushSync } from "react-dom";

function Component() {
  const [count, setCount] = useState(0);
  const buttonRef = useRef();

  const handleClick = () => {
    flushSync(() => {
      setCount(count + 1);
    });

    // æ­¤æ—¶DOMå·²æ›´æ–°ï¼ˆä½†é—­åŒ…ä¸­countä»æ˜¯æ—§å€¼ï¼‰
    console.log("é—­åŒ…count:", count); // 0
    console.log("DOM textContent:", buttonRef.current.textContent); // "1"
  };

  return (
    <button ref={buttonRef} onClick={handleClick}>
      {count}
    </button>
  );
}
```

**æ–¹æ¡ˆ 4ï¼šå‡½æ•°å¼ setState + ç¬¬äºŒä¸ªå‚æ•°æ¨¡æ‹Ÿ**

```javascript
// React Hooksæ²¡æœ‰callbackå‚æ•°
// ä½†å¯ä»¥ç”¨useEffectæ¨¡æ‹Ÿ

function Component() {
  const [count, setCount] = useState(0);
  const [shouldLog, setShouldLog] = useState(false);

  useEffect(() => {
    if (shouldLog) {
      console.log("countæ›´æ–°å:", count);
      setShouldLog(false);
    }
  }, [shouldLog, count]);

  const handleClick = () => {
    setCount((c) => c + 1);
    setShouldLog(true); // è§¦å‘effect
  };

  return <button onClick={handleClick}>{count}</button>;
}
```

**ä¸ºä»€ä¹ˆæ— æ³•ç«‹å³è·å–ï¼Ÿ**

```
æ ¹æœ¬åŸå› ï¼šJavaScripté—­åŒ…

handleClickå‡½æ•°åˆ›å»ºæ—¶ï¼š
  count = 0ï¼ˆæ•è·å½“æ—¶çš„å€¼ï¼‰

handleClickæ‰§è¡Œæ—¶ï¼š
  setCount(1) â†’ åˆ›å»ºupdateï¼Œç¨åå¤„ç†
  console.log(count) â†’ 0ï¼ˆé—­åŒ…å€¼ï¼‰

setStateä¸ä¼šä¿®æ”¹å½“å‰ä½œç”¨åŸŸçš„countå˜é‡
countè¦ç­‰åˆ°ä¸‹æ¬¡renderæ—¶æ‰æ›´æ–°
```

---

### 5. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä¿®æ”¹ stateï¼Ÿ

**ç­”æ¡ˆï¼šReact ä¾èµ–å¼•ç”¨æ¯”è¾ƒåˆ¤æ–­æ˜¯å¦æ›´æ–°ï¼Œç›´æ¥ä¿®æ”¹ state ä¼šå¯¼è‡´å¼•ç”¨ä¸å˜ï¼Œæ— æ³•è§¦å‘æ›´æ–°ã€‚**

#### é—®é¢˜ç¤ºä¾‹

```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹state
function TodoList() {
  const [todos, setTodos] = useState([{ id: 1, text: "Learn React" }]);

  const addTodo = () => {
    // ç›´æ¥ä¿®æ”¹æ•°ç»„
    todos.push({ id: 2, text: "Learn Fiber" });
    setTodos(todos); // å¼•ç”¨æ²¡å˜ï¼

    // ç»“æœï¼šç»„ä»¶ä¸ä¼šé‡æ–°æ¸²æŸ“ âŒ
  };

  return (
    <ul>
      {todos.map((todo) => (
        <li key={todo.id}>{todo.text}</li>
      ))}
    </ul>
  );
}
```

**åº•å±‚åŸç†**ï¼ˆè¯¦è§ç¬¬ 5 é¢˜ bailoutï¼‰ï¼š

```javascript
// Reactçš„æ›´æ–°åˆ¤æ–­
function beginWork(current, workInProgress, renderLanes) {
  const oldProps = current.memoizedProps;
  const newProps = workInProgress.pendingProps;

  // å…³é”®ï¼šæµ…æ¯”è¾ƒ
  if (oldProps === newProps) {  // å¼•ç”¨ç›¸ç­‰
    // æ²¡æœ‰å˜åŒ–ï¼Œbailout
    return bailoutOnAlreadyFinishedWork(...);
  }

  // æœ‰å˜åŒ–ï¼Œç»§ç»­render
}

// useStateçš„eager stateä¼˜åŒ–
function dispatchSetState(fiber, queue, action) {
  // ...
  const currentState = queue.lastRenderedState;
  const eagerState = lastRenderedReducer(currentState, action);

  if (is(eagerState, currentState)) {  // Object.isæ¯”è¾ƒ
    // stateæ²¡å˜ï¼Œè·³è¿‡render
    return;
  }

  // stateå˜äº†ï¼Œè°ƒåº¦render
}
```

**æ­£ç¡®åšæ³•ï¼šä¸å¯å˜æ›´æ–°**

```javascript
// âœ… æ­£ç¡®ï¼šåˆ›å»ºæ–°æ•°ç»„
const addTodo = () => {
  setTodos([...todos, { id: 2, text: "Learn Fiber" }]);
  // æ–°æ•°ç»„ï¼Œå¼•ç”¨ä¸åŒï¼Œè§¦å‘æ›´æ–° âœ“
};

// âœ… æ­£ç¡®ï¼šæ•°ç»„æ–¹æ³•è¿”å›æ–°æ•°ç»„
const removeTodo = (id) => {
  setTodos(todos.filter((todo) => todo.id !== id));
};

// âœ… æ­£ç¡®ï¼šå¯¹è±¡å±•å¼€
const [user, setUser] = useState({ name: "Tom", age: 20 });

const updateName = () => {
  setUser({ ...user, name: "Jerry" });
  // æ–°å¯¹è±¡ï¼Œå¼•ç”¨ä¸åŒ âœ“
};

// âœ… æ­£ç¡®ï¼šåµŒå¥—å¯¹è±¡çš„ä¸å¯å˜æ›´æ–°
const updateCity = () => {
  setUser({
    ...user,
    address: {
      ...user.address,
      city: "New York",
    },
  });
};

// âœ… æ¨èï¼šä½¿ç”¨Immerç®€åŒ–
import { produce } from "immer";

const updateCity = () => {
  setUser(
    produce((draft) => {
      draft.address.city = "New York";
      // Immerè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è±¡
    })
  );
};
```

**æ€§èƒ½è€ƒè™‘**ï¼š

```javascript
// å¤§å‹çŠ¶æ€çš„ä¸å¯å˜æ›´æ–°å¯èƒ½å¾ˆæ…¢
const bigArray = Array(10000).fill({...});

// âŒ æ…¢ï¼šæ¯æ¬¡éƒ½å±•å¼€æ•´ä¸ªæ•°ç»„
setArray([...bigArray, newItem]);

// âœ… ä¼˜åŒ–ï¼šä½¿ç”¨useReducer
function reducer(state, action) {
  switch (action.type) {
    case 'add':
      return [...state, action.item];
    case 'remove':
      return state.filter(item => item.id !== action.id);
  }
}

const [array, dispatch] = useReducer(reducer, bigArray);

// æˆ–è€…ä½¿ç”¨Immerï¼ˆå†…éƒ¨ä¼˜åŒ–ï¼‰
```

---

## äºŒã€ç»„ä»¶å’Œæ¸²æŸ“ç±»

### 6. React ç»„ä»¶ä»€ä¹ˆæ—¶å€™ä¼šé‡æ–°æ¸²æŸ“ï¼Ÿ

**ç­”æ¡ˆï¼š5 ç§æƒ…å†µä¼šè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚**

#### 5 ç§è§¦å‘æ¡ä»¶

```javascript
// 1. Stateå˜åŒ–
function Component() {
  const [count, setCount] = useState(0);

  // setCountè§¦å‘render
  return <button onClick={() => setCount((c) => c + 1)}>{count}</button>;
}

// 2. Propså˜åŒ–
function Parent() {
  const [value, setValue] = useState(0);
  return <Child prop={value} />; // valueå˜åŒ–ï¼ŒChild render
}

function Child({ prop }) {
  console.log("Child render");
  return <div>{prop}</div>;
}

// 3. Contextå˜åŒ–
const MyContext = React.createContext();

function Parent() {
  const [value, setValue] = useState(0);
  return (
    <MyContext.Provider value={value}>
      <Child /> {/* valueå˜åŒ–ï¼ŒChild render */}
    </MyContext.Provider>
  );
}

function Child() {
  const value = useContext(MyContext);
  return <div>{value}</div>;
}

// 4. çˆ¶ç»„ä»¶render
function Parent() {
  const [count, setCount] = useState(0);

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <Child /> {/* Parent renderï¼ŒChildä¹Ÿrender */}
    </>
  );
}

function Child() {
  console.log("Child render"); // æ¯æ¬¡Parentæ›´æ–°éƒ½æ‰“å°
  return <div>Child</div>;
}

// 5. forceUpdateï¼ˆç±»ç»„ä»¶ï¼‰
class Component extends React.Component {
  handleClick = () => {
    this.forceUpdate(); // å¼ºåˆ¶render
  };

  render() {
    return <button onClick={this.handleClick}>Force Update</button>;
  }
}
```

**åº•å±‚åŸç†**ï¼ˆè¯¦è§ç¬¬ 5 é¢˜ï¼‰ï¼š

```
beginWorkçš„åˆ¤æ–­é€»è¾‘ï¼š

if (oldProps !== newProps || hasContextChanged()) {
  // propsæˆ–contextå˜åŒ–
  didReceiveUpdate = true;
  // ç»§ç»­render
} else {
  // propsæ²¡å˜ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰updateæˆ–contextå˜åŒ–
  if (checkScheduledUpdateOrContext(current, renderLanes)) {
    // æœ‰setStateæˆ–contextå˜åŒ–
    didReceiveUpdate = true;
  } else {
    // å¯ä»¥bailout
    return bailoutOnAlreadyFinishedWork(...);
  }
}
```

---

### 7. çˆ¶ç»„ä»¶ renderï¼Œå­ç»„ä»¶ä¸€å®šä¼š render å—ï¼Ÿ

**ç­”æ¡ˆï¼šé»˜è®¤ä¼šï¼Œä½†å¯ä»¥é€šè¿‡ä¼˜åŒ–é¿å…ã€‚**

#### é»˜è®¤è¡Œä¸º

```javascript
function Parent() {
  const [count, setCount] = useState(0);

  console.log("Parent render");

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <Child />
    </>
  );
}

function Child() {
  console.log("Child render"); // Parentæ¯æ¬¡æ›´æ–°éƒ½ä¼šæ‰“å°
  return <div>Child</div>;
}

// ç‚¹å‡»æŒ‰é’®ï¼š
// "Parent render"
// "Child render"
```

**åŸç†**ï¼ˆè¯¦è§ç¬¬ 7 é¢˜ï¼‰ï¼š

```
beginWork(Parent):
  â†’ æ‰§è¡ŒParentå‡½æ•°
  â†’ è¿”å›æ–°çš„Reactå…ƒç´ æ ‘
  â†’ reconcileChildren
    â†’ å‘ç°Childå…ƒç´ 
    â†’ è™½ç„¶Childçš„propsæ²¡å˜ï¼Œä½†é»˜è®¤ä¼šç»§ç»­render

ä¸ºä»€ä¹ˆï¼Ÿ
- Parent renderåˆ›å»ºäº†æ–°çš„Childå…ƒç´ 
- Reactè®¤ä¸ºå¯èƒ½æœ‰å˜åŒ–ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
- ç»§ç»­beginWork(Child)
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šReact.memo**

```javascript
const MemoChild = React.memo(function Child() {
  console.log("Child render");
  return <div>Child</div>;
});

function Parent() {
  const [count, setCount] = useState(0);

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <MemoChild /> {/* propsæ²¡å˜ï¼Œä¸render */}
    </>
  );
}

// ç‚¹å‡»æŒ‰é’®ï¼š
// "Parent render"
// ï¼ˆChildä¸renderï¼‰âœ“
```

**æ–¹æ¡ˆ 2ï¼šchildren prop**

```javascript
function Parent({ children }) {
  const [count, setCount] = useState(0);

  console.log("Parent render");

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      {children} {/* childrenæ˜¯å·²åˆ›å»ºçš„å…ƒç´ ï¼Œå¼•ç”¨ä¸å˜ */}
    </>
  );
}

function App() {
  return (
    <Parent>
      <Child /> {/* åœ¨Appä¸­åˆ›å»ºï¼ŒParent renderä¸å½±å“ */}
    </Parent>
  );
}

// ç‚¹å‡»æŒ‰é’®ï¼š
// "Parent render"
// ï¼ˆChildä¸renderï¼‰âœ“
```

**æ–¹æ¡ˆ 3ï¼šçŠ¶æ€ä¸‹æ²‰**

```javascript
// âŒ ä¸å¥½ï¼šçŠ¶æ€åœ¨é¡¶å±‚
function App() {
  const [count, setCount] = useState(0);

  return (
    <>
      <Counter count={count} setCount={setCount} />
      <ExpensiveComponent /> {/* countå˜åŒ–ä¼šrender */}
    </>
  );
}

// âœ… å¥½ï¼šçŠ¶æ€ä¸‹æ²‰
function App() {
  return (
    <>
      <Counter /> {/* çŠ¶æ€åœ¨å†…éƒ¨ */}
      <ExpensiveComponent /> {/* ä¸å—å½±å“ */}
    </>
  );
}

function Counter() {
  const [count, setCount] = useState(0);
  return <button onClick={() => setCount((c) => c + 1)}>{count}</button>;
}
```

---

### 8. å¦‚ä½•é¿å…ç»„ä»¶ä¸å¿…è¦çš„æ¸²æŸ“ï¼Ÿ

**ç­”æ¡ˆï¼šä½¿ç”¨ React.memoã€useMemoã€useCallbackã€åˆç†æ‹†åˆ†ç»„ä»¶ã€‚**

#### ä¼˜åŒ–ç­–ç•¥

**ç­–ç•¥ 1ï¼šReact.memoï¼ˆè¯¦è§ç¬¬ 5 é¢˜ï¼‰**

```javascript
// é€‚ç”¨äºï¼špropsæ²¡å˜çš„å‡½æ•°ç»„ä»¶
const ExpensiveList = React.memo(function ExpensiveList({ items }) {
  console.log("ExpensiveList render");

  // æ˜‚è´µçš„è®¡ç®—
  const processed = items.map((item) => expensiveProcess(item));

  return (
    <ul>
      {processed.map((item) => (
        <li key={item.id}>{item.name}</li>
      ))}
    </ul>
  );
});

function App() {
  const [count, setCount] = useState(0);
  const items = [
    /* å›ºå®šæ•°æ® */
  ];

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <ExpensiveList items={items} /> {/* itemsæ²¡å˜ï¼Œä¸render */}
    </>
  );
}
```

**ç­–ç•¥ 2ï¼šuseMemo ç¼“å­˜è®¡ç®—ç»“æœï¼ˆè¯¦è§ç¬¬ 11 é¢˜ï¼‰**

```javascript
function SearchResults({ data, query }) {
  // âœ… ç¼“å­˜è¿‡æ»¤ç»“æœ
  const filteredData = useMemo(() => {
    console.log("filtering...");
    return data.filter((item) =>
      item.name.toLowerCase().includes(query.toLowerCase())
    );
  }, [data, query]); // åªæœ‰dataæˆ–queryå˜åŒ–æ‰é‡æ–°è®¡ç®—

  return (
    <ul>
      {filteredData.map((item) => (
        <li key={item.id}>{item.name}</li>
      ))}
    </ul>
  );
}
```

**ç­–ç•¥ 3ï¼šuseCallback ç¼“å­˜å‡½æ•°ï¼ˆè¯¦è§ç¬¬ 11 é¢˜ï¼‰**

```javascript
function Parent() {
  const [count, setCount] = useState(0);

  // âœ… ç¼“å­˜å›è°ƒå‡½æ•°
  const handleClick = useCallback(() => {
    console.log("clicked");
  }, []); // ä¾èµ–ä¸ºç©ºï¼Œå‡½æ•°å¼•ç”¨æ°¸ä¸å˜

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <MemoChild onClick={handleClick} /> {/* onClickæ²¡å˜ï¼Œä¸render */}
    </>
  );
}

const MemoChild = React.memo(function Child({ onClick }) {
  console.log("Child render");
  return <button onClick={onClick}>Click</button>;
});
```

**ç­–ç•¥ 4ï¼šåˆç†æ‹†åˆ†ç»„ä»¶**

```javascript
// âŒ ä¸å¥½ï¼šä¸€ä¸ªå¤§ç»„ä»¶
function Dashboard() {
  const [activeTab, setActiveTab] = useState("home");
  const [userData, setUserData] = useState(null);
  const [notifications, setNotifications] = useState([]);

  // activeTabå˜åŒ–ï¼Œæ•´ä¸ªDashboardéƒ½render

  return (
    <>
      <Tabs activeTab={activeTab} onChange={setActiveTab} />
      <UserPanel data={userData} /> {/* ä¸å¿…è¦çš„render */}
      <Notifications items={notifications} /> {/* ä¸å¿…è¦çš„render */}
    </>
  );
}

// âœ… å¥½ï¼šæ‹†åˆ†ç»„ä»¶
function Dashboard() {
  return (
    <>
      <TabsContainer /> {/* activeTabçŠ¶æ€åœ¨å†…éƒ¨ */}
      <UserPanel /> {/* ç‹¬ç«‹çŠ¶æ€ */}
      <Notifications /> {/* ç‹¬ç«‹çŠ¶æ€ */}
    </>
  );
}

function TabsContainer() {
  const [activeTab, setActiveTab] = useState("home");
  return <Tabs activeTab={activeTab} onChange={setActiveTab} />;
}
```

**ç­–ç•¥ 5ï¼šä½¿ç”¨ key é‡ç½®ç»„ä»¶**

```javascript
function UserProfile({ userId }) {
  return (
    <ProfilePanel key={userId} userId={userId} />
    // userIdå˜åŒ–ï¼Œkeyå˜åŒ–ï¼Œå¸è½½æ—§ç»„ä»¶ï¼ŒæŒ‚è½½æ–°ç»„ä»¶
    // è‡ªåŠ¨é‡ç½®å†…éƒ¨çŠ¶æ€
  );
}

function ProfilePanel({ userId }) {
  const [data, setData] = useState(null);

  useEffect(() => {
    // userIdå˜åŒ–ï¼Œæ•´ä¸ªç»„ä»¶é‡æ–°mount
    // ä¸éœ€è¦æ¸…ç†æ—§æ•°æ®
    fetchUser(userId).then(setData);
  }, [userId]);

  return <div>{data?.name}</div>;
}
```

---

## ä¸‰ã€Hooks ä½¿ç”¨ç±»

### 11. useEffect å’Œ useLayoutEffect çš„åŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼šæ‰§è¡Œæ—¶æœºä¸åŒï¼ŒuseEffect å¼‚æ­¥ä¸é˜»å¡ï¼ŒuseLayoutEffect åŒæ­¥é˜»å¡ã€‚**

#### æ‰§è¡Œæ—¶æœºå¯¹æ¯”ï¼ˆè¯¦è§ç¬¬ 10 é¢˜å’Œç¬¬ 16 é¢˜ï¼‰

```
æ—¶é—´è½´ï¼š

useLayoutEffect:
render â†’ commit(mutation) â†’ useLayoutEffect â†’ æµè§ˆå™¨ç»˜åˆ¶ â†’ ç”¨æˆ·çœ‹åˆ°
                                 â†‘
                            åŒæ­¥æ‰§è¡Œï¼Œé˜»å¡ç»˜åˆ¶

useEffect:
render â†’ commit(mutation) â†’ æµè§ˆå™¨ç»˜åˆ¶ â†’ ç”¨æˆ·çœ‹åˆ° â†’ useEffect
                                                      â†‘
                                               å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡
```

#### ä½¿ç”¨åœºæ™¯

**useLayoutEffectï¼šéœ€è¦åŒæ­¥è¯»å†™ DOM**

```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨useLayoutEffect
function Tooltip({ targetRef }) {
  const [position, setPosition] = useState({ x: 0, y: 0 });

  useLayoutEffect(() => {
    // åŒæ­¥è¯»å–DOM
    const rect = targetRef.current.getBoundingClientRect();

    // ç«‹å³è®¾ç½®ä½ç½®
    setPosition({
      x: rect.left,
      y: rect.bottom + 10,
    });
  }, [targetRef]);

  // å¥½å¤„ï¼šç”¨æˆ·åªçœ‹åˆ°æ­£ç¡®ä½ç½®ï¼Œä¸ä¼šé—ªçƒ
  return (
    <div style={{ position: "absolute", left: position.x, top: position.y }}>
      Tooltip
    </div>
  );
}

// âŒ é”™è¯¯ï¼šä½¿ç”¨useEffect
// é—®é¢˜ï¼šç”¨æˆ·ä¼šå…ˆçœ‹åˆ°position={0,0}ï¼Œç„¶åè·³åˆ°æ­£ç¡®ä½ç½®ï¼ˆé—ªçƒï¼‰
```

**useEffectï¼šå¤§éƒ¨åˆ†åœºæ™¯**

```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨useEffect
function DataFetcher() {
  const [data, setData] = useState(null);

  useEffect(() => {
    // æ•°æ®è·å–ä¸éœ€è¦åŒæ­¥
    fetch("/api/data")
      .then((res) => res.json())
      .then(setData);
  }, []);

  return <div>{data}</div>;
}
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

```
æµ‹è¯•ï¼š1000ä¸ªuseEffect vs useLayoutEffect

useEffectï¼ˆå¼‚æ­¥ï¼‰ï¼š
- commitå®Œæˆ â†’ ç«‹å³ç»˜åˆ¶ â†’ ç”¨æˆ·çœ‹åˆ°æ›´æ–°
- effectåœ¨åå°æ‰§è¡Œï¼Œä¸é˜»å¡
- æ€»è€—æ—¶ï¼š15msï¼ˆç”¨æˆ·æ„ŸçŸ¥ï¼‰

useLayoutEffectï¼ˆåŒæ­¥ï¼‰ï¼š
- commit â†’ ç­‰å¾…1000ä¸ªeffectæ‰§è¡Œ â†’ ç»˜åˆ¶
- é˜»å¡ç»˜åˆ¶
- æ€»è€—æ—¶ï¼š50msï¼ˆç”¨æˆ·æ„ŸçŸ¥ï¼‰

ç»“è®ºï¼šuseLayoutEffectä¼šå»¶è¿Ÿç»˜åˆ¶ï¼Œå½±å“æ€§èƒ½
```

---

### 14. ä¸ºä»€ä¹ˆ Hook å¿…é¡»åœ¨é¡¶å±‚è°ƒç”¨ï¼Ÿ

**ç­”æ¡ˆï¼šHook ä¾èµ–è°ƒç”¨é¡ºåºæ¥åŒ¹é…ï¼Œé¡ºåºå˜åŒ–ä¼šå¯¼è‡´ Hook é”™é…ã€‚**

#### é”™è¯¯ç¤ºä¾‹ï¼ˆè¯¦è§ç¬¬ 8 é¢˜ï¼‰

```javascript
// âŒ é”™è¯¯ï¼šæ¡ä»¶è°ƒç”¨
function Component({ show }) {
  const [count, setCount] = useState(0);

  if (show) {
    const [name, setName] = useState('');  // âŒ æ¡ä»¶ä¸­è°ƒç”¨
  }

  return <div>{count}</div>;
}

// é—®é¢˜
é¦–æ¬¡renderï¼ˆshow=trueï¼‰ï¼š
  Hooké“¾è¡¨ï¼šHook1(count) â†’ Hook2(name)

ç¬¬äºŒæ¬¡renderï¼ˆshow=falseï¼‰ï¼š
  Hooké“¾è¡¨ï¼šHook1(count)

  ReactæœŸæœ›ï¼šHook1(count) â†’ Hook2(name)
  å®é™…åªæœ‰ï¼šHook1(count)

  é”™è¯¯ï¼š"Rendered fewer hooks than expected"
```

**åº•å±‚åŸç†**ï¼š

```javascript
// Hookçš„åŒ¹é…æœºåˆ¶ï¼ˆè¯¦è§ç¬¬8é¢˜ï¼‰

mountæ—¶ï¼š
call#1: useState(0)    â†’ åˆ›å»ºHook1ï¼ŒåŠ å…¥é“¾è¡¨
call#2: useState('')   â†’ åˆ›å»ºHook2ï¼ŒåŠ å…¥é“¾è¡¨
call#3: useEffect(...) â†’ åˆ›å»ºHook3ï¼ŒåŠ å…¥é“¾è¡¨

updateæ—¶ï¼š
call#1: useState(0)    â†’ ä»Hook1è¯»å–
call#2: useState('')   â†’ ä»Hook2è¯»å–
call#3: useEffect(...) â†’ ä»Hook3è¯»å–

å®Œå…¨ä¾èµ–è°ƒç”¨é¡ºåºï¼
æ²¡æœ‰ä½¿ç”¨keyæˆ–nameæ¥æ ‡è¯†Hook
```

**æ­£ç¡®åšæ³•**ï¼š

```javascript
// âœ… æ­£ç¡®ï¼šHookåœ¨é¡¶å±‚
function Component({ show }) {
  const [count, setCount] = useState(0);
  const [name, setName] = useState(""); // æ€»æ˜¯è°ƒç”¨

  // æ¡ä»¶é€»è¾‘æ”¾åœ¨Hookå¤–éƒ¨
  useEffect(() => {
    if (show) {
      console.log(name);
    }
  }, [show, name]);

  return <div>{count}</div>;
}
```

---

## å››ã€æ€§èƒ½ä¼˜åŒ–ç±»

### 20. React.memo æœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ

**ç­”æ¡ˆï¼šReact.memo ç¼“å­˜ç»„ä»¶ï¼Œprops æ²¡å˜æ—¶è·³è¿‡ renderã€‚**

#### åŸºæœ¬ç”¨æ³•ï¼ˆè¯¦è§ç¬¬ 5 é¢˜ï¼‰

```javascript
const MemoComponent = React.memo(function MyComponent({ value }) {
  console.log("render");
  return <div>{value}</div>;
});

function Parent() {
  const [count, setCount] = useState(0);
  const [value] = useState("constant");

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <MemoComponent value={value} /> {/* valueæ²¡å˜ï¼Œä¸render */}
    </>
  );
}
```

#### ä½•æ—¶ä½¿ç”¨

**âœ… DOï¼šæ˜‚è´µç»„ä»¶**

```javascript
const ExpensiveChart = React.memo(function Chart({ data }) {
  // å¤æ‚çš„å›¾è¡¨æ¸²æŸ“é€»è¾‘
  const chartData = processChartData(data); // è€—æ—¶
  return <canvas>{/* ç»˜åˆ¶å›¾è¡¨ */}</canvas>;
});
```

**âœ… DOï¼šé¢‘ç¹ render çš„çˆ¶ç»„ä»¶ä¸­çš„ç¨³å®šå­ç»„ä»¶**

```javascript
function FrequentlyUpdatingParent() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => setCount((c) => c + 1), 100);
    return () => clearInterval(timer);
  }, []);

  return (
    <>
      <div>Count: {count}</div>
      <StableChild /> {/* memoå¾ˆæœ‰ç”¨ */}
    </>
  );
}

const StableChild = React.memo(function Child() {
  // å¤æ‚çš„æ¸²æŸ“
  return <div>{/* ... */}</div>;
});
```

**âŒ DON'Tï¼šç®€å•ç»„ä»¶**

```javascript
// âŒ è¿‡åº¦ä¼˜åŒ–
const SimpleText = React.memo(function Text({ children }) {
  return <span>{children}</span>; // è¶…çº§ç®€å•
});

// memoæœ¬èº«æœ‰å¼€é”€ï¼ˆæµ…æ¯”è¾ƒpropsï¼‰
// ç®€å•ç»„ä»¶renderå¾ˆå¿«ï¼Œä¸éœ€è¦memo
```

**âŒ DON'Tï¼šprops æ€»æ˜¯å˜åŒ–**

```javascript
function Parent() {
  return (
    <MemoChild
      data={{ value: Math.random() }} // æ¯æ¬¡æ–°å¯¹è±¡
      onClick={() => console.log("hi")} // æ¯æ¬¡æ–°å‡½æ•°
    />
  );
}

// memoæ— æ•ˆï¼Œå› ä¸ºpropsæ€»æ˜¯ä¸åŒ
```

---

### 21. key çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç”¨ indexï¼Ÿ

**ç­”æ¡ˆï¼škey å”¯ä¸€æ ‡è¯†èŠ‚ç‚¹ï¼Œå¸®åŠ© React é«˜æ•ˆå¤ç”¨ï¼›index ä½œä¸º key ä¼šå¯¼è‡´çŠ¶æ€é”™ä¹±ã€‚**

#### key çš„ä½œç”¨ï¼ˆè¯¦è§ç¬¬ 6 é¢˜ï¼‰

```javascript
// æ²¡æœ‰keyï¼šæŒ‰ä½ç½®åŒ¹é…
æ—§ï¼š[<Item>A</Item>, <Item>B</Item>, <Item>C</Item>]
æ–°ï¼š[<Item>B</Item>, <Item>A</Item>, <Item>C</Item>]

Reactè®¤ä¸ºï¼š
ä½ç½®0: Aå˜æˆB â†’ æ›´æ–°
ä½ç½®1: Bå˜æˆA â†’ æ›´æ–°
ä½ç½®2: Cè¿˜æ˜¯C â†’ å¤ç”¨

ç»“æœï¼š2æ¬¡æ›´æ–°ï¼ˆä¸æ˜¯æœ€ä¼˜ï¼‰

// æœ‰keyï¼šæŒ‰keyåŒ¹é…
æ—§ï¼š[<Item key="a">A</Item>, <Item key="b">B</Item>, <Item key="c">C</Item>]
æ–°ï¼š[<Item key="b">B</Item>, <Item key="a">A</Item>, <Item key="c">C</Item>]

Reactè¯†åˆ«ï¼š
key=b: ä½ç½®å˜äº† â†’ ç§»åŠ¨
key=a: ä½ç½®å˜äº† â†’ ç§»åŠ¨
key=c: ä½ç½®æ²¡å˜ â†’ å¤ç”¨

ç»“æœï¼š2æ¬¡ç§»åŠ¨ï¼ˆæœ€ä¼˜ï¼Œä¿æŒäº†ç»„ä»¶çŠ¶æ€ï¼‰
```

#### ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ indexï¼ˆè¯¦è§ç¬¬ 6 é¢˜ï¼‰

**Bug æ¼”ç¤º**ï¼š

```javascript
function TodoList() {
  const [todos, setTodos] = useState([
    { id: 1, text: 'Learn React', done: false },
    { id: 2, text: 'Learn Fiber', done: false },
    { id: 3, text: 'Build App', done: false },
  ]);

  return (
    <ul>
      {todos.map((todo, index) => (
        <TodoItem
          key={index}  // âŒ ä½¿ç”¨index
          todo={todo}
        />
      ))}
    </ul>
  );
}

function TodoItem({ todo }) {
  const [isEditing, setIsEditing] = useState(false);

  return (
    <li>
      {isEditing ? (
        <input defaultValue={todo.text} />
      ) : (
        <span onClick={() => setIsEditing(true)}>{todo.text}</span>
      )}
    </li>
  );
}

// Bugåœºæ™¯ï¼š
1. ç”¨æˆ·è®©ç¬¬2é¡¹è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼ˆLearn Fiberï¼‰
2. åˆ é™¤ç¬¬1é¡¹ï¼ˆLearn Reactï¼‰
3. ç»“æœï¼šç¬¬3é¡¹ï¼ˆBuild Appï¼‰é”™è¯¯åœ°è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼

åŸå› ï¼š
åˆ é™¤å‰ï¼š
  TodoItem(key=0, todo="Learn React", isEditing=false)
  TodoItem(key=1, todo="Learn Fiber", isEditing=true)
  TodoItem(key=2, todo="Build App", isEditing=false)

åˆ é™¤åæ•°ç»„ï¼š
  [{ id: 2, text: 'Learn Fiber' }, { id: 3, text: 'Build App' }]

æ–°å…ƒç´ ï¼š
  TodoItem(key=0, todo="Learn Fiber")
  TodoItem(key=1, todo="Build App")

diffè¿‡ç¨‹ï¼š
  key=0: å¤ç”¨æ—§çš„key=0ï¼ˆLearn Reactçš„Fiberï¼‰
         æ›´æ–°propsä¸º"Learn Fiber"
         isEditing=falseä¿ç•™
  key=1: å¤ç”¨æ—§çš„key=1ï¼ˆLearn Fiberçš„Fiberï¼‰
         æ›´æ–°propsä¸º"Build App"
         isEditing=trueä¿ç•™ â† Bugï¼

ç»“æœï¼šBuild Appç»§æ‰¿äº†Learn Fiberçš„ç¼–è¾‘çŠ¶æ€
```

**æ­£ç¡®åšæ³•**ï¼š

```javascript
// âœ… ä½¿ç”¨ç¨³å®šçš„å”¯ä¸€key
{todos.map(todo => (
  <TodoItem
    key={todo.id}  // ä½¿ç”¨ID
    todo={todo}
  />
))}

// åˆ é™¤ç¬¬1é¡¹åï¼š
æ–°å…ƒç´ ï¼š
  TodoItem(key=2, todo="Learn Fiber")
  TodoItem(key=3, todo="Build App")

diffè¿‡ç¨‹ï¼š
  key=2: åœ¨Mapä¸­æ‰¾åˆ°ï¼Œå¤ç”¨ï¼ŒisEditing=true âœ“
  key=3: åœ¨Mapä¸­æ‰¾åˆ°ï¼Œå¤ç”¨ï¼ŒisEditing=false âœ“
  key=1: Mapä¸­å‰©ä½™ï¼Œåˆ é™¤

ç»“æœï¼šæ¯ä¸ªç»„ä»¶çš„çŠ¶æ€è·Ÿéšæ­£ç¡®çš„æ•°æ® âœ“
```

---

### 23. ä»€ä¹ˆæ˜¯ React çš„æ‰¹å¤„ç†ï¼Ÿ

**ç­”æ¡ˆï¼šæ‰¹å¤„ç†æ˜¯å°†å¤šä¸ª state æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡ render çš„æ€§èƒ½ä¼˜åŒ–ã€‚**

#### React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆè¯¦è§ç¬¬ 13 é¢˜ï¼‰

```javascript
function Component() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // âœ… äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†
  const handleClick = () => {
    setCount(1); // update1
    setFlag(true); // update2
    setCount(2); // update3
    // åªrender 1æ¬¡ï¼Œcount=2, flag=true
  };

  // âœ… Promiseä¸­æ‰¹å¤„ç†ï¼ˆReact 18æ–°å¢ï¼‰
  const handleAsync = async () => {
    await fetch("/api");

    setCount(1); // update1
    setFlag(true); // update2
    // åªrender 1æ¬¡
  };

  // âœ… setTimeoutä¸­æ‰¹å¤„ç†ï¼ˆReact 18æ–°å¢ï¼‰
  const handleTimeout = () => {
    setTimeout(() => {
      setCount(1);
      setFlag(true);
      // åªrender 1æ¬¡
    }, 1000);
  };

  return (
    <>
      <button onClick={handleClick}>Click</button>
      <button onClick={handleAsync}>Async</button>
      <button onClick={handleTimeout}>Timeout</button>
    </>
  );
}
```

**åº•å±‚åŸç†**ï¼š

```
React 18çš„æ‰¹å¤„ç†å®ç°ï¼š

1. ç¬¬ä¸€ä¸ªsetState:
   â†’ ensureRootIsScheduled(root)
   â†’ didScheduleMicrotask = false
   â†’ queueMicrotask(processRootScheduleInMicrotask)
   â†’ didScheduleMicrotask = true

2. åç»­setState:
   â†’ ensureRootIsScheduled(root)
   â†’ didScheduleMicrotask = true
   â†’ è·³è¿‡è°ƒåº¦ï¼ˆå¤ç”¨åŒä¸€ä¸ªå¾®ä»»åŠ¡ï¼‰

3. åŒæ­¥ä»£ç æ‰§è¡Œå®Œ

4. å¾®ä»»åŠ¡æ‰§è¡Œ:
   â†’ æ‰¹é‡å¤„ç†æ‰€æœ‰update
   â†’ ä¸€æ¬¡render

å…³é”®ï¼šæ‰€æœ‰setStateéƒ½åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯
```

---

### 24. å¦‚ä½•é¿å…å†…è”å‡½æ•°å’Œå¯¹è±¡ï¼Ÿ

**ç­”æ¡ˆï¼šä½¿ç”¨ useCallback å’Œ useMemo ç¼“å­˜ï¼Œé¿å…æ¯æ¬¡ render åˆ›å»ºæ–°å¼•ç”¨ã€‚**

#### é—®é¢˜ç¤ºä¾‹

```javascript
// âŒ é—®é¢˜ï¼šæ¯æ¬¡renderéƒ½åˆ›å»ºæ–°å‡½æ•°å’Œå¯¹è±¡
function Parent() {
  const [count, setCount] = useState(0);

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>

      <MemoChild
        onClick={() => console.log("hi")} // æ–°å‡½æ•°
        config={{ theme: "dark" }} // æ–°å¯¹è±¡
      />
    </>
  );
}

const MemoChild = React.memo(Child);

// ç»“æœï¼šReact.memoå¤±æ•ˆï¼ŒChildæ¯æ¬¡éƒ½render
// å› ä¸ºonClickå’Œconfigå¼•ç”¨æ€»æ˜¯ä¸åŒ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨useCallbackå’ŒuseMemo
function Parent() {
  const [count, setCount] = useState(0);

  // ç¼“å­˜å‡½æ•°
  const handleClick = useCallback(() => {
    console.log("hi");
  }, []);

  // ç¼“å­˜å¯¹è±¡
  const config = useMemo(() => ({ theme: "dark" }), []);

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <MemoChild onClick={handleClick} config={config} />
      {/* onClickå’Œconfigå¼•ç”¨ç¨³å®šï¼ŒChildä¸render */}
    </>
  );
}
```

**ä½•æ—¶éœ€è¦é¿å…**ï¼š

```javascript
// âœ… éœ€è¦é¿å…ï¼šä¼ ç»™memoç»„ä»¶
<MemoChild onClick={useCallback(...)} />

// âœ… éœ€è¦é¿å…ï¼šä½œä¸ºå…¶ä»–Hookçš„ä¾èµ–
const config = useMemo(() => ({...}), []);
useEffect(() => {
  applyConfig(config);
}, [config]);  // configå¼•ç”¨ç¨³å®š

// âŒ ä¸éœ€è¦é¿å…ï¼šæ™®é€šprops
<button onClick={() => console.log('hi')}>
  {/* æ²¡é—®é¢˜ï¼Œbuttonä¸æ˜¯memoç»„ä»¶ */}
</button>

// âŒ ä¸éœ€è¦é¿å…ï¼šä¸ä¼ ç»™å­ç»„ä»¶çš„å¯¹è±¡
const style = { color: 'red' };  // ç›´æ¥å®šä¹‰å³å¯
return <div style={style}>...</div>;
```

---

## äº”ã€äº‹ä»¶ç³»ç»Ÿç±»

### 17. React äº‹ä»¶å’ŒåŸç”Ÿäº‹ä»¶çš„åŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼šReact å®ç°äº†åˆæˆäº‹ä»¶ç³»ç»Ÿï¼ˆSyntheticEventï¼‰ï¼Œç»Ÿä¸€äº†æµè§ˆå™¨å·®å¼‚ï¼Œå¹¶ä¸”æœ‰è‡ªå·±çš„äº‹ä»¶å§”æ‰˜æœºåˆ¶ã€‚**

#### ä¸»è¦åŒºåˆ«

**1. äº‹ä»¶å§”æ‰˜**

```javascript
// Reactï¼šäº‹ä»¶å§”æ‰˜åˆ°root
<div id="root">
  <button onClick={handleClick}>Click</button>
  <button onClick={handleClick}>Click</button>
  <button onClick={handleClick}>Click</button>
</div>

// Reactåªåœ¨rootä¸Šæ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨
root.addEventListener('click', dispatchEvent);

// åŸç”Ÿï¼šæ¯ä¸ªå…ƒç´ å•ç‹¬æ³¨å†Œ
document.querySelector('button:nth-child(1)').addEventListener('click', ...);
document.querySelector('button:nth-child(2)').addEventListener('click', ...);
document.querySelector('button:nth-child(3)').addEventListener('click', ...);
```

**2. å‘½åè§„èŒƒ**

```javascript
// Reactï¼šé©¼å³°å‘½å
<button onClick={handleClick}>

// åŸç”Ÿï¼šå°å†™
<button onclick="handleClick()">
```

**3. äº‹ä»¶å¯¹è±¡**

```javascript
function Component() {
  const handleClick = (e) => {
    // eæ˜¯SyntheticEventï¼ˆåˆæˆäº‹ä»¶ï¼‰
    console.log(e.type); // "click"
    console.log(e.target); // buttonå…ƒç´ 

    // è®¿é—®åŸç”Ÿäº‹ä»¶
    console.log(e.nativeEvent); // åŸç”ŸMouseEvent
  };

  return <button onClick={handleClick}>Click</button>;
}
```

**4. é˜»æ­¢é»˜è®¤è¡Œä¸º**

```javascript
// Reactï¼šå¿…é¡»æ˜¾å¼è°ƒç”¨preventDefault
function handleClick(e) {
  e.preventDefault();  // å¿…é¡»è°ƒç”¨
}

<a href="/page" onClick={handleClick}>Link</a>

// åŸç”Ÿï¼šå¯ä»¥return false
<a href="/page" onclick="handleClick(); return false;">Link</a>
```

**5. äº‹ä»¶æ± ï¼ˆReact 17 å·²ç§»é™¤ï¼‰**

```javascript
// React 16ï¼šäº‹ä»¶æ± 
function handleClick(e) {
  setTimeout(() => {
    console.log(e.type); // nullï¼ˆäº‹ä»¶å¯¹è±¡è¢«å›æ”¶ï¼‰
  }, 100);
}

// è§£å†³ï¼špersist
function handleClick(e) {
  e.persist(); // ä¿ç•™äº‹ä»¶å¯¹è±¡
  setTimeout(() => {
    console.log(e.type); // "click" âœ“
  }, 100);
}

// React 17+ï¼šç§»é™¤äº†äº‹ä»¶æ± 
function handleClick(e) {
  setTimeout(() => {
    console.log(e.type); // "click" âœ“ï¼ˆæ— éœ€persistï¼‰
  }, 100);
}
```

---

### 18. React äº‹ä»¶ä¸­çš„ event å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”æ¡ˆï¼šReact çš„äº‹ä»¶å¯¹è±¡æ˜¯ SyntheticEventï¼ˆåˆæˆäº‹ä»¶ï¼‰ï¼Œå®ƒæ˜¯å¯¹åŸç”Ÿäº‹ä»¶çš„è·¨æµè§ˆå™¨åŒ…è£…ã€‚**

#### SyntheticEvent çš„ç‰¹æ€§

```javascript
function Component() {
  const handleClick = (e) => {
    console.log(e); // SyntheticBaseEventå¯¹è±¡

    // ========== SyntheticEventçš„å±æ€§ ==========
    console.log(e.type); // "click"
    console.log(e.target); // è§¦å‘äº‹ä»¶çš„å…ƒç´ 
    console.log(e.currentTarget); // ç»‘å®šäº‹ä»¶çš„å…ƒç´ 
    console.log(e.bubbles); // true
    console.log(e.cancelable); // true
    console.log(e.defaultPrevented); // false
    console.log(e.timeStamp); // æ—¶é—´æˆ³

    // ========== è®¿é—®åŸç”Ÿäº‹ä»¶ ==========
    console.log(e.nativeEvent); // åŸç”ŸMouseEventå¯¹è±¡
    console.log(e.nativeEvent instanceof MouseEvent); // true

    // ========== å¸¸ç”¨æ–¹æ³• ==========
    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
    e.stopPropagation(); // é˜»æ­¢å†’æ³¡
    e.persist(); // React 17ä¹‹å‰éœ€è¦ï¼ˆç°åœ¨ä¸éœ€è¦ï¼‰
  };

  return <button onClick={handleClick}>Click</button>;
}
```

#### ä¸åŸç”Ÿäº‹ä»¶çš„åŒºåˆ«

```javascript
// 1. å±æ€§è§„èŒƒåŒ–
// åŸç”Ÿäº‹ä»¶ï¼šä¸åŒæµè§ˆå™¨å¯èƒ½ä¸åŒ
event.pageX      // Chrome/Firefox
event.x          // IE

// SyntheticEventï¼šç»Ÿä¸€çš„æ¥å£
e.pageX          // æ‰€æœ‰æµè§ˆå™¨éƒ½æœ‰
e.clientX        // ç»Ÿä¸€çš„API

// 2. äº‹ä»¶æ± ï¼ˆReact 17å·²ç§»é™¤ï¼‰
// React 16ï¼š
function handleClick(e) {
  setTimeout(() => {
    console.log(e.type);  // nullï¼ˆäº‹ä»¶å¯¹è±¡è¢«é‡ç”¨ï¼‰
  }, 100);
}

// éœ€è¦persist
function handleClick(e) {
  e.persist();  // ä¿ç•™äº‹ä»¶å¯¹è±¡
  setTimeout(() => {
    console.log(e.type);  // "click" âœ“
  }, 100);
}

// React 17+ï¼šä¸å†æœ‰äº‹ä»¶æ± 
function handleClick(e) {
  setTimeout(() => {
    console.log(e.type);  // "click" âœ“ï¼ˆæ— éœ€persistï¼‰
  }, 100);
}

// 3. äº‹ä»¶å§”æ‰˜
// åŸç”Ÿï¼šåœ¨æ¯ä¸ªå…ƒç´ ä¸Šç›‘å¬
<button onclick="handler">

// Reactï¼šå§”æ‰˜åˆ°root
root.addEventListener('click', dispatchEvent);
// æ€§èƒ½æ›´å¥½ï¼Œå†…å­˜å ç”¨æ›´å°‘
```

#### è·å–åŸç”Ÿäº‹ä»¶

```javascript
function Component() {
  const handleClick = (e) => {
    const nativeEvent = e.nativeEvent;

    // åŸç”Ÿäº‹ä»¶çš„ç‰¹æ®Šå±æ€§
    console.log(nativeEvent.offsetX);
    console.log(nativeEvent.offsetY);
    console.log(nativeEvent.which); // é¼ æ ‡æŒ‰é”®

    // é˜»æ­¢æ‰€æœ‰ç›‘å¬å™¨ï¼ˆåŒ…æ‹¬documentä¸Šçš„ï¼‰
    nativeEvent.stopImmediatePropagation();
  };

  return <button onClick={handleClick}>Click</button>;
}
```

#### äº‹ä»¶å¯¹è±¡çš„ç±»å‹

```javascript
// ä¸åŒäº‹ä»¶ç±»å‹æœ‰ä¸åŒçš„SyntheticEvent

// MouseEvent
<button onClick={(e: React.MouseEvent) => {
  e.clientX, e.clientY
  e.button  // 0=å·¦é”®ï¼Œ1=ä¸­é”®ï¼Œ2=å³é”®
}}>

// KeyboardEvent
<input onKeyDown={(e: React.KeyboardEvent) => {
  e.key, e.code
  e.altKey, e.ctrlKey, e.shiftKey
}} />

// FormEvent
<form onSubmit={(e: React.FormEvent) => {
  e.preventDefault();
  const formData = new FormData(e.currentTarget);
}} />

// ChangeEvent
<input onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
  e.target.value
}} />

// FocusEvent
<input onFocus={(e: React.FocusEvent) => {
  e.relatedTarget  // ä¸Šä¸€ä¸ªç„¦ç‚¹å…ƒç´ 
}} />
```

---

### 19. å¦‚ä½•é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Ÿ

**ç­”æ¡ˆï¼šä½¿ç”¨ e.stopPropagation()é˜»æ­¢ React äº‹ä»¶å†’æ³¡ï¼Œä½†æ— æ³•é˜»æ­¢åŸç”Ÿäº‹ä»¶å†’æ³¡ã€‚**

#### React äº‹ä»¶å†’æ³¡

```javascript
function Parent() {
  const handleParentClick = () => {
    console.log("Parent clicked");
  };

  return (
    <div onClick={handleParentClick}>
      <Child />
    </div>
  );
}

function Child() {
  const handleChildClick = (e) => {
    console.log("Child clicked");
    e.stopPropagation(); // é˜»æ­¢å†’æ³¡åˆ°Parent
  };

  return <button onClick={handleChildClick}>Click</button>;
}

// ç‚¹å‡»æŒ‰é’®ï¼š
// "Child clicked"
// ï¼ˆä¸ä¼šæ‰“å°"Parent clicked"ï¼‰
```

**React äº‹ä»¶ vs åŸç”Ÿäº‹ä»¶**

```javascript
function Component() {
  useEffect(() => {
    // åŸç”Ÿäº‹ä»¶ç›‘å¬
    const handleNativeClick = (e) => {
      console.log("Native: document clicked");
    };

    document.addEventListener("click", handleNativeClick);

    return () => {
      document.removeEventListener("click", handleNativeClick);
    };
  }, []);

  const handleReactClick = (e) => {
    console.log("React: button clicked");
    e.stopPropagation(); // åªé˜»æ­¢Reactäº‹ä»¶
  };

  return <button onClick={handleReactClick}>Click</button>;
}

// ç‚¹å‡»æŒ‰é’®è¾“å‡ºï¼š
// "React: button clicked"
// "Native: document clicked"  â† åŸç”Ÿäº‹ä»¶ä»ç„¶è§¦å‘

// ä¸ºä»€ä¹ˆï¼Ÿ
// Reactäº‹ä»¶å§”æ‰˜åˆ°rootï¼Œe.stopPropagation()åªé˜»æ­¢Reactå†…éƒ¨çš„å†’æ³¡
// åŸç”Ÿäº‹ä»¶åœ¨documentä¸Šï¼Œå…ˆäºReactäº‹ä»¶è§¦å‘
```

**é˜»æ­¢åŸç”Ÿäº‹ä»¶å†’æ³¡**ï¼š

```javascript
function Component() {
  const handleClick = (e) => {
    e.nativeEvent.stopImmediatePropagation(); // é˜»æ­¢æ‰€æœ‰ç›‘å¬å™¨
  };

  return <button onClick={handleClick}>Click</button>;
}
```

---

## å…­ã€Context å’Œé€šä¿¡ç±»

### 27. Context å¦‚ä½•å·¥ä½œï¼Ÿæœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Ÿ

**ç­”æ¡ˆï¼šContext é€šè¿‡ Provider/Consumer ä¼ é€’æ•°æ®ï¼Œä½† value å˜åŒ–ä¼šå¯¼è‡´æ‰€æœ‰æ¶ˆè´¹è€…é‡æ–°æ¸²æŸ“ã€‚**

#### åŸºæœ¬ç”¨æ³•

```javascript
const ThemeContext = React.createContext("light");

function App() {
  const [theme, setTheme] = useState("light");

  return (
    <ThemeContext.Provider value={theme}>
      <Toolbar />
    </ThemeContext.Provider>
  );
}

function Toolbar() {
  // Toolbarä¸ä½¿ç”¨contextï¼Œä½†ä¼šå› ä¸ºParent renderè€Œrender
  return <ThemedButton />;
}

function ThemedButton() {
  const theme = useContext(ThemeContext);
  return <button className={theme}>Button</button>;
}
```

**æ€§èƒ½é—®é¢˜**ï¼š

```javascript
// âŒ é—®é¢˜ï¼švalueæ˜¯æ–°å¯¹è±¡ï¼Œå¯¼è‡´æ‰€æœ‰æ¶ˆè´¹è€…render
function App() {
  const [user, setUser] = useState({ name: "Tom" });
  const [theme, setTheme] = useState("light");

  return (
    <UserContext.Provider value={{ user, setUser }}>
      {" "}
      {/* æ¯æ¬¡renderéƒ½æ˜¯æ–°å¯¹è±¡ */}
      <ThemeContext.Provider value={theme}>
        <Page />
      </ThemeContext.Provider>
    </UserContext.Provider>
  );
}

// Appä»»ä½•stateå˜åŒ– â†’ valueæ–°å¯¹è±¡ â†’ æ‰€æœ‰useContext(UserContext)çš„ç»„ä»¶render
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šuseMemoç¼“å­˜value
function App() {
  const [user, setUser] = useState({ name: "Tom" });
  const [theme, setTheme] = useState("light");

  const userValue = useMemo(
    () => ({ user, setUser }),
    [user] // setUseræ˜¯ç¨³å®šçš„ï¼Œä¸éœ€è¦ä¾èµ–
  );

  return (
    <UserContext.Provider value={userValue}>
      {" "}
      {/* å¼•ç”¨ç¨³å®š */}
      <ThemeContext.Provider value={theme}>
        <Page />
      </ThemeContext.Provider>
    </UserContext.Provider>
  );
}

// âœ… æ–¹æ¡ˆ2ï¼šæ‹†åˆ†Context
const UserContext = React.createContext();
const ThemeContext = React.createContext();

function App() {
  const [user, setUser] = useState({ name: "Tom" });
  const [theme, setTheme] = useState("light");

  return (
    <UserContext.Provider value={user}>
      <ThemeContext.Provider value={theme}>
        <Page />
      </ThemeContext.Provider>
    </UserContext.Provider>
  );
}

// userå˜åŒ–åªå½±å“useContext(UserContext)çš„ç»„ä»¶
// themeå˜åŒ–åªå½±å“useContext(ThemeContext)çš„ç»„ä»¶

// âœ… æ–¹æ¡ˆ3ï¼šContext Selectorï¼ˆæœªæ¥å¯èƒ½çš„APIï¼‰
// ç›®å‰å¯ä»¥ç”¨useSyncExternalStoreå®ç°
```

---

## ä¸ƒã€é”™è¯¯å¤„ç†ç±»

### 29. ErrorBoundary çš„åŸç†å’Œä½¿ç”¨ï¼Ÿ

**ç­”æ¡ˆï¼šErrorBoundary é€šè¿‡ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ•è·å­ç»„ä»¶çš„æ¸²æŸ“é”™è¯¯ï¼Œæ˜¾ç¤ºé™çº§ UIã€‚**

#### åŸºæœ¬ç”¨æ³•

```javascript
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    // æ›´æ–°stateï¼Œä¸‹æ¬¡renderæ˜¾ç¤ºé™çº§UI
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    // è®°å½•é”™è¯¯åˆ°æ—¥å¿—æœåŠ¡
    console.error("Error caught:", error, errorInfo);
    logErrorToService(error, errorInfo.componentStack);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div>
          <h1>Something went wrong.</h1>
          <details>{this.state.error && this.state.error.toString()}</details>
        </div>
      );
    }

    return this.props.children;
  }
}

// ä½¿ç”¨
function App() {
  return (
    <ErrorBoundary>
      <BuggyComponent />
    </ErrorBoundary>
  );
}
```

**åº•å±‚åŸç†**ï¼ˆç±»ä¼¼ Suspense çš„ throw/catch æœºåˆ¶ï¼‰ï¼š

```
1. BuggyComponentæŠ›å‡ºé”™è¯¯
   throw new Error('Bug!');

2. Reactæ•è·ï¼ˆbeginWorkçš„try-catchï¼‰
   try {
     beginWork(BuggyComponent)
   } catch (error) {
     handleThrow(root, error)
   }

3. æŸ¥æ‰¾ErrorBoundary
   å‘ä¸Šéå†returné“¾
   æ‰¾åˆ°æœ‰getDerivedStateFromErrorçš„ç»„ä»¶

4. æ ‡è®°ShouldCapture
   errorBoundary.flags |= ShouldCapture

5. unwindWorkè½¬æ¢flag
   flags = (flags & ~ShouldCapture) | DidCapture

6. beginWorkæ£€æµ‹DidCapture
   è°ƒç”¨getDerivedStateFromError(error)
   hasError = true

7. renderé™çº§UI
   return <div>Something went wrong</div>
```

**é™åˆ¶å’Œæ³¨æ„äº‹é¡¹**ï¼š

```javascript
// ErrorBoundaryæ— æ³•æ•è·ä»¥ä¸‹é”™è¯¯ï¼š

// 1. âŒ äº‹ä»¶å¤„ç†å™¨ä¸­çš„é”™è¯¯
<button onClick={() => {
  throw new Error('Click error');  // ä¸ä¼šè¢«æ•è·
}}>

// è§£å†³ï¼šæ‰‹åŠ¨try-catch
<button onClick={() => {
  try {
    riskyOperation();
  } catch (error) {
    handleError(error);
  }
}}>

// 2. âŒ å¼‚æ­¥ä»£ç ä¸­çš„é”™è¯¯
useEffect(() => {
  setTimeout(() => {
    throw new Error('Async error');  // ä¸ä¼šè¢«æ•è·
  }, 1000);
}, []);

// è§£å†³ï¼šæ‰‹åŠ¨try-catchæˆ–Promise.catch

// 3. âŒ ErrorBoundaryè‡ªèº«çš„é”™è¯¯
class ErrorBoundary extends React.Component {
  render() {
    throw new Error('Self error');  // ä¸ä¼šè¢«è‡ªå·±æ•è·
  }
}

// è§£å†³ï¼šåµŒå¥—å¤šå±‚ErrorBoundary

// 4. âŒ SSRæœåŠ¡ç«¯æ¸²æŸ“çš„é”™è¯¯
// è§£å†³ï¼šæœåŠ¡ç«¯ä¹Ÿéœ€è¦ErrorBoundary
```

**æœ€ä½³å®è·µ**ï¼š

```javascript
// âœ… ç»†ç²’åº¦ErrorBoundary
function App() {
  return (
    <>
      <ErrorBoundary fallback={<HeaderError />}>
        <Header />
      </ErrorBoundary>

      <ErrorBoundary fallback={<MainError />}>
        <Main />
      </ErrorBoundary>

      <ErrorBoundary fallback={<FooterError />}>
        <Footer />
      </ErrorBoundary>
    </>
  );
}

// å¥½å¤„ï¼šä¸€ä¸ªç»„ä»¶é”™è¯¯ä¸å½±å“å…¶ä»–ç»„ä»¶
```

---

## å…«ã€æœ€ä½³å®è·µç±»

### 30. React å¼€å‘æœ‰å“ªäº›æœ€ä½³å®è·µï¼Ÿ

#### 1. ç»„ä»¶è®¾è®¡

```javascript
// âœ… DOï¼šå•ä¸€èŒè´£
function UserProfile({ userId }) {
  return (
    <>
      <UserAvatar userId={userId} />
      <UserInfo userId={userId} />
      <UserStats userId={userId} />
    </>
  );
}

// âŒ DON'Tï¼šèŒè´£æ··ä¹±
function UserProfile({ userId }) {
  // å¤´åƒé€»è¾‘ã€ä¿¡æ¯é€»è¾‘ã€ç»Ÿè®¡é€»è¾‘éƒ½åœ¨ä¸€ä¸ªç»„ä»¶
}

// âœ… DOï¼šPropsè§£æ„
function Component({ name, age, email }) {
  return (
    <div>
      {name}, {age}, {email}
    </div>
  );
}

// âŒ DON'Tï¼šç›´æ¥ä½¿ç”¨propså¯¹è±¡
function Component(props) {
  return (
    <div>
      {props.name}, {props.age}, {props.email}
    </div>
  );
}
```

#### 2. State ç®¡ç†

```javascript
// âœ… DOï¼šçŠ¶æ€å°±è¿‘åŸåˆ™
function Form() {
  // usernameåªåœ¨è¿™é‡Œç”¨ï¼Œå®šä¹‰åœ¨è¿™é‡Œ
  const [username, setUsername] = useState("");
  return (
    <input value={username} onChange={(e) => setUsername(e.target.value)} />
  );
}

// âŒ DON'Tï¼šè¿‡åº¦æå‡state
function App() {
  const [username, setUsername] = useState(""); // åªæœ‰ä¸€ä¸ªå­ç»„ä»¶ç”¨
  return <Form username={username} setUsername={setUsername} />;
}

// âœ… DOï¼šä½¿ç”¨useReducerç®¡ç†å¤æ‚state
const [state, dispatch] = useReducer(reducer, {
  username: "",
  email: "",
  password: "",
  errors: {},
});

// âŒ DON'Tï¼šè¿‡å¤šuseState
const [username, setUsername] = useState("");
const [email, setEmail] = useState("");
const [password, setPassword] = useState("");
const [errors, setErrors] = useState({});
```

#### 3. æ€§èƒ½ä¼˜åŒ–

```javascript
// âœ… DOï¼šåˆç†ä½¿ç”¨memo
const ExpensiveList = React.memo(List);

// âŒ DON'Tï¼šè¿‡åº¦ä¼˜åŒ–
const SimpleText = React.memo(({ text }) => <span>{text}</span>);

// âœ… DOï¼šç¨³å®šçš„ä¾èµ–
const config = useMemo(() => ({...}), [theme]);

// âŒ DON'Tï¼šæ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡
<Component config={{ theme }} />

// âœ… DOï¼šè™šæ‹ŸåŒ–é•¿åˆ—è¡¨
import { FixedSizeList } from 'react-window';
<FixedSizeList height={600} itemCount={10000} itemSize={50}>
  {Row}
</FixedSizeList>

// âŒ DON'Tï¼šæ¸²æŸ“æ‰€æœ‰10000é¡¹
{items.map(item => <Item key={item.id} />)}
```

#### 4. Hooks ä½¿ç”¨

```javascript
// âœ… DOï¼šéµå¾ªHookè§„åˆ™
function Component() {
  const [state, setState] = useState(0); // é¡¶å±‚
  useEffect(() => {}, [state]); // é¡¶å±‚

  return <div>{state}</div>;
}

// âŒ DON'Tï¼šæ¡ä»¶è°ƒç”¨Hook
if (condition) {
  const [state, setState] = useState(0); // âŒ
}

// âœ… DOï¼šå®Œæ•´çš„ä¾èµ–æ•°ç»„
useEffect(() => {
  doSomething(prop, state);
}, [prop, state]); // åŒ…å«æ‰€æœ‰ä½¿ç”¨çš„å˜é‡

// âŒ DON'Tï¼šé—æ¼ä¾èµ–
useEffect(() => {
  doSomething(prop, state);
}, []); // âŒ é—æ¼propå’Œstate

// âœ… DOï¼šæ¸…ç†å‰¯ä½œç”¨
useEffect(() => {
  const subscription = api.subscribe();
  return () => subscription.unsubscribe(); // cleanup
}, []);

// âŒ DON'Tï¼šå¿˜è®°æ¸…ç†
useEffect(() => {
  api.subscribe(); // âŒ å†…å­˜æ³„æ¼
}, []);
```

#### 5. ä»£ç ç»„ç»‡

```javascript
// âœ… DOï¼šä½¿ç”¨è‡ªå®šä¹‰Hookæå–é€»è¾‘
function useWindowSize() {
  const [size, setSize] = useState({ width: 0, height: 0 });

  useEffect(() => {
    const handleResize = () => {
      setSize({ width: window.innerWidth, height: window.innerHeight });
    };
    window.addEventListener("resize", handleResize);
    handleResize();
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  return size;
}

// ä½¿ç”¨
function Component() {
  const { width, height } = useWindowSize();
  return (
    <div>
      {width} x {height}
    </div>
  );
}

// âœ… DOï¼šç»„ä»¶åå¤§å†™
function MyComponent() {} // âœ“

// âŒ DON'Tï¼šç»„ä»¶åå°å†™
function myComponent() {} // âŒ JSXä¼šè®¤ä¸ºæ˜¯HTMLæ ‡ç­¾
```

---

## ä¹ã€Refs å’Œ DOM ç±»

### 25. ref çš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯ï¼Ÿ

**ç­”æ¡ˆï¼šref ç”¨äºç›´æ¥è®¿é—® DOM å…ƒç´ æˆ–ç»„ä»¶å®ä¾‹ï¼Œé€‚ç”¨äºéœ€è¦å‘½ä»¤å¼æ“ä½œ DOM çš„åœºæ™¯ã€‚**

#### ä¸‰ç§ä½¿ç”¨æ–¹å¼

```javascript
// 1. useRef Hookï¼ˆå‡½æ•°ç»„ä»¶ï¼‰
function Component() {
  const inputRef = useRef(null);

  const focusInput = () => {
    inputRef.current.focus();
  };

  return (
    <>
      <input ref={inputRef} />
      <button onClick={focusInput}>Focus Input</button>
    </>
  );
}

// 2. createRefï¼ˆç±»ç»„ä»¶ï¼‰
class Component extends React.Component {
  constructor(props) {
    super(props);
    this.inputRef = React.createRef();
  }

  focusInput = () => {
    this.inputRef.current.focus();
  };

  render() {
    return (
      <>
        <input ref={this.inputRef} />
        <button onClick={this.focusInput}>Focus</button>
      </>
    );
  }
}

// 3. å›è°ƒref
function Component() {
  const [inputElement, setInputElement] = useState(null);

  return (
    <input
      ref={(node) => {
        setInputElement(node);
        // nodeæŒ‚è½½æ—¶è°ƒç”¨ï¼Œä¼ å…¥DOMå…ƒç´ 
        // nodeå¸è½½æ—¶è°ƒç”¨ï¼Œä¼ å…¥null
      }}
    />
  );
}
```

#### å¸¸è§ä½¿ç”¨åœºæ™¯

```javascript
// åœºæ™¯1ï¼šèšç„¦ç®¡ç†
function SearchBox() {
  const inputRef = useRef();

  useEffect(() => {
    inputRef.current.focus(); // è‡ªåŠ¨èšç„¦
  }, []);

  return <input ref={inputRef} />;
}

// åœºæ™¯2ï¼šæµ‹é‡DOM
function ResizablePanel() {
  const panelRef = useRef();
  const [size, setSize] = useState({ width: 0, height: 0 });

  useLayoutEffect(() => {
    const rect = panelRef.current.getBoundingClientRect();
    setSize({ width: rect.width, height: rect.height });
  });

  return (
    <div ref={panelRef}>
      Size: {size.width}x{size.height}
    </div>
  );
}

// åœºæ™¯3ï¼šæ»šåŠ¨æ§åˆ¶
function ChatMessages({ messages }) {
  const bottomRef = useRef();

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  return (
    <div>
      {messages.map((msg) => (
        <Message key={msg.id} {...msg} />
      ))}
      <div ref={bottomRef} />
    </div>
  );
}

// åœºæ™¯4ï¼šä¿å­˜å¯å˜å€¼ï¼ˆä¸è§¦å‘renderï¼‰
function Timer() {
  const [count, setCount] = useState(0);
  const intervalRef = useRef();

  useEffect(() => {
    intervalRef.current = setInterval(() => {
      setCount((c) => c + 1);
    }, 1000);

    return () => clearInterval(intervalRef.current);
  }, []);

  const pause = () => {
    clearInterval(intervalRef.current);
  };

  return (
    <>
      <div>{count}</div>
      <button onClick={pause}>Pause</button>
    </>
  );
}

// åœºæ™¯5ï¼šé›†æˆç¬¬ä¸‰æ–¹åº“
function VideoPlayer({ src }) {
  const videoRef = useRef();
  const playerRef = useRef();

  useEffect(() => {
    // åˆå§‹åŒ–ç¬¬ä¸‰æ–¹æ’­æ”¾å™¨
    playerRef.current = new ThirdPartyPlayer(videoRef.current, {
      src,
      autoplay: true,
    });

    return () => {
      playerRef.current.destroy();
    };
  }, [src]);

  return <video ref={videoRef} />;
}
```

**ref vs state**ï¼š

```javascript
// useRefï¼š
// - æ”¹å˜ä¸è§¦å‘render
// - ç”¨äºå­˜å‚¨å¯å˜å€¼
// - è®¿é—®DOMå…ƒç´ 

// useStateï¼š
// - æ”¹å˜è§¦å‘render
// - ç”¨äºæ¸²æŸ“ç›¸å…³çš„æ•°æ®
// - UIçŠ¶æ€

// ç¤ºä¾‹ï¼šè®¡æ•°å™¨ï¼ˆç”¨refè¿˜æ˜¯stateï¼Ÿï¼‰
// âŒ é”™è¯¯ï¼šç”¨refï¼ˆä¸ä¼šæ›´æ–°UIï¼‰
function Counter() {
  const countRef = useRef(0);

  const increment = () => {
    countRef.current++;
    // UIä¸æ›´æ–°ï¼
  };

  return <div>{countRef.current}</div>;
}

// âœ… æ­£ç¡®ï¼šç”¨state
function Counter() {
  const [count, setCount] = useState(0);
  return <div>{count}</div>;
}
```

---

### 26. forwardRef æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

**ç­”æ¡ˆï¼šåœ¨ React 19 ä¹‹å‰ï¼ŒforwardRef ç”¨äºå°† ref è½¬å‘ç»™å­ç»„ä»¶ã€‚React 19 å¼€å§‹ï¼Œref å¯ä»¥ä½œä¸ºæ™®é€š prop ä½¿ç”¨ï¼Œä¸å†éœ€è¦ forwardRefã€‚**

#### React 19ï¼šref ä½œä¸ºæ™®é€š propï¼ˆæ¨èï¼‰

```javascript
// âœ… React 19ï¼šref ç›´æ¥ä½œä¸º prop
function FancyInput({ ref, ...props }) {
  return <input ref={ref} {...props} />;
  // ref ç°åœ¨æ˜¯æ™®é€š propï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
}

function Parent() {
  const inputRef = useRef();

  const focus = () => {
    inputRef.current.focus(); // âœ“ æ­£å¸¸å·¥ä½œ
  };

  return (
    <>
      <FancyInput ref={inputRef} />
      <button onClick={focus}>Focus</button>
    </>
  );
}
```

**åº•å±‚åŸç†**ï¼ˆReact 19 å˜åŒ–ï¼‰ï¼š

```javascript
// React 18 åŠä¹‹å‰ï¼šref æ˜¯ç‰¹æ®Šå±æ€§
<Component ref={ref} />
// ref ä¸åœ¨ props ä¸­ï¼Œéœ€è¦ forwardRef

// React 19ï¼šref æ˜¯æ™®é€š prop
<Component ref={ref} />
// ç­‰ä»·äºï¼š
<Component {...{ ref: ref }} />
// ref åœ¨ props ä¸­ï¼Œå¯ä»¥ç›´æ¥è®¿é—®
```

#### React 18 åŠæ›´æ—©ç‰ˆæœ¬ï¼šéœ€è¦ forwardRef

```javascript
// React 18ï¼šå¿…é¡»ä½¿ç”¨ forwardRef
const FancyInput = React.forwardRef((props, ref) => {
  return <input {...props} ref={ref} />;
});

function Parent() {
  const inputRef = useRef();

  return <FancyInput ref={inputRef} />;
}
```

**é—®é¢˜ï¼šref æ— æ³•ç›´æ¥ä¼ é€’**

```javascript
// âŒ React 18ï¼šref ä¸ä¼šä¼ é€’ç»™å­ç»„ä»¶
function FancyInput(props) {
  // props ä¸­æ²¡æœ‰ refï¼
  console.log(props.ref); // undefined
  return <input {...props} />;
}

function Parent() {
  const inputRef = useRef();

  return <FancyInput ref={inputRef} />;
  // ref ä¸ä¼šå‡ºç°åœ¨ props ä¸­
}
```

#### React 19ï¼šä½¿ç”¨ useImperativeHandle æš´éœ²è‡ªå®šä¹‰æ–¹æ³•

```javascript
// æš´éœ²è‡ªå®šä¹‰æ–¹æ³•ï¼Œè€Œä¸æ˜¯æ•´ä¸ª DOM
function FancyInput({ ref, ...props }) {
  const inputRef = useRef();

  useImperativeHandle(ref, () => ({
    // åªæš´éœ² focus å’Œ select æ–¹æ³•
    focus: () => {
      inputRef.current.focus();
    },
    select: () => {
      inputRef.current.select();
    },
    // ä¸æš´éœ²æ•´ä¸ª input å…ƒç´ 
  }));

  return <input ref={inputRef} {...props} />;
}

function Parent() {
  const fancyInputRef = useRef();

  const handleClick = () => {
    fancyInputRef.current.focus(); // âœ“ å¯ä»¥è°ƒç”¨
    fancyInputRef.current.select(); // âœ“ å¯ä»¥è°ƒç”¨
    fancyInputRef.current.value; // undefinedï¼ˆæœªæš´éœ²ï¼‰
  };

  return (
    <>
      <FancyInput ref={fancyInputRef} />
      <button onClick={handleClick}>Focus & Select</button>
    </>
  );
}
```

#### è¿ç§»å»ºè®®

```javascript
// æ—§ä»£ç ï¼ˆReact 18ï¼‰
const MyComponent = React.forwardRef((props, ref) => {
  return <div ref={ref}>{props.children}</div>;
});

// æ–°ä»£ç ï¼ˆReact 19ï¼‰- æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨ ref prop
function MyComponent({ ref, children }) {
  return <div ref={ref}>{children}</div>;
}

// æ–°ä»£ç ï¼ˆReact 19ï¼‰- æ–¹å¼2ï¼šè§£æ„å‰©ä½™ props
function MyComponent({ ref, ...props }) {
  return <div ref={ref} {...props} />;
}

// æ³¨æ„ï¼šforwardRef åœ¨ React 19 ä¸­ä»ç„¶å¯ç”¨ï¼Œä½†ä¸å†å¿…éœ€
// æ¨èæ–°ä»£ç ç›´æ¥ä½¿ç”¨ ref prop
```

**å…¼å®¹æ€§è¯´æ˜**ï¼š

```javascript
// âœ… React 19 æ”¯æŒä¸¤ç§æ–¹å¼ï¼š
// 1. æ–°æ–¹å¼ï¼šref ä½œä¸º prop
function Component({ ref }) {
  return <div ref={ref} />;
}

// 2. æ—§æ–¹å¼ï¼šforwardRefï¼ˆå‘åå…¼å®¹ï¼‰
const Component = React.forwardRef((props, ref) => {
  return <div ref={ref} />;
});

// æ¨èï¼šæ–°é¡¹ç›®ä½¿ç”¨æ–°æ–¹å¼ï¼Œæ—§é¡¹ç›®å¯ä»¥é€æ­¥è¿ç§»
```

---

## åã€ç»„ä»¶é€šä¿¡ç±»

### 28. ç»„ä»¶é€šä¿¡æœ‰å“ªäº›æ–¹å¼ï¼Ÿ

**ç­”æ¡ˆï¼šPropsã€Contextã€çŠ¶æ€æå‡ã€äº‹ä»¶æ€»çº¿ã€ç¬¬ä¸‰æ–¹çŠ¶æ€ç®¡ç†ã€‚**

#### æ–¹å¼ 1ï¼šPropsï¼ˆçˆ¶ â†’ å­ï¼‰

```javascript
function Parent() {
  const [data, setData] = useState("Hello");

  return <Child data={data} onUpdate={setData} />;
}

function Child({ data, onUpdate }) {
  return (
    <>
      <div>{data}</div>
      <button onClick={() => onUpdate("New Data")}>Update</button>
    </>
  );
}
```

#### æ–¹å¼ 2ï¼šContextï¼ˆè·¨å±‚çº§ï¼‰

```javascript
const DataContext = React.createContext();

function GrandParent() {
  const [data, setData] = useState("Hello");

  return (
    <DataContext.Provider value={{ data, setData }}>
      <Parent />
    </DataContext.Provider>
  );
}

function Parent() {
  return <Child />; // ä¸éœ€è¦ä¼ é€’props
}

function Child() {
  const { data, setData } = useContext(DataContext);
  return (
    <>
      <div>{data}</div>
      <button onClick={() => setData("New")}>Update</button>
    </>
  );
}
```

#### æ–¹å¼ 3ï¼šçŠ¶æ€æå‡ï¼ˆå…„å¼Ÿç»„ä»¶ï¼‰

```javascript
function Parent() {
  const [sharedData, setSharedData] = useState("");

  return (
    <>
      <Sibling1 data={sharedData} setData={setSharedData} />
      <Sibling2 data={sharedData} setData={setSharedData} />
    </>
  );
}
```

#### æ–¹å¼ 4ï¼šè‡ªå®šä¹‰äº‹ä»¶ï¼ˆä¸æ¨èï¼‰

```javascript
// å¯ä»¥ä½†ä¸æ¨èï¼šä½¿ç”¨äº‹ä»¶æ€»çº¿
class EventBus {
  listeners = {};

  on(event, callback) {
    if (!this.listeners[event]) {
      this.listeners[event] = [];
    }
    this.listeners[event].push(callback);
  }

  emit(event, data) {
    this.listeners[event]?.forEach((cb) => cb(data));
  }
}

const bus = new EventBus();

function Component1() {
  const handleData = (data) => {
    console.log("received:", data);
  };

  useEffect(() => {
    bus.on("dataUpdate", handleData);
    return () => {
      /* éš¾ä»¥æ¸…ç† */
    };
  }, []);

  return <div>Component1</div>;
}

function Component2() {
  const sendData = () => {
    bus.emit("dataUpdate", { value: 123 });
  };

  return <button onClick={sendData}>Send</button>;
}

// é—®é¢˜ï¼šéš¾ä»¥è¿½è¸ªæ•°æ®æµï¼Œéš¾ä»¥è°ƒè¯•
// æ¨èï¼šä½¿ç”¨Contextæˆ–çŠ¶æ€ç®¡ç†åº“
```

#### æ–¹å¼ 5ï¼šçŠ¶æ€ç®¡ç†åº“

```javascript
// Redux
import { useSelector, useDispatch } from "react-redux";

function Component1() {
  const data = useSelector((state) => state.data);
  return <div>{data}</div>;
}

function Component2() {
  const dispatch = useDispatch();
  const updateData = () => {
    dispatch({ type: "UPDATE_DATA", payload: "New Data" });
  };
  return <button onClick={updateData}>Update</button>;
}

// Zustandï¼ˆæ›´è½»é‡ï¼‰
import create from "zustand";

const useStore = create((set) => ({
  data: "",
  setData: (data) => set({ data }),
}));

function Component1() {
  const data = useStore((state) => state.data);
  return <div>{data}</div>;
}

function Component2() {
  const setData = useStore((state) => state.setData);
  return <button onClick={() => setData("New")}>Update</button>;
}
```

---

## ğŸ“ è¡¥å……é¢˜ç›®

### 10. è™šæ‹Ÿ DOM ä¸€å®šæ¯”çœŸå® DOM å¿«å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸ä¸€å®šã€‚è™šæ‹Ÿ DOM çš„ä¼˜åŠ¿åœ¨äºä¼˜åŒ–å’Œè·¨å¹³å°ï¼Œè€Œä¸æ˜¯ç»å¯¹çš„æ€§èƒ½ã€‚**

#### è¯¯åŒºæ¾„æ¸…

```
âŒ é”™è¯¯è®¤çŸ¥ï¼š
è™šæ‹ŸDOMæ¯”çœŸå®DOMå¿«

âœ“ æ­£ç¡®ç†è§£ï¼š
è™šæ‹ŸDOMé€šè¿‡diffç®—æ³•ï¼Œå‡å°‘ä¸å¿…è¦çš„DOMæ“ä½œ
åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹æ€§èƒ½æ›´å¥½
ä½†ä¸æ˜¯ç»å¯¹çš„å¿«
```

#### æ€§èƒ½å¯¹æ¯”

```javascript
// åœºæ™¯1ï¼šå¤§é‡æ•°æ®é¦–æ¬¡æ¸²æŸ“
const data = Array(10000).fill({...});

// çœŸå®DOMï¼š
const container = document.getElementById('root');
data.forEach(item => {
  const div = document.createElement('div');
  div.textContent = item.text;
  container.appendChild(div);
});
// è€—æ—¶ï¼š~50ms

// Reactï¼ˆè™šæ‹ŸDOM + reconciliationï¼‰ï¼š
ReactDOM.createRoot(container).render(
  <>{data.map(item => <div key={item.id}>{item.text}</div>)}</>
);
// è€—æ—¶ï¼š~80msï¼ˆå¤šäº†diffå’ŒFiberæ ‘æ„å»ºï¼‰

ç»“è®ºï¼šé¦–æ¬¡æ¸²æŸ“ï¼Œè™šæ‹ŸDOMæ›´æ…¢ï¼ˆé¢å¤–å¼€é”€ï¼‰

// åœºæ™¯2ï¼šæ›´æ–°1ä¸ªå…ƒç´ 
data[0].text = 'Updated';

// çœŸå®DOMï¼š
document.querySelector('div:first-child').textContent = 'Updated';
// è€—æ—¶ï¼š~0.1ms

// Reactï¼š
setData([...data]);
// è€—æ—¶ï¼š~10msï¼ˆdiff 10000ä¸ªå…ƒç´ ï¼Œä½†åªæ›´æ–°1ä¸ªDOMï¼‰

ç»“è®ºï¼šç²¾ç¡®æ›´æ–°ï¼ŒçœŸå®DOMæ›´å¿«
      æ‰¹é‡æ›´æ–°ï¼Œè™šæ‹ŸDOMæ›´ä¼˜
```

#### è™šæ‹Ÿ DOM çš„çœŸæ­£ä¼˜åŠ¿

```
1. ä¼˜åŒ–ç®—æ³•
   - diffç®—æ³•æ‰¾å‡ºæœ€å°å˜æ›´
   - æ‰¹é‡DOMæ“ä½œ
   - å‡å°‘reflow/repaint

2. å£°æ˜å¼ç¼–ç¨‹
   - ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œDOM
   - ä»£ç æ›´æ˜“ç»´æŠ¤
   - å‡å°‘bug

3. è·¨å¹³å°
   - React Nativeï¼ˆç§»åŠ¨ç«¯ï¼‰
   - React Three Fiberï¼ˆ3Dï¼‰
   - React PDFç­‰

4. æ—¶é—´åˆ‡ç‰‡
   - å¯ä¸­æ–­æ¸²æŸ“
   - ä¿æŒåº”ç”¨å“åº”

ç»“è®ºï¼šè™šæ‹ŸDOMçš„ä»·å€¼ä¸åœ¨äº"å¿«"ï¼Œè€Œåœ¨äº"ä¼˜åŒ–"å’Œ"æ˜“ç”¨"
```

---

### 12. useEffect çš„ä¾èµ–æ•°ç»„ä¸ºç©ºä¼šæ€æ ·ï¼Ÿ

**ç­”æ¡ˆï¼šåªåœ¨ mount æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äº componentDidMountã€‚**

#### ä¸‰ç§ä¾èµ–æƒ…å†µ

```javascript
function Component({ userId }) {
  const [data, setData] = useState(null);

  // 1. ç©ºæ•°ç»„ï¼šåªæ‰§è¡Œä¸€æ¬¡
  useEffect(() => {
    console.log("mount");
    return () => console.log("unmount");
  }, []);
  // mountæ—¶æ‰§è¡Œcreate
  // unmountæ—¶æ‰§è¡Œcleanup
  // ä¸ä¼šå†æ‰§è¡Œ

  // 2. æœ‰ä¾èµ–ï¼šä¾èµ–å˜åŒ–æ—¶æ‰§è¡Œ
  useEffect(() => {
    fetchUser(userId).then(setData);
    return () => {
      /* cleanup */
    };
  }, [userId]);
  // userIdå˜åŒ–æ—¶ï¼šcleanupæ—§effect â†’ createæ–°effect

  // 3. æ— ä¾èµ–æ•°ç»„ï¼šæ¯æ¬¡renderéƒ½æ‰§è¡Œ
  useEffect(() => {
    console.log("every render");
  });
  // æ¯æ¬¡renderéƒ½æ‰§è¡Œï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰

  return <div>{data?.name}</div>;
}
```

#### å¸¸è§é™·é˜±ï¼šé—æ¼ä¾èµ–

```javascript
// âŒ é”™è¯¯ï¼šé—æ¼ä¾èµ–
function Component({ userId }) {
  const [data, setData] = useState(null);

  useEffect(() => {
    fetchUser(userId).then(setData); // ä½¿ç”¨äº†userId
  }, []); // âŒ ä½†æ²¡æœ‰ä¾èµ–userId

  // é—®é¢˜ï¼šuserIdå˜åŒ–æ—¶ä¸ä¼šé‡æ–°è·å–æ•°æ®
}

// âœ… æ­£ç¡®ï¼šæ·»åŠ ä¾èµ–
useEffect(() => {
  fetchUser(userId).then(setData);
}, [userId]); // userIdå˜åŒ–æ—¶é‡æ–°è·å–

// âœ… æ¨èï¼šä½¿ç”¨ESLintè§„åˆ™è‡ªåŠ¨æ£€æµ‹
// eslint-plugin-react-hooksä¼šè­¦å‘Šé—æ¼çš„ä¾èµ–
```

---

### 13. useEffect çš„ cleanup å‡½æ•°ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ

**ç­”æ¡ˆï¼šç»„ä»¶å¸è½½æ—¶ï¼Œä»¥åŠä¾èµ–å˜åŒ–å¯¼è‡´ effect é‡æ–°æ‰§è¡Œå‰ã€‚**

#### æ‰§è¡Œæ—¶æœºï¼ˆè¯¦è§ç¬¬ 10 é¢˜ï¼‰

```javascript
function Component({ userId }) {
  useEffect(() => {
    console.log('effect create:', userId);

    return () => {
      console.log('effect cleanup:', userId);
    };
  }, [userId]);

  return <div>User: {userId}</div>;
}

// æ‰§è¡Œé¡ºåºï¼š
mount (userId=1):
  â†’ "effect create: 1"

update (userId=1â†’2):
  â†’ "effect cleanup: 1"  â† cleanupæ—§effect
  â†’ "effect create: 2"   â† createæ–°effect

update (userId=2â†’3):
  â†’ "effect cleanup: 2"
  â†’ "effect create: 3"

unmount:
  â†’ "effect cleanup: 3"  â† ç»„ä»¶å¸è½½æ—¶cleanup
```

#### å¸¸è§ç”¨é€”

```javascript
// 1. æ¸…ç†è®¢é˜…
useEffect(() => {
  const subscription = api.subscribe((data) => {
    setData(data);
  });

  return () => {
    subscription.unsubscribe(); // æ¸…ç†è®¢é˜…
  };
}, []);

// 2. æ¸…ç†å®šæ—¶å™¨
useEffect(() => {
  const timer = setTimeout(() => {
    doSomething();
  }, 1000);

  return () => {
    clearTimeout(timer); // æ¸…ç†å®šæ—¶å™¨
  };
}, []);

// 3. å–æ¶ˆç½‘ç»œè¯·æ±‚
useEffect(() => {
  let cancelled = false;

  fetchData().then((data) => {
    if (!cancelled) {
      setData(data);
    }
  });

  return () => {
    cancelled = true; // æ ‡è®°å·²å–æ¶ˆ
  };
}, []);

// 4. ç§»é™¤äº‹ä»¶ç›‘å¬
useEffect(() => {
  const handleResize = () => {
    setSize(window.innerWidth);
  };

  window.addEventListener("resize", handleResize);

  return () => {
    window.removeEventListener("resize", handleResize);
  };
}, []);
```

---

### 15. è‡ªå®šä¹‰ Hook æœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ

**ç­”æ¡ˆï¼šè‡ªå®šä¹‰ Hook å¿…é¡»éµå¾ª Hook è§„åˆ™ï¼Œä¸”å¿…é¡»ä»¥"use"å¼€å¤´ã€‚**

#### è‡ªå®šä¹‰ Hook è§„åˆ™

```javascript
// âœ… æ­£ç¡®ï¼šä»¥"use"å¼€å¤´
function useWindowSize() {
  const [size, setSize] = useState({
    width: window.innerWidth,
    height: window.innerHeight
  });

  useEffect(() => {
    const handleResize = () => {
      setSize({
        width: window.innerWidth,
        height: window.innerHeight
      });
    };

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return size;
}

// âŒ é”™è¯¯ï¼šä¸ä»¥"use"å¼€å¤´
function windowSize() {  // âŒ
  const [size, setSize] = useState({...});
  useEffect(() => {...}, []);
  return size;
}

// Reactä¼šè­¦å‘Šï¼š
// "React Hook useState is called in a function that is neither a React function component nor a custom React Hook function"
```

#### é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

```javascript
// âœ… DOï¼šå¯ä»¥è°ƒç”¨å…¶ä»–Hooks
function useUser(userId) {
  const [user, setUser] = useState(null); // âœ“
  const [loading, setLoading] = useState(false); // âœ“

  useEffect(() => {
    // âœ“
    setLoading(true);
    fetchUser(userId).then((data) => {
      setUser(data);
      setLoading(false);
    });
  }, [userId]);

  return { user, loading };
}

// âœ… DOï¼šå¯ä»¥äº’ç›¸è°ƒç”¨
function useAuth() {
  const user = useUser(userId); // âœ“ è°ƒç”¨å…¶ä»–è‡ªå®šä¹‰Hook
  const [isAdmin, setIsAdmin] = useState(false);

  useEffect(() => {
    setIsAdmin(user?.role === "admin");
  }, [user]);

  return { user, isAdmin };
}

// âŒ DON'Tï¼šåœ¨æ¡ä»¶ä¸­è°ƒç”¨Hook
function useConditional(condition) {
  if (condition) {
    const [state, setState] = useState(0); // âŒ
  }
}

// âŒ DON'Tï¼šåœ¨å¾ªç¯ä¸­è°ƒç”¨Hook
function useLoop(items) {
  items.forEach((item) => {
    const [state, setState] = useState(item); // âŒ
  });
}

// âŒ DON'Tï¼šåœ¨æ™®é€šå‡½æ•°ä¸­è°ƒç”¨Hook
function normalFunction() {
  const [state, setState] = useState(0); // âŒ
}

// âœ… DOï¼šåªåœ¨ç»„ä»¶æˆ–è‡ªå®šä¹‰Hookä¸­è°ƒç”¨
function MyComponent() {
  const [state, setState] = useState(0); // âœ“
}

function useMyHook() {
  const [state, setState] = useState(0); // âœ“
}
```

---

### 16. useCallback å’Œ useMemo ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ

**ç­”æ¡ˆï¼šä¼ ç»™ memo ç»„ä»¶ã€ä½œä¸ºä¾èµ–ã€æˆ–ä¼˜åŒ–æ˜‚è´µè®¡ç®—æ—¶ä½¿ç”¨ã€‚**

#### ä½¿ç”¨åœºæ™¯ï¼ˆè¯¦è§ç¬¬ 11 é¢˜ï¼‰

**åœºæ™¯ 1ï¼šä¼ ç»™ memo ç»„ä»¶**

```javascript
function Parent() {
  const [count, setCount] = useState(0);

  // âŒ ä¸å¥½ï¼šæ¯æ¬¡æ–°å‡½æ•°
  const handleClick = () => console.log("clicked");

  // âœ… å¥½ï¼šç¼“å­˜å‡½æ•°
  const handleClick = useCallback(() => {
    console.log("clicked");
  }, []);

  return (
    <>
      <button onClick={() => setCount((c) => c + 1)}>{count}</button>
      <MemoChild onClick={handleClick} />
    </>
  );
}

const MemoChild = React.memo(Child);
```

**åœºæ™¯ 2ï¼šä½œä¸ºå…¶ä»– Hook çš„ä¾èµ–**

```javascript
function Component({ apiUrl }) {
  // ç¼“å­˜configå¯¹è±¡
  const config = useMemo(() => ({
    url: apiUrl,
    method: 'GET',
    headers: { 'Content-Type': 'application/json' }
  }), [apiUrl]);

  useEffect(() => {
    fetch(config.url, config).then(...);
  }, [config]);  // configå¼•ç”¨ç¨³å®šï¼Œä¸ä¼šæ— é™å¾ªç¯

  return <div>...</div>;
}
```

**åœºæ™¯ 3ï¼šæ˜‚è´µè®¡ç®—**

```javascript
function DataTable({ data, sortKey, filterText }) {
  // æ˜‚è´µçš„è®¡ç®—
  const processedData = useMemo(() => {
    return data
      .filter((item) => item.text.includes(filterText))
      .sort((a, b) => a[sortKey] - b[sortKey])
      .map((item) => ({
        ...item,
        computed: expensiveComputation(item),
      }));
  }, [data, sortKey, filterText]);

  return <Table data={processedData} />;
}
```

**ä½•æ—¶ä¸éœ€è¦**ï¼š

```javascript
// âŒ ä¸éœ€è¦ï¼šç®€å•è®¡ç®—
const double = useMemo(() => count * 2, [count]);
// ç›´æ¥ï¼šconst double = count * 2;

// âŒ ä¸éœ€è¦ï¼šä¸ä¼ ç»™å­ç»„ä»¶çš„å¯¹è±¡
const style = useMemo(() => ({ color: "red" }), []);
// ç›´æ¥ï¼šconst style = { color: 'red' };

// âŒ ä¸éœ€è¦ï¼šä¾èµ–æ€»æ˜¯å˜åŒ–
const filtered = useMemo(
  () => items.filter((item) => item.id === Math.random()),
  [items]
);
// Math.random()æ¯æ¬¡ä¸åŒï¼ŒuseMemoæ— æ„ä¹‰
```

---

### 9. React å¦‚ä½•åˆ¤æ–­ä½•æ—¶é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Ÿ

**ç­”æ¡ˆï¼šé€šè¿‡ shouldComponentUpdateã€memo æ¯”è¾ƒã€æˆ– bailout æ¡ä»¶åˆ¤æ–­ã€‚**

#### åˆ¤æ–­æœºåˆ¶ï¼ˆè¯¦è§ç¬¬ 5 é¢˜ï¼‰

**1. ç±»ç»„ä»¶ï¼šshouldComponentUpdate**

```javascript
class Component extends React.Component {
  shouldComponentUpdate(nextProps, nextState) {
    // è‡ªå®šä¹‰æ¯”è¾ƒé€»è¾‘
    return (
      this.props.value !== nextProps.value ||
      this.state.count !== nextState.count
    );
  }

  render() {
    return <div>{this.props.value}</div>;
  }
}
```

**2. PureComponentï¼šæµ…æ¯”è¾ƒ**

```javascript
class Component extends React.PureComponent {
  // è‡ªåŠ¨æµ…æ¯”è¾ƒpropså’Œstate
  // ç­‰ä»·äº
  shouldComponentUpdate(nextProps, nextState) {
    return (
      !shallowEqual(this.props, nextProps) ||
      !shallowEqual(this.state, nextState)
    );
  }

  render() {
    return <div>{this.props.value}</div>;
  }
}
```

**3. å‡½æ•°ç»„ä»¶ï¼šReact.memo**

```javascript
const Component = React.memo(
  function Component({ value }) {
    return <div>{value}</div>;
  },
  (prevProps, nextProps) => {
    // è¿”å›trueè¡¨ç¤ºä¸éœ€è¦æ›´æ–°
    return prevProps.value === nextProps.value;
  }
);
```

**4. Hooksï¼šbailout æ¡ä»¶**ï¼ˆè¯¦è§ç¬¬ 5 é¢˜ï¼‰

```javascript
// beginWorkä¸­çš„åˆ¤æ–­
function beginWork(current, workInProgress, renderLanes) {
  if (current !== null) {
    const oldProps = current.memoizedProps;
    const newProps = workInProgress.pendingProps;

    // å››ä¸ªbailoutæ¡ä»¶
    if (
      oldProps === newProps &&  // 1. propsæ²¡å˜
      !hasContextChanged() &&    // 2. contextæ²¡å˜
      !includesSomeLane(current.lanes, renderLanes) &&  // 3. æ²¡æœ‰update
      (workInProgress.flags & DidCapture) === NoFlags   // 4. æ²¡æœ‰é”™è¯¯
    ) {
      // bailoutï¼Œä¸render
      return bailoutOnAlreadyFinishedWork(...);
    }
  }

  // ç»§ç»­render
}
```

---

### 22. å¦‚ä½•ä¼˜åŒ–é•¿åˆ—è¡¨æ€§èƒ½ï¼Ÿ

**ç­”æ¡ˆï¼šè™šæ‹ŸåŒ–ã€åˆ†é¡µã€æ‡’åŠ è½½ã€memoã€key ä¼˜åŒ–ã€‚**

#### æ–¹æ¡ˆå¯¹æ¯”

**æ–¹æ¡ˆ 1ï¼šè™šæ‹ŸåŒ–ï¼ˆæœ€ä½³ï¼‰**

```javascript
import { FixedSizeList } from "react-window";

function LongList({ items }) {
  // åªæ¸²æŸ“å¯è§åŒºåŸŸçš„items
  const Row = ({ index, style }) => (
    <div style={style}>{items[index].text}</div>
  );

  return (
    <FixedSizeList
      height={600} // å®¹å™¨é«˜åº¦
      itemCount={items.length} // æ€»é¡¹æ•°ï¼š10000
      itemSize={50} // æ¯é¡¹é«˜åº¦
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
}

// æ€§èƒ½ï¼š
// - 10000ä¸ªitemsï¼Œåªæ¸²æŸ“~12ä¸ªï¼ˆå¯è§åŒºåŸŸï¼‰
// - æ»šåŠ¨æ—¶åŠ¨æ€æ¸²æŸ“
// - æå¤§æå‡æ€§èƒ½
```

**æ–¹æ¡ˆ 2ï¼šåˆ†é¡µ**

```javascript
function PaginatedList({ items }) {
  const [page, setPage] = useState(1);
  const pageSize = 20;

  const currentItems = useMemo(() => {
    const start = (page - 1) * pageSize;
    return items.slice(start, start + pageSize);
  }, [items, page]);

  return (
    <>
      <ul>
        {currentItems.map((item) => (
          <li key={item.id}>{item.text}</li>
        ))}
      </ul>

      <button onClick={() => setPage((p) => p - 1)} disabled={page === 1}>
        Previous
      </button>
      <button onClick={() => setPage((p) => p + 1)}>Next</button>
    </>
  );
}
```

**æ–¹æ¡ˆ 3ï¼šæ— é™æ»šåŠ¨ï¼ˆæ‡’åŠ è½½ï¼‰**

```javascript
function InfiniteList() {
  const [items, setItems] = useState([]);
  const [page, setPage] = useState(1);
  const loaderRef = useRef();

  // åŠ è½½æ›´å¤šæ•°æ®
  const loadMore = useCallback(async () => {
    const newItems = await fetchPage(page);
    setItems((prev) => [...prev, ...newItems]);
    setPage((p) => p + 1);
  }, [page]);

  // Intersection Observer
  useEffect(() => {
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadMore();
      }
    });

    if (loaderRef.current) {
      observer.observe(loaderRef.current);
    }

    return () => observer.disconnect();
  }, [loadMore]);

  return (
    <>
      <ul>
        {items.map((item) => (
          <li key={item.id}>{item.text}</li>
        ))}
      </ul>
      <div ref={loaderRef}>Loading more...</div>
    </>
  );
}
```

**æ–¹æ¡ˆ 4ï¼šmemo + key ä¼˜åŒ–**

```javascript
// memoé¿å…ä¸å¿…è¦çš„render
const MemoItem = React.memo(function Item({ data }) {
  return <li>{data.text}</li>;
});

function List({ items }) {
  return (
    <ul>
      {items.map((item) => (
        <MemoItem
          key={item.id} // ç¨³å®šçš„key
          data={item}
        />
      ))}
    </ul>
  );
}
```

---

### 9. React å¦‚ä½•åˆ¤æ–­ä½•æ—¶é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Ÿï¼ˆè¡¥å……ï¼‰

å·²åœ¨å‰é¢ç¬¬ 9 é¢˜å›ç­”ï¼Œè¿™é‡Œè¡¥å……å®æˆ˜æŠ€å·§ï¼š

**ç›‘æ§ç»„ä»¶ render çš„æŠ€å·§**ï¼š

```javascript
// æ–¹æ³•1ï¼šè‡ªå®šä¹‰Hook
function useWhyDidYouUpdate(name, props) {
  const previousProps = useRef();

  useEffect(() => {
    if (previousProps.current) {
      const allKeys = Object.keys({ ...previousProps.current, ...props });
      const changedProps = {};

      allKeys.forEach((key) => {
        if (previousProps.current[key] !== props[key]) {
          changedProps[key] = {
            from: previousProps.current[key],
            to: props[key],
          };
        }
      });

      if (Object.keys(changedProps).length > 0) {
        console.log("[why-did-you-update]", name, changedProps);
      }
    }

    previousProps.current = props;
  });
}

// ä½¿ç”¨
function MyComponent(props) {
  useWhyDidYouUpdate("MyComponent", props);
  return <div>{props.value}</div>;
}

// æ–¹æ³•2ï¼šReact DevTools Profiler
// å½•åˆ¶æ€§èƒ½ï¼ŒæŸ¥çœ‹æ¯ä¸ªç»„ä»¶ä¸ºä»€ä¹ˆrender
```

---

## ğŸ¯ 30 é“å¸¸è§é¢è¯•é¢˜æ€»ç»“

### å·²å›ç­”çš„é¢˜ç›®ï¼ˆ16 é¢˜ï¼‰

âœ… 1. setState æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥  
âœ… 2. ä¸ºä»€ä¹ˆå¤šæ¬¡ setState åª render ä¸€æ¬¡  
âœ… 3. å‡½æ•°å¼ setState å’Œç›´æ¥ä¼ å€¼çš„åŒºåˆ«  
âœ… 4. setState åå¦‚ä½•ç«‹å³è·å–å€¼  
âœ… 5. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä¿®æ”¹ state  
âœ… 6. ç»„ä»¶ä»€ä¹ˆæ—¶å€™é‡æ–°æ¸²æŸ“  
âœ… 7. çˆ¶ç»„ä»¶ render å­ç»„ä»¶ä¸€å®š render å—  
âœ… 8. å¦‚ä½•é¿å…ä¸å¿…è¦çš„æ¸²æŸ“  
âœ… 9. React å¦‚ä½•åˆ¤æ–­ä½•æ—¶é‡æ–°æ¸²æŸ“  
âœ… 10. è™šæ‹Ÿ DOM ä¸€å®šæ¯”çœŸå® DOM å¿«å—  
âœ… 11. useEffect å’Œ useLayoutEffect çš„åŒºåˆ«  
âœ… 12. useEffect ä¾èµ–æ•°ç»„ä¸ºç©ºä¼šæ€æ ·  
âœ… 13. useEffect çš„ cleanup ä½•æ—¶æ‰§è¡Œ  
âœ… 14. ä¸ºä»€ä¹ˆ Hook å¿…é¡»åœ¨é¡¶å±‚  
âœ… 15. è‡ªå®šä¹‰ Hook æœ‰ä»€ä¹ˆé™åˆ¶  
âœ… 16. useCallback å’Œ useMemo ä»€ä¹ˆæ—¶å€™ç”¨

âœ… 17. React äº‹ä»¶å’ŒåŸç”Ÿäº‹ä»¶çš„åŒºåˆ«  
âœ… 19. å¦‚ä½•é˜»æ­¢äº‹ä»¶å†’æ³¡  
âœ… 20. React.memo æœ‰ä»€ä¹ˆç”¨  
âœ… 21. key çš„ä½œç”¨ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç”¨ index  
âœ… 22. å¦‚ä½•ä¼˜åŒ–é•¿åˆ—è¡¨æ€§èƒ½  
âœ… 23. ä»€ä¹ˆæ˜¯ React çš„æ‰¹å¤„ç†  
âœ… 24. å¦‚ä½•é¿å…å†…è”å‡½æ•°å’Œå¯¹è±¡  
âœ… 25. ref çš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯  
âœ… 26. React 19 ä¸­ ref çš„æ–°ç‰¹æ€§ï¼ˆä¸å†éœ€è¦ forwardRefï¼‰  
âœ… 27. Context å¦‚ä½•å·¥ä½œ  
âœ… 28. ç»„ä»¶é€šä¿¡æœ‰å“ªäº›æ–¹å¼  
âœ… 29. ErrorBoundary çš„åŸç†å’Œä½¿ç”¨  
âœ… 30. React å¼€å‘æœ€ä½³å®è·µ

### å…¨éƒ¨é¢˜ç›®å·²å®Œæˆï¼

**æ­å–œï¼** 30 é“ React å¸¸è§é¢è¯•é¢˜å…¨éƒ¨å®Œæˆï¼Œç»“åˆå‰é¢ 20 é“åº•å±‚åŸç†é¢˜ï¼Œä½ ç°åœ¨æ‹¥æœ‰ï¼š

- âœ… 20 é“åº•å±‚åŸç†æ·±åº¦åˆ†æï¼ˆçº¦ 30 ä¸‡å­—ï¼‰
- âœ… 30 é“å¸¸è§é—®é¢˜å®æˆ˜è§£ç­”ï¼ˆçº¦ 8.5 ä¸‡å­—ï¼‰
- âœ… æ€»è®¡ 50 é“ React é¢è¯•é¢˜
- âœ… å®Œæ•´çš„ç†è®º+å®æˆ˜çŸ¥è¯†ä½“ç³»

**è¿™äº›å†…å®¹è¶³å¤Ÿåº”å¯¹ä»åˆçº§åˆ°èµ„æ·±çš„æ‰€æœ‰ React é¢è¯•ï¼**

---

## ğŸ“– ä½¿ç”¨å»ºè®®

**å­¦ä¹ è·¯å¾„**ï¼š

1. **å…ˆå­¦åº•å±‚åŸç†**ï¼ˆ20 é¢˜ï¼‰ï¼šæ‰“å¥½ç†è®ºåŸºç¡€
2. **å†çœ‹å¸¸è§é—®é¢˜**ï¼ˆ30 é¢˜ï¼‰ï¼šç†è§£å®æˆ˜åº”ç”¨
3. **ç»“åˆç»ƒä¹ **ï¼šåŠ¨æ‰‹éªŒè¯è¿™äº›çŸ¥è¯†ç‚¹
4. **é¢è¯•å‡†å¤‡**ï¼šé‡ç‚¹å¤ä¹ é«˜é¢‘é¢˜ç›®

**é«˜é¢‘é¢˜ç›® Top 10**ï¼š

1. â­â­â­ setState æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥
2. â­â­â­ Hook å¿…é¡»åœ¨é¡¶å±‚è°ƒç”¨çš„åŸå› 
3. â­â­â­ useEffect å’Œ useLayoutEffect åŒºåˆ«
4. â­â­â­ React.memo å’Œ useMemo çš„ä½¿ç”¨
5. â­â­â­ key çš„ä½œç”¨å’Œä¸èƒ½ç”¨ index çš„åŸå› 
6. â­â­ å‡½æ•°å¼ setState çš„å¿…è¦æ€§
7. â­â­ è™šæ‹Ÿ DOM çš„ä¼˜åŠ¿
8. â­â­ Context çš„æ€§èƒ½ä¼˜åŒ–
9. â­â­ é•¿åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–
10. â­â­ ErrorBoundary çš„ä½¿ç”¨

---

**ç‰ˆæœ¬ä¿¡æ¯**:

- **æœ€åæ›´æ–°**: 2025-11-07
- **React ç‰ˆæœ¬**: React 19.x
- **é‡è¦å˜åŒ–**: React 19 ä¸­ ref å¯ä½œä¸ºæ™®é€š prop ä½¿ç”¨ï¼Œä¸å†å¼ºåˆ¶éœ€è¦ forwardRef
