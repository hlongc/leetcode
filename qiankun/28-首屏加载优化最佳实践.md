# é—®é¢˜28ï¼šå¦‚ä½•ä¼˜åŒ– qiankun åº”ç”¨çš„é¦–å±åŠ è½½é€Ÿåº¦ï¼Ÿæœ‰å“ªäº›æœ€ä½³å®è·µï¼Ÿ

## ğŸ“Œ é¦–å±åŠ è½½çš„å…³é”®è·¯å¾„

```
ç”¨æˆ·è®¿é—® â†’ åŠ è½½ä¸»åº”ç”¨ â†’ åŒ¹é…è·¯ç”± â†’ åŠ è½½å­åº”ç”¨ â†’ æ¸²æŸ“å±•ç¤º
           (200ms)      (10ms)    (800ms)      (100ms)
                                   
æ€»è€—æ—¶ = ä¸»åº”ç”¨ + è·¯ç”±åŒ¹é… + å­åº”ç”¨ + æ¸²æŸ“
       â‰ˆ 1110ms

ä¼˜åŒ–ç›®æ ‡ï¼š< 1000msï¼ˆç†æƒ³ï¼‰, < 1500msï¼ˆå¯æ¥å—ï¼‰
```

## ğŸ¯ ä¼˜åŒ–ç­–ç•¥

### 1. ä¸»åº”ç”¨ä¼˜åŒ–

#### 1.1 å‡å°‘ä¸»åº”ç”¨ä½“ç§¯

```javascript
// âŒ ä¸»åº”ç”¨åŒ…å«å¤§é‡ä¸šåŠ¡ä»£ç 
import React from 'react';
import ReactDOM from 'react-dom';
import { BrowserRouter } from 'react-router-dom';
import { ConfigProvider } from 'antd';  // å®Œæ•´çš„ Ant Design
import 'antd/dist/antd.css';  // å®Œæ•´çš„æ ·å¼
import Dashboard from './pages/Dashboard';  // å¤§é‡é¡µé¢
import UserCenter from './pages/UserCenter';
// ... å¾ˆå¤šå¯¼å…¥

// ä¸»åº”ç”¨ä½“ç§¯ï¼š500KB+

// âœ… ä¸»åº”ç”¨åªä¿ç•™å¿…è¦ä»£ç 
import React from 'react';
import ReactDOM from 'react-dom';
import { registerMicroApps, start } from 'qiankun';

// ä¸»åº”ç”¨ä½“ç§¯ï¼š< 100KB

// ä¸šåŠ¡é€»è¾‘éƒ½åœ¨å­åº”ç”¨ä¸­
registerMicroApps([
    { name: 'dashboard', entry: '//localhost:8080', ... },
    { name: 'user', entry: '//localhost:8081', ... }
]);
```

#### 1.2 æŒ‰éœ€åŠ è½½ç»„ä»¶

```javascript
// ä½¿ç”¨ React.lazy
const Header = React.lazy(() => import('./components/Header'));
const Sidebar = React.lazy(() => import('./components/Sidebar'));

function MainApp() {
    return (
        <Suspense fallback={<Loading />}>
            <Header />
            <Sidebar />
            <div id="subapp-container" />
        </Suspense>
    );
}
```

#### 1.3 CDN åŠ é€Ÿ

```javascript
// webpack é…ç½®ï¼šexternals
module.exports = {
    externals: {
        'react': 'React',
        'react-dom': 'ReactDOM',
        'qiankun': 'qiankun'
    }
};

// HTML ä¸­ä½¿ç”¨ CDN
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qiankun@2/dist/index.min.js"></script>
```

### 2. å­åº”ç”¨ä¼˜åŒ–

#### 2.1 ä»£ç åˆ†å‰²

```javascript
// webpack é…ç½®
module.exports = {
    optimization: {
        splitChunks: {
            chunks: 'all',
            cacheGroups: {
                // ç¬¬ä¸‰æ–¹åº“å•ç‹¬æ‰“åŒ…
                vendor: {
                    test: /[\\/]node_modules[\\/]/,
                    name: 'vendors',
                    priority: 10
                },
                // å…¬å…±ä»£ç 
                common: {
                    minChunks: 2,
                    name: 'common',
                    priority: 5
                }
            }
        }
    }
};

// ç»“æœï¼š
// vendors.js (300KB) - ç¬¬ä¸‰æ–¹åº“ï¼Œå¯ä»¥è·¨åº”ç”¨ç¼“å­˜
// common.js (50KB)   - å…¬å…±ä»£ç 
// main.js (100KB)    - åº”ç”¨ä»£ç 
```

#### 2.2 è·¯ç”±æ‡’åŠ è½½

```javascript
// React åº”ç”¨çš„è·¯ç”±æ‡’åŠ è½½
import { lazy, Suspense } from 'react';

const Home = lazy(() => import('./pages/Home'));
const About = lazy(() => import('./pages/About'));
const User = lazy(() => import('./pages/User'));

function App() {
    return (
        <Suspense fallback={<Loading />}>
            <Routes>
                <Route path="/" element={<Home />} />
                <Route path="/about" element={<About />} />
                <Route path="/user" element={<User />} />
            </Routes>
        </Suspense>
    );
}

// é¦–å±åªåŠ è½½ Homeï¼Œå…¶ä»–é¡µé¢æŒ‰éœ€åŠ è½½
```

#### 2.3 èµ„æºå‹ç¼©

```javascript
// webpack é…ç½®
const TerserPlugin = require('terser-webpack-plugin');
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin');

module.exports = {
    mode: 'production',
    optimization: {
        minimize: true,
        minimizer: [
            new TerserPlugin({
                terserOptions: {
                    compress: {
                        drop_console: true,  // ç§»é™¤ console
                        pure_funcs: ['console.log']
                    }
                }
            }),
            new CssMinimizerPlugin()
        ]
    }
};
```

### 3. é¢„åŠ è½½ç­–ç•¥

#### 3.1 å…³é”®åº”ç”¨é¢„åŠ è½½

```javascript
start({
    prefetch: (apps) => {
        // åˆ†æç”¨æˆ·è§’è‰²ï¼Œé¢„åŠ è½½å¯èƒ½è®¿é—®çš„åº”ç”¨
        const userRole = getUserRole();
        
        if (userRole === 'admin') {
            return {
                criticalAppNames: ['admin-dashboard', 'user-management'],
                minorAppsName: ['system-settings']
            };
        } else {
            return {
                criticalAppNames: ['home', 'profile'],
                minorAppsName: ['settings']
            };
        }
    }
});
```

#### 3.2 Link prefetch

```html
<!-- åœ¨ä¸»åº”ç”¨ HTML ä¸­æ·»åŠ  prefetch -->
<link rel="prefetch" href="http://localhost:8080/index.html">
<link rel="prefetch" href="http://localhost:8080/main.js">
<link rel="prefetch" href="http://localhost:8080/vendors.js">
```

### 4. ç¼“å­˜ç­–ç•¥

#### 4.1 å¼ºç¼“å­˜

```javascript
// æœåŠ¡å™¨é…ç½®ï¼ˆNginxï¼‰
location ~* \.(js|css)$ {
    expires 1y;  # å¼ºç¼“å­˜1å¹´
    add_header Cache-Control "public, immutable";
}

location ~ /index\.html$ {
    add_header Cache-Control "no-cache";  # HTML ä¸ç¼“å­˜
}

// webpack æ–‡ä»¶ååŠ  hash
output: {
    filename: '[name].[contenthash:8].js',
    chunkFilename: '[name].[contenthash:8].chunk.js'
}
```

#### 4.2 Service Worker

```javascript
// sw.js
const CACHE_NAME = 'qiankun-apps-v1';
const urlsToCache = [
    '/',
    '/main.js',
    '/vendors.js',
    'http://localhost:8080/index.html',
    'http://localhost:8080/main.js',
];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then((cache) => cache.addAll(urlsToCache))
    );
});

self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request)
            .then((response) => response || fetch(event.request))
    );
});
```

### 5. åŠ è½½ä¼˜åŒ–

#### 5.1 å¹¶è¡ŒåŠ è½½

```javascript
// âŒ ä¸²è¡ŒåŠ è½½
const { template } = await importEntry(entry);
container.innerHTML = template;
const { execScripts } = await importEntry(entry);
await execScripts();

// âœ… å¹¶è¡ŒåŠ è½½
const entryPromise = importEntry(entry);
const [{ template }, { execScripts }] = await Promise.all([
    entryPromise,
    entryPromise
]);
container.innerHTML = template;
await execScripts();
```

#### 5.2 HTML å†…è”å…³é”®èµ„æº

```html
<!-- å­åº”ç”¨çš„ index.html -->
<!DOCTYPE html>
<html>
<head>
    <!-- â­ å†…è”å…³é”® CSS -->
    <style>
        /* é¦–å±å¿…éœ€çš„æ ·å¼ */
        .loading { /* ... */ }
        .container { /* ... */ }
    </style>
    
    <!-- å…¶ä»– CSS å¼‚æ­¥åŠ è½½ -->
    <link rel="preload" href="./main.css" as="style" onload="this.rel='stylesheet'">
</head>
<body>
    <div id="root"></div>
    
    <!-- â­ å†…è”å…³é”® JS -->
    <script>
        // é¦–å±å¿…éœ€çš„åˆå§‹åŒ–ä»£ç 
        window.APP_CONFIG = { /* ... */ };
    </script>
    
    <!-- ä¸»è¦ JS -->
    <script src="./main.js"></script>
</body>
</html>
```

### 6. æ¸²æŸ“ä¼˜åŒ–

#### 6.1 éª¨æ¶å±

```javascript
// ä¸»åº”ç”¨æä¾›éª¨æ¶å±
registerMicroApps([
    {
        name: 'react-app',
        entry: '//localhost:8080',
        container: '#subapp-container',
        activeRule: '/react-app',
        loader: (loading) => {
            const container = document.querySelector('#subapp-container');
            if (loading) {
                // â­ æ˜¾ç¤ºéª¨æ¶å±
                container.innerHTML = `
                    <div class="skeleton">
                        <div class="skeleton-header"></div>
                        <div class="skeleton-content"></div>
                        <div class="skeleton-footer"></div>
                    </div>
                `;
            }
        }
    }
]);
```

#### 6.2 é¦–å±æ•°æ®é¢„å–

```javascript
// åœ¨åŠ è½½åº”ç”¨å‰ï¼Œé¢„å–æ•°æ®

registerMicroApps(apps, {
    beforeLoad: async (app) => {
        // â­ é¢„å–é¦–å±æ•°æ®
        const data = await fetchAppData(app.name);
        
        // æ³¨å…¥åˆ°æ²™ç®±
        app.props = {
            ...app.props,
            initialData: data
        };
    }
});
```

### 7. æ€§èƒ½ç›‘æ§

```javascript
// ç›‘æ§å„é˜¶æ®µè€—æ—¶

const performanceMonitor = {
    marks: {},
    
    start(name) {
        this.marks[name] = Date.now();
    },
    
    end(name) {
        const duration = Date.now() - this.marks[name];
        console.log(`${name}: ${duration}ms`);
        
        // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
        reportMetric(name, duration);
        
        return duration;
    }
};

// ä½¿ç”¨
registerMicroApps(apps, {
    beforeLoad: (app) => {
        performanceMonitor.start(`${app.name}-load`);
    },
    afterMount: (app) => {
        performanceMonitor.end(`${app.name}-load`);
    }
});
```

## ğŸ“ é¢è¯•è¦ç‚¹

### ä¼˜åŒ–ç»´åº¦

1. **ä¸»åº”ç”¨**ï¼šå‡å°‘ä½“ç§¯ã€æŒ‰éœ€åŠ è½½ã€CDN
2. **å­åº”ç”¨**ï¼šä»£ç åˆ†å‰²ã€è·¯ç”±æ‡’åŠ è½½ã€å‹ç¼©
3. **é¢„åŠ è½½**ï¼šæ™ºèƒ½é¢„åŠ è½½ã€ä¼˜å…ˆçº§é˜Ÿåˆ—
4. **ç¼“å­˜**ï¼šå¼ºç¼“å­˜ã€Service Worker
5. **åŠ è½½**ï¼šå¹¶è¡ŒåŠ è½½ã€èµ„æºå†…è”
6. **æ¸²æŸ“**ï¼šéª¨æ¶å±ã€æ•°æ®é¢„å–

### å…³é”®æŒ‡æ ‡

1. **FCP**ï¼ˆFirst Contentful Paintï¼‰ï¼šé¦–æ¬¡å†…å®¹ç»˜åˆ¶
2. **LCP**ï¼ˆLargest Contentful Paintï¼‰ï¼šæœ€å¤§å†…å®¹ç»˜åˆ¶
3. **TTI**ï¼ˆTime to Interactiveï¼‰ï¼šå¯äº¤äº’æ—¶é—´
4. **TBT**ï¼ˆTotal Blocking Timeï¼‰ï¼šæ€»é˜»å¡æ—¶é—´

### æœ€ä½³å®è·µ

1. **ä¸»åº”ç”¨è½»é‡åŒ–**ï¼šåªåŒ…å«æ¡†æ¶ä»£ç 
2. **æ‡’åŠ è½½**ï¼šéé¦–å±å†…å®¹æŒ‰éœ€åŠ è½½
3. **é¢„åŠ è½½**ï¼šæ™ºèƒ½é¢„æµ‹ç”¨æˆ·è¡Œä¸º
4. **ç¼“å­˜**ï¼šåˆç†çš„ç¼“å­˜ç­–ç•¥
5. **ç›‘æ§**ï¼šæŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

```
ä¼˜åŒ–å‰ï¼š
ä¸»åº”ç”¨åŠ è½½ï¼š500ms
å­åº”ç”¨ä¸‹è½½ï¼š600ms
å­åº”ç”¨æ‰§è¡Œï¼š200ms
é¦–å±æ¸²æŸ“ï¼š100ms
æ€»è®¡ï¼š1400ms

ä¼˜åŒ–åï¼š
ä¸»åº”ç”¨åŠ è½½ï¼š150msï¼ˆCDN + å‡å°ä½“ç§¯ï¼‰
å­åº”ç”¨ä¸‹è½½ï¼š200msï¼ˆä»£ç åˆ†å‰² + é¢„åŠ è½½å‘½ä¸­ç¼“å­˜ï¼‰
å­åº”ç”¨æ‰§è¡Œï¼š100msï¼ˆå‡å°ä»£ç é‡ï¼‰
é¦–å±æ¸²æŸ“ï¼š50msï¼ˆéª¨æ¶å±ï¼‰
æ€»è®¡ï¼š500ms

æå‡ï¼š64%
```

æŒç»­çš„æ€§èƒ½ä¼˜åŒ–æ˜¯æå‡ç”¨æˆ·ä½“éªŒçš„å…³é”®ï¼

