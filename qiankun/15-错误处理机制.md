# é—®é¢˜15ï¼šå½“å­åº”ç”¨åŠ è½½å¤±è´¥æ—¶ï¼Œqiankun çš„é”™è¯¯å¤„ç†æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿå¦‚ä½•è‡ªå®šä¹‰é”™è¯¯å¤„ç†ï¼Ÿ

## ğŸ“Œ qiankun çš„é”™è¯¯å¤„ç†å±‚çº§

qiankun çš„é”™è¯¯å¤„ç†åˆ†ä¸ºå¤šä¸ªå±‚çº§ï¼š

1. **èµ„æºåŠ è½½é”™è¯¯**ï¼ˆHTML/JS/CSS ä¸‹è½½å¤±è´¥ï¼‰
2. **è„šæœ¬æ‰§è¡Œé”™è¯¯**ï¼ˆJS è¿è¡Œæ—¶é”™è¯¯ï¼‰
3. **ç”Ÿå‘½å‘¨æœŸé”™è¯¯**ï¼ˆbootstrap/mount/unmount é”™è¯¯ï¼‰
4. **è·¯ç”±åŒ¹é…é”™è¯¯**ï¼ˆåº”ç”¨é…ç½®é”™è¯¯ï¼‰

## ğŸ¯ QiankunError ç±»

```typescript
// packages/qiankun/src/error.ts
export class QiankunError extends Error {
    constructor(message: string) {
        super(`[qiankun]: ${message}`);
    }
}
```

**ä½œç”¨ï¼š** ç»Ÿä¸€çš„é”™è¯¯ç±»ï¼Œæ‰€æœ‰ qiankun æŠ›å‡ºçš„é”™è¯¯éƒ½ä¼šå¸¦ä¸Š `[qiankun]:` å‰ç¼€ï¼Œä¾¿äºè¯†åˆ«ã€‚

## ğŸ” å„å±‚çº§çš„é”™è¯¯å¤„ç†

### 1. èµ„æºåŠ è½½é”™è¯¯

#### HTML åŠ è½½å¤±è´¥

```typescript
// packages/qiankun/src/core/loadApp.ts: 95
const lifecyclesPromise = loadEntry<MicroAppLifeCycles>(entry, microAppDOMContainer, containerOpts);

// å¦‚æœ HTML åŠ è½½å¤±è´¥ï¼ŒloadEntry ä¼šæŠ›å‡ºé”™è¯¯
// packages/loader/src/index.ts: 183
throw new QiankunError(`The response body of entry ${entryUrl} is empty!`);
```

**é”™è¯¯ç¤ºä¾‹ï¼š**

```javascript
// åœºæ™¯1: å…¥å£ URL ä¸å­˜åœ¨
registerMicroApps([
    {
        name: 'app1',
        entry: 'http://localhost:8080/notfound.html',  // 404
        container: '#container',
        activeRule: '/app1'
    }
]);

// é”™è¯¯ä¿¡æ¯:
// [qiankun]: The response body of entry http://localhost:8080/notfound.html is empty!

// åœºæ™¯2: ç½‘ç»œé”™è¯¯
// Failed to fetch

// åœºæ™¯3: CORS é”™è¯¯
// Access to fetch at '...' has been blocked by CORS policy
```

#### JS/CSS åŠ è½½å¤±è´¥

```javascript
// import-html-entry çš„é”™è¯¯å¤„ç†
// src/index.js: 126-144
const fetchScript = (scriptUrl, opts) => scriptCache[scriptUrl] ||
    (scriptCache[scriptUrl] = fetch(scriptUrl, opts).then(response => {
        if (response.status >= 400) {
            throw new Error(`${scriptUrl} load failed with status ${response.status}`);
        }
        return response.text();
    }).catch(e => {
        try {
            if (e.message.indexOf(scriptUrl) === -1) {
                e.message = `${scriptUrl} ${e.message}`;
            }
        } catch (_) {
            // e.message å¯èƒ½æ˜¯ readonly
        }
        throw e;
    }));
```

**é”™è¯¯å¤„ç†ç‰¹ç‚¹ï¼š**

1. **è®°å½• URL**ï¼šé”™è¯¯ä¿¡æ¯åŒ…å«å…·ä½“çš„èµ„æº URL
2. **ä¸é˜»å¡å…¶ä»–èµ„æº**ï¼šæŸä¸ªè„šæœ¬å¤±è´¥ï¼Œå…¶ä»–è„šæœ¬ç»§ç»­åŠ è½½
3. **entry è„šæœ¬ç‰¹æ®Š**ï¼šentry è„šæœ¬å¤±è´¥ä¼šä¸­æ–­æ•´ä¸ªæµç¨‹

```javascript
// src/index.js: 146-147
const shouldBreakWhileError = (i) => scripts[i] === entry;
return allSettledButCanBreak(scripts.map(async script => {
    // ...
}), shouldBreakWhileError)
```

### 2. è„šæœ¬æ‰§è¡Œé”™è¯¯

#### æ™®é€šè„šæœ¬é”™è¯¯ï¼ˆä¸é˜»å¡ï¼‰

```javascript
// src/index.js: 258-268
else {
    if (typeof inlineScript === 'string') {
        try {
            if (scriptSrc?.src) {
                geval(scriptSrc.src, inlineScript);
            } else {
                geval(scriptSrc, inlineScript);
            }
        } catch (e) {
            // â­ éé˜»å¡é”™è¯¯ï¼šä½¿ç”¨ setTimeout æŠ›å‡º
            throwNonBlockingError(e, `[import-html-entry]: error occurs while executing normal script ${scriptSrc}`);
        }
    }
}
```

**throwNonBlockingError å®ç°ï¼š**

```javascript
// src/index.js: 193-198
function throwNonBlockingError(error, msg) {
    setTimeout(() => {
        console.error(msg);
        throw error;
    });
}
```

**ä¸ºä»€ä¹ˆç”¨ setTimeoutï¼Ÿ**

```javascript
// ä¸ç”¨ setTimeoutï¼ˆåŒæ­¥æŠ›å‡ºï¼‰
throw error;  // âŒ ä¼šä¸­æ–­åç»­è„šæœ¬æ‰§è¡Œ

// ä½¿ç”¨ setTimeoutï¼ˆå¼‚æ­¥æŠ›å‡ºï¼‰
setTimeout(() => {
    throw error;  // âœ“ ä¸é˜»å¡åç»­è„šæœ¬ï¼Œä½†é”™è¯¯ä»ä¼šè¢«æŠ›å‡º
});

// æ•ˆæœï¼š
// 1. é”™è¯¯ä¼šåœ¨æ§åˆ¶å°æ˜¾ç¤º
// 2. å¯ä»¥è¢« window.onerror æ•è·
// 3. ä¸é˜»å¡åç»­ä»£ç æ‰§è¡Œ
```

#### entry è„šæœ¬é”™è¯¯ï¼ˆä¸­æ–­æµç¨‹ï¼‰

```javascript
// src/index.js: 245-256
if (scriptSrc === entry) {
    noteGlobalProps(strictGlobal ? proxy : window);

    try {
        geval(scriptSrc, inlineScript);
        const exports = proxy[getGlobalProp(strictGlobal ? proxy : window)] || {};
        resolve(exports);
    } catch (e) {
        // â­ entry é”™è¯¯å¿…é¡»æŠ›å‡º
        console.error(`[import-html-entry]: error occurs while executing entry script ${scriptSrc}`);
        throw e;
    }
}
```

### 3. ç”Ÿå‘½å‘¨æœŸé”™è¯¯

#### loadApp ä¸­çš„é”™è¯¯å¤„ç†

```typescript
// packages/qiankun/src/core/loadApp.ts: 110-111
const lifecycles = await lifecyclesPromise;
if (!lifecycles) {
    throw new QiankunError(`${appName} entry ${entry} load failed as it not export lifecycles`);
}
```

**å¸¸è§é”™è¯¯ï¼š**

```javascript
// é”™è¯¯1: æ²¡æœ‰å¯¼å‡ºç”Ÿå‘½å‘¨æœŸ
// å­åº”ç”¨å¿˜è®°å¯¼å‡º bootstrap/mount/unmount

// é”™è¯¯ä¿¡æ¯:
// [qiankun]: reactApp entry http://localhost:8080 load failed as it not export lifecycles

// é”™è¯¯2: ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸æ­£ç¡®
// å¯¼å‡ºçš„ä¸æ˜¯å‡½æ•°

// é”™è¯¯ä¿¡æ¯:
// [qiankun]: You need to export lifecycle functions in reactApp entry as neither globalLatestSetProp undefined nor window['reactApp'] export correctly
```

#### ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œé”™è¯¯

```typescript
// packages/qiankun/src/core/loadApp.ts: 127-169
mount: [
    async () => { /* ... */ },
    async () => {
        microAppDOMContainer = mountContainer;
        
        if (mountTimes > 1) {
            initContainer(mountContainer, appName, { sandboxCfg: sandbox, mountTimes, instanceId });
            const htmlString = await getPureHTMLStringWithoutScripts(entry, enhancedFetch);
            await loadEntry(
                { url: entry, res: new Response(htmlString, { status: 200, statusText: 'OK' }) },
                mountContainer,
                containerOpts,
            );
        }
    },
    async () => {
        await mountSandbox(mountContainer);
    },
    async () => execHooksChain(toArray(beforeMount), app, global),
    // â­ å­åº”ç”¨ mount æ‰§è¡Œï¼Œé”™è¯¯ä¼šå‘ä¸Šä¼ æ’­
    async (props) => mount({ ...props, container: mountContainer }),
    async () => execHooksChain(toArray(afterMount), app, global),
]
```

**é”™è¯¯ä¼šå‘ä¸Šä¼ æ’­åˆ° single-spaï¼š**

```javascript
// single-spa ä¼šæ•è·ç”Ÿå‘½å‘¨æœŸé”™è¯¯
try {
    await app.mount();
} catch (error) {
    // single-spa å°†åº”ç”¨çŠ¶æ€æ ‡è®°ä¸º LOAD_ERROR æˆ– SKIP_BECAUSE_BROKEN
    app.status = 'LOAD_ERROR';
    
    // è§¦å‘ single-spa çš„é”™è¯¯äº‹ä»¶
    window.dispatchEvent(new CustomEvent('single-spa:routing-event', {
        detail: { 
            type: 'error',
            appName: app.name,
            error 
        }
    }));
}
```

### 4. loader é”™è¯¯

#### å…¥å£è„šæœ¬åŠ è½½é”™è¯¯

```typescript
// packages/loader/src/index.ts: 124-149
if (isEntryScript(script)) {
    if (foundEntryScript) {
        throw new QiankunError(
            `You should not include more than 1 entry scripts in a single HTML entry ${entryUrl} !`,
        );
    }

    foundEntryScript = true;

    const onScriptComplete = (prevListener, event) => {
        script.onload = script.onerror = null;

        if (!entryScriptLoadedDeferred.isSettled()) {
            if (event.type === 'load') {
                onEntryLoaded();
            } else {
                // â­ entry è„šæœ¬åŠ è½½å¤±è´¥
                entryScriptLoadedDeferred.reject(
                    new QiankunError(
                        `Entry ${entryUrl} load failed as entry script ${script.dataset.src || script.src} load failed}`,
                    ),
                );
            }
        }

        prevListener?.call(script, event);
    };

    script.onload = onScriptComplete.bind(null, script.onload);
    script.onerror = onScriptComplete.bind(null, script.onerror);
}
```

## ğŸ¨ è‡ªå®šä¹‰é”™è¯¯å¤„ç†

### æ–¹æ¡ˆ1: å…¨å±€é”™è¯¯ç›‘å¬ï¼ˆæ¨èï¼‰

```javascript
// 1. ç›‘å¬ window.onerrorï¼ˆæ•è·æ‰€æœ‰ JS é”™è¯¯ï¼‰
window.addEventListener('error', (event) => {
    const { message, filename, lineno, colno, error } = event;
    
    // åˆ¤æ–­æ˜¯å¦æ˜¯ qiankun ç›¸å…³é”™è¯¯
    if (message.includes('[qiankun]') || message.includes('[import-html-entry]')) {
        console.error('qiankun é”™è¯¯:', {
            message,
            filename,
            line: lineno,
            column: colno,
            error
        });
        
        // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
        reportError({
            type: 'qiankun-error',
            message,
            filename,
            stack: error?.stack
        });
        
        // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
        showErrorNotification('åº”ç”¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
        
        // é˜»æ­¢é»˜è®¤é”™è¯¯å¤„ç†
        event.preventDefault();
    }
});

// 2. ç›‘å¬ Promise rejection
window.addEventListener('unhandledrejection', (event) => {
    const { reason } = event;
    
    if (reason instanceof Error && (
        reason.message.includes('[qiankun]') ||
        reason.message.includes('[import-html-entry]')
    )) {
        console.error('qiankun Promise é”™è¯¯:', reason);
        
        // å¤„ç†é”™è¯¯
        handleQiankunError(reason);
        
        // é˜»æ­¢é»˜è®¤å¤„ç†
        event.preventDefault();
    }
});
```

### æ–¹æ¡ˆ2: single-spa äº‹ä»¶ç›‘å¬

```javascript
// single-spa æä¾›çš„é”™è¯¯äº‹ä»¶
window.addEventListener('single-spa:routing-event', (event) => {
    const { detail } = event;
    
    if (detail.type === 'error') {
        console.error(`åº”ç”¨ ${detail.appName} å‘ç”Ÿé”™è¯¯:`, detail.error);
        
        // æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†
        if (detail.error.message.includes('load failed')) {
            // åŠ è½½å¤±è´¥
            showErrorUI(`åº”ç”¨ ${detail.appName} åŠ è½½å¤±è´¥`);
            
            // å°è¯•é‡æ–°åŠ è½½
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else if (detail.error.message.includes('export lifecycles')) {
            // ç”Ÿå‘½å‘¨æœŸé”™è¯¯
            showErrorUI(`åº”ç”¨ ${detail.appName} é…ç½®é”™è¯¯`);
        }
    }
});
```

### æ–¹æ¡ˆ3: ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­å¤„ç†

```javascript
registerMicroApps(
    [
        {
            name: 'app1',
            entry: 'http://localhost:8080',
            container: '#container',
            activeRule: '/app1'
        }
    ],
    {
        // â­ ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸé’©å­æ•è·é”™è¯¯
        beforeLoad: async (app) => {
            try {
                // æ‰§è¡ŒåŠ è½½å‰çš„æ£€æŸ¥
                await checkAppAvailability(app.entry);
            } catch (error) {
                console.error(`åº”ç”¨ ${app.name} ä¸å¯ç”¨:`, error);
                
                // æ˜¾ç¤ºé”™è¯¯é¡µé¢
                showErrorPage(app.name, 'åº”ç”¨ä¸å¯ç”¨');
                
                // é˜»æ­¢åŠ è½½
                throw new Error(`Stop loading ${app.name}`);
            }
        },
        
        beforeMount: async (app) => {
            // æŒ‚è½½å‰çš„å®¹é”™
            console.log(`æ­£åœ¨æŒ‚è½½ ${app.name}`);
        },
        
        afterMount: async (app) => {
            // æŒ‚è½½æˆåŠŸ
            console.log(`${app.name} æŒ‚è½½æˆåŠŸ`);
        }
    }
);
```

### æ–¹æ¡ˆ4: è‡ªå®šä¹‰ fetchï¼ˆæ‹¦æˆªèµ„æºåŠ è½½é”™è¯¯ï¼‰

```javascript
function createFetchWithErrorHandler(onError) {
    return async (url, opts) => {
        try {
            const response = await window.fetch(url, opts);
            
            if (!response.ok) {
                const error = new Error(`HTTP ${response.status}: ${response.statusText}`);
                error.url = url;
                error.status = response.status;
                
                // è°ƒç”¨é”™è¯¯å¤„ç†å™¨
                if (onError) {
                    onError(error);
                }
                
                throw error;
            }
            
            return response;
        } catch (error) {
            // ç½‘ç»œé”™è¯¯
            error.url = url;
            
            if (onError) {
                onError(error);
            }
            
            throw error;
        }
    };
}

// ä½¿ç”¨
const customFetch = createFetchWithErrorHandler((error) => {
    console.error('èµ„æºåŠ è½½å¤±è´¥:', error.url, error.message);
    
    // ä¸ŠæŠ¥é”™è¯¯
    reportError({
        type: 'resource-load-error',
        url: error.url,
        status: error.status,
        message: error.message
    });
    
    // æ˜¾ç¤ºæç¤º
    if (error.status === 404) {
        showNotification(`èµ„æºä¸å­˜åœ¨: ${error.url}`);
    } else if (error.status >= 500) {
        showNotification('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    }
});

start({
    fetch: customFetch
});
```

## ğŸ› ï¸ é”™è¯¯æ¢å¤ç­–ç•¥

### ç­–ç•¥1: è‡ªåŠ¨é‡è¯•

```javascript
class AppLoader {
    constructor(maxRetries = 3) {
        this.maxRetries = maxRetries;
        this.retryCount = new Map();
    }

    async loadApp(app) {
        const retries = this.retryCount.get(app.name) || 0;

        try {
            // å°è¯•åŠ è½½åº”ç”¨
            await loadMicroApp(app);
            
            // æˆåŠŸï¼Œé‡ç½®é‡è¯•è®¡æ•°
            this.retryCount.set(app.name, 0);
        } catch (error) {
            console.error(`åº”ç”¨ ${app.name} åŠ è½½å¤±è´¥ (${retries + 1}/${this.maxRetries}):`, error);

            if (retries < this.maxRetries) {
                // å¢åŠ é‡è¯•è®¡æ•°
                this.retryCount.set(app.name, retries + 1);

                // å»¶è¿Ÿåé‡è¯•
                const delay = Math.pow(2, retries) * 1000;  // æŒ‡æ•°é€€é¿
                console.log(`${delay}ms åé‡è¯•...`);
                
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // é€’å½’é‡è¯•
                return this.loadApp(app);
            } else {
                // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
                this.retryCount.set(app.name, 0);
                
                // æ˜¾ç¤ºé”™è¯¯é¡µé¢
                showErrorPage(app.name, 'åº”ç”¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                
                throw error;
            }
        }
    }
}

// ä½¿ç”¨
const loader = new AppLoader(3);

registerMicroApps([
    {
        name: 'app1',
        entry: 'http://localhost:8080',
        container: '#container',
        activeRule: '/app1',
        loader: (loading) => {
            if (loading) {
                showLoading();
            } else {
                hideLoading();
            }
        }
    }
]);

// æ‹¦æˆªåŠ è½½ï¼Œæ·»åŠ é‡è¯•é€»è¾‘
start();
```

### ç­–ç•¥2: é™çº§æ–¹æ¡ˆ

```javascript
// å®šä¹‰é™çº§ç­–ç•¥
const fallbackStrategies = {
    'app1': {
        primary: 'http://cdn1.example.com/app1',
        fallback: 'http://cdn2.example.com/app1',
        static: '/static/app1-fallback.html'
    }
};

async function loadAppWithFallback(app) {
    const strategy = fallbackStrategies[app.name];
    
    if (!strategy) {
        return loadMicroApp(app);
    }

    // å°è¯•ä¸» CDN
    try {
        return await loadMicroApp({
            ...app,
            entry: strategy.primary
        });
    } catch (primaryError) {
        console.warn(`ä¸» CDN åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ CDN`);

        // å°è¯•å¤‡ç”¨ CDN
        try {
            return await loadMicroApp({
                ...app,
                entry: strategy.fallback
            });
        } catch (fallbackError) {
            console.warn(`å¤‡ç”¨ CDN åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é™æ€é™çº§é¡µé¢`);

            // æœ€åçš„é™çº§ï¼šé™æ€é¡µé¢
            const container = document.querySelector(app.container);
            const response = await fetch(strategy.static);
            container.innerHTML = await response.text();
            
            return null;
        }
    }
}
```

### ç­–ç•¥3: é”™è¯¯è¾¹ç•Œç»„ä»¶

```javascript
// React é”™è¯¯è¾¹ç•Œ
class MicroAppErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
    }

    static getDerivedStateFromError(error) {
        return { hasError: true, error };
    }

    componentDidCatch(error, errorInfo) {
        console.error('å¾®åº”ç”¨é”™è¯¯:', error, errorInfo);
        
        // ä¸ŠæŠ¥é”™è¯¯
        reportError({
            type: 'micro-app-error',
            appName: this.props.appName,
            error: error.toString(),
            componentStack: errorInfo.componentStack
        });
    }

    handleRetry = () => {
        this.setState({ hasError: false, error: null });
        window.location.reload();
    };

    render() {
        if (this.state.hasError) {
            return (
                <div className="error-boundary">
                    <h2>åº”ç”¨ {this.props.appName} åŠ è½½å¤±è´¥</h2>
                    <p>{this.state.error?.message}</p>
                    <button onClick={this.handleRetry}>é‡è¯•</button>
                    <button onClick={() => window.history.back()}>è¿”å›</button>
                </div>
            );
        }

        return this.props.children;
    }
}

// ä½¿ç”¨
<MicroAppErrorBoundary appName="app1">
    <div id="subapp-container"></div>
</MicroAppErrorBoundary>
```

## ğŸ“ é¢è¯•è¦ç‚¹

### é”™è¯¯åˆ†ç±»

1. **èµ„æºåŠ è½½é”™è¯¯**ï¼šHTML/JS/CSS ä¸‹è½½å¤±è´¥
2. **è„šæœ¬æ‰§è¡Œé”™è¯¯**ï¼šJS è¿è¡Œæ—¶é”™è¯¯
3. **ç”Ÿå‘½å‘¨æœŸé”™è¯¯**ï¼šbootstrap/mount/unmount é”™è¯¯
4. **é…ç½®é”™è¯¯**ï¼šåº”ç”¨é…ç½®ä¸æ­£ç¡®

### é”™è¯¯å¤„ç†æœºåˆ¶

1. **QiankunError**: ç»Ÿä¸€çš„é”™è¯¯ç±»
2. **éé˜»å¡é”™è¯¯**ï¼šä½¿ç”¨ setTimeout å¼‚æ­¥æŠ›å‡º
3. **entry è„šæœ¬ç‰¹æ®Š**ï¼šå¤±è´¥ä¼šä¸­æ–­æµç¨‹
4. **é”™è¯¯ä¼ æ’­**ï¼šå‘ä¸Šä¼ æ’­åˆ° single-spa

### è‡ªå®šä¹‰å¤„ç†

1. **å…¨å±€ç›‘å¬**ï¼šwindow.onerrorã€unhandledrejection
2. **single-spa äº‹ä»¶**ï¼šrouting-event
3. **ç”Ÿå‘½å‘¨æœŸé’©å­**ï¼šbeforeLoad ä¸­æ‹¦æˆª
4. **è‡ªå®šä¹‰ fetch**ï¼šæ‹¦æˆªèµ„æºåŠ è½½é”™è¯¯

### é”™è¯¯æ¢å¤

1. **è‡ªåŠ¨é‡è¯•**ï¼šæŒ‡æ•°é€€é¿ç­–ç•¥
2. **é™çº§æ–¹æ¡ˆ**ï¼šå¤š CDN + é™æ€é¡µé¢
3. **é”™è¯¯è¾¹ç•Œ**ï¼šéš”ç¦»é”™è¯¯å½±å“èŒƒå›´
4. **å‹å¥½æç¤º**ï¼šç»™ç”¨æˆ·æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®Œå–„çš„é”™è¯¯ç›‘æ§

```javascript
// ç»Ÿä¸€çš„é”™è¯¯ä¸ŠæŠ¥
function setupErrorMonitoring() {
    // JS é”™è¯¯
    window.addEventListener('error', (event) => {
        reportError({
            type: 'js-error',
            message: event.message,
            filename: event.filename,
            stack: event.error?.stack
        });
    });

    // Promise é”™è¯¯
    window.addEventListener('unhandledrejection', (event) => {
        reportError({
            type: 'promise-error',
            message: event.reason?.message || event.reason,
            stack: event.reason?.stack
        });
    });

    // qiankun é”™è¯¯
    window.addEventListener('single-spa:routing-event', (event) => {
        if (event.detail.type === 'error') {
            reportError({
                type: 'qiankun-error',
                appName: event.detail.appName,
                message: event.detail.error?.message,
                stack: event.detail.error?.stack
            });
        }
    });
}

setupErrorMonitoring();
```

### 2. ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

```javascript
function showUserFriendlyError(error) {
    let message = 'åº”ç”¨åŠ è½½å¤±è´¥';
    let suggestion = 'è¯·åˆ·æ–°é¡µé¢é‡è¯•';

    if (error.message.includes('404')) {
        message = 'åº”ç”¨ä¸å­˜åœ¨';
        suggestion = 'è¯·è”ç³»ç®¡ç†å‘˜';
    } else if (error.message.includes('timeout')) {
        message = 'ç½‘ç»œè¶…æ—¶';
        suggestion = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
    } else if (error.message.includes('CORS')) {
        message = 'è·¨åŸŸé”™è¯¯';
        suggestion = 'è¯·è”ç³»æŠ€æœ¯æ”¯æŒ';
    }

    showNotification({
        type: 'error',
        title: message,
        content: suggestion,
        duration: 5000,
        actions: [
            { text: 'é‡è¯•', onClick: () => window.location.reload() },
            { text: 'è¿”å›é¦–é¡µ', onClick: () => window.location.href = '/' }
        ]
    });
}
```

### 3. å¼€å‘ç¯å¢ƒçš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

```javascript
if (process.env.NODE_ENV === 'development') {
    // å¼€å‘ç¯å¢ƒï¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯
    window.addEventListener('error', (event) => {
        console.group('%c qiankun é”™è¯¯è¯¦æƒ…', 'color: red; font-weight: bold');
        console.error('é”™è¯¯ä¿¡æ¯:', event.message);
        console.error('æ–‡ä»¶:', event.filename);
        console.error('ä½ç½®:', `${event.lineno}:${event.colno}`);
        console.error('å †æ ˆ:', event.error?.stack);
        console.groupEnd();
    });
} else {
    // ç”Ÿäº§ç¯å¢ƒï¼šç®€æ´æç¤º + ä¸ŠæŠ¥
    window.addEventListener('error', (event) => {
        reportError(event.error);
        showErrorNotification('å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•');
    });
}
```

qiankun æä¾›äº†å¤šå±‚æ¬¡çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæ—¢ä¿è¯äº†ç³»ç»Ÿçš„å¥å£®æ€§ï¼Œåˆç»™å¼€å‘è€…ç•™ä¸‹äº†è¶³å¤Ÿçš„è‡ªå®šä¹‰ç©ºé—´ï¼

