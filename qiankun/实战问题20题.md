# ğŸ”¥ Qiankun é¡¹ç›®å®æˆ˜20é¢˜

> åŸºäºçœŸå®é¡¹ç›®ç»éªŒçš„å®æˆ˜é—®é¢˜ï¼Œé¢è¯•å¿…é—®ï¼

---

## é—®é¢˜1ï¼šä¸»åº”ç”¨å’Œå­åº”ç”¨å¦‚ä½•å…±äº« Reactã€Vue ç­‰ä¾èµ–ï¼Ÿå¦‚ä½•é¿å…é‡å¤æ‰“åŒ…ï¼Ÿ

### é—®é¢˜èƒŒæ™¯

```javascript
// ä¸»åº”ç”¨ä½¿ç”¨ React 17
// å­åº”ç”¨Aä½¿ç”¨ React 17
// å­åº”ç”¨Bä½¿ç”¨ React 17

// å¦‚æœæ¯ä¸ªåº”ç”¨éƒ½æ‰“åŒ… Reactï¼š
// React.js: 130KB Ã— 3 = 390KB
// æµªè´¹å¸¦å®½ï¼ŒåŠ è½½æ…¢
```

### è§£å†³æ–¹æ¡ˆ1ï¼šexternals + CDNï¼ˆæ¨èï¼‰

```javascript
// ===== ä¸»åº”ç”¨ webpack é…ç½® =====
module.exports = {
    externals: {
        'react': 'React',
        'react-dom': 'ReactDOM',
        'react-router-dom': 'ReactRouterDOM'
    }
};

// ä¸»åº”ç”¨ index.html
<script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-router-dom@5.3.0/umd/react-router-dom.min.js"></script>

// ===== å­åº”ç”¨ webpack é…ç½®ï¼ˆç›¸åŒï¼‰=====
module.exports = {
    externals: {
        'react': 'React',
        'react-dom': 'ReactDOM',
        'react-router-dom': 'ReactRouterDOM'
    }
};

// å­åº”ç”¨ä¸éœ€è¦å†å¼•å…¥ Reactï¼ˆå·²åœ¨ä¸»åº”ç”¨åŠ è½½ï¼‰
```

**ä¼˜ç‚¹ï¼š**
- React åªåŠ è½½ä¸€æ¬¡ï¼Œæ‰€æœ‰åº”ç”¨å…±äº«
- åˆ©ç”¨ CDN åŠ é€Ÿ
- å‡å°‘æ‰“åŒ…ä½“ç§¯

**æ³¨æ„äº‹é¡¹ï¼š**
```javascript
// 1. ç‰ˆæœ¬å¿…é¡»ä¸€è‡´
// ä¸»åº”ç”¨å’Œæ‰€æœ‰å­åº”ç”¨ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ React

// 2. UMD æ ¼å¼
// CDN èµ„æºå¿…é¡»æ˜¯ UMD æ ¼å¼ï¼Œæ‰èƒ½æŒ‚è½½åˆ° window

// 3. åŠ è½½é¡ºåº
// ä¸»åº”ç”¨å…ˆåŠ è½½å…¬å…±ä¾èµ–ï¼Œå­åº”ç”¨æ‰èƒ½æ­£å¸¸å·¥ä½œ
```

### è§£å†³æ–¹æ¡ˆ2ï¼šwebpack Module Federation

```javascript
// ===== ä¸»åº”ç”¨ webpack é…ç½® =====
const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
    plugins: [
        new ModuleFederationPlugin({
            name: 'mainApp',
            filename: 'remoteEntry.js',
            exposes: {
                // æš´éœ² React ç»™å­åº”ç”¨ä½¿ç”¨
                './react': 'react',
                './react-dom': 'react-dom'
            },
            shared: {
                react: { singleton: true, eager: true },
                'react-dom': { singleton: true, eager: true }
            }
        })
    ]
};

// ===== å­åº”ç”¨ webpack é…ç½® =====
module.exports = {
    plugins: [
        new ModuleFederationPlugin({
            name: 'reactApp',
            remotes: {
                mainApp: 'mainApp@http://localhost:9000/remoteEntry.js'
            },
            shared: {
                react: { singleton: true },
                'react-dom': { singleton: true }
            }
        })
    ]
};
```

---

## é—®é¢˜2ï¼šå­åº”ç”¨å¦‚ä½•æ—¢èƒ½ç‹¬ç«‹è¿è¡Œï¼Œåˆèƒ½è¢« qiankun åŠ è½½ï¼Ÿ

### é—®é¢˜èƒŒæ™¯

```javascript
// éœ€æ±‚ï¼š
// 1. å¼€å‘æ—¶ï¼šå­åº”ç”¨ç‹¬ç«‹è¿è¡Œï¼ˆhttp://localhost:8080ï¼‰
// 2. é›†æˆæ—¶ï¼šè¢«ä¸»åº”ç”¨åŠ è½½
```

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== å­åº”ç”¨ src/index.js =====

import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

// å®šä¹‰æ¸²æŸ“å‡½æ•°
function render(props = {}) {
    const { container } = props;
    
    ReactDOM.render(
        <App />,
        container 
            ? container.querySelector('#root')  // qiankun ç¯å¢ƒ
            : document.getElementById('root')    // ç‹¬ç«‹è¿è¡Œ
    );
}

// â­ åˆ¤æ–­è¿è¡Œç¯å¢ƒ
if (!window.__POWERED_BY_QIANKUN__) {
    // ç‹¬ç«‹è¿è¡Œ
    render();
}

// â­ å¯¼å‡ºç”Ÿå‘½å‘¨æœŸç»™ qiankun
export async function bootstrap() {
    console.log('[react app] bootstraped');
}

export async function mount(props) {
    console.log('[react app] mount', props);
    render(props);
}

export async function unmount(props) {
    console.log('[react app] unmount', props);
    const { container } = props;
    ReactDOM.unmountComponentAtNode(
        container 
            ? container.querySelector('#root')
            : document.getElementById('root')
    );
}
```

```javascript
// ===== å­åº”ç”¨ public/index.html =====
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>React App</title>
</head>
<body>
    <!-- ç‹¬ç«‹è¿è¡Œæ—¶ä½¿ç”¨ -->
    <div id="root"></div>
</body>
</html>
```

---

## é—®é¢˜3ï¼šwebpack çš„ publicPath å¦‚ä½•é…ç½®ï¼Ÿå¦‚ä½•è§£å†³å­åº”ç”¨é™æ€èµ„æº 404 é—®é¢˜ï¼Ÿ

### é—®é¢˜èƒŒæ™¯

```javascript
// å­åº”ç”¨éƒ¨ç½²åœ¨ï¼šhttps://cdn.example.com/react-app/
// ä¸»åº”ç”¨è®¿é—®ï¼šhttps://main.example.com

// å­åº”ç”¨ä¸­çš„å›¾ç‰‡ï¼š
<img src="./logo.png" />

// å®é™…è¯·æ±‚ï¼šhttps://main.example.com/logo.png âŒ
// åº”è¯¥è¯·æ±‚ï¼šhttps://cdn.example.com/react-app/logo.png âœ“
```

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹å¼1: è¿è¡Œæ—¶è®¾ç½® publicPathï¼ˆæ¨èï¼‰=====

// å­åº”ç”¨ src/public-path.js
if (window.__POWERED_BY_QIANKUN__) {
    __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// å­åº”ç”¨ src/index.jsï¼ˆç¬¬ä¸€è¡Œå¯¼å…¥ï¼‰
import './public-path';
import React from 'react';
// ... å…¶ä»–å¯¼å…¥
```

```javascript
// ===== æ–¹å¼2: webpack é…ç½® =====

module.exports = {
    output: {
        publicPath: process.env.NODE_ENV === 'production'
            ? 'https://cdn.example.com/react-app/'
            : 'http://localhost:8080/'
    }
};
```

```javascript
// ===== æ–¹å¼3: åŠ¨æ€ publicPathï¼ˆæœ€çµæ´»ï¼‰=====

// webpack.config.js
module.exports = {
    output: {
        publicPath: '/'  // é»˜è®¤å€¼
    }
};

// å­åº”ç”¨ src/public-path.js
if (window.__POWERED_BY_QIANKUN__) {
    __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
} else {
    // ç‹¬ç«‹è¿è¡Œæ—¶æ ¹æ®ç¯å¢ƒåˆ¤æ–­
    __webpack_public_path__ = process.env.PUBLIC_URL || '/';
}
```

---

## é—®é¢˜4ï¼šå¤šä¸ªå­åº”ç”¨ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ React/Vue ä¼šæœ‰é—®é¢˜å—ï¼Ÿå¦‚ä½•å¤„ç†ï¼Ÿ

### é—®é¢˜èƒŒæ™¯

```javascript
// ä¸»åº”ç”¨ï¼šReact 17
// å­åº”ç”¨Aï¼šReact 17
// å­åº”ç”¨Bï¼šReact 16
// å­åº”ç”¨Cï¼šVue 3

// æ˜¯å¦å…¼å®¹ï¼Ÿ
```

### ç­”æ¡ˆ

**å¯ä»¥å…±å­˜ï¼è¿™æ­£æ˜¯å¾®å‰ç«¯çš„ä¼˜åŠ¿ã€‚**

```javascript
// ===== æ¯ä¸ªåº”ç”¨æ‰“åŒ…è‡ªå·±çš„æ¡†æ¶ =====

// å­åº”ç”¨Aï¼ˆReact 17ï¼‰
package.json: { "react": "^17.0.0" }
// æ‰“åŒ…ï¼šreact 17 åŒ…å«åœ¨ bundle ä¸­

// å­åº”ç”¨Bï¼ˆReact 16ï¼‰
package.json: { "react": "^16.14.0" }
// æ‰“åŒ…ï¼šreact 16 åŒ…å«åœ¨ bundle ä¸­

// å­åº”ç”¨Cï¼ˆVue 3ï¼‰
package.json: { "vue": "^3.0.0" }
// æ‰“åŒ…ï¼švue 3 åŒ…å«åœ¨ bundle ä¸­

// qiankun çš„æ²™ç®±ä¼šéš”ç¦»å„è‡ªçš„å…¨å±€å˜é‡
sandboxA.window.React = React17
sandboxB.window.React = React16
sandboxC.window.Vue = Vue3

// äº’ä¸å½±å“ âœ“
```

**æœ€ä½³å®è·µï¼š**

```javascript
// 1. æ ¸å¿ƒåº“ä¸ external
// æ¯ä¸ªåº”ç”¨æ‰“åŒ…è‡ªå·±çš„æ¡†æ¶ç‰ˆæœ¬

// 2. å·¥å…·åº“å¯ä»¥ external
// lodashã€moment ç­‰å¯ä»¥å…±äº«

// webpack.config.js
module.exports = {
    externals: {
        // âŒ ä¸è¦ external æ¡†æ¶
        // 'react': 'React',
        
        // âœ… å¯ä»¥ external å·¥å…·åº“
        'lodash': '_',
        'moment': 'moment'
    }
};
```

---

## é—®é¢˜5ï¼šå­åº”ç”¨çš„è·¯ç”±åº”è¯¥ç”¨ hash æ¨¡å¼è¿˜æ˜¯ history æ¨¡å¼ï¼Ÿ

### ç­”æ¡ˆä¸å»ºè®®

**æ¨èï¼šå­åº”ç”¨ä½¿ç”¨ hash æ¨¡å¼ï¼Œä¸»åº”ç”¨ä½¿ç”¨ history æ¨¡å¼ã€‚**

```javascript
// ===== ä¸»åº”ç”¨ï¼šhistory æ¨¡å¼ =====
// react-router
<BrowserRouter>
    <Route path="/app1" />
    <Route path="/app2" />
</BrowserRouter>

// ===== å­åº”ç”¨ï¼šhash æ¨¡å¼ =====
// react-router
<HashRouter>
    <Route path="/home" />
    <Route path="/about" />
</HashRouter>

// å®é™… URLï¼š
// http://main.com/app1#/home
//             â†‘     â†‘
//         ä¸»åº”ç”¨è·¯ç”± å­åº”ç”¨è·¯ç”±
```

**ä¸ºä»€ä¹ˆï¼Ÿ**

```javascript
// 1. é¿å…è·¯ç”±å†²çª
// history æ¨¡å¼çš„å­åº”ç”¨å¯èƒ½ä¸ä¸»åº”ç”¨è·¯ç”±å†²çª

// ä¸»åº”ç”¨è·¯ç”±ï¼š/app1/users
// å­åº”ç”¨è·¯ç”±ï¼š/users

// å†²çªï¼

// 2. ç®€åŒ–éƒ¨ç½²
// hash æ¨¡å¼ä¸éœ€è¦æœåŠ¡å™¨è·¯ç”±é…ç½®

// 3. ç‹¬ç«‹è¿è¡Œå…¼å®¹
// å­åº”ç”¨ç‹¬ç«‹è¿è¡Œæ—¶ï¼Œhash æ¨¡å¼é…ç½®ç®€å•
```

**ç‰¹æ®Šæƒ…å†µï¼šå­åº”ç”¨ä¹Ÿç”¨ history æ¨¡å¼**

```javascript
// éœ€è¦é…ç½® base

// å­åº”ç”¨ router é…ç½®
<BrowserRouter basename={window.__POWERED_BY_QIANKUN__ ? '/app1' : '/'}>
    <Route path="/home" />  
    <Route path="/about" />
</BrowserRouter>

// URL ç»“æ„ï¼š
// http://main.com/app1/home
//                â†‘    â†‘
//             base  å­è·¯ç”±
```

---

## é—®é¢˜6ï¼šå¦‚ä½•åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒè°ƒè¯•ä¸»åº”ç”¨å’Œå­åº”ç”¨ï¼Ÿ

### å¼€å‘ç¯å¢ƒé…ç½®

```javascript
// ===== ä¸»åº”ç”¨é…ç½® =====

// å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°å­åº”ç”¨
const apps = [
    {
        name: 'react-app',
        entry: process.env.NODE_ENV === 'development'
            ? 'http://localhost:8080'  // æœ¬åœ°å¼€å‘
            : 'https://cdn.example.com/react-app',  // ç”Ÿäº§ç¯å¢ƒ
        container: '#subapp-container',
        activeRule: '/react-app'
    }
];

registerMicroApps(apps);

// ===== å­åº”ç”¨é…ç½®ï¼ˆè·¨åŸŸï¼‰=====

// webpack.config.js
module.exports = {
    devServer: {
        port: 8080,
        headers: {
            // â­ å…è®¸è·¨åŸŸ
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, PATCH, OPTIONS',
            'Access-Control-Allow-Headers': 'X-Requested-With, content-type, Authorization'
        }
    }
};
```

### è°ƒè¯•æŠ€å·§

```javascript
// 1. ä½¿ç”¨ Chrome DevTools
// - Sources é¢æ¿å¯ä»¥çœ‹åˆ°å­åº”ç”¨çš„ä»£ç 
// - sourceURL ä¼šæ˜¾ç¤ºè„šæœ¬æ¥æº
// - å¯ä»¥æ­£å¸¸æ‰“æ–­ç‚¹è°ƒè¯•

// 2. React DevTools
// - å¯ä»¥æŸ¥çœ‹å­åº”ç”¨çš„ç»„ä»¶æ ‘
// - éœ€è¦ç¡®ä¿ React DevTools èƒ½è¯†åˆ«å­åº”ç”¨

// 3. æ—¥å¿—è¾“å‡º
console.log('[å­åº”ç”¨A] æ•°æ®åŠ è½½:', data);
console.log('[ä¸»åº”ç”¨] åˆ‡æ¢åˆ°:', appName);

// 4. æ€§èƒ½åˆ†æ
performance.mark('app-load-start');
// ... åŠ è½½åº”ç”¨
performance.mark('app-load-end');
performance.measure('app-load', 'app-load-start', 'app-load-end');
```

---

## é—®é¢˜7ï¼šå­åº”ç”¨å¦‚ä½•è·å–ä¸»åº”ç”¨çš„ç”¨æˆ·ä¿¡æ¯ã€æƒé™ç­‰æ•°æ®ï¼Ÿ

### æ–¹æ¡ˆ1ï¼šé€šè¿‡ props ä¼ é€’ï¼ˆæ¨èï¼‰

```javascript
// ===== ä¸»åº”ç”¨ =====
const user = getUserInfo();
const permissions = getUserPermissions();

registerMicroApps([
    {
        name: 'react-app',
        entry: '//localhost:8080',
        container: '#container',
        activeRule: '/react-app',
        props: {
            // â­ ä¼ é€’æ•°æ®
            user,
            permissions,
            // ä¼ é€’æ–¹æ³•
            logout: () => handleLogout(),
            updateUser: (newUser) => updateUserInfo(newUser)
        }
    }
]);

// ===== å­åº”ç”¨ =====
export async function mount(props) {
    const { user, permissions, logout, updateUser } = props;
    
    // ä½¿ç”¨ä¸»åº”ç”¨ä¼ é€’çš„æ•°æ®
    ReactDOM.render(
        <App 
            user={user} 
            permissions={permissions}
            onLogout={logout}
            onUpdateUser={updateUser}
        />, 
        props.container
    );
}
```

### æ–¹æ¡ˆ2ï¼šé€šè¿‡ globalState

```javascript
// ===== ä¸»åº”ç”¨ =====
import { initGlobalState } from 'qiankun';

const actions = initGlobalState({
    user: getUserInfo(),
    permissions: getUserPermissions(),
    token: getToken()
});

// ç”¨æˆ·ç™»å½•åæ›´æ–°
actions.setGlobalState({
    user: newUser,
    token: newToken
});

// ä¼ é€’ç»™å­åº”ç”¨
registerMicroApps([
    {
        name: 'react-app',
        props: { globalState: actions }
    }
]);

// ===== å­åº”ç”¨ =====
export async function mount(props) {
    const { globalState } = props;
    
    // ç›‘å¬çŠ¶æ€å˜åŒ–
    globalState.onGlobalStateChange((state, prev) => {
        console.log('ç”¨æˆ·ä¿¡æ¯æ›´æ–°:', state.user);
        updateApp(state);
    }, true);  // true: ç«‹å³æ‰§è¡Œä¸€æ¬¡
}
```

---

## é—®é¢˜8ï¼šå­åº”ç”¨å¸è½½æ—¶ï¼Œå®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬æ²¡æ¸…ç†å¹²å‡€å¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå¦‚ä½•æ’æŸ¥å’Œè§£å†³ï¼Ÿ

### æ’æŸ¥æ–¹æ³•

```javascript
// 1. Chrome DevTools Memory åˆ†æ
// - æ‰“å¼€ Memory é¢æ¿
// - Take heap snapshot
// - åˆ‡æ¢å‡ æ¬¡å­åº”ç”¨
// - å†æ¬¡ Take heap snapshot
// - å¯¹æ¯”å†…å­˜å¢é•¿

// 2. ä½¿ç”¨ Performance Monitor
// - æ‰“å¼€ Performance Monitor
// - è§‚å¯Ÿ JS heap size
// - åˆ‡æ¢å­åº”ç”¨ï¼Œè§‚å¯Ÿå†…å­˜æ˜¯å¦æŒç»­å¢é•¿

// 3. æ£€æŸ¥ Detached DOM
// - åœ¨ Memory é¢æ¿æœç´¢ "Detached"
// - æŸ¥çœ‹æ˜¯å¦æœ‰å¤§é‡ Detached DOM èŠ‚ç‚¹
```

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== å­åº”ç”¨ =====

// 1. ç»Ÿä¸€ç®¡ç†å®šæ—¶å™¨
class TimerManager {
    constructor() {
        this.timers = [];
    }

    setTimeout(callback, delay) {
        const timer = setTimeout(callback, delay);
        this.timers.push({ type: 'timeout', id: timer });
        return timer;
    }

    setInterval(callback, delay) {
        const timer = setInterval(callback, delay);
        this.timers.push({ type: 'interval', id: timer });
        return timer;
    }

    clearAll() {
        this.timers.forEach(({ type, id }) => {
            if (type === 'timeout') {
                clearTimeout(id);
            } else {
                clearInterval(id);
            }
        });
        this.timers = [];
    }
}

const timerManager = new TimerManager();

// 2. ç»Ÿä¸€ç®¡ç†äº‹ä»¶ç›‘å¬
class EventManager {
    constructor() {
        this.listeners = [];
    }

    addEventListener(target, type, handler, options) {
        target.addEventListener(type, handler, options);
        this.listeners.push({ target, type, handler, options });
    }

    removeAll() {
        this.listeners.forEach(({ target, type, handler, options }) => {
            target.removeEventListener(type, handler, options);
        });
        this.listeners = [];
    }
}

const eventManager = new EventManager();

// 3. åœ¨ unmount ä¸­å½»åº•æ¸…ç†
export async function unmount(props) {
    // æ¸…ç†å®šæ—¶å™¨
    timerManager.clearAll();
    
    // æ¸…ç†äº‹ä»¶ç›‘å¬
    eventManager.removeAll();
    
    // å–æ¶ˆæœªå®Œæˆçš„è¯·æ±‚
    abortController.abort();
    
    // å…³é—­ WebSocket
    if (ws) {
        ws.close();
        ws = null;
    }
    
    // å¸è½½ React
    ReactDOM.unmountComponentAtNode(props.container);
    
    // æ¸…ç†å…¨å±€å˜é‡
    delete window.myAppData;
}

// 4. ä½¿ç”¨ React Hooks è‡ªåŠ¨æ¸…ç†
function useEventListener(target, type, handler) {
    useEffect(() => {
        target.addEventListener(type, handler);
        return () => {
            target.removeEventListener(type, handler);
        };
    }, [target, type, handler]);
}
```

---

## é—®é¢˜9ï¼šä¸»åº”ç”¨å’Œå­åº”ç”¨å¦‚ä½•å…±äº«è·¯ç”±ä¿¡æ¯ï¼Ÿå­åº”ç”¨å¦‚ä½•æ„ŸçŸ¥ä¸»åº”ç”¨çš„è·¯ç”±å˜åŒ–ï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== ä¸»åº”ç”¨ =====
import { useHistory } from 'react-router-dom';

function MainApp() {
    const history = useHistory();

    // ç›‘å¬è·¯ç”±å˜åŒ–
    useEffect(() => {
        const unlisten = history.listen((location) => {
            // é€šçŸ¥å­åº”ç”¨è·¯ç”±å˜åŒ–
            window.dispatchEvent(new CustomEvent('mainapp-route-change', {
                detail: { location }
            }));
        });

        return unlisten;
    }, [history]);

    // ä¼ é€’è·¯ç”±ä¿¡æ¯ç»™å­åº”ç”¨
    const props = {
        mainHistory: history,
        mainLocation: history.location
    };

    return <div id="subapp-container" />;
}

// ===== å­åº”ç”¨ =====
export async function mount(props) {
    const { mainHistory, mainLocation } = props;

    // ç›‘å¬ä¸»åº”ç”¨è·¯ç”±å˜åŒ–
    window.addEventListener('mainapp-route-change', (e) => {
        console.log('ä¸»åº”ç”¨è·¯ç”±å˜åŒ–:', e.detail.location);
    });

    // å­åº”ç”¨è·¯ç”±è·³è½¬å¯ä»¥é€šçŸ¥ä¸»åº”ç”¨
    function navigateToMainApp(path) {
        mainHistory.push(path);
    }
}
```

---

## é—®é¢˜10ï¼šå¦‚ä½•å¤„ç†å­åº”ç”¨çš„ç¯å¢ƒå˜é‡ï¼Ÿå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå¦‚ä½•åŒºåˆ†ï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹å¼1: .env æ–‡ä»¶ =====

// å­åº”ç”¨ .env.development
REACT_APP_API_BASE=http://localhost:3000/api
REACT_APP_ENV=development

// å­åº”ç”¨ .env.production
REACT_APP_API_BASE=https://api.example.com
REACT_APP_ENV=production

// ä½¿ç”¨
const apiBase = process.env.REACT_APP_API_BASE;

// ===== æ–¹å¼2: ä¸»åº”ç”¨æ³¨å…¥ =====

// ä¸»åº”ç”¨
registerMicroApps([
    {
        name: 'react-app',
        props: {
            env: {
                apiBase: process.env.API_BASE,
                environment: process.env.NODE_ENV
            }
        }
    }
]);

// å­åº”ç”¨
export async function mount(props) {
    const { env } = props;
    console.log('ç¯å¢ƒé…ç½®:', env);
}

// ===== æ–¹å¼3: è¿è¡Œæ—¶é…ç½® =====

// éƒ¨ç½²æ—¶æ³¨å…¥é…ç½®
window.__APP_CONFIG__ = {
    apiBase: 'https://api.example.com',
    cdnBase: 'https://cdn.example.com'
};

// å­åº”ç”¨è¯»å–
const apiBase = window.__APP_CONFIG__?.apiBase || 'http://localhost:3000';
```

---

## é—®é¢˜11ï¼šæ ·å¼å†²çªäº†æ€ä¹ˆåŠï¼Ÿæœ‰å“ªäº›å®æˆ˜ç»éªŒï¼Ÿ

### å¸¸è§å†²çªåœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ

#### åœºæ™¯1ï¼šé‡ç½®æ ·å¼å†²çª

```css
/* ä¸»åº”ç”¨çš„å…¨å±€é‡ç½® */
* { margin: 0; padding: 0; box-sizing: border-box; }

/* å­åº”ç”¨ä¹Ÿæœ‰é‡ç½® */
* { margin: 0; padding: 0; }

/* è§£å†³æ–¹æ¡ˆï¼šé™åˆ¶ä½œç”¨åŸŸ */
/* ä¸»åº”ç”¨ */
#main-app * { margin: 0; padding: 0; }

/* å­åº”ç”¨ */
#subapp-container * { margin: 0; padding: 0; }
```

#### åœºæ™¯2ï¼šUI åº“æ ·å¼å†²çª

```javascript
// ä¸»åº”ç”¨ï¼šAnt Design 4.x
// å­åº”ç”¨ï¼šAnt Design 3.x

// è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨ CSS Modules
// Ant Design æ”¯æŒæ ·å¼å‰ç¼€

// ä¸»åº”ç”¨
<ConfigProvider prefixCls="main-ant">
    <Button>ä¸»åº”ç”¨æŒ‰é’®</Button>
</ConfigProvider>

// å­åº”ç”¨
<ConfigProvider prefixCls="sub-ant">
    <Button>å­åº”ç”¨æŒ‰é’®</Button>
</ConfigProvider>

// ç”Ÿæˆçš„ç±»åï¼š
// .main-ant-btn
// .sub-ant-btn

// è§£å†³æ–¹æ¡ˆ2ï¼šå¼€å¯ experimentalStyleIsolation
start({
    sandbox: {
        experimentalStyleIsolation: true
    }
});
```

#### åœºæ™¯3ï¼šå­—ä½“å›¾æ ‡å†²çª

```css
/* ä¸»åº”ç”¨ä½¿ç”¨ Font Awesome */
@font-face {
    font-family: 'FontAwesome';
    src: url('./fonts/fontawesome.woff2');
}

.fa { font-family: 'FontAwesome'; }

/* å­åº”ç”¨ä¹Ÿä½¿ç”¨ Font Awesomeï¼ˆä¸åŒç‰ˆæœ¬ï¼‰*/
@font-face {
    font-family: 'FontAwesome';
    src: url('./fonts/fontawesome-new.woff2');
}

/* è§£å†³æ–¹æ¡ˆï¼šé‡å‘½åå­—ä½“ */
/* å­åº”ç”¨ */
@font-face {
    font-family: 'SubApp-FontAwesome';  /* é‡å‘½å */
    src: url('./fonts/fontawesome-new.woff2');
}

.sub-fa { font-family: 'SubApp-FontAwesome'; }
```

---

## é—®é¢˜12ï¼šå­åº”ç”¨æ‰“åŒ…åçš„æ–‡ä»¶åå¦‚ä½•é…ç½®ï¼Ÿhash è¿˜æ˜¯å›ºå®šåç§°ï¼Ÿ

### æ¨èé…ç½®

```javascript
// webpack.config.js

module.exports = {
    output: {
        // â­ ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ contenthash
        filename: process.env.NODE_ENV === 'production'
            ? '[name].[contenthash:8].js'
            : '[name].js',
        
        chunkFilename: process.env.NODE_ENV === 'production'
            ? '[name].[contenthash:8].chunk.js'
            : '[name].chunk.js',
    }
};
```

**ä¸ºä»€ä¹ˆï¼Ÿ**

```javascript
// ä½¿ç”¨ contenthash çš„å¥½å¤„ï¼š

// 1. æ–‡ä»¶å˜åŒ–æ—¶ï¼Œhash å˜åŒ–
main.abc123.js â†’ main.def456.js
// æµè§ˆå™¨ä¼šåŠ è½½æ–°æ–‡ä»¶ï¼Œä¸ä¼šä½¿ç”¨æ—§ç¼“å­˜

// 2. æ–‡ä»¶ä¸å˜ï¼Œhash ä¸å˜
vendors.xyz789.jsï¼ˆæœªå˜åŒ–ï¼‰
// æµè§ˆå™¨ä½¿ç”¨ç¼“å­˜ï¼Œä¸é‡æ–°ä¸‹è½½

// 3. é…åˆå¼ºç¼“å­˜
// Nginx é…ç½®
location ~* \.(js|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

// 4. import-html-entry çš„ç¼“å­˜
// URL å˜åŒ–ä¼šé‡æ–°åŠ è½½
// http://localhost:8080/main.abc123.js
// http://localhost:8080/main.def456.js
// ä¸¤ä¸ªä¸åŒçš„ URLï¼Œä¸ä¼šé”™è¯¯åœ°ä½¿ç”¨ç¼“å­˜
```

**index.html ä¸èƒ½ç”¨ hashï¼š**

```javascript
// âŒ é”™è¯¯
entry: 'http://localhost:8080/index.abc123.html'

// âœ… æ­£ç¡®
entry: 'http://localhost:8080/index.html'

// åŸå› ï¼š
// 1. HTML å…¥å£éœ€è¦å›ºå®š URL
// 2. HTML é€šè¿‡ Cache-Control: no-cache æ§åˆ¶ç¼“å­˜
// 3. JS/CSS æ‰ä½¿ç”¨ contenthash
```

---

## é—®é¢˜13ï¼šå¦‚ä½•å®ç°å­åº”ç”¨çš„æŒ‰éœ€åŠ è½½å’Œæ‡’åŠ è½½ï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== å­åº”ç”¨çš„è·¯ç”±æ‡’åŠ è½½ =====

import { lazy, Suspense } from 'react';

// æ‡’åŠ è½½é¡µé¢ç»„ä»¶
const Home = lazy(() => import('./pages/Home'));
const About = lazy(() => import('./pages/About'));
const User = lazy(() => import('./pages/User'));

function App() {
    return (
        <Suspense fallback={<Loading />}>
            <Routes>
                <Route path="/home" element={<Home />} />
                <Route path="/about" element={<About />} />
                <Route path="/user" element={<User />} />
            </Routes>
        </Suspense>
    );
}

// é¦–å±åªåŠ è½½ main.js
// è®¿é—® /about æ—¶æ‰åŠ è½½ About.chunk.js
```

```javascript
// ===== webpack é…ç½®ä¼˜åŒ– =====

module.exports = {
    optimization: {
        splitChunks: {
            chunks: 'all',
            cacheGroups: {
                // ç¬¬ä¸‰æ–¹åº“
                vendor: {
                    test: /[\\/]node_modules[\\/]/,
                    name: 'vendors',
                    priority: 10
                },
                // å…¬å…±ä»£ç 
                common: {
                    minChunks: 2,
                    name: 'common',
                    priority: 5,
                    reuseExistingChunk: true
                }
            }
        }
    }
};

// äº§å‡ºï¼š
// vendors.js (200KB) - ç¬¬ä¸‰æ–¹åº“
// common.js (50KB)   - å…¬å…±ä»£ç 
// main.js (80KB)     - å…¥å£æ–‡ä»¶
// Home.chunk.js (30KB)   - æŒ‰éœ€åŠ è½½
// About.chunk.js (25KB)  - æŒ‰éœ€åŠ è½½
// User.chunk.js (40KB)   - æŒ‰éœ€åŠ è½½
```

---

## é—®é¢˜14ï¼šå¦‚ä½•å¤„ç†å­åº”ç”¨ä¸­åŠ¨æ€åŠ è½½çš„å›¾ç‰‡ã€å­—ä½“ç­‰é™æ€èµ„æºï¼Ÿ

### é—®é¢˜åœºæ™¯

```javascript
// å­åº”ç”¨ä»£ç 
<img src={require('./assets/logo.png')} />

// æˆ–
import logo from './assets/logo.png';
<img src={logo} />

// å®é™…è¯·æ±‚ï¼š
// http://main.com/static/media/logo.abc123.png âŒ
// åº”è¯¥è¯·æ±‚ï¼š
// http://cdn.com/react-app/static/media/logo.abc123.png âœ“
```

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹å¼1: æ­£ç¡®é…ç½® publicPath =====

// å­åº”ç”¨ src/public-path.js
if (window.__POWERED_BY_QIANKUN__) {
    __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// å­åº”ç”¨ src/index.jsï¼ˆç¬¬ä¸€è¡Œï¼‰
import './public-path';

// ===== æ–¹å¼2: ä½¿ç”¨ç»å¯¹è·¯å¾„ =====

// é…ç½®ç¯å¢ƒå˜é‡
// .env.production
REACT_APP_CDN_BASE=https://cdn.example.com/react-app

// ä½¿ç”¨
const logo = `${process.env.REACT_APP_CDN_BASE}/assets/logo.png`;
<img src={logo} />

// ===== æ–¹å¼3: ä» props è·å– publicPath =====

// ä¸»åº”ç”¨ä¼ é€’
registerMicroApps([
    {
        name: 'react-app',
        props: {
            publicPath: 'https://cdn.example.com/react-app/'
        }
    }
]);

// å­åº”ç”¨ä½¿ç”¨
export async function mount(props) {
    const { publicPath } = props;
    
    // è®¾ç½®å…¨å±€ publicPath
    window.__PUBLIC_PATH__ = publicPath;
    
    // ä½¿ç”¨
    <img src={`${window.__PUBLIC_PATH__}assets/logo.png`} />
}
```

---

## é—®é¢˜15ï¼šä¸»åº”ç”¨æ›´æ–°åï¼Œå¦‚ä½•ä¿è¯å­åº”ç”¨çš„å…¼å®¹æ€§ï¼Ÿ

### ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

```javascript
// ===== å®šä¹‰åè®®ç‰ˆæœ¬ =====

// ä¸»åº”ç”¨
const PROTOCOL_VERSION = '2.0.0';

registerMicroApps([
    {
        name: 'react-app',
        props: {
            protocolVersion: PROTOCOL_VERSION,
            // ä¼ é€’ API ç‰ˆæœ¬
            apiVersion: '1.0.0'
        }
    }
]);

// å­åº”ç”¨éªŒè¯
export async function bootstrap(props) {
    const { protocolVersion } = props;
    const REQUIRED_VERSION = '2.0.0';
    
    if (protocolVersion !== REQUIRED_VERSION) {
        console.error(`ç‰ˆæœ¬ä¸å…¼å®¹: éœ€è¦ ${REQUIRED_VERSION}, å½“å‰ ${protocolVersion}`);
        
        // æç¤ºç”¨æˆ·åˆ·æ–°
        if (confirm('æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦åˆ·æ–°é¡µé¢ï¼Ÿ')) {
            window.location.reload();
        }
        
        throw new Error('ç‰ˆæœ¬ä¸å…¼å®¹');
    }
}
```

### æ¸è¿›å¼å‡çº§

```javascript
// 1. å‘åå…¼å®¹
// æ–°ç‰ˆæœ¬ API ä¿æŒå¯¹æ—§ç‰ˆæœ¬çš„å…¼å®¹

// ä¸»åº”ç”¨ v2
registerMicroApps([
    {
        props: {
            // v2 æ–°å¢çš„ API
            newFeature: () => {},
            
            // v1 çš„ APIï¼ˆä¿ç•™ï¼‰
            oldFeature: () => {}
        }
    }
]);

// 2. åºŸå¼ƒè­¦å‘Š
if (props.oldFeature) {
    console.warn('oldFeature å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ newFeature');
}

// 3. ç°åº¦å‘å¸ƒ
// å…ˆå‘å¸ƒä¸»åº”ç”¨æ–°ç‰ˆæœ¬ï¼ˆä¿æŒå…¼å®¹ï¼‰
// å†é€æ­¥å‡çº§å­åº”ç”¨
// æœ€åç§»é™¤æ—§ API
```

---

## é—®é¢˜16ï¼šå¦‚ä½•åœ¨ qiankun ä¸­å®ç°å­åº”ç”¨çš„æƒé™æ§åˆ¶ï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== ä¸»åº”ç”¨ï¼šæƒé™æ£€æŸ¥ =====

const apps = [
    { 
        name: 'admin', 
        entry: '//localhost:8080',
        requiredPermission: 'ADMIN'  // éœ€è¦ç®¡ç†å‘˜æƒé™
    },
    { 
        name: 'user', 
        entry: '//localhost:8081',
        requiredPermission: 'USER'
    }
];

// è¿‡æ»¤ç”¨æˆ·æœ‰æƒé™çš„åº”ç”¨
const userPermissions = getUserPermissions();  // ['USER', 'VIEW']
const allowedApps = apps.filter(app => 
    userPermissions.includes(app.requiredPermission)
);

registerMicroApps(allowedApps);

// ===== è¿è¡Œæ—¶æƒé™æ£€æŸ¥ =====

registerMicroApps(apps, {
    beforeLoad: async (app) => {
        // æ£€æŸ¥æƒé™
        const hasPermission = await checkPermission(app.name);
        
        if (!hasPermission) {
            // è·³è½¬åˆ°æ— æƒé™é¡µé¢
            window.location.href = '/403';
            throw new Error('æ— æƒé™è®¿é—®');
        }
    }
});

// ===== å­åº”ç”¨ï¼šç»†ç²’åº¦æƒé™ =====

export async function mount(props) {
    const { permissions } = props;
    
    ReactDOM.render(
        <App permissions={permissions} />,
        props.container
    );
}

// åœ¨ç»„ä»¶ä¸­
function AdminPanel({ permissions }) {
    if (!permissions.includes('ADMIN')) {
        return <Forbidden />;
    }
    
    return <AdminContent />;
}
```

---

## é—®é¢˜17ï¼šå¦‚ä½•ç›‘æ§å¾®å‰ç«¯åº”ç”¨çš„æ€§èƒ½å’Œé”™è¯¯ï¼Ÿ

### å®Œæ•´ç›‘æ§æ–¹æ¡ˆ

```javascript
// ===== 1. æ€§èƒ½ç›‘æ§ =====

class PerformanceMonitor {
    constructor() {
        this.metrics = {};
    }

    // åº”ç”¨åŠ è½½è€—æ—¶
    measureAppLoad(appName) {
        const entries = performance.getEntriesByName(appName);
        if (entries.length > 0) {
            const loadTime = entries[0].duration;
            
            this.report({
                metric: 'app_load_time',
                appName,
                value: loadTime,
                timestamp: Date.now()
            });
        }
    }

    // èµ„æºåŠ è½½è€—æ—¶
    measureResourceLoad() {
        const resources = performance.getEntriesByType('resource');
        
        resources.forEach(resource => {
            if (resource.duration > 1000) {  // è¶…è¿‡1ç§’çš„èµ„æº
                this.report({
                    metric: 'slow_resource',
                    url: resource.name,
                    duration: resource.duration
                });
            }
        });
    }

    // é¦–å±æ¸²æŸ“æ—¶é—´
    measureFCP() {
        const fcp = performance.getEntriesByName('first-contentful-paint')[0];
        if (fcp) {
            this.report({
                metric: 'fcp',
                value: fcp.startTime
            });
        }
    }

    report(data) {
        // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
        fetch('/api/metrics', {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }
}

const monitor = new PerformanceMonitor();

// åœ¨ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨
registerMicroApps(apps, {
    beforeLoad: (app) => {
        performance.mark(`${app.name}-load-start`);
    },
    afterMount: (app) => {
        performance.mark(`${app.name}-load-end`);
        performance.measure(
            app.name,
            `${app.name}-load-start`,
            `${app.name}-load-end`
        );
        
        monitor.measureAppLoad(app.name);
    }
});

// ===== 2. é”™è¯¯ç›‘æ§ =====

class ErrorMonitor {
    constructor() {
        this.setupListeners();
    }

    setupListeners() {
        // JS é”™è¯¯
        window.addEventListener('error', (event) => {
            this.reportError({
                type: 'js_error',
                message: event.message,
                filename: event.filename,
                line: event.lineno,
                column: event.colno,
                stack: event.error?.stack
            });
        });

        // Promise é”™è¯¯
        window.addEventListener('unhandledrejection', (event) => {
            this.reportError({
                type: 'promise_error',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });

        // qiankun é”™è¯¯
        window.addEventListener('single-spa:routing-event', (event) => {
            if (event.detail.type === 'error') {
                this.reportError({
                    type: 'qiankun_error',
                    appName: event.detail.appName,
                    message: event.detail.error?.message,
                    stack: event.detail.error?.stack
                });
            }
        });
    }

    reportError(error) {
        // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Sentryï¼‰
        fetch('/api/errors', {
            method: 'POST',
            body: JSON.stringify({
                ...error,
                userAgent: navigator.userAgent,
                url: window.location.href,
                timestamp: Date.now()
            })
        });
    }
}

new ErrorMonitor();
```

---

## é—®é¢˜18ï¼šqiankun åº”ç”¨å¦‚ä½•éƒ¨ç½²ï¼ŸNginx å¦‚ä½•é…ç½®ï¼Ÿ

### Nginx é…ç½®

```nginx
# ===== ä¸»åº”ç”¨é…ç½® =====
server {
    listen 80;
    server_name main.example.com;

    # ä¸»åº”ç”¨æ ¹ç›®å½•
    root /var/www/main-app;
    index index.html;

    # HTML ä¸ç¼“å­˜
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # JS/CSS å¼ºç¼“å­˜
    location ~* \.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # é™æ€èµ„æº
    location ~* \.(png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public";
    }

    # SPA è·¯ç”±æ”¯æŒ
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# ===== å­åº”ç”¨é…ç½® =====
server {
    listen 80;
    server_name app1.example.com;

    root /var/www/react-app;
    index index.html;

    # â­ CORS é…ç½®ï¼ˆé‡è¦ï¼‰
    add_header Access-Control-Allow-Origin https://main.example.com;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
    add_header Access-Control-Allow-Credentials true;

    # å¤„ç† OPTIONS è¯·æ±‚
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # ç¼“å­˜é…ç½®ï¼ˆåŒä¸»åº”ç”¨ï¼‰
    location ~* \.html$ {
        add_header Cache-Control "no-cache";
    }

    location ~* \.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### Docker éƒ¨ç½²

```dockerfile
# ä¸»åº”ç”¨ Dockerfile
FROM node:16 as builder
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

---

## é—®é¢˜19ï¼šå­åº”ç”¨çš„æ¥å£è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿå¦‚ä½•é…ç½®è¯·æ±‚åŸŸåï¼Ÿ

### æ–¹æ¡ˆ1ï¼šç¯å¢ƒå˜é‡

```javascript
// å­åº”ç”¨ .env.development
REACT_APP_API_BASE=http://localhost:3000

// å­åº”ç”¨ .env.production
REACT_APP_API_BASE=https://api.example.com

// ä½¿ç”¨
import axios from 'axios';

const api = axios.create({
    baseURL: process.env.REACT_APP_API_BASE
});

api.get('/users').then(/* ... */);
```

### æ–¹æ¡ˆ2ï¼šä¸»åº”ç”¨æ³¨å…¥

```javascript
// ä¸»åº”ç”¨
registerMicroApps([
    {
        name: 'react-app',
        props: {
            apiConfig: {
                baseURL: process.env.API_BASE,
                timeout: 10000
            }
        }
    }
]);

// å­åº”ç”¨
export async function mount(props) {
    const { apiConfig } = props;
    
    // åˆ›å»º axios å®ä¾‹
    const api = axios.create(apiConfig);
    
    // å­˜å‚¨åˆ°å…¨å±€æˆ– Context
    window.api = api;
}
```

### è·¨åŸŸå¤„ç†

```javascript
// å¼€å‘ç¯å¢ƒï¼šwebpack proxy
module.exports = {
    devServer: {
        proxy: {
            '/api': {
                target: 'http://localhost:3000',
                changeOrigin: true,
                pathRewrite: { '^/api': '' }
            }
        }
    }
};

// ç”Ÿäº§ç¯å¢ƒï¼šNginx åå‘ä»£ç†
location /api/ {
    proxy_pass http://backend-server/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

---

## é—®é¢˜20ï¼šå¤šä¸ªå­åº”ç”¨æœ‰ç›¸åŒçš„ä¾èµ–ï¼ˆå¦‚ lodashã€momentï¼‰ï¼Œå¦‚ä½•é¿å…é‡å¤åŠ è½½ï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹å¼1: externals + CDN =====

// æ‰€æœ‰åº”ç”¨çš„ webpack é…ç½®
module.exports = {
    externals: {
        'lodash': '_',
        'moment': 'moment',
        'axios': 'axios'
    }
};

// ä¸»åº”ç”¨ index.html åŠ è½½å…¬å…±åº“
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.2.0/dist/axios.min.js"></script>

// æ‰€æœ‰å­åº”ç”¨å…±äº«è¿™äº›ä¾èµ–

// ===== æ–¹å¼2: import-html-entry çš„ç¼“å­˜ =====

// å­åº”ç”¨A
<script src="https://cdn.com/lodash.min.js"></script>

// å­åº”ç”¨B
<script src="https://cdn.com/lodash.min.js"></script>  // åŒä¸€ä¸ª URL

// import-html-entry ä¼šç¼“å­˜
// lodash åªä¸‹è½½ä¸€æ¬¡ï¼Œä¸¤ä¸ªåº”ç”¨å…±äº«ç¼“å­˜

// ===== æ–¹å¼3: DLL æ’ä»¶ =====

// webpack.dll.config.js
const webpack = require('webpack');

module.exports = {
    entry: {
        vendor: ['lodash', 'moment', 'axios']
    },
    output: {
        path: path.join(__dirname, 'public/dll'),
        filename: '[name].dll.js',
        library: '[name]_library'
    },
    plugins: [
        new webpack.DllPlugin({
            name: '[name]_library',
            path: path.join(__dirname, 'public/dll', '[name].manifest.json')
        })
    ]
};

// ç”Ÿæˆ vendor.dll.jsï¼Œæ‰€æœ‰åº”ç”¨å…±äº«
```

---

## é—®é¢˜21ï¼šå¦‚ä½•å®ç°å­åº”ç”¨çš„ç°åº¦å‘å¸ƒï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== åŸºäºç”¨æˆ· ID çš„ç°åº¦ =====

function getAppEntry(appName, userId) {
    // ç°åº¦è§„åˆ™ï¼šç”¨æˆ· ID å°¾å·ä¸º 0-2 çš„ä½¿ç”¨æ–°ç‰ˆæœ¬
    const isGrayUser = userId % 10 <= 2;
    
    if (isGrayUser) {
        return {
            v1: `https://cdn.example.com/${appName}/v1/index.html`,
            v2: `https://cdn.example.com/${appName}/v2/index.html`  // ç°åº¦ç‰ˆæœ¬
        }[process.env.GRAY_VERSION || 'v2'];
    }
    
    return `https://cdn.example.com/${appName}/v1/index.html`;
}

const currentUser = getCurrentUser();

registerMicroApps([
    {
        name: 'react-app',
        entry: getAppEntry('react-app', currentUser.id),
        // ...
    }
]);

// ===== åŸºäºé…ç½®çš„ç°åº¦ =====

// ä»æœåŠ¡å™¨è·å–ç°åº¦é…ç½®
const grayConfig = await fetch('/api/gray-config').then(r => r.json());
/*
{
    "react-app": {
        "grayRatio": 0.1,  // 10% ç°åº¦
        "grayVersion": "v2"
    }
}
*/

function shouldUseGrayVersion(appName) {
    const config = grayConfig[appName];
    if (!config) return false;
    
    return Math.random() < config.grayRatio;
}

registerMicroApps([
    {
        name: 'react-app',
        entry: shouldUseGrayVersion('react-app')
            ? 'https://cdn.example.com/react-app/v2/index.html'
            : 'https://cdn.example.com/react-app/v1/index.html',
    }
]);
```

---

## é—®é¢˜22ï¼šå­åº”ç”¨çš„å•å…ƒæµ‹è¯•å¦‚ä½•ç¼–å†™ï¼Ÿ

### æµ‹è¯•ç­–ç•¥

```javascript
// ===== æµ‹è¯•ç”Ÿå‘½å‘¨æœŸå‡½æ•° =====

// __tests__/lifecycle.test.js
import { mount, unmount, bootstrap } from '../src/index';

describe('ç”Ÿå‘½å‘¨æœŸæµ‹è¯•', () => {
    let container;

    beforeEach(() => {
        container = document.createElement('div');
        container.id = 'root';
        document.body.appendChild(container);
    });

    afterEach(() => {
        document.body.removeChild(container);
    });

    test('bootstrap åº”è¯¥æˆåŠŸæ‰§è¡Œ', async () => {
        await expect(bootstrap()).resolves.toBeUndefined();
    });

    test('mount åº”è¯¥æ¸²æŸ“å†…å®¹', async () => {
        await mount({ container });
        
        expect(container.querySelector('#root')).toBeTruthy();
        expect(container.textContent).toContain('App');
    });

    test('unmount åº”è¯¥æ¸…ç†å†…å®¹', async () => {
        await mount({ container });
        await unmount({ container });
        
        expect(container.querySelector('#root').innerHTML).toBe('');
    });
});

// ===== æµ‹è¯•ç»„ä»¶ =====

// __tests__/App.test.js
import { render, screen } from '@testing-library/react';
import App from '../src/App';

test('åº”è¯¥æ¸²æŸ“æ ‡é¢˜', () => {
    render(<App />);
    expect(screen.getByText('åº”ç”¨æ ‡é¢˜')).toBeInTheDocument();
});
```

---

## é—®é¢˜23ï¼šä¸»åº”ç”¨å´©æºƒäº†ï¼Œå­åº”ç”¨ä¼šå—å½±å“å—ï¼Ÿå¦‚ä½•å®ç°å®¹é”™ï¼Ÿ

### éš”ç¦»å’Œå®¹é”™

```javascript
// ===== 1. é”™è¯¯è¾¹ç•Œéš”ç¦» =====

// ä¸»åº”ç”¨
class MicroAppErrorBoundary extends React.Component {
    state = { hasError: false };

    static getDerivedStateFromError(error) {
        return { hasError: true };
    }

    componentDidCatch(error, errorInfo) {
        console.error('å­åº”ç”¨é”™è¯¯:', error, errorInfo);
        reportError(error);
    }

    render() {
        if (this.state.hasError) {
            return <ErrorFallback appName={this.props.appName} />;
        }
        return this.props.children;
    }
}

// ä½¿ç”¨
<MicroAppErrorBoundary appName="react-app">
    <div id="subapp-container" />
</MicroAppErrorBoundary>

// ===== 2. ä¸»åº”ç”¨å´©æºƒä¸å½±å“å­åº”ç”¨ =====

// ç†è®ºä¸Šï¼š
// - ä¸»åº”ç”¨å´©æºƒï¼Œæ•´ä¸ªé¡µé¢å´©æºƒ
// - å­åº”ç”¨ä¹Ÿä¼šå—å½±å“

// å®è·µä¸­ï¼š
// - ä½¿ç”¨é”™è¯¯è¾¹ç•Œéš”ç¦»å„ä¸ªåŒºåŸŸ
// - ä¸»åº”ç”¨çš„å…³é”®åŠŸèƒ½åšå¥½å®¹é”™
// - å®šæœŸä¿å­˜çŠ¶æ€åˆ° localStorage

// æç«¯æ–¹æ¡ˆï¼šå­åº”ç”¨ä½¿ç”¨ iframe
// å®Œå…¨éš”ç¦»ï¼Œä½†å¤±å»äº†å¾®å‰ç«¯çš„ä¼˜åŠ¿
```

---

## é—®é¢˜24ï¼šqiankun å¦‚ä½•é…åˆ TypeScript ä½¿ç”¨ï¼Ÿç±»å‹å®šä¹‰å¦‚ä½•å¤„ç†ï¼Ÿ

### TypeScript é…ç½®

```typescript
// ===== ä¸»åº”ç”¨ =====

import { registerMicroApps, start, RegistrableApp } from 'qiankun';

// å®šä¹‰å­åº”ç”¨çš„ props ç±»å‹
interface MicroAppProps {
    user: {
        id: number;
        name: string;
    };
    permissions: string[];
    onLogout: () => void;
}

const apps: RegistrableApp<MicroAppProps>[] = [
    {
        name: 'react-app',
        entry: '//localhost:8080',
        container: '#container',
        activeRule: '/react-app',
        props: {
            user: { id: 1, name: 'Admin' },
            permissions: ['read', 'write'],
            onLogout: () => console.log('logout')
        }
    }
];

registerMicroApps(apps);
start();

// ===== å­åº”ç”¨ =====

// src/types.ts
export interface MicroAppProps {
    container?: HTMLElement;
    user: {
        id: number;
        name: string;
    };
    permissions: string[];
    onLogout: () => void;
}

// src/index.tsx
export async function bootstrap() {
    console.log('bootstrap');
}

export async function mount(props: MicroAppProps) {
    const { container, user, permissions } = props;
    
    ReactDOM.render(
        <App user={user} permissions={permissions} />,
        container?.querySelector('#root') || document.getElementById('root')
    );
}

export async function unmount(props: MicroAppProps) {
    const { container } = props;
    ReactDOM.unmountComponentAtNode(
        container?.querySelector('#root') || document.getElementById('root')!
    );
}
```

---

## é—®é¢˜25ï¼šå¦‚ä½•å¤„ç†å­åº”ç”¨çš„æ‡’åŠ è½½ç»„ä»¶åœ¨ qiankun ä¸­å¤±æ•ˆçš„é—®é¢˜ï¼Ÿ

### é—®é¢˜åœºæ™¯

```javascript
// å­åº”ç”¨ä½¿ç”¨ React.lazy
const UserPage = React.lazy(() => import('./pages/User'));

// ç‹¬ç«‹è¿è¡Œï¼šæ­£å¸¸ âœ“
// qiankun åŠ è½½ï¼š404 âŒ

// åŸå› ï¼špublicPath ä¸æ­£ç¡®
// è¯·æ±‚ï¼šhttp://main.com/static/js/User.chunk.js âŒ
// åº”è¯¥ï¼šhttp://localhost:8080/static/js/User.chunk.js âœ“
```

### è§£å†³æ–¹æ¡ˆ

```javascript
// src/public-path.jsï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼‰
if (window.__POWERED_BY_QIANKUN__) {
    __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// src/index.jsï¼ˆç¬¬ä¸€è¡Œå¯¼å…¥ï¼‰
import './public-path';  // â­ å¿…é¡»åœ¨æ‰€æœ‰å¯¼å…¥ä¹‹å‰
import React from 'react';
import ReactDOM from 'react-dom';
// ... å…¶ä»–å¯¼å…¥

// è¿™æ ·æ‡’åŠ è½½çš„ chunk ä¼šä½¿ç”¨æ­£ç¡®çš„ publicPath
```

---

## é—®é¢˜26ï¼šä¸»å­åº”ç”¨éƒ½ç”¨äº† Ant Design/Element UIï¼Œå¦‚ä½•é¿å…æ ·å¼å†²çªï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹æ¡ˆ1: ä½¿ç”¨ä¸åŒçš„å‰ç¼€ï¼ˆæ¨èï¼‰=====

// ä¸»åº”ç”¨
import { ConfigProvider } from 'antd';

<ConfigProvider prefixCls="main-ant">
    <App />
</ConfigProvider>

// å­åº”ç”¨
<ConfigProvider prefixCls="sub-ant">
    <App />
</ConfigProvider>

// ç”Ÿæˆçš„ç±»åï¼š
// ä¸»åº”ç”¨ï¼š.main-ant-btn, .main-ant-modal
// å­åº”ç”¨ï¼š.sub-ant-btn, .sub-ant-modal

// ===== æ–¹æ¡ˆ2: æŒ‰éœ€å¼•å…¥æ ·å¼ =====

// ä½¿ç”¨ babel-plugin-import
{
    "plugins": [
        ["import", {
            "libraryName": "antd",
            "style": true  // åªå¼•å…¥ä½¿ç”¨åˆ°çš„ç»„ä»¶æ ·å¼
        }]
    ]
}

// ä»£ç 
import { Button, Modal } from 'antd';
// è‡ªåŠ¨è½¬æ¢ä¸ºï¼š
import Button from 'antd/es/button';
import 'antd/es/button/style';

// ===== æ–¹æ¡ˆ3: å¼€å¯æ ·å¼éš”ç¦» =====

start({
    sandbox: {
        experimentalStyleIsolation: true
    }
});

// æ‰€æœ‰æ ·å¼è‡ªåŠ¨æ·»åŠ  [data-qiankun] å±æ€§é€‰æ‹©å™¨
```

---

## é—®é¢˜27ï¼šå¦‚ä½•å¤„ç†å­åº”ç”¨çš„ç¯å¢ƒåˆ¤æ–­ï¼Ÿå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå¦‚ä½•åŒºåˆ†ï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== å­åº”ç”¨çš„ç¯å¢ƒç®¡ç† =====

// src/config/env.js
const envConfig = {
    development: {
        apiBase: 'http://localhost:3000',
        wsBase: 'ws://localhost:3001',
        cdnBase: 'http://localhost:8080'
    },
    testing: {
        apiBase: 'https://test-api.example.com',
        wsBase: 'wss://test-ws.example.com',
        cdnBase: 'https://test-cdn.example.com'
    },
    production: {
        apiBase: 'https://api.example.com',
        wsBase: 'wss://ws.example.com',
        cdnBase: 'https://cdn.example.com'
    }
};

// è·å–å½“å‰ç¯å¢ƒ
function getEnv() {
    // ä¼˜å…ˆä»ä¸»åº”ç”¨ props è·å–
    if (window.__QIANKUN_ENV__) {
        return window.__QIANKUN_ENV__;
    }
    
    // å…¶æ¬¡ä»ç¯å¢ƒå˜é‡
    return process.env.NODE_ENV || 'development';
}

export const config = envConfig[getEnv()];

// ===== ä¸»åº”ç”¨æ³¨å…¥ç¯å¢ƒä¿¡æ¯ =====

registerMicroApps([
    {
        name: 'react-app',
        props: {
            env: process.env.NODE_ENV,
            config: {
                apiBase: process.env.API_BASE
            }
        }
    }
]);

// ===== å­åº”ç”¨ä½¿ç”¨ =====

import { config } from './config/env';

axios.defaults.baseURL = config.apiBase;
```

---

## é—®é¢˜28ï¼šå­åº”ç”¨åŠ è½½å¾ˆæ…¢ï¼Œå¦‚ä½•å®šä½æ€§èƒ½ç“¶é¢ˆï¼Ÿ

### æ€§èƒ½åˆ†ææ­¥éª¤

```javascript
// ===== 1. ä½¿ç”¨ Performance API =====

registerMicroApps(apps, {
    beforeLoad: (app) => {
        console.time(`${app.name}-load`);
        performance.mark(`${app.name}-start`);
    },
    afterMount: (app) => {
        console.timeEnd(`${app.name}-load`);
        performance.mark(`${app.name}-end`);
        performance.measure(
            `${app.name}-load`,
            `${app.name}-start`,
            `${app.name}-end`
        );
        
        // æŸ¥çœ‹è¯¦ç»†æŒ‡æ ‡
        const measure = performance.getEntriesByName(`${app.name}-load`)[0];
        console.log(`${app.name} åŠ è½½è€—æ—¶: ${measure.duration}ms`);
    }
});

// ===== 2. åˆ†æèµ„æºåŠ è½½ =====

// æŸ¥çœ‹æ‰€æœ‰èµ„æºåŠ è½½æ—¶é—´
const resources = performance.getEntriesByType('resource');
resources
    .filter(r => r.name.includes('localhost:8080'))  // å­åº”ç”¨èµ„æº
    .sort((a, b) => b.duration - a.duration)  // æŒ‰è€—æ—¶æ’åº
    .forEach(r => {
        console.log(`${r.name}: ${r.duration}ms`);
    });

// ===== 3. webpack-bundle-analyzer =====

// webpack.config.js
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

module.exports = {
    plugins: [
        new BundleAnalyzerPlugin({
            analyzerMode: 'static',
            reportFilename: 'bundle-report.html'
        })
    ]
};

// è¿è¡Œåä¼šç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Šï¼ŒæŸ¥çœ‹å“ªäº›åŒ…ä½“ç§¯å¤§

// ===== 4. Chrome DevTools =====

// Network é¢æ¿ï¼š
// - æŸ¥çœ‹èµ„æºåŠ è½½æ—¶é—´
// - æŸ¥çœ‹èµ„æºå¤§å°
// - æŸ¥çœ‹å¹¶è¡Œåº¦

// Performance é¢æ¿ï¼š
// - å½•åˆ¶åŠ è½½è¿‡ç¨‹
// - æŸ¥çœ‹ Scriptingã€Rendering æ—¶é—´
// - æŸ¥æ‰¾é•¿ä»»åŠ¡
```

### å¸¸è§æ€§èƒ½é—®é¢˜

```javascript
// é—®é¢˜1: æŸä¸ª chunk ç‰¹åˆ«å¤§
// è§£å†³ï¼šä»£ç åˆ†å‰²ï¼ŒæŒ‰éœ€åŠ è½½

// é—®é¢˜2: èµ„æºåŠ è½½ä¸²è¡Œ
// è§£å†³ï¼šä½¿ç”¨ preload/prefetch

// é—®é¢˜3: ç¬¬ä¸‰æ–¹åº“å¤ªå¤§
// è§£å†³ï¼šæŒ‰éœ€å¼•å…¥ã€ä½¿ç”¨è½»é‡æ›¿ä»£

// é—®é¢˜4: é¦–å±åŒ…å«æ‰€æœ‰è·¯ç”±
// è§£å†³ï¼šè·¯ç”±æ‡’åŠ è½½
```

---

## é—®é¢˜29ï¼šqiankun åº”ç”¨å¦‚ä½•å®ç° SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰ï¼Ÿ

### ç°çŠ¶å’ŒæŒ‘æˆ˜

**qiankun ç›®å‰ä¸ç›´æ¥æ”¯æŒ SSRï¼Œä¸»è¦æŒ‘æˆ˜ï¼š**

1. æœåŠ¡ç«¯æ²¡æœ‰ DOM ç¯å¢ƒ
2. import-html-entry ä¾èµ– fetchã€DOMParser
3. æ²™ç®±ä¾èµ– Proxyã€window å¯¹è±¡

### æ›¿ä»£æ–¹æ¡ˆ

```javascript
// ===== æ–¹æ¡ˆ1: ä¸»åº”ç”¨ SSR + å­åº”ç”¨ CSR =====

// ä¸»åº”ç”¨ä½¿ç”¨ Next.js SSR
// å­åº”ç”¨å®¢æˆ·ç«¯æ¸²æŸ“

// pages/index.js (Next.js)
export default function Home() {
    useEffect(() => {
        // å®¢æˆ·ç«¯åŠ è½½å­åº”ç”¨
        if (typeof window !== 'undefined') {
            loadMicroApp({
                name: 'react-app',
                entry: '//localhost:8080',
                container: '#subapp'
            });
        }
    }, []);

    return (
        <div>
            <h1>ä¸»åº”ç”¨ï¼ˆSSRï¼‰</h1>
            <div id="subapp"></div>
        </div>
    );
}

// ===== æ–¹æ¡ˆ2: é¢„æ¸²æŸ“ =====

// ä½¿ç”¨ prerender-spa-plugin
const PrerenderSPAPlugin = require('prerender-spa-plugin');

module.exports = {
    plugins: [
        new PrerenderSPAPlugin({
            routes: ['/', '/app1', '/app2'],
            // é¢„æ¸²æŸ“é™æ€ HTML
        })
    ]
};
```

---

## é—®é¢˜30ï¼šå¦‚ä½•å®ç°å­åº”ç”¨çš„çƒ­æ›´æ–°ï¼ˆHMRï¼‰åœ¨ qiankun ä¸­æ­£å¸¸å·¥ä½œï¼Ÿ

### é…ç½®æ–¹æ¡ˆ

```javascript
// ===== å­åº”ç”¨ webpack é…ç½® =====

module.exports = {
    devServer: {
        hot: true,  // å¼€å¯ HMR
        port: 8080,
        headers: {
            'Access-Control-Allow-Origin': '*'  // å…è®¸è·¨åŸŸ
        },
        // â­ å…³é”®é…ç½®
        historyApiFallback: true,
        allowedHosts: 'all'
    }
};

// ===== src/index.js =====

import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

function render(props) {
    const { container } = props || {};
    ReactDOM.render(<App />, container?.querySelector('#root') || document.getElementById('root'));
}

// å¼€å‘ç¯å¢ƒçƒ­æ›´æ–°
if (module.hot) {
    module.hot.accept('./App', () => {
        render();
    });
}

// ç”Ÿå‘½å‘¨æœŸ
export async function mount(props) {
    render(props);
}
```

**æ³¨æ„äº‹é¡¹ï¼š**

```javascript
// 1. ä¸»åº”ç”¨ä¹Ÿéœ€è¦å¼€å¯ HMR
// å¦åˆ™ä¸»åº”ç”¨åˆ·æ–°ä¼šå¯¼è‡´å­åº”ç”¨é‡æ–°åŠ è½½

// 2. å­åº”ç”¨çš„ HMR åªåœ¨ç‹¬ç«‹è¿è¡Œæ—¶æ•ˆæœæœ€å¥½
// åœ¨ qiankun ä¸­åŠ è½½æ—¶å¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢

// 3. æ¨èå¼€å‘æ—¶ç‹¬ç«‹è¿è¡Œå­åº”ç”¨
npm run start  // å­åº”ç”¨ç‹¬ç«‹è¿è¡Œ
// åŠŸèƒ½å¼€å‘å®Œæˆåå†é›†æˆåˆ°ä¸»åº”ç”¨æµ‹è¯•
```

---

## é—®é¢˜31ï¼šå¦‚ä½•å®ç°å­åº”ç”¨çš„ç‰ˆæœ¬å›æ»šï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== 1. ä¿ç•™å¤šä¸ªç‰ˆæœ¬ =====

// éƒ¨ç½²ç»“æ„
https://cdn.example.com/react-app/
    â”œâ”€â”€ v1/
    â”‚   â”œâ”€â”€ index.html
    â”‚   â””â”€â”€ main.js
    â”œâ”€â”€ v2/
    â”‚   â”œâ”€â”€ index.html
    â”‚   â””â”€â”€ main.js
    â””â”€â”€ current -> v2/  # è½¯é“¾æ¥æŒ‡å‘å½“å‰ç‰ˆæœ¬

// ===== 2. åŠ¨æ€é…ç½®ç‰ˆæœ¬ =====

// ä»æœåŠ¡å™¨è·å–ç‰ˆæœ¬é…ç½®
const versionConfig = await fetch('/api/app-versions').then(r => r.json());
/*
{
    "react-app": "v2",
    "vue-app": "v1"
}
*/

registerMicroApps([
    {
        name: 'react-app',
        entry: `https://cdn.example.com/react-app/${versionConfig['react-app']}/index.html`,
        // ...
    }
]);

// ===== 3. å›æ»šæ“ä½œ =====

// æœåŠ¡ç«¯æ›´æ–°é…ç½®
{
    "react-app": "v1"  // ä» v2 å›æ»šåˆ° v1
}

// ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œè‡ªåŠ¨åŠ è½½ v1 ç‰ˆæœ¬

// ===== 4. å®æ—¶å›æ»šï¼ˆæ— éœ€åˆ·æ–°ï¼‰=====

// ä¸»åº”ç”¨ç›‘å¬é…ç½®å˜åŒ–
setInterval(async () => {
    const newConfig = await fetch('/api/app-versions').then(r => r.json());
    
    if (newConfig['react-app'] !== currentVersion) {
        // ç‰ˆæœ¬å˜åŒ–ï¼Œé‡æ–°åŠ è½½åº”ç”¨
        const app = microApps.find(a => a.name === 'react-app');
        await app.unmount();
        
        // æ›´æ–° entry
        app.entry = `https://cdn.example.com/react-app/${newConfig['react-app']}/index.html`;
        
        await app.mount();
    }
}, 60000);  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

## é—®é¢˜32ï¼šå­åº”ç”¨çš„å›½é™…åŒ–ï¼ˆi18nï¼‰å¦‚ä½•å®ç°ï¼Ÿå¦‚ä½•ä¸ä¸»åº”ç”¨åŒæ­¥è¯­è¨€åˆ‡æ¢ï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== ä¸»åº”ç”¨ =====

import { initGlobalState } from 'qiankun';

const actions = initGlobalState({
    locale: 'zh-CN'  // å½“å‰è¯­è¨€
});

// åˆ‡æ¢è¯­è¨€
function changeLanguage(newLocale) {
    actions.setGlobalState({ locale: newLocale });
    
    // ä¸»åº”ç”¨åˆ‡æ¢è¯­è¨€
    i18n.changeLanguage(newLocale);
}

// ä¼ é€’ç»™å­åº”ç”¨
registerMicroApps([
    {
        name: 'react-app',
        props: { 
            globalState: actions,
            locale: 'zh-CN'
        }
    }
]);

// ===== å­åº”ç”¨ï¼ˆreact-i18nextï¼‰=====

import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

// åˆå§‹åŒ– i18n
i18n.use(initReactI18next).init({
    resources: {
        'zh-CN': { translation: require('./locales/zh-CN.json') },
        'en-US': { translation: require('./locales/en-US.json') }
    },
    lng: 'zh-CN',
    fallbackLng: 'zh-CN'
});

export async function mount(props) {
    const { globalState, locale } = props;
    
    // è®¾ç½®åˆå§‹è¯­è¨€
    i18n.changeLanguage(locale);
    
    // ç›‘å¬è¯­è¨€åˆ‡æ¢
    globalState.onGlobalStateChange((state, prev) => {
        if (state.locale !== prev.locale) {
            i18n.changeLanguage(state.locale);
        }
    });
    
    ReactDOM.render(<App />, props.container);
}
```

---

## é—®é¢˜33ï¼šqiankun å¦‚ä½•é…åˆ Vite ä½¿ç”¨ï¼Ÿæœ‰ä»€ä¹ˆæ³¨æ„äº‹é¡¹ï¼Ÿ

### Vite å­åº”ç”¨é…ç½®

```javascript
// ===== vite.config.js =====

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import qiankun from 'vite-plugin-qiankun';

export default defineConfig({
    plugins: [
        react(),
        qiankun('react-app', {
            useDevMode: true
        })
    ],
    server: {
        port: 8080,
        cors: true,  // â­ å…è®¸è·¨åŸŸ
        origin: 'http://localhost:8080'
    },
    base: './',  // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    build: {
        target: 'esnext',
        minify: false,
        cssCodeSplit: false
    }
});

// ===== src/main.js =====

import { renderWithQiankun, qiankunWindow } from 'vite-plugin-qiankun/dist/helper';
import { createApp } from 'vue';
import App from './App.vue';

let app;

function render(props = {}) {
    const { container } = props;
    app = createApp(App);
    app.mount(container ? container.querySelector('#app') : '#app');
}

// Vite æ’ä»¶ä¼šè‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ
renderWithQiankun({
    bootstrap() {
        console.log('bootstrap');
    },
    mount(props) {
        render(props);
    },
    unmount() {
        app?.unmount();
    }
});

// ç‹¬ç«‹è¿è¡Œ
if (!qiankunWindow.__POWERED_BY_QIANKUN__) {
    render();
}
```

---

## é—®é¢˜34ï¼šå¦‚ä½•å®ç°å­åº”ç”¨çš„æŒ‰é’®çº§åˆ«æƒé™æ§åˆ¶ï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== ä¸»åº”ç”¨ä¼ é€’æƒé™ =====

const permissions = getUserPermissions();  // ['user:read', 'user:write', 'admin:read']

registerMicroApps([
    {
        name: 'react-app',
        props: { permissions }
    }
]);

// ===== å­åº”ç”¨æƒé™ç»„ä»¶ =====

// components/PermissionButton.jsx
function PermissionButton({ permission, children, ...props }) {
    const { permissions } = useContext(PermissionsContext);
    
    // æ£€æŸ¥æƒé™
    if (!permissions.includes(permission)) {
        return null;  // æ— æƒé™ï¼Œä¸æ˜¾ç¤º
    }
    
    return <button {...props}>{children}</button>;
}

// ä½¿ç”¨
<PermissionButton permission="user:delete" onClick={handleDelete}>
    åˆ é™¤ç”¨æˆ·
</PermissionButton>

// ===== è·¯ç”±çº§æƒé™ =====

function PrivateRoute({ permission, element }) {
    const { permissions } = useContext(PermissionsContext);
    
    if (!permissions.includes(permission)) {
        return <Navigate to="/403" />;
    }
    
    return element;
}

// ä½¿ç”¨
<Routes>
    <Route path="/users" element={
        <PrivateRoute permission="user:read" element={<Users />} />
    } />
    <Route path="/admin" element={
        <PrivateRoute permission="admin:read" element={<Admin />} />
    } />
</Routes>
```

---

## é—®é¢˜35ï¼šå­åº”ç”¨ä¸­ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹ SDKï¼ˆå¦‚åœ°å›¾ã€æ”¯ä»˜ï¼‰ï¼Œå¦‚ä½•å¤„ç†è„šæœ¬åŠ è½½ï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹å¼1: åœ¨ä¸»åº”ç”¨åŠ è½½ï¼ˆæ¨èï¼‰=====

// ä¸»åº”ç”¨ index.html
<script src="https://api.map.baidu.com/api?v=3.0&ak=YOUR_AK"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>

// å­åº”ç”¨ç›´æ¥ä½¿ç”¨
export async function mount(props) {
    // ä½¿ç”¨ç™¾åº¦åœ°å›¾
    const map = new BMap.Map('map-container');
    
    // ä½¿ç”¨å¾®ä¿¡ SDK
    wx.config({ /* ... */ });
}

// ===== æ–¹å¼2: å­åº”ç”¨åŠ¨æ€åŠ è½½ =====

// utils/loadScript.js
export function loadScript(url) {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        const existingScript = document.querySelector(`script[src="${url}"]`);
        if (existingScript) {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// ä½¿ç”¨
export async function mount(props) {
    // åŠ è½½åœ°å›¾ SDK
    await loadScript('https://api.map.baidu.com/api?v=3.0&ak=YOUR_AK');
    
    // åˆå§‹åŒ–åœ°å›¾
    const map = new BMap.Map('map-container');
}

export async function unmount(props) {
    // â­ æ¸…ç† SDK
    const script = document.querySelector('script[src*="api.map.baidu.com"]');
    if (script) {
        script.remove();
    }
    
    // æ¸…ç†å…¨å±€å¯¹è±¡
    delete window.BMap;
}
```

---

## é—®é¢˜36ï¼šå¦‚ä½•å¤„ç†å­åº”ç”¨çš„ 404 é¡µé¢ï¼Ÿ

### å®ç°æ–¹æ¡ˆ

```javascript
// ===== æ–¹å¼1: å­åº”ç”¨å†…éƒ¨å¤„ç† =====

// å­åº”ç”¨è·¯ç”±é…ç½®
<Routes>
    <Route path="/" element={<Home />} />
    <Route path="/about" element={<About />} />
    {/* â­ æ•è·æ‰€æœ‰æœªåŒ¹é…çš„è·¯ç”± */}
    <Route path="*" element={<NotFound />} />
</Routes>

// NotFound ç»„ä»¶
function NotFound() {
    const navigate = useNavigate();
    
    return (
        <div>
            <h1>é¡µé¢ä¸å­˜åœ¨</h1>
            <button onClick={() => navigate('/')}>è¿”å›é¦–é¡µ</button>
            {/* æˆ–è¿”å›ä¸»åº”ç”¨ */}
            <button onClick={() => window.history.back()}>è¿”å›</button>
        </div>
    );
}

// ===== æ–¹å¼2: ä¸»åº”ç”¨ç»Ÿä¸€å¤„ç† =====

// ä¸»åº”ç”¨
<Routes>
    <Route path="/app1/*" element={<MicroApp name="app1" />} />
    <Route path="/app2/*" element={<MicroApp name="app2" />} />
    {/* ä¸»åº”ç”¨çš„ 404 */}
    <Route path="*" element={<MainNotFound />} />
</Routes>
```

---

## é—®é¢˜37ï¼šCSS-in-JSï¼ˆstyled-components/emotionï¼‰åœ¨ qiankun ä¸­æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ

### æ½œåœ¨é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

```javascript
// ===== é—®é¢˜1: æ ·å¼æœªéš”ç¦» =====

// styled-components ç”Ÿæˆçš„æ ·å¼ä¼šæ’å…¥åˆ° document.head
// å¯èƒ½å½±å“ä¸»åº”ç”¨

// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ StyleSheetManager
import { StyleSheetManager } from 'styled-components';

export async function mount(props) {
    const { container } = props;
    
    // â­ æŒ‡å®šæ ·å¼æ’å…¥ä½ç½®
    ReactDOM.render(
        <StyleSheetManager target={container.querySelector('head') || document.head}>
            <App />
        </StyleSheetManager>,
        container
    );
}

// ===== é—®é¢˜2: é‡å¤åŠ è½½æ ·å¼ =====

// styled-components ä¼šåœ¨ sheet ä¸­è®°å½•å·²æ³¨å…¥çš„æ ·å¼
// ä½†å­åº”ç”¨é‡æ–°æŒ‚è½½æ—¶ï¼Œsheet å¯èƒ½è¢«æ¸…ç©º

// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ qiankun çš„æ ·å¼éš”ç¦»
start({
    sandbox: {
        experimentalStyleIsolation: true
    }
});

// ===== é—®é¢˜3: SSR æ ·å¼ä¸ç”Ÿæ•ˆ =====

// å¦‚æœå­åº”ç”¨æœ‰ SSRï¼ŒæœåŠ¡ç«¯ç”Ÿæˆçš„æ ·å¼å¯èƒ½ä¸¢å¤±

// è§£å†³æ–¹æ¡ˆï¼šä¸åœ¨å­åº”ç”¨ä½¿ç”¨ SSR
// æˆ–ç¡®ä¿ styled-components çš„ ServerStyleSheet æ­£ç¡®é…ç½®
```

---

## é—®é¢˜38ï¼šä¸»åº”ç”¨ä½¿ç”¨äº†å…¨å±€çš„ axios æ‹¦æˆªå™¨ï¼Œä¼šå½±å“å­åº”ç”¨å—ï¼Ÿ

### é—®é¢˜åˆ†æ

```javascript
// ä¸»åº”ç”¨
import axios from 'axios';

// å…¨å±€æ‹¦æˆªå™¨
axios.interceptors.request.use(config => {
    config.headers.Authorization = `Bearer ${getToken()}`;
    return config;
});

// å­åº”ç”¨
import axios from 'axios';

axios.get('/api/data');  
// ä¼šä½¿ç”¨ä¸»åº”ç”¨çš„æ‹¦æˆªå™¨å—ï¼Ÿ

// ç­”æ¡ˆï¼šä¼šï¼
// å› ä¸ºéƒ½æ˜¯åŒä¸€ä¸ª axios å®ä¾‹ï¼ˆå¦‚æœå…±äº«ä¾èµ–ï¼‰
```

### è§£å†³æ–¹æ¡ˆ

```javascript
// ===== æ–¹æ¡ˆ1: å­åº”ç”¨ä½¿ç”¨ç‹¬ç«‹çš„ axios å®ä¾‹ =====

// å­åº”ç”¨
import axios from 'axios';

// åˆ›å»ºç‹¬ç«‹å®ä¾‹
const api = axios.create({
    baseURL: process.env.API_BASE
});

// æ·»åŠ è‡ªå·±çš„æ‹¦æˆªå™¨
api.interceptors.request.use(config => {
    // å­åº”ç”¨çš„é€»è¾‘
    return config;
});

// ä½¿ç”¨ç‹¬ç«‹å®ä¾‹
api.get('/data');

// ===== æ–¹æ¡ˆ2: ä¸å…±äº« axios =====

// å­åº”ç”¨ webpack é…ç½®
module.exports = {
    externals: {
        // âŒ ä¸è¦ external axios
        // 'axios': 'axios',
    }
};

// æ¯ä¸ªåº”ç”¨æ‰“åŒ…è‡ªå·±çš„ axios
// äº’ä¸å½±å“

// ===== æ–¹æ¡ˆ3: é‡ç½®æ‹¦æˆªå™¨ =====

export async function mount(props) {
    // æ¸…é™¤ç°æœ‰æ‹¦æˆªå™¨
    axios.interceptors.request.handlers = [];
    axios.interceptors.response.handlers = [];
    
    // æ·»åŠ å­åº”ç”¨çš„æ‹¦æˆªå™¨
    axios.interceptors.request.use(/* ... */);
}

export async function unmount(props) {
    // æ¸…ç†æ‹¦æˆªå™¨
    axios.interceptors.request.handlers = [];
    axios.interceptors.response.handlers = [];
}
```

---

## é—®é¢˜39ï¼šå¦‚ä½•åœ¨ qiankun ä¸­ä½¿ç”¨ Webpack Module Federationï¼Ÿ

### é…ç½®æ–¹æ¡ˆ

```javascript
// ===== ä¸»åº”ç”¨ webpack é…ç½® =====

const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
    plugins: [
        new ModuleFederationPlugin({
            name: 'mainApp',
            remotes: {
                // â­ å­åº”ç”¨ä½œä¸ºè¿œç¨‹æ¨¡å—
                reactApp: 'reactApp@http://localhost:8080/remoteEntry.js',
                vueApp: 'vueApp@http://localhost:8081/remoteEntry.js'
            },
            shared: {
                react: { singleton: true },
                'react-dom': { singleton: true }
            }
        })
    ]
};

// ===== å­åº”ç”¨ webpack é…ç½® =====

module.exports = {
    plugins: [
        new ModuleFederationPlugin({
            name: 'reactApp',
            filename: 'remoteEntry.js',
            exposes: {
                // æš´éœ²ç»„ä»¶
                './Button': './src/components/Button',
                './UserCard': './src/components/UserCard',
                // æš´éœ²æ•´ä¸ªåº”ç”¨
                './App': './src/App'
            },
            shared: {
                react: { singleton: true },
                'react-dom': { singleton: true }
            }
        })
    ]
};

// ===== ä¸»åº”ç”¨ä½¿ç”¨å­åº”ç”¨ç»„ä»¶ =====

// åŠ¨æ€å¯¼å…¥
const RemoteButton = React.lazy(() => import('reactApp/Button'));

function MainApp() {
    return (
        <Suspense fallback={<Loading />}>
            <RemoteButton onClick={() => console.log('clicked')} />
        </Suspense>
    );
}

// ===== ä¸ qiankun ç»“åˆ =====

// å¯ä»¥åŒæ—¶ä½¿ç”¨ qiankun å’Œ Module Federation
// qiankun: åŠ è½½å®Œæ•´åº”ç”¨
// Module Federation: å…±äº«ç»„ä»¶å’Œä¾èµ–
```

---

## é—®é¢˜40ï¼šå‰ç«¯å¾®æœåŠ¡å’Œå¾®å‰ç«¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿqiankun å±äºå“ªä¸€ç§ï¼Ÿ

### æ¦‚å¿µåŒºåˆ†

**å¾®å‰ç«¯ï¼ˆMicro Frontendsï¼‰ï¼š**
- å‰ç«¯åº”ç”¨çš„æ‹†åˆ†å’Œç»„åˆ
- è¿è¡Œåœ¨åŒä¸€ä¸ªæµè§ˆå™¨é¡µé¢
- å…±äº«åŒä¸€ä¸ª window å¯¹è±¡ï¼ˆéœ€è¦éš”ç¦»ï¼‰
- qiankun æ˜¯å¾®å‰ç«¯æ¡†æ¶ âœ“

**å‰ç«¯å¾®æœåŠ¡ï¼ˆFrontend Microservicesï¼‰ï¼š**
- å‰ç«¯æœåŠ¡çš„æ‹†åˆ†
- ç‹¬ç«‹çš„å‰ç«¯æœåŠ¡ï¼ˆç‹¬ç«‹åŸŸå/ç«¯å£ï¼‰
- å®Œå…¨ç‹¬ç«‹ï¼Œé€šè¿‡ API æˆ– iframe é€šä¿¡
- æ›´å¼ºè°ƒæœåŠ¡çš„ç‹¬ç«‹æ€§

### å¯¹æ¯”

| ç‰¹æ€§ | å¾®å‰ç«¯ï¼ˆqiankunï¼‰ | å‰ç«¯å¾®æœåŠ¡ |
|------|-----------------|-----------|
| **åº”ç”¨å…³ç³»** | ç»„åˆåœ¨ä¸€èµ· | å®Œå…¨ç‹¬ç«‹ |
| **URL** | å…±äº«åŸŸå | ç‹¬ç«‹åŸŸå |
| **é€šä¿¡** | props/globalState | API/postMessage |
| **éš”ç¦»** | æ²™ç®± | å®Œå…¨éš”ç¦»ï¼ˆå¤©ç„¶ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | ç»Ÿä¸€ | å¯èƒ½ä¸ç»Ÿä¸€ |
| **æŠ€æœ¯æ ˆ** | å¯ä»¥ä¸åŒ | å¯ä»¥ä¸åŒ |

### qiankun çš„å®šä½

```
qiankun = å¾®å‰ç«¯æ¡†æ¶

åŠŸèƒ½ï¼š
1. åº”ç”¨åŠ è½½ï¼ˆHTML Entryï¼‰
2. JavaScript éš”ç¦»ï¼ˆæ²™ç®±ï¼‰
3. æ ·å¼éš”ç¦»
4. åº”ç”¨é€šä¿¡
5. ç”Ÿå‘½å‘¨æœŸç®¡ç†

ç›®æ ‡ï¼š
- è®©å¤šä¸ªå‰ç«¯åº”ç”¨ç»„åˆæˆä¸€ä¸ªæ•´ä½“
- ç”¨æˆ·ä½“éªŒç»Ÿä¸€
- æŠ€æœ¯æ ˆå¯ä»¥ä¸åŒ
- å›¢é˜Ÿå¯ä»¥ç‹¬ç«‹å¼€å‘
```

---

## ğŸ“ æ€»ç»“

è¿™20ä¸ªå®æˆ˜é—®é¢˜æ¶µç›–äº†ï¼š

1. **ä¾èµ–ç®¡ç†**ï¼ˆ1, 4, 20, 38ï¼‰
2. **å¼€å‘è°ƒè¯•**ï¼ˆ2, 6, 25, 30ï¼‰
3. **é…ç½®é—®é¢˜**ï¼ˆ3, 5, 10, 12ï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**ï¼ˆ13, 28ï¼‰
5. **é”™è¯¯å¤„ç†**ï¼ˆ8, 17, 23ï¼‰
6. **é€šä¿¡æœºåˆ¶**ï¼ˆ7, 9, 32ï¼‰
7. **æ ·å¼å¤„ç†**ï¼ˆ11, 26, 37ï¼‰
8. **æƒé™æ§åˆ¶**ï¼ˆ16, 34ï¼‰
9. **éƒ¨ç½²è¿ç»´**ï¼ˆ18, 21, 31ï¼‰
10. **æ–°æŠ€æœ¯**ï¼ˆ33, 39, 40ï¼‰

æŒæ¡è¿™äº›å®æˆ˜é—®é¢˜ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š
- âœ… å¿«é€Ÿæ­å»ºå¾®å‰ç«¯é¡¹ç›®
- âœ… è§£å†³å¸¸è§çš„å‘å’Œé—®é¢˜
- âœ… ä¼˜åŒ–åº”ç”¨æ€§èƒ½
- âœ… åº”å¯¹å„ç§é¢è¯•åœºæ™¯

ç¥æ‚¨é¢è¯•æˆåŠŸï¼ğŸ‰

