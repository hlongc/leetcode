# é—®é¢˜27ï¼šqiankun çš„èµ„æºé¢„åŠ è½½ï¼ˆprefetchï¼‰æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸrequestIdleCallback åœ¨å…¶ä¸­èµ·ä»€ä¹ˆä½œç”¨ï¼Ÿ

## ğŸ“Œ é¢„åŠ è½½çš„æ ¸å¿ƒæ€æƒ³

**ç©ºé—²æ—¶åŠ è½½ï¼ŒæŒ‰éœ€æ‰§è¡Œ**

1. **é¦–å±ä¼˜å…ˆ**ï¼šä¸å½±å“é¦–å±åº”ç”¨çš„åŠ è½½
2. **ç©ºé—²åŠ è½½**ï¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é¢„åŠ è½½å…¶ä»–åº”ç”¨
3. **èµ„æºç¼“å­˜**ï¼šåˆ©ç”¨ import-html-entry çš„ç¼“å­˜æœºåˆ¶
4. **å»¶è¿Ÿæ‰§è¡Œ**ï¼šåªä¸‹è½½èµ„æºï¼Œä¸æ‰§è¡Œè„šæœ¬

## ğŸ¯ é¢„åŠ è½½çš„å®ç°åŸç†

### åŸºæœ¬å®ç°

```javascript
// é¢„åŠ è½½å•ä¸ªåº”ç”¨
async function prefetchApp(app, options = {}) {
    const { entry } = app;
    const { fetch } = options;

    try {
        // 1. åŠ è½½å…¥å£ï¼Œè·å–èµ„æºåˆ—è¡¨
        const { getExternalScripts, getExternalStyleSheets } = await importEntry(entry, { fetch });

        // 2. è§¦å‘èµ„æºä¸‹è½½ï¼ˆå¹¶è¡Œï¼‰
        await Promise.all([
            getExternalScripts(),      // ä¸‹è½½æ‰€æœ‰ JS
            getExternalStyleSheets()   // ä¸‹è½½æ‰€æœ‰ CSS
        ]);

        console.log(`é¢„åŠ è½½å®Œæˆ: ${app.name}`);
    } catch (error) {
        console.error(`é¢„åŠ è½½å¤±è´¥: ${app.name}`, error);
    }
}
```

### æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥

```javascript
// qiankun çš„æ™ºèƒ½é¢„åŠ è½½ï¼ˆåŸºäºæ—§ç‰ˆæœ¬ï¼‰

function doPrefetchStrategy(apps, prefetch, importEntryOpts) {
    // 1. è·å–é¦–å±åº”ç”¨
    const firstScreenApps = getFirstScreenApps(apps);
    
    // 2. è·å–éœ€è¦é¢„åŠ è½½çš„åº”ç”¨
    const appsToPreload = apps.filter(app => !firstScreenApps.includes(app));

    if (prefetch === true) {
        // â­ é¦–å±åŠ è½½å®Œæˆåï¼Œç©ºé—²æ—¶é¢„åŠ è½½
        window.addEventListener('load', () => {
            requestIdleCallback(() => {
                appsToPreload.forEach(app => {
                    prefetchApp(app, importEntryOpts);
                });
            });
        });
    } else if (prefetch === 'all') {
        // ç«‹å³é¢„åŠ è½½æ‰€æœ‰åº”ç”¨
        appsToPreload.forEach(app => {
            prefetchApp(app, importEntryOpts);
        });
    } else if (Array.isArray(prefetch)) {
        // é¢„åŠ è½½æŒ‡å®šçš„åº”ç”¨
        const appsToLoad = apps.filter(app => prefetch.includes(app.name));
        appsToLoad.forEach(app => {
            prefetchApp(app, importEntryOpts);
        });
    }
}

// è·å–é¦–å±åº”ç”¨
function getFirstScreenApps(apps) {
    const currentPath = window.location.pathname;
    
    return apps.filter(app => {
        const { activeRule } = app;
        
        if (typeof activeRule === 'string') {
            return currentPath.startsWith(activeRule);
        }
        
        if (typeof activeRule === 'function') {
            return activeRule(window.location);
        }
        
        return false;
    });
}
```

## â° requestIdleCallback çš„ä½œç”¨

### ä»€ä¹ˆæ˜¯ requestIdleCallbackï¼Ÿ

```javascript
// requestIdleCallback: åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œå›è°ƒ

requestIdleCallback((deadline) => {
    // deadline.timeRemaining(): å‰©ä½™ç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    // deadline.didTimeout: æ˜¯å¦è¶…æ—¶
    
    while (deadline.timeRemaining() > 0 && tasks.length > 0) {
        const task = tasks.shift();
        task();
    }
});
```

**æµè§ˆå™¨çš„å¸§æ¸²æŸ“ï¼š**

```
ä¸€å¸§ï¼ˆ16.67ms @ 60fpsï¼‰
â”œâ”€ JavaScript æ‰§è¡Œ (8ms)
â”œâ”€ æ ·å¼è®¡ç®— (2ms)
â”œâ”€ å¸ƒå±€ (2ms)
â”œâ”€ ç»˜åˆ¶ (2ms)
â””â”€ ç©ºé—²æ—¶é—´ (2.67ms) â­ requestIdleCallback åœ¨è¿™é‡Œæ‰§è¡Œ
```

### åœ¨é¢„åŠ è½½ä¸­çš„åº”ç”¨

```javascript
function prefetchApps(apps) {
    window.addEventListener('load', () => {
        // â­ é¦–å±åŠ è½½å®Œæˆåï¼Œåœ¨ç©ºé—²æ—¶é¢„åŠ è½½
        requestIdleCallback(
            (deadline) => {
                let i = 0;
                
                // åœ¨ç©ºé—²æ—¶é—´å†…ï¼Œå°½å¯èƒ½å¤šåœ°é¢„åŠ è½½
                while (deadline.timeRemaining() > 0 && i < apps.length) {
                    prefetchApp(apps[i]);
                    i++;
                }
                
                // å¦‚æœè¿˜æœ‰æœªåŠ è½½çš„åº”ç”¨ï¼Œç»§ç»­è¯·æ±‚ç©ºé—²æ—¶é—´
                if (i < apps.length) {
                    requestIdleCallback(() => {
                        prefetchApps(apps.slice(i));
                    });
                }
            },
            { timeout: 2000 }  // æœ€å¤šç­‰å¾… 2 ç§’
        );
    });
}
```

**ä¸ºä»€ä¹ˆç”¨ requestIdleCallbackï¼Ÿ**

```javascript
// ä¸ç”¨ requestIdleCallbackï¼ˆç«‹å³é¢„åŠ è½½ï¼‰
window.addEventListener('load', () => {
    apps.forEach(app => prefetchApp(app));
});

// é—®é¢˜ï¼š
// - å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹
// - å½±å“ç”¨æˆ·äº¤äº’
// - é¦–å±åçš„æ“ä½œå˜æ…¢

// ä½¿ç”¨ requestIdleCallbackï¼ˆç©ºé—²æ—¶é¢„åŠ è½½ï¼‰
window.addEventListener('load', () => {
    requestIdleCallback(() => {
        apps.forEach(app => prefetchApp(app));
    });
});

// å¥½å¤„ï¼š
// - ä¸é˜»å¡ä¸»çº¿ç¨‹
// - ä¸å½±å“ç”¨æˆ·äº¤äº’
// - å……åˆ†åˆ©ç”¨ç©ºé—²æ—¶é—´
```

### requestIdleCallback å…¼å®¹æ€§å¤„ç†

```javascript
// import-html-entry çš„ polyfill
// src/utils.js: 106-119

export const requestIdleCallback =
    window.requestIdleCallback ||
    function requestIdleCallback(cb) {
        const start = Date.now();
        return setTimeout(() => {
            cb({
                didTimeout: false,
                timeRemaining() {
                    return Math.max(0, 50 - (Date.now() - start));
                },
            });
        }, 1);
    };
```

**å…¼å®¹æ€§ï¼š**
- Chrome 47+
- Firefox 55+
- Edge 79+
- Safari: âŒ ä¸æ”¯æŒï¼ˆä½¿ç”¨ polyfillï¼‰

## ğŸš€ é«˜çº§é¢„åŠ è½½ç­–ç•¥

### 1. ä¼˜å…ˆçº§é˜Ÿåˆ—

```javascript
class PrefetchScheduler {
    constructor() {
        this.highPriorityQueue = [];
        this.normalPriorityQueue = [];
        this.lowPriorityQueue = [];
    }

    add(app, priority = 'normal') {
        const queue = {
            high: this.highPriorityQueue,
            normal: this.normalPriorityQueue,
            low: this.lowPriorityQueue
        }[priority];
        
        queue.push(app);
    }

    async start() {
        // 1. ç«‹å³åŠ è½½é«˜ä¼˜å…ˆçº§
        await Promise.all(
            this.highPriorityQueue.map(app => prefetchApp(app))
        );

        // 2. ç©ºé—²æ—¶åŠ è½½æ™®é€šä¼˜å…ˆçº§
        requestIdleCallback(() => {
            this.normalPriorityQueue.forEach(app => prefetchApp(app));
        });

        // 3. éå¸¸ç©ºé—²æ—¶åŠ è½½ä½ä¼˜å…ˆçº§
        requestIdleCallback(() => {
            this.lowPriorityQueue.forEach(app => prefetchApp(app));
        }, { timeout: 5000 });
    }
}

// ä½¿ç”¨
const scheduler = new PrefetchScheduler();
scheduler.add(importantApp, 'high');    // é‡è¦åº”ç”¨
scheduler.add(normalApp, 'normal');     // æ™®é€šåº”ç”¨
scheduler.add(rarelyUsedApp, 'low');    // å¾ˆå°‘ä½¿ç”¨çš„åº”ç”¨
scheduler.start();
```

### 2. ç½‘ç»œæ„ŸçŸ¥é¢„åŠ è½½

```javascript
function shouldPrefetch() {
    // æ£€æŸ¥ç½‘ç»œçŠ¶å†µ
    const connection = navigator.connection || 
                       navigator.mozConnection || 
                       navigator.webkitConnection;
    
    if (!connection) {
        return true;  // æ— æ³•æ£€æµ‹ï¼Œé»˜è®¤å…è®¸
    }

    // æ…¢é€Ÿç½‘ç»œä¸é¢„åŠ è½½
    const slowConnections = ['slow-2g', '2g', '3g'];
    if (slowConnections.includes(connection.effectiveType)) {
        console.log('ç½‘ç»œè¾ƒæ…¢ï¼Œè·³è¿‡é¢„åŠ è½½');
        return false;
    }

    // çœæµé‡æ¨¡å¼ä¸é¢„åŠ è½½
    if (connection.saveData) {
        console.log('çœæµé‡æ¨¡å¼ï¼Œè·³è¿‡é¢„åŠ è½½');
        return false;
    }

    // 4Gã€WiFi ç­‰å¿«é€Ÿç½‘ç»œï¼Œé¢„åŠ è½½
    return true;
}

// ä½¿ç”¨
if (shouldPrefetch()) {
    requestIdleCallback(() => {
        prefetchApps(apps);
    });
}
```

### 3. æ¸è¿›å¼é¢„åŠ è½½

```javascript
// æŒ‰éœ€é¢„åŠ è½½ï¼Œé€æ­¥æ‰©å¤§èŒƒå›´

class ProgressivePrefetcher {
    constructor(apps) {
        this.apps = apps;
        this.prefetched = new Set();
    }

    async prefetchNext(count = 1) {
        const toPrefetch = this.apps
            .filter(app => !this.prefetched.has(app.name))
            .slice(0, count);

        for (const app of toPrefetch) {
            await prefetchApp(app);
            this.prefetched.add(app.name);
        }

        console.log(`å·²é¢„åŠ è½½ ${this.prefetched.size}/${this.apps.length} ä¸ªåº”ç”¨`);
    }

    startProgressive() {
        // é¦–å±å®Œæˆåï¼Œé¢„åŠ è½½ç¬¬1ä¸ª
        window.addEventListener('load', () => {
            requestIdleCallback(() => this.prefetchNext(1));
        });

        // 5ç§’åï¼Œé¢„åŠ è½½ç¬¬2ä¸ª
        setTimeout(() => {
            requestIdleCallback(() => this.prefetchNext(1));
        }, 5000);

        // 10ç§’åï¼Œé¢„åŠ è½½å‰©ä½™çš„
        setTimeout(() => {
            requestIdleCallback(() => this.prefetchNext(10));
        }, 10000);
    }
}
```

### 4. æ™ºèƒ½é¢„æµ‹é¢„åŠ è½½

```javascript
// æ ¹æ®ç”¨æˆ·è¡Œä¸ºé¢„æµ‹ï¼Œæå‰é¢„åŠ è½½

class SmartPrefetcher {
    constructor(apps) {
        this.apps = apps;
        this.hoveredApps = new Map();
    }

    // ç›‘å¬å¯¼èˆªé“¾æ¥çš„ hover
    init() {
        document.addEventListener('mouseover', (e) => {
            const link = e.target.closest('a[href]');
            if (!link) return;

            const href = link.getAttribute('href');
            const app = this.findAppByPath(href);
            
            if (app && !this.hoveredApps.has(app.name)) {
                // ç”¨æˆ· hover äº†é“¾æ¥ï¼Œé¢„åŠ è½½å¯¹åº”åº”ç”¨
                console.log(`ç”¨æˆ·å…³æ³¨ ${app.name}ï¼Œå¼€å§‹é¢„åŠ è½½`);
                
                this.hoveredApps.set(app.name, Date.now());
                prefetchApp(app);
            }
        });
    }

    findAppByPath(path) {
        return this.apps.find(app => {
            const { activeRule } = app;
            if (typeof activeRule === 'string') {
                return path.startsWith(activeRule);
            }
            return false;
        });
    }
}

// ä½¿ç”¨
const smartPrefetcher = new SmartPrefetcher(apps);
smartPrefetcher.init();

// æ•ˆæœï¼š
// ç”¨æˆ·é¼ æ ‡æ‚¬åœåœ¨"å•†å“ä¸­å¿ƒ"é“¾æ¥ä¸Š
// â†’ ç«‹å³é¢„åŠ è½½å•†å“åº”ç”¨
// â†’ ç”¨æˆ·ç‚¹å‡»æ—¶ç§’å¼€ âœ“
```

## ğŸ“ é¢è¯•è¦ç‚¹

### æ ¸å¿ƒåŸç†

1. **importEntry**ï¼šåŠ è½½ä½†ä¸æ‰§è¡Œ
2. **ç¼“å­˜åˆ©ç”¨**ï¼šèµ„æºç¼“å­˜åˆ° scriptCache/styleCache
3. **å¼‚æ­¥åŠ è½½**ï¼šä¸é˜»å¡ä¸»æµç¨‹
4. **ç©ºé—²æ‰§è¡Œ**ï¼šrequestIdleCallback

### requestIdleCallback çš„ä½œç”¨

1. **ç©ºé—²æ£€æµ‹**ï¼šæµè§ˆå™¨ç©ºé—²æ—¶æ‰æ‰§è¡Œ
2. **ä¸é˜»å¡**ï¼šä¸å½±å“ç”¨æˆ·äº¤äº’
3. **æ—¶é—´é¢„ç®—**ï¼štimeRemaining() æ§åˆ¶æ‰§è¡Œæ—¶é•¿
4. **ä¼˜é›…é™çº§**ï¼špolyfill å…¼å®¹

### é«˜çº§ç­–ç•¥

1. **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šå…³é”®åº”ç”¨ä¼˜å…ˆ
2. **ç½‘ç»œæ„ŸçŸ¥**ï¼šæ…¢é€Ÿç½‘ç»œä¸é¢„åŠ è½½
3. **æ¸è¿›å¼**ï¼šé€æ­¥æ‰©å¤§é¢„åŠ è½½èŒƒå›´
4. **æ™ºèƒ½é¢„æµ‹**ï¼šåŸºäºç”¨æˆ·è¡Œä¸º

### æ€§èƒ½ä¼˜åŒ–

1. **å¹¶è¡Œä¸‹è½½**ï¼šPromise.all
2. **åˆ†æ‰¹åŠ è½½**ï¼šé¿å…ä¸€æ¬¡åŠ è½½å¤ªå¤š
3. **æŒ‰éœ€é¢„åŠ è½½**ï¼šä¸æ˜¯æ‰€æœ‰åº”ç”¨éƒ½é¢„åŠ è½½
4. **ç½‘ç»œæ¡ä»¶**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´

## ğŸ’¡ æœ€ä½³å®è·µ

```javascript
// å®Œæ•´çš„é¢„åŠ è½½æ–¹æ¡ˆ

function setupPrefetch(apps, options = {}) {
    const {
        strategy = 'idle',  // idle | immediate | smart
        maxConcurrent = 2,  // æœ€å¤šåŒæ—¶é¢„åŠ è½½å‡ ä¸ª
        networkCheck = true
    } = options;

    // ç½‘ç»œæ£€æŸ¥
    if (networkCheck && !shouldPrefetch()) {
        console.log('ç½‘ç»œæ¡ä»¶ä¸ä½³ï¼Œè·³è¿‡é¢„åŠ è½½');
        return;
    }

    // è·å–é¦–å±åº”ç”¨
    const firstScreenApps = getFirstScreenApps(apps);
    const otherApps = apps.filter(app => !firstScreenApps.includes(app));

    if (strategy === 'idle') {
        // ç©ºé—²æ—¶é¢„åŠ è½½
        window.addEventListener('load', () => {
            let index = 0;
            
            const loadNext = () => {
                if (index >= otherApps.length) return;
                
                const batch = otherApps.slice(index, index + maxConcurrent);
                index += maxConcurrent;
                
                Promise.all(batch.map(app => prefetchApp(app)))
                    .then(() => {
                        if (index < otherApps.length) {
                            requestIdleCallback(loadNext);
                        }
                    });
            };
            
            requestIdleCallback(loadNext);
        });
    } else if (strategy === 'immediate') {
        // ç«‹å³é¢„åŠ è½½
        otherApps.forEach(app => prefetchApp(app));
    } else if (strategy === 'smart') {
        // æ™ºèƒ½é¢„åŠ è½½
        const smartPrefetcher = new SmartPrefetcher(otherApps);
        smartPrefetcher.init();
    }
}
```

é¢„åŠ è½½æ˜¯æå‡å¾®å‰ç«¯ç”¨æˆ·ä½“éªŒçš„å…³é”®æŠ€æœ¯ï¼Œé€šè¿‡ requestIdleCallback å®ç°äº†æ€§èƒ½å’Œä½“éªŒçš„å®Œç¾å¹³è¡¡ï¼

