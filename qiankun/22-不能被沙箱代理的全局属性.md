# é—®é¢˜22ï¼šå“ªäº›å…¨å±€å±æ€§ä¸èƒ½è¢«æ²™ç®±ä»£ç†ï¼Ÿqiankun å¦‚ä½•å¤„ç†è¿™äº›ç‰¹æ®Šå±æ€§ï¼ˆå¦‚ documentã€location ç­‰ï¼‰ï¼Ÿ

## ğŸ“Œ ä¸èƒ½å®Œå…¨ä»£ç†çš„å±æ€§åˆ†ç±»

qiankun æ²™ç®±ä¸­æœ‰äº›å…¨å±€å±æ€§**ä¸èƒ½æˆ–ä¸åº”è¯¥**è¢«å®Œå…¨ä»£ç†ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

1. **BOM æ ¸å¿ƒå¯¹è±¡**ï¼šdocumentã€locationã€history ç­‰
2. **ä¸å¯é…ç½®å±æ€§**ï¼šæŸäº›å†…ç½®å±æ€§
3. **ç™½åå•å±æ€§**ï¼šéœ€è¦é€ƒé€¸åˆ°çœŸå® window çš„å±æ€§
4. **ç‰¹æ®Šå¼•ç”¨**ï¼šwindowã€selfã€topã€parent ç­‰

## ğŸ¯ 1. document å¯¹è±¡

### ä¸ºä»€ä¹ˆä¸èƒ½ä»£ç†ï¼Ÿ

```javascript
// é—®é¢˜ï¼šdocument æ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡

// 1. å®ƒæœ‰å¤§é‡çš„æ–¹æ³•å’Œå±æ€§
document.getElementById()
document.querySelector()
document.createElement()
document.addEventListener()
// ... å‡ ç™¾ä¸ª API

// 2. å¾ˆå¤š API å†…éƒ¨æœ‰ this æ£€æŸ¥
const createElement = document.createElement;
createElement('div');
// âŒ TypeError: Illegal invocation
// å¿…é¡»æ˜¯ï¼šdocument.createElement('div')

// 3. document ä¸ DOM æ ‘å¼ºç»‘å®š
// å®Œå…¨ä»£ç† document ä¼šå¯¼è‡´ DOM æ“ä½œå¼‚å¸¸
```

### qiankun çš„å¤„ç†æ–¹å¼

```typescript
// packages/sandbox/src/core/sandbox/StandardSandbox.ts: 70-71
intrinsics = {
    // â­ document ä½œä¸º intrinsicï¼ˆå†…ç½®å±æ€§ï¼‰æ³¨å…¥
    document: { 
        value: document,      // ä½¿ç”¨çœŸå® document
        writable: true,       // å¯å†™ï¼ˆå…è®¸å­åº”ç”¨ä¿®æ”¹ï¼‰
        enumerable: true, 
        configurable: true 
    },
}
```

**ä½†ä¼šä»£ç† document çš„ç‰¹å®šæ–¹æ³•ï¼š**

```typescript
// packages/sandbox/src/patchers/dynamicAppend/forStandardSandbox.ts: 90-167
const proxyDocument = new Proxy(document, {
    get: (target, p, receiver) => {
        switch (p) {
            case 'createElement': {
                // â­ ä»£ç† createElement
                return function createElement(...args) {
                    const element = target.createElement.call(target, ...args);
                    // æ ‡è®°å…ƒç´ å±äºå½“å‰æ²™ç®±
                    attachElementToSandbox(element);
                    return element;
                };
            }

            case 'querySelector': {
                // â­ ä»£ç† querySelector
                return function querySelector(...args) {
                    const selector = args[0];
                    // ç‰¹æ®Šå¤„ç† head å’Œ body
                    if (selector === 'head') {
                        return getDocumentHeadElement();  // è¿”å›å®¹å™¨çš„ head
                    }
                    if (selector === 'body') {
                        return getDocumentBodyElement();  // è¿”å›å®¹å™¨çš„ body
                    }
                    return target.querySelector.call(target, ...args);
                };
            }

            case 'head': {
                // â­ è¿”å›å®¹å™¨çš„ head
                return getDocumentHeadElement();
            }

            case 'body': {
                // â­ è¿”å›å®¹å™¨çš„ body
                return getDocumentBodyElement();
            }

            default:
                const value = target[p];
                return rebindTarget2Fn(target, value, receiver);
        }
    }
});

// æ³¨å…¥åˆ°æ²™ç®±
sandbox.addIntrinsics({
    document: { value: proxyDocument, writable: false, enumerable: true, configurable: true }
});
```

### ä¸ºä»€ä¹ˆè¦ç‰¹æ®Šå¤„ç† document.head å’Œ document.bodyï¼Ÿ

```javascript
// é—®é¢˜ï¼šå­åº”ç”¨çš„æ ·å¼å’Œè„šæœ¬åº”è¯¥æ·»åŠ åˆ°å“ªé‡Œï¼Ÿ

// å­åº”ç”¨ä»£ç 
const style = document.createElement('style');
style.textContent = '.app { color: red; }';
document.head.appendChild(style);

// å¦‚æœä¸å¤„ç†ï¼š
// style ä¼šæ·»åŠ åˆ°çœŸå®çš„ document.head
// å½±å“æ•´ä¸ªé¡µé¢ï¼ŒåŒ…æ‹¬ä¸»åº”ç”¨ âŒ

// qiankun çš„å¤„ç†ï¼š
// 1. document.head è¿”å›å®¹å™¨çš„ headï¼ˆqiankun-headï¼‰
// 2. appendChild è¢«åŠ«æŒ
// 3. style æ·»åŠ åˆ°å®¹å™¨çš„ head ä¸­
// 4. æ ·å¼åªå½±å“å®¹å™¨å†…çš„å†…å®¹ âœ“
```

**å®¹å™¨ç»“æ„ï¼š**

```html
<div id="subapp-container" data-name="react-app">
    <!-- â­ qiankun åˆ›å»ºçš„è™šæ‹Ÿ head -->
    <qiankun-head>
        <style>/* å­åº”ç”¨çš„æ ·å¼ */</style>
        <link rel="stylesheet" href="...">
    </qiankun-head>
    
    <!-- å­åº”ç”¨çš„å†…å®¹ -->
    <div id="root">
        <h1>å­åº”ç”¨å†…å®¹</h1>
    </div>
</div>
```

## ğŸŒ 2. location å¯¹è±¡

### ä¸ºä»€ä¹ˆä¸èƒ½ä»£ç†ï¼Ÿ

```javascript
// location å¯¹è±¡æ˜¯ç‰¹æ®Šçš„

// 1. è®¾ç½® location ä¼šå¯¼èˆª
window.location = 'https://example.com';  // é¡µé¢è·³è½¬

// 2. location çš„å±æ€§ä¹Ÿä¼šè§¦å‘å¯¼èˆª
window.location.href = 'https://example.com';  // é¡µé¢è·³è½¬
window.location.hash = '#section';  // hash å˜åŒ–

// 3. æŸäº›å±æ€§æ˜¯åªè¯»çš„
window.location.origin;  // åªè¯»

// å¦‚æœå®Œå…¨ä»£ç†ï¼Œä¼šç ´åè·¯ç”±åŠŸèƒ½
```

### qiankun çš„å¤„ç†æ–¹å¼

```javascript
// location ä¸ä»£ç†ï¼Œç›´æ¥ä½¿ç”¨çœŸå®çš„ location

get: (target, prop) => {
    if (prop === 'location') {
        // è¿”å›çœŸå® window.location
        return window.location;
    }
    // ...
}

// å­åº”ç”¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ location
sandbox.proxy.location.href;  // è¯»å–
sandbox.proxy.location.hash = '#page1';  // è®¾ç½®
sandbox.proxy.location.reload();  // æ–¹æ³•è°ƒç”¨

// æ‰€æœ‰æ“ä½œéƒ½åœ¨çœŸå® location ä¸Šè¿›è¡Œ
```

### history å¯¹è±¡ç±»ä¼¼

```javascript
// history ä¹Ÿä¸ä»£ç†

get: (target, prop) => {
    if (prop === 'history') {
        return window.history;
    }
}

// å­åº”ç”¨çš„è·¯ç”±æ“ä½œæ­£å¸¸å·¥ä½œ
sandbox.proxy.history.pushState({}, '', '/new-path');
sandbox.proxy.history.replaceState({}, '', '/replace-path');
sandbox.proxy.history.back();
```

## ğŸ”’ 3. ç™½åå•å±æ€§ï¼ˆå¿…é¡»é€ƒé€¸åˆ°çœŸå® windowï¼‰

```typescript
// packages/sandbox/src/core/membrane/index.ts: 39-48
const globalVariableWhiteList: string[] = [
    'System',           // System.js æ¨¡å—åŠ è½½å™¨
    '__cjsWrapper',     // CommonJS wrapper
    
    // å¼€å‘ç¯å¢ƒ
    '__REACT_ERROR_OVERLAY_GLOBAL_HOOK__',  // React å¼€å‘å·¥å…·
    'event',  // React äº‹ä»¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
];
```

### ä¸ºä»€ä¹ˆéœ€è¦ç™½åå•ï¼Ÿ

#### ä¾‹å­1: System.js

```javascript
// System.js ä½¿ç”¨é—´æ¥ evalï¼Œéœ€è¦åœ¨å…¨å±€ä½œç”¨åŸŸ

// å­åº”ç”¨ä½¿ç”¨ SystemJS
sandbox.proxy.System = {
    import: function(moduleName) {
        // SystemJS çš„å†…éƒ¨å®ç°ä½¿ç”¨ (0, eval)
        // è¿™ä¼šé€ƒé€¸åˆ°å…¨å±€ä½œç”¨åŸŸ
        (0, eval)(`/* module code */`);
    }
};

// å¦‚æœ System åœ¨ fakeWindow ä¸­ï¼š
// eval æ‰§è¡Œçš„ä»£ç æ— æ³•è®¿é—®å…¨å±€ System âŒ

// æ”¾åœ¨ç™½åå•ï¼Œè®¾ç½®åˆ°çœŸå® windowï¼š
// eval æ‰§è¡Œçš„ä»£ç å¯ä»¥è®¿é—® System âœ“
```

#### ä¾‹å­2: React å¼€å‘å·¥å…·

```javascript
// React DevTools éœ€è¦åœ¨çœŸå® window ä¸Š

// React åº”ç”¨åˆå§‹åŒ–æ—¶
if (window.__REACT_ERROR_OVERLAY_GLOBAL_HOOK__) {
    // æ³¨å†Œé”™è¯¯å¤„ç†
    window.__REACT_ERROR_OVERLAY_GLOBAL_HOOK__.register(app);
}

// å¦‚æœè¿™ä¸ªé’©å­åœ¨ fakeWindowï¼š
// - ä¸»åº”ç”¨çš„ React å’Œå­åº”ç”¨çš„ React æ— æ³•å…±äº«
// - DevTools æ— æ³•æ­£å¸¸å·¥ä½œ

// æ”¾åœ¨ç™½åå•ï¼š
// - æ‰€æœ‰åº”ç”¨å…±äº«åŒä¸€ä¸ªé’©å­
// - DevTools æ­£å¸¸å·¥ä½œ âœ“
```

### ç™½åå•çš„å®ç°

```typescript
// packages/sandbox/src/core/membrane/index.ts: 98-104
set: (membraneTarget, p, value: never) => {
    if (!this.locking) {
        // â­ ç™½åå•å±æ€§ï¼šç›´æ¥è®¾ç½®åˆ°çœŸå® window
        if (typeof p === 'string' && whitelistVars.indexOf(p) !== -1) {
            incubatorContext[p as never] = value;
        } else {
            // æ™®é€šå±æ€§ï¼šè®¾ç½®åˆ° membraneTarget
            membraneTarget[p] = value;
        }
        // ...
    }
}
```

## ğŸš« 4. ä¸å¯é…ç½®çš„å±æ€§

### é—®é¢˜åœºæ™¯

```javascript
// æŸäº›å±æ€§åœ¨ window ä¸Šæ˜¯ä¸å¯é…ç½®çš„

// ä¾‹å­ï¼š
Object.getOwnPropertyDescriptor(window, 'top');
// { value: Window, writable: false, enumerable: true, configurable: false }

Object.getOwnPropertyDescriptor(window, 'window');
// { value: Window, writable: false, enumerable: true, configurable: false }
```

### Proxy çš„é™åˆ¶

```javascript
// Proxy è§„åˆ™ï¼š
// å¦‚æœç›®æ ‡å¯¹è±¡çš„å±æ€§æ˜¯ä¸å¯é…ç½®çš„ï¼Œ
// Proxy ä¸èƒ½è¿”å›ä¸ç›®æ ‡å¯¹è±¡ä¸åŒçš„å€¼

const target = {};
Object.defineProperty(target, 'fixed', {
    value: 'original',
    configurable: false
});

const proxy = new Proxy(target, {
    get(target, prop) {
        if (prop === 'fixed') {
            return 'modified';  // å°è¯•è¿”å›ä¸åŒçš„å€¼
        }
        return target[prop];
    }
});

console.log(proxy.fixed);
// âŒ TypeError: 'get' on proxy: property 'fixed' is a read-only and 
//    non-configurable data property on the proxy target but the proxy 
//    did not return its actual value
```

### qiankun çš„å¤„ç†æ–¹å¼

```typescript
// packages/sandbox/src/core/membrane/index.ts: 291-312
// å¤åˆ¶ä¸å¯é…ç½®çš„å±æ€§åˆ° membraneTarget

getOwnPropertyNames(incubatorContext)
    .filter((p) => {
        const descriptor = getOwnPropertyDescriptor(incubatorContext, p);
        // æ‰¾å‡ºä¸å¯é…ç½®çš„å±æ€§
        return !hasOwnProperty(endowments, p) && !descriptor?.configurable;
    })
    .forEach((p) => {
        const descriptor = getOwnPropertyDescriptor(incubatorContext, p);
        if (descriptor) {
            // â­ å¤åˆ¶åˆ° membraneTargetï¼Œä¿æŒç›¸åŒçš„æè¿°ç¬¦
            defineProperty(
                target,
                p,
                freeze(descriptor),  // å†»ç»“æè¿°ç¬¦ï¼Œé¿å…è¢«ä¿®æ”¹
            );
        }
    });
```

## ğŸ¨ 5. ç‰¹æ®Šå¼•ç”¨å±æ€§

### windowã€selfã€globalThis

```typescript
// packages/sandbox/src/core/sandbox/StandardSandbox.ts: 30-35
intrinsics = {
    // â­ é˜²æ­¢é€ƒé€¸ï¼šè¿”å› proxy æœ¬èº«
    window: { 
        get: getRealmGlobal,  // è¿”å› realmGlobalï¼ˆå³ proxyï¼‰
        enumerable: true, 
        configurable: false 
    },
    self: { 
        get: getRealmGlobal, 
        enumerable: true, 
        configurable: false 
    },
    globalThis: { 
        get: getRealmGlobal, 
        enumerable: false, 
        configurable: true 
    },
}
```

**æ•ˆæœï¼š**

```javascript
// å­åº”ç”¨å°è¯•é€ƒé€¸
const w1 = sandbox.proxy.window;
const w2 = w1.window;
const w3 = w2.window;

console.log(w1 === sandbox.proxy);  // true
console.log(w2 === sandbox.proxy);  // true
console.log(w3 === sandbox.proxy);  // true

// æ°¸è¿œæ‹¿ä¸åˆ°çœŸå® window âœ“
```

### topã€parentï¼ˆiframe åœºæ™¯ï¼‰

```typescript
// packages/sandbox/src/core/sandbox/StandardSandbox.ts: 22-28, 55-68
const getTopValue = (p: 'top' | 'parent'): WindowProxy => {
    // å¦‚æœä¸»åº”ç”¨ä¸åœ¨ iframe ä¸­
    if (incubatorContext === incubatorContext.parent) {
        return realmGlobal;  // è¿”å›æ²™ç®± proxy
    }
    // å¦‚æœä¸»åº”ç”¨åœ¨ iframe ä¸­
    return incubatorContext[p]!;  // è¿”å›çœŸå®çš„ top/parent
};

intrinsics = {
    top: {
        get() {
            return getTopValue('top');
        },
        configurable: false,
        enumerable: true,
    },
    parent: {
        get() {
            return getTopValue('parent');
        },
        configurable: false,
        enumerable: true,
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

```javascript
// åœºæ™¯1: ä¸»åº”ç”¨ä¸åœ¨ iframe ä¸­
// ä¸»åº”ç”¨ç›´æ¥è¿è¡Œåœ¨é¡¶å±‚çª—å£

sandbox.proxy.top;     // è¿”å› sandbox.proxyï¼ˆé˜²æ­¢é€ƒé€¸ï¼‰
sandbox.proxy.parent;  // è¿”å› sandbox.proxyï¼ˆé˜²æ­¢é€ƒé€¸ï¼‰

// åœºæ™¯2: ä¸»åº”ç”¨åœ¨ iframe ä¸­
// ä¸»åº”ç”¨åœ¨æŸä¸ª iframe é‡Œè¿è¡Œ

sandbox.proxy.top;     // è¿”å›çœŸå®çš„ window.topï¼ˆå…è®¸è®¿é—®å¤–å±‚ï¼‰
sandbox.proxy.parent;  // è¿”å›çœŸå®çš„ window.parentï¼ˆå…è®¸è®¿é—®å¤–å±‚ï¼‰

// åŸå› ï¼š
// å¦‚æœä¸»åº”ç”¨åœ¨ iframe ä¸­ï¼Œå­åº”ç”¨å¯èƒ½éœ€è¦è®¿é—®å¤–å±‚çª—å£
// æ¯”å¦‚ï¼špostMessage é€šä¿¡
```

## ğŸ¨ 6. hasOwnProperty

```typescript
// packages/sandbox/src/core/sandbox/StandardSandbox.ts: 37-50
intrinsics = {
    hasOwnProperty: {
        value: function hasOwnPropertyImpl(this: unknown, key: PropertyKey): boolean {
            // â­ ç‰¹æ®Šå¤„ç†ï¼šæ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡
            
            // è°ƒç”¨æ–¹å¼ï¼šhasOwnProperty.call(obj, key)
            if (this !== realmGlobal && this !== null && typeof this === 'object') {
                return hasOwnProperty(this, key);
            }

            // è°ƒç”¨æ–¹å¼ï¼šwindow.hasOwnProperty(key)
            // åŒæ—¶æ£€æŸ¥ target å’Œ incubatorContext
            return hasOwnProperty(target, key) || hasOwnProperty(incubatorContext, key);
        },
        writable: true,
        enumerable: false,
        configurable: true,
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Ÿ**

```javascript
// é—®é¢˜ï¼šhasOwnProperty éœ€è¦æ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡

sandbox.proxy.customProp = 'value';
// è®¾ç½®åˆ° fakeWindow

sandbox.proxy.hasOwnProperty('customProp');
// åº”è¯¥è¿”å› true
// éœ€è¦æ£€æŸ¥ fakeWindow

sandbox.proxy.hasOwnProperty('document');
// åº”è¯¥è¿”å› true
// éœ€è¦æ£€æŸ¥çœŸå® window

// å› æ­¤å®ç°ä¸­åŒæ—¶æ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡
```

## ğŸ”§ 7. eval

```typescript
// packages/sandbox/src/core/sandbox/StandardSandbox.ts: 52-53
intrinsics = {
    eval: { 
        value: eval,  // ä½¿ç”¨åŸç”Ÿ eval
        writable: true, 
        enumerable: false, 
        configurable: true 
    },
}
```

**ä¸ºä»€ä¹ˆç”¨åŸç”Ÿ evalï¼Ÿ**

```javascript
// eval æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°

// ç›´æ¥è°ƒç”¨ evalï¼ˆDirect evalï¼‰
eval('var x = 1');  // x åœ¨å½“å‰ä½œç”¨åŸŸ

// é—´æ¥è°ƒç”¨ evalï¼ˆIndirect evalï¼‰
const indirectEval = eval;
indirectEval('var x = 1');  // x åœ¨å…¨å±€ä½œç”¨åŸŸ

// å­åº”ç”¨å¯èƒ½ä½¿ç”¨ (0, eval) æˆ– window.eval
// å¿…é¡»ä¿æŒ eval çš„åŸå§‹è¡Œä¸º
```

## ğŸ“Š 8. å…¶ä»–éœ€è¦ç‰¹æ®Šå¤„ç†çš„ API

### localStorage / sessionStorage

```javascript
// é—®é¢˜ï¼šå­˜å‚¨ API æ˜¯å…¨å±€å…±äº«çš„

// å­åº”ç”¨A
sandbox.proxy.localStorage.setItem('token', 'tokenA');

// å­åº”ç”¨B
sandbox.proxy.localStorage.setItem('token', 'tokenB');  // è¦†ç›–äº†Açš„token

// ç»“æœï¼šä¸¤ä¸ªåº”ç”¨çš„æ•°æ®äº’ç›¸å¹²æ‰° âŒ
```

**è§£å†³æ–¹æ¡ˆï¼šå‰ç¼€éš”ç¦»**

```javascript
// è™½ç„¶ qiankun æ²¡æœ‰å†…ç½®å®ç°ï¼Œä½†å¯ä»¥è‡ªå·±åš

function createIsolatedStorage(appName, storage) {
    return {
        getItem(key) {
            return storage.getItem(`${appName}:${key}`);
        },
        setItem(key, value) {
            storage.setItem(`${appName}:${key}`, value);
        },
        removeItem(key) {
            storage.removeItem(`${appName}:${key}`);
        },
        clear() {
            // åªæ¸…é™¤å½“å‰åº”ç”¨çš„æ•°æ®
            Object.keys(storage).forEach(key => {
                if (key.startsWith(`${appName}:`)) {
                    storage.removeItem(key);
                }
            });
        }
    };
}

// æ³¨å…¥åˆ°æ²™ç®±
sandbox.addIntrinsics({
    localStorage: {
        value: createIsolatedStorage('app1', window.localStorage),
        writable: false,
        enumerable: true,
        configurable: true
    }
});
```

### addEventListener / removeEventListener

```javascript
// é—®é¢˜ï¼šäº‹ä»¶ç›‘å¬å™¨éœ€è¦ç»‘å®šåˆ°çœŸå® window

// å¦‚æœä¸ç»‘å®šï¼š
const addEventListener = sandbox.proxy.addEventListener;
addEventListener('resize', handler);
// âŒ TypeError: Illegal invocation

// qiankun çš„å¤„ç†ï¼šç»‘å®š this
get: (target, prop) => {
    if (prop === 'addEventListener') {
        return window.addEventListener.bind(window);
    }
}

// æ­£å¸¸å·¥ä½œ âœ“
```

**ä½†éœ€è¦åœ¨å¸è½½æ—¶æ¸…ç†ï¼š**

```javascript
// qiankun ä¼šè®°å½•å­åº”ç”¨æ·»åŠ çš„ç›‘å¬å™¨

const listeners = [];

sandbox.proxy.addEventListener = new Proxy(window.addEventListener, {
    apply(target, thisArg, args) {
        listeners.push({ type: args[0], handler: args[1] });
        return target.apply(window, args);
    }
});

// å¸è½½æ—¶æ¸…ç†
sandbox.inactive = function() {
    listeners.forEach(({ type, handler }) => {
        window.removeEventListener(type, handler);
    });
    listeners.length = 0;
};
```

## ğŸ“ é¢è¯•è¦ç‚¹

### ä¸èƒ½å®Œå…¨ä»£ç†çš„å±æ€§

1. **document**ï¼šéƒ¨åˆ†ä»£ç†ï¼ˆheadã€bodyã€createElementç­‰ï¼‰
2. **location**ï¼šä¸ä»£ç†ï¼Œç›´æ¥ä½¿ç”¨çœŸå®å¯¹è±¡
3. **history**ï¼šä¸ä»£ç†ï¼Œç›´æ¥ä½¿ç”¨çœŸå®å¯¹è±¡
4. **navigator**ï¼šä¸ä»£ç†ï¼Œç›´æ¥ä½¿ç”¨çœŸå®å¯¹è±¡
5. **localStorage/sessionStorage**ï¼šä¸ä»£ç†ï¼Œéœ€è¦æ‰‹åŠ¨éš”ç¦»

### ç‰¹æ®Šå¼•ç”¨

1. **windowã€selfã€globalThis**ï¼šè¿”å› proxyï¼ˆé˜²é€ƒé€¸ï¼‰
2. **topã€parent**ï¼šæ ¹æ® iframe æƒ…å†µè¿”å›
3. **hasOwnProperty**ï¼šæ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡

### ç™½åå•æœºåˆ¶

1. **System**ï¼šSystem.js éœ€è¦å…¨å±€è®¿é—®
2. **__cjsWrapper**ï¼šCommonJS åŒ…è£…å™¨
3. **å¼€å‘å·¥å…·**ï¼šReact DevTools ç­‰

### å¤„ç†æ–¹å¼

1. **ç›´æ¥ä½¿ç”¨**ï¼šè¿”å›çœŸå®å¯¹è±¡ï¼ˆlocationã€historyï¼‰
2. **éƒ¨åˆ†ä»£ç†**ï¼šä»£ç†ç‰¹å®šæ–¹æ³•ï¼ˆdocumentï¼‰
3. **ç»‘å®š this**ï¼šå‡½æ•°ç»‘å®šåˆ°çœŸå® windowï¼ˆaddEventListenerï¼‰
4. **ç™½åå•é€ƒé€¸**ï¼šè®¾ç½®åˆ°çœŸå® windowï¼ˆSystemï¼‰
5. **ç‰¹æ®Šå®ç°**ï¼šè‡ªå®šä¹‰é€»è¾‘ï¼ˆhasOwnPropertyï¼‰

## ğŸ’¡ ä¸ºä»€ä¹ˆä¸èƒ½å…¨éƒ¨ä»£ç†ï¼Ÿ

```javascript
// ç†æƒ³æƒ…å†µï¼šä»£ç†æ‰€æœ‰å±æ€§
const perfectSandbox = new Proxy(fakeWindow, {
    get: (target, prop) => {
        // æ‰€æœ‰å±æ€§éƒ½ä» fakeWindow è¯»å–
        return target[prop];
    }
});

// ç°å®é—®é¢˜ï¼š
// 1. document/location ç­‰å¯¹è±¡å¤ªå¤æ‚ï¼Œå®Œå…¨ä»£ç†ä¼šæœ‰é—®é¢˜
// 2. æŸäº› API å†…éƒ¨æœ‰ä¸¥æ ¼çš„ this æ£€æŸ¥
// 3. æŸäº›å±æ€§åœ¨è§„èŒƒä¸Šä¸å…è®¸ä»£ç†
// 4. æŸäº›åŠŸèƒ½éœ€è¦å…¨å±€å…±äº«ï¼ˆå¦‚ System.jsï¼‰

// å› æ­¤éœ€è¦ï¼š
// - è¯†åˆ«å“ªäº›å±æ€§éœ€è¦ç‰¹æ®Šå¤„ç†
// - é’ˆå¯¹æ€§åœ°è®¾è®¡ä»£ç†ç­–ç•¥
// - å¹³è¡¡éš”ç¦»æ€§å’ŒåŠŸèƒ½æ€§
```

qiankun é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å±æ€§åˆ†ç±»å’Œå¤„ç†ç­–ç•¥ï¼Œåœ¨ä¿è¯éš”ç¦»æ€§çš„åŒæ—¶ï¼Œç¡®ä¿äº†å„ç§ Web API çš„æ­£å¸¸å·¥ä½œï¼

