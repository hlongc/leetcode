# é—®é¢˜3ï¼šimport-html-entry å¦‚ä½•å¤„ç† HTML ä¸­çš„å¤–é“¾è„šæœ¬ï¼ˆexternal scriptsï¼‰å’Œå†…è”è„šæœ¬ï¼ˆinline scriptsï¼‰ï¼Ÿ

## ğŸ“Œ æ ¸å¿ƒåŒºåˆ«

| ç‰¹æ€§ | å¤–é“¾è„šæœ¬ | å†…è”è„šæœ¬ |
|------|---------|---------|
| **è¯†åˆ«æ–¹å¼** | `<script src="...">` | `<script>code</script>` |
| **å­˜å‚¨æ ¼å¼** | URL å­—ç¬¦ä¸²æˆ–å¯¹è±¡ | å®Œæ•´çš„ script æ ‡ç­¾å­—ç¬¦ä¸² |
| **åŠ è½½æ–¹å¼** | fetch å¼‚æ­¥ä¸‹è½½ | ç›´æ¥ä» HTML ä¸­æå– |
| **ç¼“å­˜ç­–ç•¥** | scriptCache ç¼“å­˜ | æ— éœ€ç¼“å­˜ï¼ˆå·²åœ¨å†…å­˜ä¸­ï¼‰ |
| **æ‰§è¡Œæ—¶æœº** | ä¸‹è½½å®Œæˆåæ‰§è¡Œ | ç«‹å³å¯æ‰§è¡Œ |

## ğŸ” 1. è¯†åˆ«ä¸æå–é˜¶æ®µï¼ˆprocessTplï¼‰

### å¤–é“¾è„šæœ¬çš„è¯†åˆ«

```javascript
// src/process-tpl.js: 129-167
// é€šè¿‡ SCRIPT_SRC_REGEX åŒ¹é… src å±æ€§
if (SCRIPT_TAG_REGEX.test(match) && scriptTag.match(SCRIPT_SRC_REGEX)) {
    const matchedScriptSrcMatch = scriptTag.match(SCRIPT_SRC_REGEX);
    let matchedScriptSrc = matchedScriptSrcMatch && matchedScriptSrcMatch[2];

    if (matchedScriptSrc) {
        // è¡¥å…¨ç›¸å¯¹è·¯å¾„
        if (!hasProtocol(matchedScriptSrc)) {
            matchedScriptSrc = getEntirePath(matchedScriptSrc, baseURI);
        }
        matchedScriptSrc = parseUrl(matchedScriptSrc);
    }

    // æ£€æµ‹ç‰¹æ®Šå±æ€§
    const asyncScript = !!scriptTag.match(SCRIPT_ASYNC_REGEX);
    const crossOriginScript = !!scriptTag.match(SCRIPT_CROSSORIGIN_REGEX);

    // å­˜å‚¨ä¸ºå­—ç¬¦ä¸²æˆ–å¯¹è±¡
    scripts.push(
        (asyncScript || crossOriginScript) 
            ? { async: asyncScript, src: matchedScriptSrc, crossOrigin: crossOriginScript }
            : matchedScriptSrc
    );

    return genScriptReplaceSymbol(matchedScriptSrc, asyncScript, crossOriginScript);
}
```

**å¤–é“¾è„šæœ¬çš„å­˜å‚¨å½¢å¼ï¼š**

```javascript
// 1. æ™®é€šå¤–é“¾è„šæœ¬ï¼ˆå­—ç¬¦ä¸²ï¼‰
'http://localhost:8080/main.js'

// 2. å¸¦å±æ€§çš„å¤–é“¾è„šæœ¬ï¼ˆå¯¹è±¡ï¼‰
{
    async: true,
    src: 'http://localhost:8080/analytics.js',
    crossOrigin: true
}
```

### å†…è”è„šæœ¬çš„è¯†åˆ«

```javascript
// src/process-tpl.js: 170-190
else {
    // æå–å†…è”ä»£ç 
    const code = getInlineCode(match);

    // è¿‡æ»¤çº¯æ³¨é‡Šä»£ç å—
    const isPureCommentBlock = code.split(/[\r\n]+/)
        .every(line => !line.trim() || line.trim().startsWith('//'));

    if (!isPureCommentBlock) {
        scripts.push(match);  // å­˜å‚¨å®Œæ•´çš„ <script> æ ‡ç­¾
    }

    return inlineScriptReplaceSymbol;
}
```

**getInlineCode å®ç°ï¼š**

```javascript
// src/utils.js: 78-82
export function getInlineCode(match) {
    const start = match.indexOf('>') + 1;  // æ‰¾åˆ° > åçš„ä½ç½®
    const end = match.lastIndexOf('<');     // æ‰¾åˆ°æœ€åçš„ < ä½ç½®
    return match.substring(start, end);     // æå–ä¸­é—´çš„ä»£ç 
}
```

**å†…è”è„šæœ¬çš„å­˜å‚¨å½¢å¼ï¼š**

```javascript
// å®Œæ•´çš„ script æ ‡ç­¾ï¼ˆåŒ…å«ä»£ç ï¼‰
'<script>console.log("hello");</script>'
'<script type="text/javascript">\nwindow.APP_CONFIG = {};\n</script>'
```

## ğŸ“¥ 2. åŠ è½½é˜¶æ®µï¼ˆgetExternalScriptsï¼‰

è¿™ä¸ªé˜¶æ®µåªå¤„ç†å¤–é“¾è„šæœ¬ï¼Œå†…è”è„šæœ¬å·²ç»åœ¨ HTML ä¸­æå–å®Œæ¯•ã€‚

```javascript
// src/index.js: 124-191
export function getExternalScripts(scripts, fetch = defaultFetch, entry) {
    // è„šæœ¬ç¼“å­˜
    const fetchScript = (scriptUrl, opts) => scriptCache[scriptUrl] ||
        (scriptCache[scriptUrl] = fetch(scriptUrl, opts).then(response => {
            if (response.status >= 400) {
                throw new Error(`${scriptUrl} load failed with status ${response.status}`);
            }
            return response.text();
        }).catch(e => {
            // é”™è¯¯å¤„ç†
            throw e;
        }));

    // entry js ä¸‹è½½å¤±è´¥åº”è¯¥ç›´æ¥ break
    const shouldBreakWhileError = (i) => scripts[i] === entry;

    return allSettledButCanBreak(scripts.map(async script => {
        // 1. å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„è„šæœ¬
        if (typeof script === 'string') {
            if (isInlineCode(script)) {
                // å†…è”è„šæœ¬ï¼šç›´æ¥æå–ä»£ç 
                return getInlineCode(script);
            } else {
                // å¤–é“¾è„šæœ¬ï¼šfetch ä¸‹è½½
                return fetchScript(script);
            }
        } 
        // 2. å¤„ç†å¯¹è±¡ç±»å‹çš„è„šæœ¬ï¼ˆasync/crossOriginï¼‰
        else {
            const { src, async, crossOrigin } = script;
            const fetchOpts = crossOrigin ? { credentials: 'include' } : {};

            if (async) {
                // async è„šæœ¬åœ¨ç©ºé—²æ—¶åŠ è½½
                return {
                    src,
                    async: true,
                    content: new Promise((resolve, reject) => 
                        requestIdleCallback(() => 
                            fetchScript(src, fetchOpts).then(resolve, reject)
                        )
                    ),
                };
            }

            return fetchScript(src, fetchOpts);
        }
    }), shouldBreakWhileError)
    .then(results => 
        results.map((result, i) => {
            if (result.status === 'fulfilled') {
                result.value = {
                    src: scripts[i],  // åŸå§‹è„šæœ¬ä¿¡æ¯
                    value: result.value,  // è„šæœ¬å†…å®¹æˆ– Promise
                };
            }
            return result;
        }).filter(result => {
            // å¿½ç•¥å¤±è´¥çš„è¯·æ±‚
            if (result.status === 'rejected') {
                Promise.reject(result.reason);
            }
            return result.status === 'fulfilled';
        }).map(result => result.value)
    );
}
```

### å…³é”®å¤„ç†é€»è¾‘ï¼š

#### 1. ç±»å‹åˆ¤æ–­

```javascript
if (typeof script === 'string') {
    // å­—ç¬¦ä¸²ç±»å‹ï¼šå¯èƒ½æ˜¯ URL æˆ–å†…è”ä»£ç 
    if (isInlineCode(script)) {
        // å†…è”ï¼šæå–ä»£ç 
        return getInlineCode(script);
    } else {
        // å¤–é“¾ï¼šä¸‹è½½
        return fetchScript(script);
    }
} else {
    // å¯¹è±¡ç±»å‹ï¼šå¸¦å±æ€§çš„å¤–é“¾è„šæœ¬
    const { src, async, crossOrigin } = script;
    // ...
}
```

**isInlineCode åˆ¤æ–­ï¼š**

```javascript
// src/index.js: 55
const isInlineCode = code => code.startsWith('<');
```

ç®€å•ä½†æœ‰æ•ˆï¼šå†…è”è„šæœ¬å­˜å‚¨çš„æ˜¯ `<script>` æ ‡ç­¾ï¼Œå¿…ç„¶ä»¥ `<` å¼€å¤´ã€‚

#### 2. ç¼“å­˜æœºåˆ¶

```javascript
const fetchScript = (scriptUrl, opts) => scriptCache[scriptUrl] ||
    (scriptCache[scriptUrl] = fetch(scriptUrl, opts).then(...));
```

**ç‰¹ç‚¹ï¼š**
- åŒä¸€ä¸ª URL åªä¼šä¸‹è½½ä¸€æ¬¡
- ä½¿ç”¨ Promise ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚
- å†…è”è„šæœ¬ä¸éœ€è¦ç¼“å­˜ï¼ˆç›´æ¥æå–ï¼‰

#### 3. async è„šæœ¬çš„ç‰¹æ®Šå¤„ç†

```javascript
if (async) {
    return {
        src,
        async: true,
        content: new Promise((resolve, reject) => 
            requestIdleCallback(() => 
                fetchScript(src, fetchOpts).then(resolve, reject)
            )
        ),
    };
}
```

**ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ `requestIdleCallback` åœ¨æµè§ˆå™¨ç©ºé—²æ—¶ä¸‹è½½
- è¿”å›ä¸€ä¸ªåŒ…å« Promise çš„å¯¹è±¡
- ä¸ä¼šé˜»å¡å…¶ä»–è„šæœ¬çš„åŠ è½½

#### 4. crossOrigin å¤„ç†

```javascript
const fetchOpts = crossOrigin ? { credentials: 'include' } : {};
```

æºå¸¦å‡­è¯ï¼ˆcookiesï¼‰è¿›è¡Œè·¨åŸŸè¯·æ±‚ã€‚

#### 5. é”™è¯¯å¤„ç†ç­–ç•¥

```javascript
const shouldBreakWhileError = (i) => scripts[i] === entry;
```

**é‡è¦ç‰¹æ€§ï¼š**
- **entry è„šæœ¬å¤±è´¥**ï¼šç«‹å³ä¸­æ–­ï¼ŒæŠ›å‡ºé”™è¯¯
- **æ™®é€šè„šæœ¬å¤±è´¥**ï¼šä»…è®°å½•é”™è¯¯ï¼Œç»§ç»­åŠ è½½å…¶ä»–è„šæœ¬

## âš™ï¸ 3. æ‰§è¡Œé˜¶æ®µï¼ˆexecScriptsï¼‰

è¿™ä¸ªé˜¶æ®µç»Ÿä¸€å¤„ç†å¤–é“¾å’Œå†…è”è„šæœ¬ã€‚

```javascript
// src/index.js: 215-308
export function execScripts(entry, scripts, proxy = window, opts = {}) {
    return getExternalScripts(scripts, fetch, entry)
        .then(scriptsText => {
            // scriptsText: [{ src: '...', value: 'code' }, ...]

            const geval = (scriptSrc, inlineScript) => {
                const rawCode = beforeExec(inlineScript, scriptSrc) || inlineScript;
                const code = getExecutableScript(scriptSrc, rawCode, { 
                    proxy, 
                    strictGlobal, 
                    scopedGlobalVariables 
                });
                evalCode(scriptSrc, code);
                afterExec(inlineScript, scriptSrc);
            };

            function exec(scriptSrc, inlineScript, resolve) {
                if (scriptSrc === entry) {
                    // entry è„šæœ¬ç‰¹æ®Šå¤„ç†
                    noteGlobalProps(strictGlobal ? proxy : window);

                    try {
                        geval(scriptSrc, inlineScript);
                        const exports = proxy[getGlobalProp(strictGlobal ? proxy : window)] || {};
                        resolve(exports);
                    } catch (e) {
                        console.error(`[import-html-entry]: error occurs while executing entry script ${scriptSrc}`);
                        throw e;
                    }
                } else {
                    // æ™®é€šè„šæœ¬
                    if (typeof inlineScript === 'string') {
                        try {
                            if (scriptSrc?.src) {
                                geval(scriptSrc.src, inlineScript);
                            } else {
                                geval(scriptSrc, inlineScript);
                            }
                        } catch (e) {
                            throwNonBlockingError(e, `[import-html-entry]: error occurs while executing normal script ${scriptSrc}`);
                        }
                    } else {
                        // async è„šæœ¬
                        inlineScript.async && inlineScript?.content
                            .then(downloadedScriptText => geval(inlineScript.src, downloadedScriptText))
                            .catch(e => {
                                throwNonBlockingError(e, `[import-html-entry]: error occurs while executing async script ${inlineScript.src}`);
                            });
                    }
                }
            }

            // é¡ºåºè°ƒåº¦æ‰§è¡Œ
            function schedule(i, resolvePromise) {
                if (i < scriptsText.length) {
                    const script = scriptsText[i];
                    const scriptSrc = script.src;
                    const inlineScript = script.value;

                    exec(scriptSrc, inlineScript, resolvePromise);
                    if (!entry && i === scriptsText.length - 1) {
                        resolvePromise();
                    } else {
                        schedule(i + 1, resolvePromise);
                    }
                }
            }

            return new Promise(resolve => schedule(0, success || resolve));
        });
}
```

### å…³é”®æ‰§è¡Œé€»è¾‘ï¼š

#### 1. ä»£ç åŒ…è£…ï¼ˆgetExecutableScriptï¼‰

æ— è®ºå¤–é“¾è¿˜æ˜¯å†…è”ï¼Œéƒ½ä¼šè¢«åŒ…è£…å¤„ç†ï¼š

```javascript
// src/index.js: 57-77
function getExecutableScript(scriptSrc, scriptText, opts = {}) {
    const { proxy, strictGlobal, scopedGlobalVariables = [] } = opts;

    const sourceUrl = isInlineCode(scriptSrc) ? '' : `//# sourceURL=${scriptSrc}\n`;

    const globalWindow = (0, eval)('window');
    globalWindow.proxy = proxy;

    return strictGlobal
        ? `;(function(){with(this){${scriptText}\n${sourceUrl}}}).bind(window.proxy)();`
        : `;(function(window, self, globalThis){;${scriptText}\n${sourceUrl}}).bind(window.proxy)(window.proxy, window.proxy, window.proxy);`;
}
```

**å¤–é“¾è„šæœ¬åŒ…è£…ç¤ºä¾‹ï¼š**
```javascript
// åŸå§‹ä»£ç 
console.log('hello');

// åŒ…è£…åï¼ˆé strictGlobalï¼‰
;(function(window, self, globalThis){;console.log('hello');
//# sourceURL=http://localhost:8080/main.js
}).bind(window.proxy)(window.proxy, window.proxy, window.proxy);
```

**å†…è”è„šæœ¬åŒ…è£…ç¤ºä¾‹ï¼š**
```javascript
// åŸå§‹ä»£ç 
window.config = { api: '/api' };

// åŒ…è£…åï¼ˆæ—  sourceURLï¼‰
;(function(window, self, globalThis){;window.config = { api: '/api' };
}).bind(window.proxy)(window.proxy, window.proxy, window.proxy);
```

**å…³é”®ç‚¹ï¼š**
- å¤–é“¾è„šæœ¬æ·»åŠ  `sourceURL`ï¼Œä¾¿äºè°ƒè¯•
- å†…è”è„šæœ¬æ²¡æœ‰ sourceURL
- é€šè¿‡ `bind` ç»‘å®š proxy ä½œä¸º `this`
- é€šè¿‡å‚æ•°ä¼ é€’ proxy è¦†ç›– windowã€selfã€globalThis

#### 2. é¡ºåºæ‰§è¡Œ

```javascript
function schedule(i, resolvePromise) {
    if (i < scriptsText.length) {
        const script = scriptsText[i];
        exec(script.src, script.value, resolvePromise);
        schedule(i + 1, resolvePromise);  // é€’å½’è°ƒåº¦
    }
}
```

**ä¿è¯æ‰§è¡Œé¡ºåºï¼š**
- å¤–é“¾å’Œå†…è”è„šæœ¬æŒ‰ HTML ä¸­çš„é¡ºåºæ‰§è¡Œ
- åŒæ­¥è„šæœ¬ä¸²è¡Œæ‰§è¡Œ
- async è„šæœ¬å¼‚æ­¥æ‰§è¡Œï¼ˆä¸é˜»å¡ï¼‰

#### 3. é”™è¯¯å¤„ç†å·®å¼‚

```javascript
// entry è„šæœ¬é”™è¯¯
try {
    geval(scriptSrc, inlineScript);
    resolve(exports);
} catch (e) {
    throw e;  // æŠ›å‡ºé”™è¯¯ï¼Œä¸­æ–­æ‰§è¡Œ
}

// æ™®é€šè„šæœ¬é”™è¯¯
try {
    geval(scriptSrc, inlineScript);
} catch (e) {
    throwNonBlockingError(e, msg);  // éé˜»å¡é”™è¯¯
}
```

**throwNonBlockingError å®ç°ï¼š**

```javascript
// src/index.js: 193-198
function throwNonBlockingError(error, msg) {
    setTimeout(() => {
        console.error(msg);
        throw error;
    });
}
```

é€šè¿‡ `setTimeout` å»¶è¿ŸæŠ›å‡ºï¼Œä¸é˜»å¡åç»­è„šæœ¬æ‰§è¡Œã€‚

#### 4. async è„šæœ¬çš„æ‰§è¡Œ

```javascript
inlineScript.async && inlineScript?.content
    .then(downloadedScriptText => geval(inlineScript.src, downloadedScriptText))
    .catch(e => {
        throwNonBlockingError(e, `...`);
    });
```

å¼‚æ­¥è„šæœ¬åœ¨ä¸‹è½½å®Œæˆåç‹¬ç«‹æ‰§è¡Œï¼Œä¸å½±å“ä¸»æµç¨‹ã€‚

## ğŸ“Š å®Œæ•´æµç¨‹å¯¹æ¯”

### å¤–é“¾è„šæœ¬å¤„ç†æµç¨‹

```
HTML è§£æï¼ˆprocessTplï¼‰
    â†“
è¯†åˆ« <script src="...">
    â†“
æå– src å±æ€§ + è¡¥å…¨è·¯å¾„
    â†“
å­˜å‚¨ä¸ºå­—ç¬¦ä¸²æˆ–å¯¹è±¡
    â†“
èµ„æºåŠ è½½ï¼ˆgetExternalScriptsï¼‰
    â†“
fetch ä¸‹è½½è„šæœ¬å†…å®¹
    â†“
ç¼“å­˜åˆ° scriptCache
    â†“
è„šæœ¬æ‰§è¡Œï¼ˆexecScriptsï¼‰
    â†“
åŒ…è£…ä»£ç ï¼ˆæ·»åŠ  sourceURLï¼‰
    â†“
eval æ‰§è¡Œ
```

### å†…è”è„šæœ¬å¤„ç†æµç¨‹

```
HTML è§£æï¼ˆprocessTplï¼‰
    â†“
è¯†åˆ« <script>...</script>
    â†“
æå–å®Œæ•´æ ‡ç­¾å†…å®¹
    â†“
å­˜å‚¨ä¸ºå­—ç¬¦ä¸²
    â†“
èµ„æºåŠ è½½ï¼ˆgetExternalScriptsï¼‰
    â†“
ä½¿ç”¨ getInlineCode æå–ä»£ç 
    â†“
æ— éœ€ä¸‹è½½å’Œç¼“å­˜
    â†“
è„šæœ¬æ‰§è¡Œï¼ˆexecScriptsï¼‰
    â†“
åŒ…è£…ä»£ç ï¼ˆæ—  sourceURLï¼‰
    â†“
eval æ‰§è¡Œ
```

## ğŸ“ é¢è¯•è¦ç‚¹

1. **è¯†åˆ«æœºåˆ¶**ï¼šé€šè¿‡ `src` å±æ€§åŒºåˆ†å¤–é“¾å’Œå†…è”è„šæœ¬
2. **å­˜å‚¨å·®å¼‚**ï¼šå¤–é“¾å­˜ URLï¼Œå†…è”å­˜å®Œæ•´æ ‡ç­¾
3. **åŠ è½½ç­–ç•¥**ï¼šå¤–é“¾éœ€ fetch ä¸‹è½½ï¼Œå†…è”ç›´æ¥æå–
4. **ç¼“å­˜æœºåˆ¶**ï¼šå¤–é“¾è„šæœ¬ç¼“å­˜ï¼Œå†…è”è„šæœ¬ä¸ç¼“å­˜
5. **æ‰§è¡Œé¡ºåº**ï¼šä¸¥æ ¼æŒ‰ HTML ä¸­çš„é¡ºåºæ‰§è¡Œ
6. **é”™è¯¯å¤„ç†**ï¼šentry è„šæœ¬é”™è¯¯ä¸­æ–­ï¼Œæ™®é€šè„šæœ¬é”™è¯¯ä¸é˜»å¡
7. **async æ”¯æŒ**ï¼šasync è„šæœ¬ç©ºé—²æ—¶åŠ è½½ï¼Œå¼‚æ­¥æ‰§è¡Œ
8. **è°ƒè¯•æ”¯æŒ**ï¼šå¤–é“¾è„šæœ¬æ·»åŠ  sourceURL ä¾¿äºè°ƒè¯•

## ğŸ’¡ è®¾è®¡äº®ç‚¹

1. **ç»Ÿä¸€æ¥å£**ï¼šå¤–é“¾å’Œå†…è”è„šæœ¬ä½¿ç”¨ç»Ÿä¸€çš„ scripts æ•°ç»„ç®¡ç†
2. **ç±»å‹åŒºåˆ†**ï¼šé€šè¿‡å­—ç¬¦ä¸²/å¯¹è±¡ç±»å‹åŒºåˆ†ä¸åŒçš„è„šæœ¬å±æ€§
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ã€requestIdleCallbackã€å®¹é”™æœºåˆ¶
4. **è°ƒè¯•å‹å¥½**ï¼šsourceURLã€é”™è¯¯ä¿¡æ¯åŒ…å«è„šæœ¬è·¯å¾„
5. **çµæ´»æ‰©å±•**ï¼šæ”¯æŒ beforeExecã€afterExec é’©å­

